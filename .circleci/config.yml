version: 2.1

orbs:
  node: circleci/node@5.1.0

executors:
  node-executor:
    docker:
      - image: cimg/node:18.19
      - image: cimg/postgres:15.5
        environment:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: ecommerce_test_db
      - image: redis:7.2
    working_directory: ~/project
    resource_class: medium

commands:
  install_dependencies:
    steps:
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package.json" }}
            - v1-dependencies-
      - run:
          name: Install Dependencies
          command: npm ci
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package.json" }}

  wait_for_db:
    steps:
      - run:
          name: Wait for PostgreSQL
          command: dockerize -wait tcp://localhost:5432 -timeout 1m

jobs:
  checkout_and_install:
    executor: node-executor
    steps:
      - checkout
      - install_dependencies
      - persist_to_workspace:
          root: ~/project
          paths:
            - .

  lint_and_typecheck:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: Run ESLint
          command: npm run lint
      - run:
          name: Run TypeScript type check
          command: npm run typecheck

  build:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: Build TypeScript
          command: npm run build
      - persist_to_workspace:
          root: ~/project
          paths:
            - dist

  test_unit_adaptive_analysis:
    executor: node-executor
    parallelism: 4
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: Run Unit Tests (Analysis Mode)
          command: circleci run testsuite "unit-tests" --test-selection=all --test-analysis=all
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage
          destination: coverage-adaptive-analysis

  test_unit_adaptive_selection:
    executor: node-executor
    parallelism: 4
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: Run Unit Tests (Selection Mode)
          command: circleci run testsuite "unit-tests" --test-selection=impacted --test-analysis=none
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage
          destination: coverage-adaptive-selection

  test_integration_adaptive_analysis:
    executor: node-executor
    parallelism: 2
    steps:
      - attach_workspace:
          at: ~/project
      - wait_for_db
      - run:
          name: Run Database Migrations
          command: npm run db:migrate
      - run:
          name: Run Integration Tests (Analysis Mode)
          command: circleci run testsuite "integration-tests" --test-selection=all --test-analysis=all
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage
          destination: coverage-adaptive-analysis

  test_integration_adaptive_selection:
    executor: node-executor
    parallelism: 2
    steps:
      - attach_workspace:
          at: ~/project
      - wait_for_db
      - run:
          name: Run Database Migrations
          command: npm run db:migrate
      - run:
          name: Run Integration Tests (Selection Mode)
          command: circleci run testsuite "integration-tests" --test-selection=impacted --test-analysis=none
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage
          destination: coverage-adaptive-selection

  test_e2e_adaptive_analysis:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/project
      - wait_for_db
      - run:
          name: Run Database Migrations
          command: npm run db:migrate
      - run:
          name: Seed Test Data
          command: npm run db:seed
      - run:
          name: Run E2E Tests (Analysis Mode)
          command: circleci run testsuite "e2e-tests" --test-selection=all --test-analysis=all
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage
          destination: coverage-adaptive-analysis

  test_e2e_adaptive_selection:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/project
      - wait_for_db
      - run:
          name: Run Database Migrations
          command: npm run db:migrate
      - run:
          name: Seed Test Data
          command: npm run db:seed
      - run:
          name: Run E2E Tests (Selection Mode)
          command: circleci run testsuite "e2e-tests" --test-selection=impacted --test-analysis=none
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage
          destination: coverage-adaptive-selection

workflows:
  version: 2

  test_adaptive_analysis:
    jobs:
      - checkout_and_install:
          filters:
            branches:
              only: master
      - lint_and_typecheck:
          requires:
            - checkout_and_install
      - test_unit_adaptive_analysis:
          requires:
            - lint_and_typecheck
      - test_integration_adaptive_analysis:
          requires:
            - test_unit_adaptive_analysis
      - test_e2e_adaptive_analysis:
          requires:
            - test_integration_adaptive_analysis
      - build:
          requires:
            - test_e2e_adaptive_analysis

  test_adaptive_intelligent:
    jobs:
      - checkout_and_install:
          filters:
            branches:
              only: adaptive-testing-demo
      - lint_and_typecheck:
          requires:
            - checkout_and_install
      - test_unit_adaptive_selection:
          requires:
            - lint_and_typecheck
      - test_integration_adaptive_selection:
          requires:
            - test_unit_adaptive_selection
      - test_e2e_adaptive_selection:
          requires:
            - test_integration_adaptive_selection
      - build:
          requires:
            - test_e2e_adaptive_selection
