f98804e5c0ead77dd02a581294c787ef
"use strict";
/**
 * TDD Implementation: Product Service
 *
 * Business logic layer for product management
 * Implements all functionality to pass tests in product.service.spec.ts
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.ProductService = void 0;
const product_entity_1 = require("../entities/product.entity");
const errors_1 = require("@libs/errors");
class ProductService {
    productRepository;
    constructor(productRepository) {
        this.productRepository = productRepository;
    }
    /**
     * Create new product with validation
     */
    async createProduct(data) {
        // Validate price
        if (data.price <= 0) {
            throw new errors_1.BadRequestError('Price must be positive');
        }
        // Validate inventory
        if (data.inventory < 0) {
            throw new errors_1.BadRequestError('Inventory cannot be negative');
        }
        // Validate compareAtPrice if provided
        if (data.compareAtPrice !== undefined) {
            if (data.compareAtPrice <= data.price) {
                throw new errors_1.BadRequestError('Compare at price must be higher than price');
            }
        }
        return this.productRepository.createProduct(data);
    }
    /**
     * Get product by ID
     */
    async getProductById(productId) {
        return this.productRepository.findById(productId);
    }
    /**
     * Update product
     */
    async updateProduct(productId, data) {
        // Validate price if being updated
        if (data.price !== undefined && data.price <= 0) {
            throw new errors_1.BadRequestError('Price must be positive');
        }
        // Validate compareAtPrice if being updated
        if (data.compareAtPrice !== undefined && data.price !== undefined) {
            if (data.compareAtPrice <= data.price) {
                throw new errors_1.BadRequestError('Compare at price must be higher than price');
            }
        }
        return this.productRepository.update(productId, data);
    }
    /**
     * Delete product
     */
    async deleteProduct(productId) {
        await this.productRepository.delete(productId);
    }
    /**
     * Publish product (make it active)
     */
    async publishProduct(productId) {
        return this.productRepository.update(productId, {
            status: product_entity_1.ProductStatus.ACTIVE,
        });
    }
    /**
     * Unpublish product (make it draft)
     */
    async unpublishProduct(productId) {
        return this.productRepository.update(productId, {
            status: product_entity_1.ProductStatus.DRAFT,
        });
    }
    /**
     * Update inventory
     */
    async updateInventory(productId, inventory) {
        if (inventory < 0) {
            throw new errors_1.BadRequestError('Inventory cannot be negative');
        }
        return this.productRepository.updateInventory(productId, inventory);
    }
    /**
     * Reserve inventory for purchase
     */
    async reserveInventory(productId, quantity) {
        if (quantity <= 0) {
            throw new errors_1.BadRequestError('Quantity must be positive');
        }
        return this.productRepository.decrementInventory(productId, quantity);
    }
    /**
     * Restock inventory
     */
    async restockInventory(productId, quantity) {
        if (quantity <= 0) {
            throw new errors_1.BadRequestError('Quantity must be positive');
        }
        return this.productRepository.incrementInventory(productId, quantity);
    }
    /**
     * Get products with low stock
     */
    async getLowStockProducts(threshold = 10) {
        return this.productRepository.findLowStock(threshold);
    }
    /**
     * Get products on sale
     */
    async getProductsOnSale() {
        return this.productRepository.findOnSale();
    }
    /**
     * Search products with filters
     */
    async searchProducts(query, options) {
        return this.productRepository.searchProducts(query, options);
    }
    /**
     * Record a sale (decrement inventory and increment sold count)
     */
    async recordSale(productId, quantity) {
        await this.productRepository.decrementInventory(productId, quantity);
        await this.productRepository.incrementSoldCount(productId, quantity);
    }
    /**
     * Update product rating
     */
    async updateProductRating(productId, newRating, reviewCount) {
        // Validate rating
        if (newRating < 1 || newRating > 5) {
            throw new errors_1.BadRequestError('Rating must be between 1 and 5');
        }
        // Get current product to calculate new average
        const product = await this.productRepository.findById(productId);
        // Calculate new average rating
        const totalRating = product.rating * product.reviewCount + newRating * reviewCount;
        const totalReviews = product.reviewCount + reviewCount;
        const newAverageRating = totalRating / totalReviews;
        return this.productRepository.updateRating(productId, Math.round(newAverageRating * 10) / 10, // Round to 1 decimal
        totalReviews);
    }
    /**
     * Get top selling products
     */
    async getTopSellingProducts(limit = 10) {
        return this.productRepository.findTopSelling(limit);
    }
    /**
     * Get top rated products
     */
    async getTopRatedProducts(limit = 10, minReviews = 5) {
        return this.productRepository.findTopRated(limit, minReviews);
    }
}
exports.ProductService = ProductService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXEFkYXB0aXZlX1Rlc3RpbmdcXHNyY1xcc2VydmljZXNcXHByb2R1Y3QtY2F0YWxvZ1xcc2VydmljZXNcXHByb2R1Y3Quc2VydmljZS50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7O0dBS0c7OztBQUdILCtEQUFvRTtBQUNwRSx5Q0FBK0M7QUF3Qi9DLE1BQWEsY0FBYztJQUNMO0lBQXBCLFlBQW9CLGlCQUFvQztRQUFwQyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO0lBQUcsQ0FBQztJQUU1RDs7T0FFRztJQUNILEtBQUssQ0FBQyxhQUFhLENBQUMsSUFBc0I7UUFDeEMsaUJBQWlCO1FBQ2pCLElBQUksSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUNwQixNQUFNLElBQUksd0JBQWUsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1FBQ3RELENBQUM7UUFFRCxxQkFBcUI7UUFDckIsSUFBSSxJQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3ZCLE1BQU0sSUFBSSx3QkFBZSxDQUFDLDhCQUE4QixDQUFDLENBQUM7UUFDNUQsQ0FBQztRQUVELHNDQUFzQztRQUN0QyxJQUFJLElBQUksQ0FBQyxjQUFjLEtBQUssU0FBUyxFQUFFLENBQUM7WUFDdEMsSUFBSSxJQUFJLENBQUMsY0FBYyxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztnQkFDdEMsTUFBTSxJQUFJLHdCQUFlLENBQUMsNENBQTRDLENBQUMsQ0FBQztZQUMxRSxDQUFDO1FBQ0gsQ0FBQztRQUVELE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsY0FBYyxDQUFDLFNBQWlCO1FBQ3BDLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsYUFBYSxDQUFDLFNBQWlC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RUQ7O09BRUc7SUFDSCxLQUFLLENBQUMscUJBQXFCLENBQUMsUUFBZ0IsRUFBRTtRQUM1QyxPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLG1CQUFtQixDQUFDLFFBQWdCLEVBQUUsRUFBRSxhQUFxQixDQUFDO1FBQ2xFLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDaEUsQ0FBQztDQUNGO0FBeExELHdDQXdMQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcQWRhcHRpdmVfVGVzdGluZ1xcc3JjXFxzZXJ2aWNlc1xccHJvZHVjdC1jYXRhbG9nXFxzZXJ2aWNlc1xccHJvZHVjdC5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVEREIEltcGxlbWVudGF0aW9uOiBQcm9kdWN0IFNlcnZpY2VcbiAqXG4gKiBCdXNpbmVzcyBsb2dpYyBsYXllciBmb3IgcHJvZHVjdCBtYW5hZ2VtZW50XG4gKiBJbXBsZW1lbnRzIGFsbCBmdW5jdGlvbmFsaXR5IHRvIHBhc3MgdGVzdHMgaW4gcHJvZHVjdC5zZXJ2aWNlLnNwZWMudHNcbiAqL1xuXG5pbXBvcnQgeyBQcm9kdWN0UmVwb3NpdG9yeSwgU2VhcmNoUHJvZHVjdHNPcHRpb25zLCBTZWFyY2hQcm9kdWN0c1Jlc3VsdCB9IGZyb20gJy4uL3JlcG9zaXRvcmllcy9wcm9kdWN0LnJlcG9zaXRvcnknO1xuaW1wb3J0IHsgUHJvZHVjdCwgUHJvZHVjdFN0YXR1cyB9IGZyb20gJy4uL2VudGl0aWVzL3Byb2R1Y3QuZW50aXR5JztcbmltcG9ydCB7IEJhZFJlcXVlc3RFcnJvciB9IGZyb20gJ0BsaWJzL2Vycm9ycyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ3JlYXRlUHJvZHVjdER0byB7XG4gIG5hbWU6IHN0cmluZztcbiAgZGVzY3JpcHRpb246IHN0cmluZztcbiAgc2t1OiBzdHJpbmc7XG4gIHByaWNlOiBudW1iZXI7XG4gIGNvbXBhcmVBdFByaWNlPzogbnVtYmVyO1xuICBpbnZlbnRvcnk6IG51bWJlcjtcbiAgY2F0ZWdvcnlJZD86IHN0cmluZztcbiAgaW1hZ2VzPzogc3RyaW5nW107XG4gIG1ldGFkYXRhPzogUmVjb3JkPHN0cmluZywgdW5rbm93bj47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVXBkYXRlUHJvZHVjdER0byB7XG4gIG5hbWU/OiBzdHJpbmc7XG4gIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICBwcmljZT86IG51bWJlcjtcbiAgY29tcGFyZUF0UHJpY2U/OiBudW1iZXI7XG4gIGNhdGVnb3J5SWQ/OiBzdHJpbmc7XG4gIGltYWdlcz86IHN0cmluZ1tdO1xuICBtZXRhZGF0YT86IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xufVxuXG5leHBvcnQgY2xhc3MgUHJvZHVjdFNlcnZpY2Uge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHByb2R1Y3RSZXBvc2l0b3J5OiBQcm9kdWN0UmVwb3NpdG9yeSkge31cblxuICAvKipcbiAgICogQ3JlYXRlIG5ldyBwcm9kdWN0IHdpdGggdmFsaWRhdGlvblxuICAgKi9cbiAgYXN5bmMgY3JlYXRlUHJvZHVjdChkYXRhOiBDcmVhdGVQcm9kdWN0RHRvKTogUHJvbWlzZTxQcm9kdWN0PiB7XG4gICAgLy8gVmFsaWRhdGUgcHJpY2VcbiAgICBpZiAoZGF0YS5wcmljZSA8PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEVycm9yKCdQcmljZSBtdXN0IGJlIHBvc2l0aXZlJyk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgaW52ZW50b3J5XG4gICAgaWYgKGRhdGEuaW52ZW50b3J5IDwgMCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFcnJvcignSW52ZW50b3J5IGNhbm5vdCBiZSBuZWdhdGl2ZScpO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIGNvbXBhcmVBdFByaWNlIGlmIHByb3ZpZGVkXG4gICAgaWYgKGRhdGEuY29tcGFyZUF0UHJpY2UgIT09IHVuZGVmaW5lZCkge1xuICAgICAgaWYgKGRhdGEuY29tcGFyZUF0UHJpY2UgPD0gZGF0YS5wcmljZSkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEVycm9yKCdDb21wYXJlIGF0IHByaWNlIG11c3QgYmUgaGlnaGVyIHRoYW4gcHJpY2UnKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcm9kdWN0UmVwb3NpdG9yeS5jcmVhdGVQcm9kdWN0KGRhdGEpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBwcm9kdWN0IGJ5IElEXG4gICAqL1xuICBhc3luYyBnZXRQcm9kdWN0QnlJZChwcm9kdWN0SWQ6IHN0cmluZyk6IFByb21pc2U8UHJvZHVjdD4ge1xuICAgIHJldHVybiB0aGlzLnByb2R1Y3RSZXBvc2l0b3J5LmZpbmRCeUlkKHByb2R1Y3RJZCk7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIHByb2R1Y3RcbiAgICovXG4gIGFzeW5jIHVwZGF0ZVByb2R1Y3QocHJvZHVjdElkOiBzdHJpbmcsIGRhdGE6IFVwZGF0ZVByb2R1Y3REdG8pOiBQcm9taXNlPFByb2R1Y3Q+IHtcbiAgICAvLyBWYWxpZGF0ZSBwcmljZSBpZiBiZWluZyB1cGRhdGVkXG4gICAgaWYgKGRhdGEucHJpY2UgIT09IHVuZGVmaW5lZCAmJiBkYXRhLnByaWNlIDw9IDApIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXJyb3IoJ1ByaWNlIG11c3QgYmUgcG9zaXRpdmUnKTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSBjb21wYXJlQXRQcmljZSBpZiBiZWluZyB1cGRhdGVkXG4gICAgaWYgKGRhdGEuY29tcGFyZUF0UHJpY2UgIT09IHVuZGVmaW5lZCAmJiBkYXRhLnByaWNlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGlmIChkYXRhLmNvbXBhcmVBdFByaWNlIDw9IGRhdGEucHJpY2UpIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFcnJvcignQ29tcGFyZSBhdCBwcmljZSBtdXN0IGJlIGhpZ2hlciB0aGFuIHByaWNlJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucHJvZHVjdFJlcG9zaXRvcnkudXBkYXRlKHByb2R1Y3RJZCwgZGF0YSk7XG4gIH1cblxuICAvKipcbiAgICogRGVsZXRlIHByb2R1Y3RcbiAgICovXG4gIGFzeW5jIGRlbGV0ZVByb2R1Y3QocHJvZHVjdElkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLnByb2R1Y3RSZXBvc2l0b3J5LmRlbGV0ZShwcm9kdWN0SWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIFB1Ymxpc2ggcHJvZHVjdCAobWFrZSBpdCBhY3RpdmUpXG4gICAqL1xuICBhc3luYyBwdWJsaXNoUHJvZHVjdChwcm9kdWN0SWQ6IHN0cmluZyk6IFByb21pc2U8UHJvZHVjdD4ge1xuICAgIHJldHVybiB0aGlzLnByb2R1Y3RSZXBvc2l0b3J5LnVwZGF0ZShwcm9kdWN0SWQsIHtcbiAgICAgIHN0YXR1czogUHJvZHVjdFN0YXR1cy5BQ1RJVkUsXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogVW5wdWJsaXNoIHByb2R1Y3QgKG1ha2UgaXQgZHJhZnQpXG4gICAqL1xuICBhc3luYyB1bnB1Ymxpc2hQcm9kdWN0KHByb2R1Y3RJZDogc3RyaW5nKTogUHJvbWlzZTxQcm9kdWN0PiB7XG4gICAgcmV0dXJuIHRoaXMucHJvZHVjdFJlcG9zaXRvcnkudXBkYXRlKHByb2R1Y3RJZCwge1xuICAgICAgc3RhdHVzOiBQcm9kdWN0U3RhdHVzLkRSQUZULFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSBpbnZlbnRvcnlcbiAgICovXG4gIGFzeW5jIHVwZGF0ZUludmVudG9yeShwcm9kdWN0SWQ6IHN0cmluZywgaW52ZW50b3J5OiBudW1iZXIpOiBQcm9taXNlPFByb2R1Y3Q+IHtcbiAgICBpZiAoaW52ZW50b3J5IDwgMCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFcnJvcignSW52ZW50b3J5IGNhbm5vdCBiZSBuZWdhdGl2ZScpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnByb2R1Y3RSZXBvc2l0b3J5LnVwZGF0ZUludmVudG9yeShwcm9kdWN0SWQsIGludmVudG9yeSk7XG4gIH1cblxuICAvKipcbiAgICogUmVzZXJ2ZSBpbnZlbnRvcnkgZm9yIHB1cmNoYXNlXG4gICAqL1xuICBhc3luYyByZXNlcnZlSW52ZW50b3J5KHByb2R1Y3RJZDogc3RyaW5nLCBxdWFudGl0eTogbnVtYmVyKTogUHJvbWlzZTxQcm9kdWN0PiB7XG4gICAgaWYgKHF1YW50aXR5IDw9IDApIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXJyb3IoJ1F1YW50aXR5IG11c3QgYmUgcG9zaXRpdmUnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcm9kdWN0UmVwb3NpdG9yeS5kZWNyZW1lbnRJbnZlbnRvcnkocHJvZHVjdElkLCBxdWFudGl0eSk7XG4gIH1cblxuICAvKipcbiAgICogUmVzdG9jayBpbnZlbnRvcnlcbiAgICovXG4gIGFzeW5jIHJlc3RvY2tJbnZlbnRvcnkocHJvZHVjdElkOiBzdHJpbmcsIHF1YW50aXR5OiBudW1iZXIpOiBQcm9taXNlPFByb2R1Y3Q+IHtcbiAgICBpZiAocXVhbnRpdHkgPD0gMCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFcnJvcignUXVhbnRpdHkgbXVzdCBiZSBwb3NpdGl2ZScpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnByb2R1Y3RSZXBvc2l0b3J5LmluY3JlbWVudEludmVudG9yeShwcm9kdWN0SWQsIHF1YW50aXR5KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgcHJvZHVjdHMgd2l0aCBsb3cgc3RvY2tcbiAgICovXG4gIGFzeW5jIGdldExvd1N0b2NrUHJvZHVjdHModGhyZXNob2xkOiBudW1iZXIgPSAxMCk6IFByb21pc2U8UHJvZHVjdFtdPiB7XG4gICAgcmV0dXJuIHRoaXMucHJvZHVjdFJlcG9zaXRvcnkuZmluZExvd1N0b2NrKHRocmVzaG9sZCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHByb2R1Y3RzIG9uIHNhbGVcbiAgICovXG4gIGFzeW5jIGdldFByb2R1Y3RzT25TYWxlKCk6IFByb21pc2U8UHJvZHVjdFtdPiB7XG4gICAgcmV0dXJuIHRoaXMucHJvZHVjdFJlcG9zaXRvcnkuZmluZE9uU2FsZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlYXJjaCBwcm9kdWN0cyB3aXRoIGZpbHRlcnNcbiAgICovXG4gIGFzeW5jIHNlYXJjaFByb2R1Y3RzKFxuICAgIHF1ZXJ5OiBzdHJpbmcsXG4gICAgb3B0aW9uczogU2VhcmNoUHJvZHVjdHNPcHRpb25zXG4gICk6IFByb21pc2U8U2VhcmNoUHJvZHVjdHNSZXN1bHQ+IHtcbiAgICByZXR1cm4gdGhpcy5wcm9kdWN0UmVwb3NpdG9yeS5zZWFyY2hQcm9kdWN0cyhxdWVyeSwgb3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogUmVjb3JkIGEgc2FsZSAoZGVjcmVtZW50IGludmVudG9yeSBhbmQgaW5jcmVtZW50IHNvbGQgY291bnQpXG4gICAqL1xuICBhc3luYyByZWNvcmRTYWxlKHByb2R1Y3RJZDogc3RyaW5nLCBxdWFudGl0eTogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5wcm9kdWN0UmVwb3NpdG9yeS5kZWNyZW1lbnRJbnZlbnRvcnkocHJvZHVjdElkLCBxdWFudGl0eSk7XG4gICAgYXdhaXQgdGhpcy5wcm9kdWN0UmVwb3NpdG9yeS5pbmNyZW1lbnRTb2xkQ291bnQocHJvZHVjdElkLCBxdWFudGl0eSk7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIHByb2R1Y3QgcmF0aW5nXG4gICAqL1xuICBhc3luYyB1cGRhdGVQcm9kdWN0UmF0aW5nKFxuICAgIHByb2R1Y3RJZDogc3RyaW5nLFxuICAgIG5ld1JhdGluZzogbnVtYmVyLFxuICAgIHJldmlld0NvdW50OiBudW1iZXJcbiAgKTogUHJvbWlzZTxQcm9kdWN0PiB7XG4gICAgLy8gVmFsaWRhdGUgcmF0aW5nXG4gICAgaWYgKG5ld1JhdGluZyA8IDEgfHwgbmV3UmF0aW5nID4gNSkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFcnJvcignUmF0aW5nIG11c3QgYmUgYmV0d2VlbiAxIGFuZCA1Jyk7XG4gICAgfVxuXG4gICAgLy8gR2V0IGN1cnJlbnQgcHJvZHVjdCB0byBjYWxjdWxhdGUgbmV3IGF2ZXJhZ2VcbiAgICBjb25zdCBwcm9kdWN0ID0gYXdhaXQgdGhpcy5wcm9kdWN0UmVwb3NpdG9yeS5maW5kQnlJZChwcm9kdWN0SWQpO1xuXG4gICAgLy8gQ2FsY3VsYXRlIG5ldyBhdmVyYWdlIHJhdGluZ1xuICAgIGNvbnN0IHRvdGFsUmF0aW5nID0gcHJvZHVjdC5yYXRpbmcgKiBwcm9kdWN0LnJldmlld0NvdW50ICsgbmV3UmF0aW5nICogcmV2aWV3Q291bnQ7XG4gICAgY29uc3QgdG90YWxSZXZpZXdzID0gcHJvZHVjdC5yZXZpZXdDb3VudCArIHJldmlld0NvdW50O1xuICAgIGNvbnN0IG5ld0F2ZXJhZ2VSYXRpbmcgPSB0b3RhbFJhdGluZyAvIHRvdGFsUmV2aWV3cztcblxuICAgIHJldHVybiB0aGlzLnByb2R1Y3RSZXBvc2l0b3J5LnVwZGF0ZVJhdGluZyhcbiAgICAgIHByb2R1Y3RJZCxcbiAgICAgIE1hdGgucm91bmQobmV3QXZlcmFnZVJhdGluZyAqIDEwKSAvIDEwLCAvLyBSb3VuZCB0byAxIGRlY2ltYWxcbiAgICAgIHRvdGFsUmV2aWV3c1xuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRvcCBzZWxsaW5nIHByb2R1Y3RzXG4gICAqL1xuICBhc3luYyBnZXRUb3BTZWxsaW5nUHJvZHVjdHMobGltaXQ6IG51bWJlciA9IDEwKTogUHJvbWlzZTxQcm9kdWN0W10+IHtcbiAgICByZXR1cm4gdGhpcy5wcm9kdWN0UmVwb3NpdG9yeS5maW5kVG9wU2VsbGluZyhsaW1pdCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRvcCByYXRlZCBwcm9kdWN0c1xuICAgKi9cbiAgYXN5bmMgZ2V0VG9wUmF0ZWRQcm9kdWN0cyhsaW1pdDogbnVtYmVyID0gMTAsIG1pblJldmlld3M6IG51bWJlciA9IDUpOiBQcm9taXNlPFByb2R1Y3RbXT4ge1xuICAgIHJldHVybiB0aGlzLnByb2R1Y3RSZXBvc2l0b3J5LmZpbmRUb3BSYXRlZChsaW1pdCwgbWluUmV2aWV3cyk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==