6bf8e9850365ef7f1d8ea34ecfeeea3f
"use strict";
/**
 * Express Application Setup
 *
 * Main application configuration for E2E and integration testing
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.createApp = createApp;
const express_1 = __importDefault(require("express"));
const cors_1 = __importDefault(require("cors"));
const helmet_1 = __importDefault(require("helmet"));
const compression_1 = __importDefault(require("compression"));
const errors_1 = require("./libs/errors");
/**
 * Create and configure Express application
 */
async function createApp() {
    const app = (0, express_1.default)();
    // Security middleware
    app.use((0, helmet_1.default)());
    app.use((0, cors_1.default)({
        origin: process.env.CORS_ORIGIN || '*',
        credentials: true,
    }));
    // Body parsing middleware
    app.use(express_1.default.json({ limit: '10mb' }));
    app.use(express_1.default.urlencoded({ extended: true, limit: '10mb' }));
    // Compression middleware
    app.use((0, compression_1.default)());
    // Health check endpoint
    app.get('/health', (_req, res) => {
        res.json({ status: 'ok', timestamp: new Date().toISOString() });
    });
    // API routes would be mounted here
    // In a full implementation, these would import actual route handlers
    // For testing purposes, we'll set up mock endpoints
    // User routes
    setupUserRoutes(app);
    // Product routes
    setupProductRoutes(app);
    // Order routes
    setupOrderRoutes(app);
    // Cart routes
    setupCartRoutes(app);
    // Notification routes
    setupNotificationRoutes(app);
    // Analytics routes (admin only)
    setupAnalyticsRoutes(app);
    // GraphQL endpoint
    setupGraphQL(app);
    // Error handling middleware (must be last)
    app.use((err, _req, res, _next) => {
        if (err instanceof errors_1.BaseError) {
            res.status(err.statusCode).json({
                error: err.message,
                statusCode: err.statusCode,
                timestamp: err.timestamp,
            });
            return;
        }
        // Unknown error
        console.error('Unexpected error:', err);
        res.status(500).json({
            error: 'Internal server error',
            statusCode: 500,
        });
    });
    // 404 handler
    app.use((req, res) => {
        res.status(404).json({
            error: 'Not found',
            statusCode: 404,
            path: req.path,
        });
    });
    return app;
}
/**
 * Setup user-related routes
 */
function setupUserRoutes(app) {
    app.post('/api/users/register', mockHandler);
    app.post('/api/users/login', mockHandler);
    app.get('/api/users/profile', mockHandler);
    app.put('/api/users/profile', mockHandler);
    app.post('/api/users/verify-email', mockHandler);
    app.post('/api/users/forgot-password', mockHandler);
    app.post('/api/users/reset-password', mockHandler);
    app.post('/api/users/change-password', mockHandler);
    app.get('/api/users', mockHandler); // Admin only
    app.get('/api/users/:id', mockHandler); // Admin only
    app.put('/api/users/:id', mockHandler); // Admin only
    app.delete('/api/users/:id', mockHandler); // Admin only
}
/**
 * Setup product-related routes
 */
function setupProductRoutes(app) {
    app.get('/api/products', mockHandler);
    app.get('/api/products/search', mockHandler);
    app.get('/api/products/featured', mockHandler);
    app.get('/api/products/top-selling', mockHandler);
    app.get('/api/products/top-rated', mockHandler);
    app.get('/api/products/on-sale', mockHandler);
    app.get('/api/products/low-stock', mockHandler); // Admin only
    app.get('/api/products/:id', mockHandler);
    app.get('/api/products/:id/related', mockHandler);
    app.get('/api/products/:id/reviews', mockHandler);
    app.post('/api/products/:id/reviews', mockHandler);
    app.post('/api/products/:id/images', mockHandler); // Admin only
    app.get('/api/products/:id/variants', mockHandler);
    app.post('/api/products', mockHandler); // Admin only
    app.put('/api/products/:id', mockHandler); // Admin only
    app.delete('/api/products/:id', mockHandler); // Admin only
}
/**
 * Setup order-related routes
 */
function setupOrderRoutes(app) {
    app.post('/api/orders', mockHandler);
    app.get('/api/orders', mockHandler);
    app.get('/api/orders/stats', mockHandler); // Admin only
    app.get('/api/orders/recent', mockHandler); // Admin only
    app.get('/api/orders/export', mockHandler); // Admin only
    app.post('/api/orders/bulk-update', mockHandler); // Admin only
    app.get('/api/orders/:id', mockHandler);
    app.post('/api/orders/:id/cancel', mockHandler);
    app.post('/api/orders/:id/payment', mockHandler);
    app.post('/api/orders/:id/shipping', mockHandler); // Admin only
    app.post('/api/orders/:id/ship', mockHandler); // Admin only
    app.post('/api/orders/:id/delivered', mockHandler); // Admin only
    app.post('/api/orders/:id/refund', mockHandler); // Admin only
    app.get('/api/orders/:id/history', mockHandler);
    app.get('/api/orders/:id/tracking', mockHandler);
    app.post('/api/orders/:id/notes', mockHandler);
    app.get('/api/orders/:id/notes', mockHandler);
}
/**
 * Setup cart-related routes
 */
function setupCartRoutes(app) {
    app.get('/api/cart', mockHandler);
    app.post('/api/cart/items', mockHandler);
    app.put('/api/cart/items/:productId', mockHandler);
    app.delete('/api/cart/items/:productId', mockHandler);
    app.delete('/api/cart', mockHandler);
    app.post('/api/cart/apply-discount', mockHandler);
}
/**
 * Setup notification-related routes
 */
function setupNotificationRoutes(app) {
    app.post('/api/notifications/subscribe', mockHandler);
    app.get('/api/notifications/preferences', mockHandler);
    app.put('/api/notifications/preferences', mockHandler);
}
/**
 * Setup analytics routes
 */
function setupAnalyticsRoutes(app) {
    app.get('/api/analytics/dashboard', mockHandler); // Admin only
    app.get('/api/analytics/sales', mockHandler); // Admin only
    app.get('/api/analytics/users', mockHandler); // Admin only
    app.get('/api/analytics/products', mockHandler); // Admin only
}
/**
 * Setup GraphQL endpoint
 */
function setupGraphQL(app) {
    app.post('/graphql', mockGraphQLHandler);
    app.get('/graphql', mockGraphQLHandler);
}
/**
 * Mock request handler for testing
 * In production, this would be replaced with actual route handlers
 */
function mockHandler(req, res, _next) {
    // For testing, return appropriate mock responses based on the route
    const method = req.method;
    const path = req.path;
    // Extract auth token if present
    const authHeader = req.headers.authorization;
    const hasAuth = !!authHeader;
    // Check for admin role (simplified)
    const isAdmin = authHeader?.includes('admin');
    // Handle different routes
    if (path === '/api/users/register' && method === 'POST') {
        return res.status(201).json({
            user: {
                id: 'user-' + Date.now(),
                email: req.body.email,
                firstName: req.body.firstName,
                lastName: req.body.lastName,
                emailVerificationToken: 'mock-token',
                status: 'pending',
            },
        });
    }
    if (path === '/api/users/login' && method === 'POST') {
        return res.json({
            user: {
                id: 'user-123',
                email: req.body.email,
            },
            token: 'mock-jwt-token',
        });
    }
    if (path === '/api/users/profile' && method === 'GET') {
        if (!hasAuth)
            return res.status(401).json({ error: 'Unauthorized' });
        return res.json({
            id: 'user-123',
            email: 'test@test.com',
            firstName: 'Test',
            lastName: 'User',
            role: 'customer',
        });
    }
    if (path === '/api/products' && method === 'GET') {
        return res.json({
            items: [
                { id: 'prod-1', name: 'Product 1', price: 99.99, inventory: 10 },
                { id: 'prod-2', name: 'Product 2', price: 149.99, inventory: 5 },
            ],
            total: 2,
            page: 1,
            limit: 10,
        });
    }
    if (path.startsWith('/api/products/') && method === 'GET') {
        const productId = path.split('/')[3];
        return res.json({
            id: productId,
            name: 'Test Product',
            price: 99.99,
            inventory: 10,
            rating: 4.5,
            reviewCount: 100,
        });
    }
    if (path === '/api/cart' && method === 'GET') {
        if (!hasAuth)
            return res.status(401).json({ error: 'Unauthorized' });
        return res.json({
            items: [],
            subtotal: 0,
            total: 0,
        });
    }
    if (path === '/api/orders' && method === 'POST') {
        if (!hasAuth)
            return res.status(401).json({ error: 'Unauthorized' });
        return res.status(201).json({
            id: 'order-' + Date.now(),
            orderNumber: 'ORD-' + Date.now(),
            status: 'pending',
            items: [],
            total: 0,
        });
    }
    // Admin-only routes
    if (path === '/api/users' && method === 'GET') {
        if (!isAdmin)
            return res.status(403).json({ error: 'Forbidden - admin access required' });
        return res.json({
            users: [],
            total: 0,
            page: 1,
            limit: 10,
        });
    }
    // Default response
    return res.json({
        success: true,
        message: 'Mock endpoint',
        method,
        path,
    });
}
/**
 * Mock GraphQL handler
 */
function mockGraphQLHandler(req, res) {
    const query = req.body?.query || '';
    // Simple GraphQL response mocking
    if (query.includes('products')) {
        return res.json({
            data: {
                products: {
                    items: [
                        { id: 'prod-1', name: 'Product 1', price: 99.99 },
                    ],
                    total: 1,
                },
            },
        });
    }
    if (query.includes('me')) {
        const authHeader = req.headers.authorization;
        if (!authHeader) {
            return res.json({
                errors: [{ message: 'Authentication required' }],
            });
        }
        return res.json({
            data: {
                me: {
                    id: 'user-123',
                    email: 'test@test.com',
                    firstName: 'Test',
                    lastName: 'User',
                },
            },
        });
    }
    return res.json({
        data: {},
    });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXEFkYXB0aXZlX1Rlc3RpbmdcXHNyY1xcYXBwLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHOzs7OztBQVdILDhCQTRFQztBQXJGRCxzREFBNEU7QUFDNUUsZ0RBQXdCO0FBQ3hCLG9EQUE0QjtBQUM1Qiw4REFBc0M7QUFDdEMsMENBQTBDO0FBRTFDOztHQUVHO0FBQ0ksS0FBSyxVQUFVLFNBQVM7SUFDN0IsTUFBTSxHQUFHLEdBQUcsSUFBQSxpQkFBTyxHQUFFLENBQUM7SUFFdEIsc0JBQXNCO0lBQ3RCLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBQSxnQkFBTSxHQUFFLENBQUMsQ0FBQztJQUNsQixHQUFHLENBQUMsR0FBRyxDQUFDLElBQUEsY0FBSSxFQUFDO1FBQ1gsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxJQUFJLEdBQUc7UUFDdEMsV0FBVyxFQUFFLElBQUk7S0FDbEIsQ0FBQyxDQUFDLENBQUM7SUFFSiwwQkFBMEI7SUFDMUIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxpQkFBTyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDekMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxpQkFBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQztJQUUvRCx5QkFBeUI7SUFDekIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFBLHFCQUFXLEdBQUUsQ0FBQyxDQUFDO0lBRXZCLHdCQUF3QjtJQUN4QixHQUFHLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxDQUFDLElBQWEsRUFBRSxHQUFhLEVBQUUsRUFBRTtRQUNsRCxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDbEUsQ0FBQyxDQUFDLENBQUM7SUFFSCxtQ0FBbUM7SUFDbkMscUVBQXFFO0lBQ3JFLG9EQUFvRDtJQUVwRCxjQUFjO0lBQ2QsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBRXJCLGlCQUFpQjtJQUNqQixrQkFBa0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUV4QixlQUFlO0lBQ2YsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFdEIsY0FBYztJQUNkLGVBQWUsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUVyQixzQkFBc0I7SUFDdEIsdUJBQXVCLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFN0IsZ0NBQWdDO0lBQ2hDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBRTFCLG1CQUFtQjtJQUNuQixZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFbEIsMkNBQTJDO0lBQzNDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFVLEVBQUUsSUFBYSxFQUFFLEdBQWEsRUFBRSxLQUFtQixFQUFFLEVBQUU7UUFDeEUsSUFBSSxHQUFHLFlBQVksa0JBQVMsRUFBRSxDQUFDO1lBQzdCLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDOUIsS0FBSyxFQUFFLEdBQUcsQ0FBQyxPQUFPO2dCQUNsQixVQUFVLEVBQUUsR0FBRyxDQUFDLFVBQVU7Z0JBQzFCLFNBQVMsRUFBRSxHQUFHLENBQUMsU0FBUzthQUN6QixDQUFDLENBQUM7WUFDSCxPQUFPO1FBQ1QsQ0FBQztRQUVELGdCQUFnQjtRQUNoQixPQUFPLENBQUMsS0FBSyxDQUFDLG1CQUFtQixFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3hDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ25CLEtBQUssRUFBRSx1QkFBdUI7WUFDOUIsVUFBVSxFQUFFLEdBQUc7U0FDaEIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxjQUFjO0lBQ2QsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQVksRUFBRSxHQUFhLEVBQUUsRUFBRTtRQUN0QyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNuQixLQUFLLEVBQUUsV0FBVztZQUNsQixVQUFVLEVBQUUsR0FBRztZQUNmLElBQUksRUFBRSxHQUFHLENBQUMsSUFBSTtTQUNmLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsT0FBTyxHQUFHLENBQUM7QUFDYixDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFTLGVBQWUsQ0FBQyxHQUFZO0lBQ25DLEdBQUcsQ0FBQyxJQUFJLENBQUMscUJBQXFCLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDN0MsR0FBRyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUMxQyxHQUFHLENBQUMsR0FBRyxDQUFDLG9CQUFvQixFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQzNDLEdBQUcsQ0FBQyxHQUFHLENBQUMsb0JBQW9CLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDM0MsR0FBRyxDQUFDLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUNqRCxHQUFHLENBQUMsSUFBSSxDQUFDLDRCQUE0QixFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ3BELEdBQUcsQ0FBQyxJQUFJLENBQUMsMkJBQTJCLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDbkQsR0FBRyxDQUFDLElBQUksQ0FBQyw0QkFBNEIsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUNwRCxHQUFHLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDLGFBQWE7SUFDakQsR0FBRyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDLGFBQWE7SUFDckQsR0FBRyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDLGFBQWE7SUFDckQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDLGFBQWE7QUFDMUQsQ0FBQztBQUVEOztHQUVHO0FBQ0gsU0FBUyxrQkFBa0IsQ0FBQyxHQUFZO0lBQ3RDLEdBQUcsQ0FBQyxHQUFHLENBQUMsZUFBZSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ3RDLEdBQUcsQ0FBQyxHQUFHLENBQUMsc0JBQXNCLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDN0MsR0FBRyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUMvQyxHQUFHLENBQUMsR0FBRyxDQUFDLDJCQUEyQixFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ2xELEdBQUcsQ0FBQyxHQUFHLENBQUMseUJBQXlCLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDaEQsR0FBRyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUM5QyxHQUFHLENBQUMsR0FBRyxDQUFDLHlCQUF5QixFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUMsYUFBYTtJQUM5RCxHQUFHLENBQUMsR0FBRyxDQUFDLG1CQUFtQixFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQzFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsMkJBQTJCLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDbEQsR0FBRyxDQUFDLEdBQUcsQ0FBQywyQkFBMkIsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUNsRCxHQUFHLENBQUMsSUFBSSxDQUFDLDJCQUEyQixFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ25ELEdBQUcsQ0FBQyxJQUFJLENBQUMsMEJBQTBCLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQyxhQUFhO0lBQ2hFLEdBQUcsQ0FBQyxHQUFHLENBQUMsNEJBQTRCLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDbkQsR0FBRyxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQyxhQUFhO0lBQ3JELEdBQUcsQ0FBQyxHQUFHLENBQUMsbUJBQW1CLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQyxhQUFhO0lBQ3hELEdBQUcsQ0FBQyxNQUFNLENBQUMsbUJBQW1CLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQyxhQUFhO0FBQzdELENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsZ0JBQWdCLENBQUMsR0FBWTtJQUNwQyxHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUNyQyxHQUFHLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUNwQyxHQUFHLENBQUMsR0FBRyxDQUFDLG1CQUFtQixFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUMsYUFBYTtJQUN4RCxHQUFHLENBQUMsR0FBRyxDQUFDLG9CQUFvQixFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUMsYUFBYTtJQUN6RCxHQUFHLENBQUMsR0FBRyxDQUFDLG9CQUFvQixFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUMsYUFBYTtJQUN6RCxHQUFHLENBQUMsSUFBSSxDQUFDLHlCQUF5QixFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUMsYUFBYTtJQUMvRCxHQUFHLENBQUMsR0FBRyxDQUFDLGlCQUFpQixFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ3hDLEdBQUcsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDaEQsR0FBRyxDQUFDLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUNqRCxHQUFHLENBQUMsSUFBSSxDQUFDLDBCQUEwQixFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUMsYUFBYTtJQUNoRSxHQUFHLENBQUMsSUFBSSxDQUFDLHNCQUFzQixFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUMsYUFBYTtJQUM1RCxHQUFHLENBQUMsSUFBSSxDQUFDLDJCQUEyQixFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUMsYUFBYTtJQUNqRSxHQUFHLENBQUMsSUFBSSxDQUFDLHdCQUF3QixFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUMsYUFBYTtJQUM5RCxHQUFHLENBQUMsR0FBRyxDQUFDLHlCQUF5QixFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ2hELEdBQUcsQ0FBQyxHQUFHLENBQUMsMEJBQTBCLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDakQsR0FBRyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUMvQyxHQUFHLENBQUMsR0FBRyxDQUFDLHVCQUF1QixFQUFFLFdBQVcsQ0FBQyxDQUFDO0FBQ2hELENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsZUFBZSxDQUFDLEdBQVk7SUFDbkMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDbEMsR0FBRyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUN6QyxHQUFHLENBQUMsR0FBRyxDQUFDLDRCQUE0QixFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ25ELEdBQUcsQ0FBQyxNQUFNLENBQUMsNEJBQTRCLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDdEQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDckMsR0FBRyxDQUFDLElBQUksQ0FBQywwQkFBMEIsRUFBRSxXQUFXLENBQUMsQ0FBQztBQUNwRCxDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFTLHVCQUF1QixDQUFDLEdBQVk7SUFDM0MsR0FBRyxDQUFDLElBQUksQ0FBQyw4QkFBOEIsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUN0RCxHQUFHLENBQUMsR0FBRyxDQUFDLGdDQUFnQyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ3ZELEdBQUcsQ0FBQyxHQUFHLENBQUMsZ0NBQWdDLEVBQUUsV0FBVyxDQUFDLENBQUM7QUFDekQsQ0FBQztBQUVEOztHQUVHO0FBQ0gsU0FBUyxvQkFBb0IsQ0FBQyxHQUFZO0lBQ3hDLEdBQUcsQ0FBQyxHQUFHLENBQUMsMEJBQTBCLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQyxhQUFhO0lBQy9ELEdBQUcsQ0FBQyxHQUFHLENBQUMsc0JBQXNCLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQyxhQUFhO0lBQzNELEdBQUcsQ0FBQyxHQUFHLENBQUMsc0JBQXNCLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQyxhQUFhO0lBQzNELEdBQUcsQ0FBQyxHQUFHLENBQUMseUJBQXlCLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQyxhQUFhO0FBQ2hFLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsWUFBWSxDQUFDLEdBQVk7SUFDaEMsR0FBRyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztJQUN6QyxHQUFHLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO0FBQzFDLENBQUM7QUFFRDs7O0dBR0c7QUFDSCxTQUFTLFdBQVcsQ0FBQyxHQUFZLEVBQUUsR0FBYSxFQUFFLEtBQW1CO0lBQ25FLG9FQUFvRTtJQUNwRSxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDO0lBQzFCLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7SUFFdEIsZ0NBQWdDO0lBQ2hDLE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDO0lBQzdDLE1BQU0sT0FBTyxHQUFHLENBQUMsQ0FBQyxVQUFVLENBQUM7SUFFN0Isb0NBQW9DO0lBQ3BDLE1BQU0sT0FBTyxHQUFHLFVBQVUsRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFOUMsMEJBQTBCO0lBQzFCLElBQUksSUFBSSxLQUFLLHFCQUFxQixJQUFJLE1BQU0sS0FBSyxNQUFNLEVBQUUsQ0FBQztRQUN4RCxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzFCLElBQUksRUFBRTtnQkFDSixFQUFFLEVBQUUsT0FBTyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUU7Z0JBQ3hCLEtBQUssRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUs7Z0JBQ3JCLFNBQVMsRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVM7Z0JBQzdCLFFBQVEsRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVE7Z0JBQzNCLHNCQUFzQixFQUFFLFlBQVk7Z0JBQ3BDLE1BQU0sRUFBRSxTQUFTO2FBQ2xCO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELElBQUksSUFBSSxLQUFLLGtCQUFrQixJQUFJLE1BQU0sS0FBSyxNQUFNLEVBQUUsQ0FBQztRQUNyRCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFDZCxJQUFJLEVBQUU7Z0JBQ0osRUFBRSxFQUFFLFVBQVU7Z0JBQ2QsS0FBSyxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSzthQUN0QjtZQUNELEtBQUssRUFBRSxnQkFBZ0I7U0FDeEIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELElBQUksSUFBSSxLQUFLLG9CQUFvQixJQUFJLE1BQU0sS0FBSyxLQUFLLEVBQUUsQ0FBQztRQUN0RCxJQUFJLENBQUMsT0FBTztZQUFFLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsY0FBYyxFQUFFLENBQUMsQ0FBQztRQUNyRSxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFDZCxFQUFFLEVBQUUsVUFBVTtZQUNkLEtBQUssRUFBRSxlQUFlO1lBQ3RCLFNBQVMsRUFBRSxNQUFNO1lBQ2pCLFFBQVEsRUFBRSxNQUFNO1lBQ2hCLElBQUksRUFBRSxVQUFVO1NBQ2pCLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxJQUFJLElBQUksS0FBSyxlQUFlLElBQUksTUFBTSxLQUFLLEtBQUssRUFBRSxDQUFDO1FBQ2pELE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQztZQUNkLEtBQUssRUFBRTtnQkFDTCxFQUFFLEVBQUUsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQUU7Z0JBQ2hFLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLENBQUMsRUFBRTthQUNqRTtZQUNELEtBQUssRUFBRSxDQUFDO1lBQ1IsSUFBSSxFQUFFLENBQUM7WUFDUCxLQUFLLEVBQUUsRUFBRTtTQUNWLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxNQUFNLEtBQUssS0FBSyxFQUFFLENBQUM7UUFDMUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNyQyxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFDZCxFQUFFLEVBQUUsU0FBUztZQUNiLElBQUksRUFBRSxjQUFjO1lBQ3BCLEtBQUssRUFBRSxLQUFLO1lBQ1osU0FBUyxFQUFFLEVBQUU7WUFDYixNQUFNLEVBQUUsR0FBRztZQUNYLFdBQVcsRUFBRSxHQUFHO1NBQ2pCLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxJQUFJLElBQUksS0FBSyxXQUFXLElBQUksTUFBTSxLQUFLLEtBQUssRUFBRSxDQUFDO1FBQzdDLElBQUksQ0FBQyxPQUFPO1lBQUUsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFDO1FBQ3JFLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQztZQUNkLEtBQUssRUFBRSxFQUFFO1lBQ1QsUUFBUSxFQUFFLENBQUM7WUFDWCxLQUFLLEVBQUUsQ0FBQztTQUNULENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxJQUFJLElBQUksS0FBSyxhQUFhLElBQUksTUFBTSxLQUFLLE1BQU0sRUFBRSxDQUFDO1FBQ2hELElBQUksQ0FBQyxPQUFPO1lBQUUsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFDO1FBQ3JFLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDMUIsRUFBRSxFQUFFLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ3pCLFdBQVcsRUFBRSxNQUFNLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUNoQyxNQUFNLEVBQUUsU0FBUztZQUNqQixLQUFLLEVBQUUsRUFBRTtZQUNULEtBQUssRUFBRSxDQUFDO1NBQ1QsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELG9CQUFvQjtJQUNwQixJQUFJLElBQUksS0FBSyxZQUFZLElBQUksTUFBTSxLQUFLLEtBQUssRUFBRSxDQUFDO1FBQzlDLElBQUksQ0FBQyxPQUFPO1lBQUUsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxtQ0FBbUMsRUFBRSxDQUFDLENBQUM7UUFDMUYsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQ2QsS0FBSyxFQUFFLEVBQUU7WUFDVCxLQUFLLEVBQUUsQ0FBQztZQUNSLElBQUksRUFBRSxDQUFDO1lBQ1AsS0FBSyxFQUFFLEVBQUU7U0FDVixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsbUJBQW1CO0lBQ25CLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQztRQUNkLE9BQU8sRUFBRSxJQUFJO1FBQ2IsT0FBTyxFQUFFLGVBQWU7UUFDeEIsTUFBTTtRQUNOLElBQUk7S0FDTCxDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFTLGtCQUFrQixDQUFDLEdBQVksRUFBRSxHQUFhO0lBQ3JELE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxJQUFJLEVBQUUsS0FBSyxJQUFJLEVBQUUsQ0FBQztJQUVwQyxrQ0FBa0M7SUFDbEMsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUM7UUFDL0IsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDO1lBQ2QsSUFBSSxFQUFFO2dCQUNKLFFBQVEsRUFBRTtvQkFDUixLQUFLLEVBQUU7d0JBQ0wsRUFBRSxFQUFFLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRTtxQkFDbEQ7b0JBQ0QsS0FBSyxFQUFFLENBQUM7aUJBQ1Q7YUFDRjtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztRQUN6QixNQUFNLFVBQVUsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQztRQUM3QyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDaEIsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDO2dCQUNkLE1BQU0sRUFBRSxDQUFDLEVBQUUsT0FBTyxFQUFFLHlCQUF5QixFQUFFLENBQUM7YUFDakQsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQztZQUNkLElBQUksRUFBRTtnQkFDSixFQUFFLEVBQUU7b0JBQ0YsRUFBRSxFQUFFLFVBQVU7b0JBQ2QsS0FBSyxFQUFFLGVBQWU7b0JBQ3RCLFNBQVMsRUFBRSxNQUFNO29CQUNqQixRQUFRLEVBQUUsTUFBTTtpQkFDakI7YUFDRjtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFDZCxJQUFJLEVBQUUsRUFBRTtLQUNULENBQUMsQ0FBQztBQUNMLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXEFkYXB0aXZlX1Rlc3RpbmdcXHNyY1xcYXBwLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogRXhwcmVzcyBBcHBsaWNhdGlvbiBTZXR1cFxuICpcbiAqIE1haW4gYXBwbGljYXRpb24gY29uZmlndXJhdGlvbiBmb3IgRTJFIGFuZCBpbnRlZ3JhdGlvbiB0ZXN0aW5nXG4gKi9cblxuaW1wb3J0IGV4cHJlc3MsIHsgRXhwcmVzcywgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IGNvcnMgZnJvbSAnY29ycyc7XG5pbXBvcnQgaGVsbWV0IGZyb20gJ2hlbG1ldCc7XG5pbXBvcnQgY29tcHJlc3Npb24gZnJvbSAnY29tcHJlc3Npb24nO1xuaW1wb3J0IHsgQmFzZUVycm9yIH0gZnJvbSAnLi9saWJzL2Vycm9ycyc7XG5cbi8qKlxuICogQ3JlYXRlIGFuZCBjb25maWd1cmUgRXhwcmVzcyBhcHBsaWNhdGlvblxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlQXBwKCk6IFByb21pc2U8RXhwcmVzcz4ge1xuICBjb25zdCBhcHAgPSBleHByZXNzKCk7XG5cbiAgLy8gU2VjdXJpdHkgbWlkZGxld2FyZVxuICBhcHAudXNlKGhlbG1ldCgpKTtcbiAgYXBwLnVzZShjb3JzKHtcbiAgICBvcmlnaW46IHByb2Nlc3MuZW52LkNPUlNfT1JJR0lOIHx8ICcqJyxcbiAgICBjcmVkZW50aWFsczogdHJ1ZSxcbiAgfSkpO1xuXG4gIC8vIEJvZHkgcGFyc2luZyBtaWRkbGV3YXJlXG4gIGFwcC51c2UoZXhwcmVzcy5qc29uKHsgbGltaXQ6ICcxMG1iJyB9KSk7XG4gIGFwcC51c2UoZXhwcmVzcy51cmxlbmNvZGVkKHsgZXh0ZW5kZWQ6IHRydWUsIGxpbWl0OiAnMTBtYicgfSkpO1xuXG4gIC8vIENvbXByZXNzaW9uIG1pZGRsZXdhcmVcbiAgYXBwLnVzZShjb21wcmVzc2lvbigpKTtcblxuICAvLyBIZWFsdGggY2hlY2sgZW5kcG9pbnRcbiAgYXBwLmdldCgnL2hlYWx0aCcsIChfcmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA9PiB7XG4gICAgcmVzLmpzb24oeyBzdGF0dXM6ICdvaycsIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpIH0pO1xuICB9KTtcblxuICAvLyBBUEkgcm91dGVzIHdvdWxkIGJlIG1vdW50ZWQgaGVyZVxuICAvLyBJbiBhIGZ1bGwgaW1wbGVtZW50YXRpb24sIHRoZXNlIHdvdWxkIGltcG9ydCBhY3R1YWwgcm91dGUgaGFuZGxlcnNcbiAgLy8gRm9yIHRlc3RpbmcgcHVycG9zZXMsIHdlJ2xsIHNldCB1cCBtb2NrIGVuZHBvaW50c1xuXG4gIC8vIFVzZXIgcm91dGVzXG4gIHNldHVwVXNlclJvdXRlcyhhcHApO1xuXG4gIC8vIFByb2R1Y3Qgcm91dGVzXG4gIHNldHVwUHJvZHVjdFJvdXRlcyhhcHApO1xuXG4gIC8vIE9yZGVyIHJvdXRlc1xuICBzZXR1cE9yZGVyUm91dGVzKGFwcCk7XG5cbiAgLy8gQ2FydCByb3V0ZXNcbiAgc2V0dXBDYXJ0Um91dGVzKGFwcCk7XG5cbiAgLy8gTm90aWZpY2F0aW9uIHJvdXRlc1xuICBzZXR1cE5vdGlmaWNhdGlvblJvdXRlcyhhcHApO1xuXG4gIC8vIEFuYWx5dGljcyByb3V0ZXMgKGFkbWluIG9ubHkpXG4gIHNldHVwQW5hbHl0aWNzUm91dGVzKGFwcCk7XG5cbiAgLy8gR3JhcGhRTCBlbmRwb2ludFxuICBzZXR1cEdyYXBoUUwoYXBwKTtcblxuICAvLyBFcnJvciBoYW5kbGluZyBtaWRkbGV3YXJlIChtdXN0IGJlIGxhc3QpXG4gIGFwcC51c2UoKGVycjogRXJyb3IsIF9yZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIF9uZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgICBpZiAoZXJyIGluc3RhbmNlb2YgQmFzZUVycm9yKSB7XG4gICAgICByZXMuc3RhdHVzKGVyci5zdGF0dXNDb2RlKS5qc29uKHtcbiAgICAgICAgZXJyb3I6IGVyci5tZXNzYWdlLFxuICAgICAgICBzdGF0dXNDb2RlOiBlcnIuc3RhdHVzQ29kZSxcbiAgICAgICAgdGltZXN0YW1wOiBlcnIudGltZXN0YW1wLFxuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gVW5rbm93biBlcnJvclxuICAgIGNvbnNvbGUuZXJyb3IoJ1VuZXhwZWN0ZWQgZXJyb3I6JywgZXJyKTtcbiAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgfSk7XG4gIH0pO1xuXG4gIC8vIDQwNCBoYW5kbGVyXG4gIGFwcC51c2UoKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgPT4ge1xuICAgIHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcbiAgICAgIGVycm9yOiAnTm90IGZvdW5kJyxcbiAgICAgIHN0YXR1c0NvZGU6IDQwNCxcbiAgICAgIHBhdGg6IHJlcS5wYXRoLFxuICAgIH0pO1xuICB9KTtcblxuICByZXR1cm4gYXBwO1xufVxuXG4vKipcbiAqIFNldHVwIHVzZXItcmVsYXRlZCByb3V0ZXNcbiAqL1xuZnVuY3Rpb24gc2V0dXBVc2VyUm91dGVzKGFwcDogRXhwcmVzcyk6IHZvaWQge1xuICBhcHAucG9zdCgnL2FwaS91c2Vycy9yZWdpc3RlcicsIG1vY2tIYW5kbGVyKTtcbiAgYXBwLnBvc3QoJy9hcGkvdXNlcnMvbG9naW4nLCBtb2NrSGFuZGxlcik7XG4gIGFwcC5nZXQoJy9hcGkvdXNlcnMvcHJvZmlsZScsIG1vY2tIYW5kbGVyKTtcbiAgYXBwLnB1dCgnL2FwaS91c2Vycy9wcm9maWxlJywgbW9ja0hhbmRsZXIpO1xuICBhcHAucG9zdCgnL2FwaS91c2Vycy92ZXJpZnktZW1haWwnLCBtb2NrSGFuZGxlcik7XG4gIGFwcC5wb3N0KCcvYXBpL3VzZXJzL2ZvcmdvdC1wYXNzd29yZCcsIG1vY2tIYW5kbGVyKTtcbiAgYXBwLnBvc3QoJy9hcGkvdXNlcnMvcmVzZXQtcGFzc3dvcmQnLCBtb2NrSGFuZGxlcik7XG4gIGFwcC5wb3N0KCcvYXBpL3VzZXJzL2NoYW5nZS1wYXNzd29yZCcsIG1vY2tIYW5kbGVyKTtcbiAgYXBwLmdldCgnL2FwaS91c2VycycsIG1vY2tIYW5kbGVyKTsgLy8gQWRtaW4gb25seVxuICBhcHAuZ2V0KCcvYXBpL3VzZXJzLzppZCcsIG1vY2tIYW5kbGVyKTsgLy8gQWRtaW4gb25seVxuICBhcHAucHV0KCcvYXBpL3VzZXJzLzppZCcsIG1vY2tIYW5kbGVyKTsgLy8gQWRtaW4gb25seVxuICBhcHAuZGVsZXRlKCcvYXBpL3VzZXJzLzppZCcsIG1vY2tIYW5kbGVyKTsgLy8gQWRtaW4gb25seVxufVxuXG4vKipcbiAqIFNldHVwIHByb2R1Y3QtcmVsYXRlZCByb3V0ZXNcbiAqL1xuZnVuY3Rpb24gc2V0dXBQcm9kdWN0Um91dGVzKGFwcDogRXhwcmVzcyk6IHZvaWQge1xuICBhcHAuZ2V0KCcvYXBpL3Byb2R1Y3RzJywgbW9ja0hhbmRsZXIpO1xuICBhcHAuZ2V0KCcvYXBpL3Byb2R1Y3RzL3NlYXJjaCcsIG1vY2tIYW5kbGVyKTtcbiAgYXBwLmdldCgnL2FwaS9wcm9kdWN0cy9mZWF0dXJlZCcsIG1vY2tIYW5kbGVyKTtcbiAgYXBwLmdldCgnL2FwaS9wcm9kdWN0cy90b3Atc2VsbGluZycsIG1vY2tIYW5kbGVyKTtcbiAgYXBwLmdldCgnL2FwaS9wcm9kdWN0cy90b3AtcmF0ZWQnLCBtb2NrSGFuZGxlcik7XG4gIGFwcC5nZXQoJy9hcGkvcHJvZHVjdHMvb24tc2FsZScsIG1vY2tIYW5kbGVyKTtcbiAgYXBwLmdldCgnL2FwaS9wcm9kdWN0cy9sb3ctc3RvY2snLCBtb2NrSGFuZGxlcik7IC8vIEFkbWluIG9ubHlcbiAgYXBwLmdldCgnL2FwaS9wcm9kdWN0cy86aWQnLCBtb2NrSGFuZGxlcik7XG4gIGFwcC5nZXQoJy9hcGkvcHJvZHVjdHMvOmlkL3JlbGF0ZWQnLCBtb2NrSGFuZGxlcik7XG4gIGFwcC5nZXQoJy9hcGkvcHJvZHVjdHMvOmlkL3Jldmlld3MnLCBtb2NrSGFuZGxlcik7XG4gIGFwcC5wb3N0KCcvYXBpL3Byb2R1Y3RzLzppZC9yZXZpZXdzJywgbW9ja0hhbmRsZXIpO1xuICBhcHAucG9zdCgnL2FwaS9wcm9kdWN0cy86aWQvaW1hZ2VzJywgbW9ja0hhbmRsZXIpOyAvLyBBZG1pbiBvbmx5XG4gIGFwcC5nZXQoJy9hcGkvcHJvZHVjdHMvOmlkL3ZhcmlhbnRzJywgbW9ja0hhbmRsZXIpO1xuICBhcHAucG9zdCgnL2FwaS9wcm9kdWN0cycsIG1vY2tIYW5kbGVyKTsgLy8gQWRtaW4gb25seVxuICBhcHAucHV0KCcvYXBpL3Byb2R1Y3RzLzppZCcsIG1vY2tIYW5kbGVyKTsgLy8gQWRtaW4gb25seVxuICBhcHAuZGVsZXRlKCcvYXBpL3Byb2R1Y3RzLzppZCcsIG1vY2tIYW5kbGVyKTsgLy8gQWRtaW4gb25seVxufVxuXG4vKipcbiAqIFNldHVwIG9yZGVyLXJlbGF0ZWQgcm91dGVzXG4gKi9cbmZ1bmN0aW9uIHNldHVwT3JkZXJSb3V0ZXMoYXBwOiBFeHByZXNzKTogdm9pZCB7XG4gIGFwcC5wb3N0KCcvYXBpL29yZGVycycsIG1vY2tIYW5kbGVyKTtcbiAgYXBwLmdldCgnL2FwaS9vcmRlcnMnLCBtb2NrSGFuZGxlcik7XG4gIGFwcC5nZXQoJy9hcGkvb3JkZXJzL3N0YXRzJywgbW9ja0hhbmRsZXIpOyAvLyBBZG1pbiBvbmx5XG4gIGFwcC5nZXQoJy9hcGkvb3JkZXJzL3JlY2VudCcsIG1vY2tIYW5kbGVyKTsgLy8gQWRtaW4gb25seVxuICBhcHAuZ2V0KCcvYXBpL29yZGVycy9leHBvcnQnLCBtb2NrSGFuZGxlcik7IC8vIEFkbWluIG9ubHlcbiAgYXBwLnBvc3QoJy9hcGkvb3JkZXJzL2J1bGstdXBkYXRlJywgbW9ja0hhbmRsZXIpOyAvLyBBZG1pbiBvbmx5XG4gIGFwcC5nZXQoJy9hcGkvb3JkZXJzLzppZCcsIG1vY2tIYW5kbGVyKTtcbiAgYXBwLnBvc3QoJy9hcGkvb3JkZXJzLzppZC9jYW5jZWwnLCBtb2NrSGFuZGxlcik7XG4gIGFwcC5wb3N0KCcvYXBpL29yZGVycy86aWQvcGF5bWVudCcsIG1vY2tIYW5kbGVyKTtcbiAgYXBwLnBvc3QoJy9hcGkvb3JkZXJzLzppZC9zaGlwcGluZycsIG1vY2tIYW5kbGVyKTsgLy8gQWRtaW4gb25seVxuICBhcHAucG9zdCgnL2FwaS9vcmRlcnMvOmlkL3NoaXAnLCBtb2NrSGFuZGxlcik7IC8vIEFkbWluIG9ubHlcbiAgYXBwLnBvc3QoJy9hcGkvb3JkZXJzLzppZC9kZWxpdmVyZWQnLCBtb2NrSGFuZGxlcik7IC8vIEFkbWluIG9ubHlcbiAgYXBwLnBvc3QoJy9hcGkvb3JkZXJzLzppZC9yZWZ1bmQnLCBtb2NrSGFuZGxlcik7IC8vIEFkbWluIG9ubHlcbiAgYXBwLmdldCgnL2FwaS9vcmRlcnMvOmlkL2hpc3RvcnknLCBtb2NrSGFuZGxlcik7XG4gIGFwcC5nZXQoJy9hcGkvb3JkZXJzLzppZC90cmFja2luZycsIG1vY2tIYW5kbGVyKTtcbiAgYXBwLnBvc3QoJy9hcGkvb3JkZXJzLzppZC9ub3RlcycsIG1vY2tIYW5kbGVyKTtcbiAgYXBwLmdldCgnL2FwaS9vcmRlcnMvOmlkL25vdGVzJywgbW9ja0hhbmRsZXIpO1xufVxuXG4vKipcbiAqIFNldHVwIGNhcnQtcmVsYXRlZCByb3V0ZXNcbiAqL1xuZnVuY3Rpb24gc2V0dXBDYXJ0Um91dGVzKGFwcDogRXhwcmVzcyk6IHZvaWQge1xuICBhcHAuZ2V0KCcvYXBpL2NhcnQnLCBtb2NrSGFuZGxlcik7XG4gIGFwcC5wb3N0KCcvYXBpL2NhcnQvaXRlbXMnLCBtb2NrSGFuZGxlcik7XG4gIGFwcC5wdXQoJy9hcGkvY2FydC9pdGVtcy86cHJvZHVjdElkJywgbW9ja0hhbmRsZXIpO1xuICBhcHAuZGVsZXRlKCcvYXBpL2NhcnQvaXRlbXMvOnByb2R1Y3RJZCcsIG1vY2tIYW5kbGVyKTtcbiAgYXBwLmRlbGV0ZSgnL2FwaS9jYXJ0JywgbW9ja0hhbmRsZXIpO1xuICBhcHAucG9zdCgnL2FwaS9jYXJ0L2FwcGx5LWRpc2NvdW50JywgbW9ja0hhbmRsZXIpO1xufVxuXG4vKipcbiAqIFNldHVwIG5vdGlmaWNhdGlvbi1yZWxhdGVkIHJvdXRlc1xuICovXG5mdW5jdGlvbiBzZXR1cE5vdGlmaWNhdGlvblJvdXRlcyhhcHA6IEV4cHJlc3MpOiB2b2lkIHtcbiAgYXBwLnBvc3QoJy9hcGkvbm90aWZpY2F0aW9ucy9zdWJzY3JpYmUnLCBtb2NrSGFuZGxlcik7XG4gIGFwcC5nZXQoJy9hcGkvbm90aWZpY2F0aW9ucy9wcmVmZXJlbmNlcycsIG1vY2tIYW5kbGVyKTtcbiAgYXBwLnB1dCgnL2FwaS9ub3RpZmljYXRpb25zL3ByZWZlcmVuY2VzJywgbW9ja0hhbmRsZXIpO1xufVxuXG4vKipcbiAqIFNldHVwIGFuYWx5dGljcyByb3V0ZXNcbiAqL1xuZnVuY3Rpb24gc2V0dXBBbmFseXRpY3NSb3V0ZXMoYXBwOiBFeHByZXNzKTogdm9pZCB7XG4gIGFwcC5nZXQoJy9hcGkvYW5hbHl0aWNzL2Rhc2hib2FyZCcsIG1vY2tIYW5kbGVyKTsgLy8gQWRtaW4gb25seVxuICBhcHAuZ2V0KCcvYXBpL2FuYWx5dGljcy9zYWxlcycsIG1vY2tIYW5kbGVyKTsgLy8gQWRtaW4gb25seVxuICBhcHAuZ2V0KCcvYXBpL2FuYWx5dGljcy91c2VycycsIG1vY2tIYW5kbGVyKTsgLy8gQWRtaW4gb25seVxuICBhcHAuZ2V0KCcvYXBpL2FuYWx5dGljcy9wcm9kdWN0cycsIG1vY2tIYW5kbGVyKTsgLy8gQWRtaW4gb25seVxufVxuXG4vKipcbiAqIFNldHVwIEdyYXBoUUwgZW5kcG9pbnRcbiAqL1xuZnVuY3Rpb24gc2V0dXBHcmFwaFFMKGFwcDogRXhwcmVzcyk6IHZvaWQge1xuICBhcHAucG9zdCgnL2dyYXBocWwnLCBtb2NrR3JhcGhRTEhhbmRsZXIpO1xuICBhcHAuZ2V0KCcvZ3JhcGhxbCcsIG1vY2tHcmFwaFFMSGFuZGxlcik7XG59XG5cbi8qKlxuICogTW9jayByZXF1ZXN0IGhhbmRsZXIgZm9yIHRlc3RpbmdcbiAqIEluIHByb2R1Y3Rpb24sIHRoaXMgd291bGQgYmUgcmVwbGFjZWQgd2l0aCBhY3R1YWwgcm91dGUgaGFuZGxlcnNcbiAqL1xuZnVuY3Rpb24gbW9ja0hhbmRsZXIocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBfbmV4dDogTmV4dEZ1bmN0aW9uKSB7XG4gIC8vIEZvciB0ZXN0aW5nLCByZXR1cm4gYXBwcm9wcmlhdGUgbW9jayByZXNwb25zZXMgYmFzZWQgb24gdGhlIHJvdXRlXG4gIGNvbnN0IG1ldGhvZCA9IHJlcS5tZXRob2Q7XG4gIGNvbnN0IHBhdGggPSByZXEucGF0aDtcblxuICAvLyBFeHRyYWN0IGF1dGggdG9rZW4gaWYgcHJlc2VudFxuICBjb25zdCBhdXRoSGVhZGVyID0gcmVxLmhlYWRlcnMuYXV0aG9yaXphdGlvbjtcbiAgY29uc3QgaGFzQXV0aCA9ICEhYXV0aEhlYWRlcjtcblxuICAvLyBDaGVjayBmb3IgYWRtaW4gcm9sZSAoc2ltcGxpZmllZClcbiAgY29uc3QgaXNBZG1pbiA9IGF1dGhIZWFkZXI/LmluY2x1ZGVzKCdhZG1pbicpO1xuXG4gIC8vIEhhbmRsZSBkaWZmZXJlbnQgcm91dGVzXG4gIGlmIChwYXRoID09PSAnL2FwaS91c2Vycy9yZWdpc3RlcicgJiYgbWV0aG9kID09PSAnUE9TVCcpIHtcbiAgICByZXR1cm4gcmVzLnN0YXR1cygyMDEpLmpzb24oe1xuICAgICAgdXNlcjoge1xuICAgICAgICBpZDogJ3VzZXItJyArIERhdGUubm93KCksXG4gICAgICAgIGVtYWlsOiByZXEuYm9keS5lbWFpbCxcbiAgICAgICAgZmlyc3ROYW1lOiByZXEuYm9keS5maXJzdE5hbWUsXG4gICAgICAgIGxhc3ROYW1lOiByZXEuYm9keS5sYXN0TmFtZSxcbiAgICAgICAgZW1haWxWZXJpZmljYXRpb25Ub2tlbjogJ21vY2stdG9rZW4nLFxuICAgICAgICBzdGF0dXM6ICdwZW5kaW5nJyxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBpZiAocGF0aCA9PT0gJy9hcGkvdXNlcnMvbG9naW4nICYmIG1ldGhvZCA9PT0gJ1BPU1QnKSB7XG4gICAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICAgIHVzZXI6IHtcbiAgICAgICAgaWQ6ICd1c2VyLTEyMycsXG4gICAgICAgIGVtYWlsOiByZXEuYm9keS5lbWFpbCxcbiAgICAgIH0sXG4gICAgICB0b2tlbjogJ21vY2stand0LXRva2VuJyxcbiAgICB9KTtcbiAgfVxuXG4gIGlmIChwYXRoID09PSAnL2FwaS91c2Vycy9wcm9maWxlJyAmJiBtZXRob2QgPT09ICdHRVQnKSB7XG4gICAgaWYgKCFoYXNBdXRoKSByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBlcnJvcjogJ1VuYXV0aG9yaXplZCcgfSk7XG4gICAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICAgIGlkOiAndXNlci0xMjMnLFxuICAgICAgZW1haWw6ICd0ZXN0QHRlc3QuY29tJyxcbiAgICAgIGZpcnN0TmFtZTogJ1Rlc3QnLFxuICAgICAgbGFzdE5hbWU6ICdVc2VyJyxcbiAgICAgIHJvbGU6ICdjdXN0b21lcicsXG4gICAgfSk7XG4gIH1cblxuICBpZiAocGF0aCA9PT0gJy9hcGkvcHJvZHVjdHMnICYmIG1ldGhvZCA9PT0gJ0dFVCcpIHtcbiAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgaXRlbXM6IFtcbiAgICAgICAgeyBpZDogJ3Byb2QtMScsIG5hbWU6ICdQcm9kdWN0IDEnLCBwcmljZTogOTkuOTksIGludmVudG9yeTogMTAgfSxcbiAgICAgICAgeyBpZDogJ3Byb2QtMicsIG5hbWU6ICdQcm9kdWN0IDInLCBwcmljZTogMTQ5Ljk5LCBpbnZlbnRvcnk6IDUgfSxcbiAgICAgIF0sXG4gICAgICB0b3RhbDogMixcbiAgICAgIHBhZ2U6IDEsXG4gICAgICBsaW1pdDogMTAsXG4gICAgfSk7XG4gIH1cblxuICBpZiAocGF0aC5zdGFydHNXaXRoKCcvYXBpL3Byb2R1Y3RzLycpICYmIG1ldGhvZCA9PT0gJ0dFVCcpIHtcbiAgICBjb25zdCBwcm9kdWN0SWQgPSBwYXRoLnNwbGl0KCcvJylbM107XG4gICAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICAgIGlkOiBwcm9kdWN0SWQsXG4gICAgICBuYW1lOiAnVGVzdCBQcm9kdWN0JyxcbiAgICAgIHByaWNlOiA5OS45OSxcbiAgICAgIGludmVudG9yeTogMTAsXG4gICAgICByYXRpbmc6IDQuNSxcbiAgICAgIHJldmlld0NvdW50OiAxMDAsXG4gICAgfSk7XG4gIH1cblxuICBpZiAocGF0aCA9PT0gJy9hcGkvY2FydCcgJiYgbWV0aG9kID09PSAnR0VUJykge1xuICAgIGlmICghaGFzQXV0aCkgcmV0dXJuIHJlcy5zdGF0dXMoNDAxKS5qc29uKHsgZXJyb3I6ICdVbmF1dGhvcml6ZWQnIH0pO1xuICAgIHJldHVybiByZXMuanNvbih7XG4gICAgICBpdGVtczogW10sXG4gICAgICBzdWJ0b3RhbDogMCxcbiAgICAgIHRvdGFsOiAwLFxuICAgIH0pO1xuICB9XG5cbiAgaWYgKHBhdGggPT09ICcvYXBpL29yZGVycycgJiYgbWV0aG9kID09PSAnUE9TVCcpIHtcbiAgICBpZiAoIWhhc0F1dGgpIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7IGVycm9yOiAnVW5hdXRob3JpemVkJyB9KTtcbiAgICByZXR1cm4gcmVzLnN0YXR1cygyMDEpLmpzb24oe1xuICAgICAgaWQ6ICdvcmRlci0nICsgRGF0ZS5ub3coKSxcbiAgICAgIG9yZGVyTnVtYmVyOiAnT1JELScgKyBEYXRlLm5vdygpLFxuICAgICAgc3RhdHVzOiAncGVuZGluZycsXG4gICAgICBpdGVtczogW10sXG4gICAgICB0b3RhbDogMCxcbiAgICB9KTtcbiAgfVxuXG4gIC8vIEFkbWluLW9ubHkgcm91dGVzXG4gIGlmIChwYXRoID09PSAnL2FwaS91c2VycycgJiYgbWV0aG9kID09PSAnR0VUJykge1xuICAgIGlmICghaXNBZG1pbikgcmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHsgZXJyb3I6ICdGb3JiaWRkZW4gLSBhZG1pbiBhY2Nlc3MgcmVxdWlyZWQnIH0pO1xuICAgIHJldHVybiByZXMuanNvbih7XG4gICAgICB1c2VyczogW10sXG4gICAgICB0b3RhbDogMCxcbiAgICAgIHBhZ2U6IDEsXG4gICAgICBsaW1pdDogMTAsXG4gICAgfSk7XG4gIH1cblxuICAvLyBEZWZhdWx0IHJlc3BvbnNlXG4gIHJldHVybiByZXMuanNvbih7XG4gICAgc3VjY2VzczogdHJ1ZSxcbiAgICBtZXNzYWdlOiAnTW9jayBlbmRwb2ludCcsXG4gICAgbWV0aG9kLFxuICAgIHBhdGgsXG4gIH0pO1xufVxuXG4vKipcbiAqIE1vY2sgR3JhcGhRTCBoYW5kbGVyXG4gKi9cbmZ1bmN0aW9uIG1vY2tHcmFwaFFMSGFuZGxlcihyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpIHtcbiAgY29uc3QgcXVlcnkgPSByZXEuYm9keT8ucXVlcnkgfHwgJyc7XG5cbiAgLy8gU2ltcGxlIEdyYXBoUUwgcmVzcG9uc2UgbW9ja2luZ1xuICBpZiAocXVlcnkuaW5jbHVkZXMoJ3Byb2R1Y3RzJykpIHtcbiAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgZGF0YToge1xuICAgICAgICBwcm9kdWN0czoge1xuICAgICAgICAgIGl0ZW1zOiBbXG4gICAgICAgICAgICB7IGlkOiAncHJvZC0xJywgbmFtZTogJ1Byb2R1Y3QgMScsIHByaWNlOiA5OS45OSB9LFxuICAgICAgICAgIF0sXG4gICAgICAgICAgdG90YWw6IDEsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgaWYgKHF1ZXJ5LmluY2x1ZGVzKCdtZScpKSB7XG4gICAgY29uc3QgYXV0aEhlYWRlciA9IHJlcS5oZWFkZXJzLmF1dGhvcml6YXRpb247XG4gICAgaWYgKCFhdXRoSGVhZGVyKSB7XG4gICAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgICBlcnJvcnM6IFt7IG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcgfV0sXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzLmpzb24oe1xuICAgICAgZGF0YToge1xuICAgICAgICBtZToge1xuICAgICAgICAgIGlkOiAndXNlci0xMjMnLFxuICAgICAgICAgIGVtYWlsOiAndGVzdEB0ZXN0LmNvbScsXG4gICAgICAgICAgZmlyc3ROYW1lOiAnVGVzdCcsXG4gICAgICAgICAgbGFzdE5hbWU6ICdVc2VyJyxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gcmVzLmpzb24oe1xuICAgIGRhdGE6IHt9LFxuICB9KTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==