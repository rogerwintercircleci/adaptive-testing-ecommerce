10307044da3e66e1e0f48ca4b4b5becd
"use strict";
/**
 * Inventory Management Service Implementation
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.InventoryService = void 0;
const errors_1 = require("@libs/errors");
class InventoryService {
    inventoryRepository;
    productRepository;
    DEFAULT_RESERVATION_MINUTES = 15;
    constructor(inventoryRepository, productRepository) {
        this.inventoryRepository = inventoryRepository;
        this.productRepository = productRepository;
    }
    async getStock(productId) {
        const inventory = await this.inventoryRepository.findByProductId(productId);
        return {
            ...inventory,
            available: inventory.quantity - (inventory.reserved || 0),
        };
    }
    async adjustInventory(data) {
        const inventory = await this.inventoryRepository.findByProductId(data.productId);
        const newQuantity = inventory.quantity + data.quantity;
        if (newQuantity < 0) {
            throw new errors_1.BadRequestError('Insufficient inventory');
        }
        const updated = await this.inventoryRepository.update(data.productId, {
            quantity: newQuantity,
        });
        // Record adjustment in history
        await this.inventoryRepository.recordAdjustment({
            productId: data.productId,
            quantity: data.quantity,
            reason: data.reason,
            userId: data.userId,
            date: new Date(),
        });
        return updated;
    }
    async reserveStock(data) {
        const inventory = await this.inventoryRepository.findByProductId(data.productId);
        const available = inventory.quantity - (inventory.reserved || 0);
        if (available < data.quantity) {
            throw new errors_1.ConflictError('Insufficient stock available');
        }
        const expirationMinutes = data.expirationMinutes || this.DEFAULT_RESERVATION_MINUTES;
        const expiresAt = new Date(Date.now() + expirationMinutes * 60 * 1000);
        return this.inventoryRepository.createReservation({
            ...data,
            expiresAt,
        });
    }
    async releaseReservation(reservationId) {
        await this.inventoryRepository.findReservation(reservationId);
        await this.inventoryRepository.releaseReservation(reservationId);
    }
    async confirmReservation(reservationId) {
        const reservation = await this.inventoryRepository.findReservation(reservationId);
        const inventory = await this.inventoryRepository.findByProductId(reservation.productId);
        const updated = await this.inventoryRepository.update(reservation.productId, {
            quantity: inventory.quantity - reservation.quantity,
            reserved: (inventory.reserved || 0) - reservation.quantity,
        });
        await this.inventoryRepository.releaseReservation(reservationId);
        return updated;
    }
    async checkAvailability(productId, quantity) {
        const inventory = await this.inventoryRepository.findByProductId(productId);
        const available = inventory.quantity - (inventory.reserved || 0);
        return available >= quantity;
    }
    async getLowStockProducts(options) {
        const lowStock = await this.inventoryRepository.findLowStock();
        if (options?.threshold !== undefined) {
            const threshold = options.threshold;
            return lowStock.filter(item => {
                const percentage = (item.quantity / item.minStockLevel) * 100;
                return percentage <= threshold;
            }).map(item => ({
                ...item,
                stockPercentage: (item.quantity / item.minStockLevel) * 100,
            }));
        }
        return lowStock;
    }
    async getOutOfStockProducts() {
        return this.inventoryRepository.findOutOfStock();
    }
    async setMinStockLevel(productId, minStockLevel) {
        if (minStockLevel < 0) {
            throw new errors_1.BadRequestError('Minimum stock level cannot be negative');
        }
        await this.inventoryRepository.findByProductId(productId);
        return this.inventoryRepository.update(productId, {
            minStockLevel,
        });
    }
    async setReorderPoint(productId, reorderPoint, reorderQuantity) {
        await this.inventoryRepository.findByProductId(productId);
        return this.inventoryRepository.update(productId, {
            reorderPoint,
            reorderQuantity,
        });
    }
    async getInventoryHistory(productId, options) {
        return this.inventoryRepository.getInventoryHistory(productId, options);
    }
    async releaseExpiredReservations() {
        const expired = await this.inventoryRepository.findExpiredReservations();
        for (const reservation of expired) {
            await this.inventoryRepository.releaseReservation(reservation.id);
        }
        return {
            releasedCount: expired.length,
        };
    }
    async getStockValue(productId) {
        const inventory = await this.inventoryRepository.findByProductId(productId);
        const product = await this.productRepository.findById(productId);
        return inventory.quantity * product.price;
    }
    async bulkUpdateInventory(updates) {
        let updated = 0;
        let failed = 0;
        for (const update of updates) {
            try {
                await this.adjustInventory({
                    productId: update.productId,
                    quantity: update.quantity,
                    reason: 'bulk_update',
                });
                updated++;
            }
            catch (error) {
                failed++;
            }
        }
        return { updated, failed };
    }
    async getInventoryTurnover(productId, days) {
        const history = await this.inventoryRepository.getInventoryHistory(productId);
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);
        const sales = history.filter(h => h.date >= cutoff && h.quantity < 0);
        const totalSold = Math.abs(sales.reduce((sum, h) => sum + h.quantity, 0));
        const inventory = await this.inventoryRepository.findByProductId(productId);
        const turnoverRate = inventory.quantity > 0 ? totalSold / inventory.quantity : 0;
        return {
            totalSold,
            averageInventory: inventory.quantity,
            turnoverRate,
        };
    }
    async predictRestockDate(productId) {
        const inventory = await this.inventoryRepository.findByProductId(productId);
        const history = await this.inventoryRepository.getInventoryHistory(productId);
        // Calculate daily average sales
        const sales = history.filter(h => h.quantity < 0);
        const totalSold = Math.abs(sales.reduce((sum, h) => sum + h.quantity, 0));
        const avgDailySales = totalSold / 30; // Last 30 days
        const daysUntilReorder = (inventory.quantity - inventory.reorderPoint) / avgDailySales;
        const restockDate = new Date();
        restockDate.setDate(restockDate.getDate() + Math.ceil(daysUntilReorder));
        return {
            estimatedDays: Math.ceil(daysUntilReorder),
            restockDate,
        };
    }
    async transferStock(transferDto) {
        // Record deduction from source
        await this.inventoryRepository.recordAdjustment({
            productId: transferDto.productId,
            quantity: -transferDto.quantity,
            reason: `transfer_to_${transferDto.toLocation}`,
            date: new Date(),
        });
        // Record addition to destination
        await this.inventoryRepository.recordAdjustment({
            productId: transferDto.productId,
            quantity: transferDto.quantity,
            reason: `transfer_from_${transferDto.fromLocation}`,
            date: new Date(),
        });
    }
}
exports.InventoryService = InventoryService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXEFkYXB0aXZlX1Rlc3RpbmdcXHNyY1xcc2VydmljZXNcXGludmVudG9yeVxcc2VydmljZXNcXGludmVudG9yeS5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7R0FFRzs7O0FBS0gseUNBQThEO0FBZ0I5RCxNQUFhLGdCQUFnQjtJQUlqQjtJQUNBO0lBSk8sMkJBQTJCLEdBQUcsRUFBRSxDQUFDO0lBRWxELFlBQ1UsbUJBQXdDLEVBQ3hDLGlCQUFvQztRQURwQyx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7SUFDM0MsQ0FBQztJQUVKLEtBQUssQ0FBQyxRQUFRLENBQUMsU0FBaUI7UUFDOUIsTUFBTSxTQUFTLEdBQUcsTUFBTSxJQUFJLENBQUMsbUJBQW1CLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzVFLE9BQU87WUFDTCxHQUFHLFNBQVM7WUFDWixTQUFTLEVBQUUsU0FBUyxDQUFDLFFBQVEsR0FBRyxDQUFDLFNBQVMsQ0FBQyxRQUFRLElBQUksQ0FBQyxDQUFDO1NBQzFELENBQUM7SUFDSixDQUFDO0lBRUQsS0FBSyxDQUFDLGVBQWUsQ0FBQyxJQUF3QjtRQUM1QyxNQUFNLFNBQVMsR0FBRyxNQUFNLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRWpGLE1BQU0sV0FBVyxHQUFHLFNBQVMsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUV2RCxJQUFJLFdBQVcsR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUNwQixNQUFNLElBQUksd0JBQWUsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1FBQ3RELENBQUM7UUFFRCxNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNwRSxRQUFRLEVBQUUsV0FBVztTQUN0QixDQUFDLENBQUM7UUFFSCwrQkFB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LENBQUMsZ0JBQWdCLENBQUM7WUFDMUMsV0FBVztTQUNaLENBQUM7SUFDSixDQUFDO0lBRUQsS0FBSyxDQUFDLGFBQWEsQ0FBQyxXQUFnQjtRQUNsQywrQkFBK0I7UUFDL0IsTUFBTSxJQUFJLENBQUMsbUJBQW1CLENBQUMsZ0JBQWdCLENBQUM7WUFDOUMsU0FBUyxFQUFFLFdBQVcsQ0FBQyxTQUFTO1lBQ2hDLFFBQVEsRUFBRSxDQUFDLFdBQVcsQ0FBQyxRQUFRO1lBQy9CLE1BQU0sRUFBRSxlQUFlLFdBQVcsQ0FBQyxVQUFVLEVBQUU7WUFDL0MsSUFBSSxFQUFFLElBQUksSUFBSSxFQUFFO1NBQ2pCLENBQUMsQ0FBQztRQUVILGlDQUFpQztRQUNqQyxNQUFNLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxnQkFBZ0IsQ0FBQztZQUM5QyxTQUFTLEVBQUUsV0FBVyxDQUFDLFNBQVM7WUFDaEMsUUFBUSxFQUFFLFdBQVcsQ0FBQyxRQUFRO1lBQzlCLE1BQU0sRUFBRSxpQkFBaUIsV0FBVyxDQUFDLFlBQVksRUFBRTtZQUNuRCxJQUFJLEVBQUUsSUFBSSxJQUFJLEVBQUU7U0FDakIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGO0FBaE9ELDRDQWdPQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcQWRhcHRpdmVfVGVzdGluZ1xcc3JjXFxzZXJ2aWNlc1xcaW52ZW50b3J5XFxzZXJ2aWNlc1xcaW52ZW50b3J5LnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBJbnZlbnRvcnkgTWFuYWdlbWVudCBTZXJ2aWNlIEltcGxlbWVudGF0aW9uXG4gKi9cblxuaW1wb3J0IHsgSW52ZW50b3J5UmVwb3NpdG9yeSB9IGZyb20gJy4uL3JlcG9zaXRvcmllcy9pbnZlbnRvcnkucmVwb3NpdG9yeSc7XG5pbXBvcnQgeyBQcm9kdWN0UmVwb3NpdG9yeSB9IGZyb20gJy4uLy4uL3Byb2R1Y3QtY2F0YWxvZy9yZXBvc2l0b3JpZXMvcHJvZHVjdC5yZXBvc2l0b3J5JztcbmltcG9ydCB7IEludmVudG9yeSB9IGZyb20gJy4uL2VudGl0aWVzL2ludmVudG9yeS5lbnRpdHknO1xuaW1wb3J0IHsgQmFkUmVxdWVzdEVycm9yLCBDb25mbGljdEVycm9yIH0gZnJvbSAnQGxpYnMvZXJyb3JzJztcblxuZXhwb3J0IGludGVyZmFjZSBBZGp1c3RJbnZlbnRvcnlEdG8ge1xuICBwcm9kdWN0SWQ6IHN0cmluZztcbiAgcXVhbnRpdHk6IG51bWJlcjtcbiAgcmVhc29uOiBzdHJpbmc7XG4gIHVzZXJJZD86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSZXNlcnZhdGlvbkR0byB7XG4gIHByb2R1Y3RJZDogc3RyaW5nO1xuICBxdWFudGl0eTogbnVtYmVyO1xuICBvcmRlcklkOiBzdHJpbmc7XG4gIGV4cGlyYXRpb25NaW51dGVzPzogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgSW52ZW50b3J5U2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgREVGQVVMVF9SRVNFUlZBVElPTl9NSU5VVEVTID0gMTU7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlSZXBvc2l0b3J5OiBJbnZlbnRvcnlSZXBvc2l0b3J5LFxuICAgIHByaXZhdGUgcHJvZHVjdFJlcG9zaXRvcnk6IFByb2R1Y3RSZXBvc2l0b3J5XG4gICkge31cblxuICBhc3luYyBnZXRTdG9jayhwcm9kdWN0SWQ6IHN0cmluZykge1xuICAgIGNvbnN0IGludmVudG9yeSA9IGF3YWl0IHRoaXMuaW52ZW50b3J5UmVwb3NpdG9yeS5maW5kQnlQcm9kdWN0SWQocHJvZHVjdElkKTtcbiAgICByZXR1cm4ge1xuICAgICAgLi4uaW52ZW50b3J5LFxuICAgICAgYXZhaWxhYmxlOiBpbnZlbnRvcnkucXVhbnRpdHkgLSAoaW52ZW50b3J5LnJlc2VydmVkIHx8IDApLFxuICAgIH07XG4gIH1cblxuICBhc3luYyBhZGp1c3RJbnZlbnRvcnkoZGF0YTogQWRqdXN0SW52ZW50b3J5RHRvKSB7XG4gICAgY29uc3QgaW52ZW50b3J5ID0gYXdhaXQgdGhpcy5pbnZlbnRvcnlSZXBvc2l0b3J5LmZpbmRCeVByb2R1Y3RJZChkYXRhLnByb2R1Y3RJZCk7XG5cbiAgICBjb25zdCBuZXdRdWFudGl0eSA9IGludmVudG9yeS5xdWFudGl0eSArIGRhdGEucXVhbnRpdHk7XG5cbiAgICBpZiAobmV3UXVhbnRpdHkgPCAwKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEVycm9yKCdJbnN1ZmZpY2llbnQgaW52ZW50b3J5Jyk7XG4gICAgfVxuXG4gICAgY29uc3QgdXBkYXRlZCA9IGF3YWl0IHRoaXMuaW52ZW50b3J5UmVwb3NpdG9yeS51cGRhdGUoZGF0YS5wcm9kdWN0SWQsIHtcbiAgICAgIHF1YW50aXR5OiBuZXdRdWFudGl0eSxcbiAgICB9KTtcblxuICAgIC8vIFJlY29yZCBhZGp1c3RtZW50IGluIGhpc3RvcnlcbiAgICBhd2FpdCB0aGlzLmludmVudG9yeVJlcG9zaXRvcnkucmVjb3JkQWRqdXN0bWVudCh7XG4gICAgICBwcm9kdWN0SWQ6IGRhdGEucHJvZHVjdElkLFxuICAgICAgcXVhbnRpdHk6IGRhdGEucXVhbnRpdHksXG4gICAgICByZWFzb246IGRhdGEucmVhc29uLFxuICAgICAgdXNlcklkOiBkYXRhLnVzZXJJZCxcbiAgICAgIGRhdGU6IG5ldyBEYXRlKCksXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdXBkYXRlZDtcbiAgfVxuXG4gIGFzeW5jIHJlc2VydmVTdG9jayhkYXRhOiBSZXNlcnZhdGlvbkR0bykge1xuICAgIGNvbnN0IGludmVudG9yeSA9IGF3YWl0IHRoaXMuaW52ZW50b3J5UmVwb3NpdG9yeS5maW5kQnlQcm9kdWN0SWQoZGF0YS5wcm9kdWN0SWQpO1xuICAgIGNvbnN0IGF2YWlsYWJsZSA9IGludmVudG9yeS5xdWFudGl0eSAtIChpbnZlbnRvcnkucmVzZXJ2ZWQgfHwgMCk7XG5cbiAgICBpZiAoYXZhaWxhYmxlIDwgZGF0YS5xdWFudGl0eSkge1xuICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXJyb3IoJ0luc3VmZmljaWVudCBzdG9jayBhdmFpbGFibGUnKTtcbiAgICB9XG5cbiAgICBjb25zdCBleHBpcmF0aW9uTWludXRlcyA9IGRhdGEuZXhwaXJhdGlvbk1pbnV0ZXMgfHwgdGhpcy5ERUZBVUxUX1JFU0VSVkFUSU9OX01JTlVURVM7XG4gICAgY29uc3QgZXhwaXJlc0F0ID0gbmV3IERhdGUoRGF0ZS5ub3coKSArIGV4cGlyYXRpb25NaW51dGVzICogNjAgKiAxMDAwKTtcblxuICAgIHJldHVybiB0aGlzLmludmVudG9yeVJlcG9zaXRvcnkuY3JlYXRlUmVzZXJ2YXRpb24oe1xuICAgICAgLi4uZGF0YSxcbiAgICAgIGV4cGlyZXNBdCxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHJlbGVhc2VSZXNlcnZhdGlvbihyZXNlcnZhdGlvbklkOiBzdHJpbmcpIHtcbiAgICBhd2FpdCB0aGlzLmludmVudG9yeVJlcG9zaXRvcnkuZmluZFJlc2VydmF0aW9uKHJlc2VydmF0aW9uSWQpO1xuICAgIGF3YWl0IHRoaXMuaW52ZW50b3J5UmVwb3NpdG9yeS5yZWxlYXNlUmVzZXJ2YXRpb24ocmVzZXJ2YXRpb25JZCk7XG4gIH1cblxuICBhc3luYyBjb25maXJtUmVzZXJ2YXRpb24ocmVzZXJ2YXRpb25JZDogc3RyaW5nKSB7XG4gICAgY29uc3QgcmVzZXJ2YXRpb24gPSBhd2FpdCB0aGlzLmludmVudG9yeVJlcG9zaXRvcnkuZmluZFJlc2VydmF0aW9uKHJlc2VydmF0aW9uSWQpO1xuICAgIGNvbnN0IGludmVudG9yeSA9IGF3YWl0IHRoaXMuaW52ZW50b3J5UmVwb3NpdG9yeS5maW5kQnlQcm9kdWN0SWQocmVzZXJ2YXRpb24ucHJvZHVjdElkKTtcblxuICAgIGNvbnN0IHVwZGF0ZWQgPSBhd2FpdCB0aGlzLmludmVudG9yeVJlcG9zaXRvcnkudXBkYXRlKHJlc2VydmF0aW9uLnByb2R1Y3RJZCwge1xuICAgICAgcXVhbnRpdHk6IGludmVudG9yeS5xdWFudGl0eSAtIHJlc2VydmF0aW9uLnF1YW50aXR5LFxuICAgICAgcmVzZXJ2ZWQ6IChpbnZlbnRvcnkucmVzZXJ2ZWQgfHwgMCkgLSByZXNlcnZhdGlvbi5xdWFudGl0eSxcbiAgICB9KTtcblxuICAgIGF3YWl0IHRoaXMuaW52ZW50b3J5UmVwb3NpdG9yeS5yZWxlYXNlUmVzZXJ2YXRpb24ocmVzZXJ2YXRpb25JZCk7XG5cbiAgICByZXR1cm4gdXBkYXRlZDtcbiAgfVxuXG4gIGFzeW5jIGNoZWNrQXZhaWxhYmlsaXR5KHByb2R1Y3RJZDogc3RyaW5nLCBxdWFudGl0eTogbnVtYmVyKSB7XG4gICAgY29uc3QgaW52ZW50b3J5ID0gYXdhaXQgdGhpcy5pbnZlbnRvcnlSZXBvc2l0b3J5LmZpbmRCeVByb2R1Y3RJZChwcm9kdWN0SWQpO1xuICAgIGNvbnN0IGF2YWlsYWJsZSA9IGludmVudG9yeS5xdWFudGl0eSAtIChpbnZlbnRvcnkucmVzZXJ2ZWQgfHwgMCk7XG4gICAgcmV0dXJuIGF2YWlsYWJsZSA+PSBxdWFudGl0eTtcbiAgfVxuXG4gIGFzeW5jIGdldExvd1N0b2NrUHJvZHVjdHMob3B0aW9ucz86IHsgdGhyZXNob2xkPzogbnVtYmVyIH0pOiBQcm9taXNlPEFycmF5PEludmVudG9yeSAmIHsgc3RvY2tQZXJjZW50YWdlPzogbnVtYmVyIH0+PiB7XG4gICAgY29uc3QgbG93U3RvY2sgPSBhd2FpdCB0aGlzLmludmVudG9yeVJlcG9zaXRvcnkuZmluZExvd1N0b2NrKCk7XG5cbiAgICBpZiAob3B0aW9ucz8udGhyZXNob2xkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGNvbnN0IHRocmVzaG9sZCA9IG9wdGlvbnMudGhyZXNob2xkO1xuICAgICAgcmV0dXJuIGxvd1N0b2NrLmZpbHRlcihpdGVtID0+IHtcbiAgICAgICAgY29uc3QgcGVyY2VudGFnZSA9IChpdGVtLnF1YW50aXR5IC8gaXRlbS5taW5TdG9ja0xldmVsKSAqIDEwMDtcbiAgICAgICAgcmV0dXJuIHBlcmNlbnRhZ2UgPD0gdGhyZXNob2xkO1xuICAgICAgfSkubWFwKGl0ZW0gPT4gKHtcbiAgICAgICAgLi4uaXRlbSxcbiAgICAgICAgc3RvY2tQZXJjZW50YWdlOiAoaXRlbS5xdWFudGl0eSAvIGl0ZW0ubWluU3RvY2tMZXZlbCkgKiAxMDAsXG4gICAgICB9KSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGxvd1N0b2NrO1xuICB9XG5cbiAgYXN5bmMgZ2V0T3V0T2ZTdG9ja1Byb2R1Y3RzKCk6IFByb21pc2U8SW52ZW50b3J5W10+IHtcbiAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnlSZXBvc2l0b3J5LmZpbmRPdXRPZlN0b2NrKCk7XG4gIH1cblxuICBhc3luYyBzZXRNaW5TdG9ja0xldmVsKHByb2R1Y3RJZDogc3RyaW5nLCBtaW5TdG9ja0xldmVsOiBudW1iZXIpIHtcbiAgICBpZiAobWluU3RvY2tMZXZlbCA8IDApIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXJyb3IoJ01pbmltdW0gc3RvY2sgbGV2ZWwgY2Fubm90IGJlIG5lZ2F0aXZlJyk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5pbnZlbnRvcnlSZXBvc2l0b3J5LmZpbmRCeVByb2R1Y3RJZChwcm9kdWN0SWQpO1xuXG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5UmVwb3NpdG9yeS51cGRhdGUocHJvZHVjdElkLCB7XG4gICAgICBtaW5TdG9ja0xldmVsLFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgc2V0UmVvcmRlclBvaW50KHByb2R1Y3RJZDogc3RyaW5nLCByZW9yZGVyUG9pbnQ6IG51bWJlciwgcmVvcmRlclF1YW50aXR5OiBudW1iZXIpIHtcbiAgICBhd2FpdCB0aGlzLmludmVudG9yeVJlcG9zaXRvcnkuZmluZEJ5UHJvZHVjdElkKHByb2R1Y3RJZCk7XG5cbiAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnlSZXBvc2l0b3J5LnVwZGF0ZShwcm9kdWN0SWQsIHtcbiAgICAgIHJlb3JkZXJQb2ludCxcbiAgICAgIHJlb3JkZXJRdWFudGl0eSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGdldEludmVudG9yeUhpc3RvcnkocHJvZHVjdElkOiBzdHJpbmcsIG9wdGlvbnM/OiBhbnkpIHtcbiAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnlSZXBvc2l0b3J5LmdldEludmVudG9yeUhpc3RvcnkocHJvZHVjdElkLCBvcHRpb25zKTtcbiAgfVxuXG4gIGFzeW5jIHJlbGVhc2VFeHBpcmVkUmVzZXJ2YXRpb25zKCkge1xuICAgIGNvbnN0IGV4cGlyZWQgPSBhd2FpdCB0aGlzLmludmVudG9yeVJlcG9zaXRvcnkuZmluZEV4cGlyZWRSZXNlcnZhdGlvbnMoKTtcblxuICAgIGZvciAoY29uc3QgcmVzZXJ2YXRpb24gb2YgZXhwaXJlZCkge1xuICAgICAgYXdhaXQgdGhpcy5pbnZlbnRvcnlSZXBvc2l0b3J5LnJlbGVhc2VSZXNlcnZhdGlvbihyZXNlcnZhdGlvbi5pZCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHJlbGVhc2VkQ291bnQ6IGV4cGlyZWQubGVuZ3RoLFxuICAgIH07XG4gIH1cblxuICBhc3luYyBnZXRTdG9ja1ZhbHVlKHByb2R1Y3RJZDogc3RyaW5nKSB7XG4gICAgY29uc3QgaW52ZW50b3J5ID0gYXdhaXQgdGhpcy5pbnZlbnRvcnlSZXBvc2l0b3J5LmZpbmRCeVByb2R1Y3RJZChwcm9kdWN0SWQpO1xuICAgIGNvbnN0IHByb2R1Y3QgPSBhd2FpdCB0aGlzLnByb2R1Y3RSZXBvc2l0b3J5LmZpbmRCeUlkKHByb2R1Y3RJZCk7XG5cbiAgICByZXR1cm4gaW52ZW50b3J5LnF1YW50aXR5ICogcHJvZHVjdC5wcmljZTtcbiAgfVxuXG4gIGFzeW5jIGJ1bGtVcGRhdGVJbnZlbnRvcnkodXBkYXRlczogQXJyYXk8eyBwcm9kdWN0SWQ6IHN0cmluZzsgcXVhbnRpdHk6IG51bWJlciB9Pikge1xuICAgIGxldCB1cGRhdGVkID0gMDtcbiAgICBsZXQgZmFpbGVkID0gMDtcblxuICAgIGZvciAoY29uc3QgdXBkYXRlIG9mIHVwZGF0ZXMpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuYWRqdXN0SW52ZW50b3J5KHtcbiAgICAgICAgICBwcm9kdWN0SWQ6IHVwZGF0ZS5wcm9kdWN0SWQsXG4gICAgICAgICAgcXVhbnRpdHk6IHVwZGF0ZS5xdWFudGl0eSxcbiAgICAgICAgICByZWFzb246ICdidWxrX3VwZGF0ZScsXG4gICAgICAgIH0pO1xuICAgICAgICB1cGRhdGVkKys7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBmYWlsZWQrKztcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4geyB1cGRhdGVkLCBmYWlsZWQgfTtcbiAgfVxuXG4gIGFzeW5jIGdldEludmVudG9yeVR1cm5vdmVyKHByb2R1Y3RJZDogc3RyaW5nLCBkYXlzOiBudW1iZXIpIHtcbiAgICBjb25zdCBoaXN0b3J5ID0gYXdhaXQgdGhpcy5pbnZlbnRvcnlSZXBvc2l0b3J5LmdldEludmVudG9yeUhpc3RvcnkocHJvZHVjdElkKTtcblxuICAgIGNvbnN0IGN1dG9mZiA9IG5ldyBEYXRlKCk7XG4gICAgY3V0b2ZmLnNldERhdGUoY3V0b2ZmLmdldERhdGUoKSAtIGRheXMpO1xuXG4gICAgY29uc3Qgc2FsZXMgPSBoaXN0b3J5LmZpbHRlcihoID0+IGguZGF0ZSA+PSBjdXRvZmYgJiYgaC5xdWFudGl0eSA8IDApO1xuICAgIGNvbnN0IHRvdGFsU29sZCA9IE1hdGguYWJzKHNhbGVzLnJlZHVjZSgoc3VtLCBoKSA9PiBzdW0gKyBoLnF1YW50aXR5LCAwKSk7XG5cbiAgICBjb25zdCBpbnZlbnRvcnkgPSBhd2FpdCB0aGlzLmludmVudG9yeVJlcG9zaXRvcnkuZmluZEJ5UHJvZHVjdElkKHByb2R1Y3RJZCk7XG4gICAgY29uc3QgdHVybm92ZXJSYXRlID0gaW52ZW50b3J5LnF1YW50aXR5ID4gMCA/IHRvdGFsU29sZCAvIGludmVudG9yeS5xdWFudGl0eSA6IDA7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxTb2xkLFxuICAgICAgYXZlcmFnZUludmVudG9yeTogaW52ZW50b3J5LnF1YW50aXR5LFxuICAgICAgdHVybm92ZXJSYXRlLFxuICAgIH07XG4gIH1cblxuICBhc3luYyBwcmVkaWN0UmVzdG9ja0RhdGUocHJvZHVjdElkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBpbnZlbnRvcnkgPSBhd2FpdCB0aGlzLmludmVudG9yeVJlcG9zaXRvcnkuZmluZEJ5UHJvZHVjdElkKHByb2R1Y3RJZCk7XG4gICAgY29uc3QgaGlzdG9yeSA9IGF3YWl0IHRoaXMuaW52ZW50b3J5UmVwb3NpdG9yeS5nZXRJbnZlbnRvcnlIaXN0b3J5KHByb2R1Y3RJZCk7XG5cbiAgICAvLyBDYWxjdWxhdGUgZGFpbHkgYXZlcmFnZSBzYWxlc1xuICAgIGNvbnN0IHNhbGVzID0gaGlzdG9yeS5maWx0ZXIoaCA9PiBoLnF1YW50aXR5IDwgMCk7XG4gICAgY29uc3QgdG90YWxTb2xkID0gTWF0aC5hYnMoc2FsZXMucmVkdWNlKChzdW0sIGgpID0+IHN1bSArIGgucXVhbnRpdHksIDApKTtcbiAgICBjb25zdCBhdmdEYWlseVNhbGVzID0gdG90YWxTb2xkIC8gMzA7IC8vIExhc3QgMzAgZGF5c1xuXG4gICAgY29uc3QgZGF5c1VudGlsUmVvcmRlciA9IChpbnZlbnRvcnkucXVhbnRpdHkgLSBpbnZlbnRvcnkucmVvcmRlclBvaW50KSAvIGF2Z0RhaWx5U2FsZXM7XG5cbiAgICBjb25zdCByZXN0b2NrRGF0ZSA9IG5ldyBEYXRlKCk7XG4gICAgcmVzdG9ja0RhdGUuc2V0RGF0ZShyZXN0b2NrRGF0ZS5nZXREYXRlKCkgKyBNYXRoLmNlaWwoZGF5c1VudGlsUmVvcmRlcikpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGVzdGltYXRlZERheXM6IE1hdGguY2VpbChkYXlzVW50aWxSZW9yZGVyKSxcbiAgICAgIHJlc3RvY2tEYXRlLFxuICAgIH07XG4gIH1cblxuICBhc3luYyB0cmFuc2ZlclN0b2NrKHRyYW5zZmVyRHRvOiBhbnkpIHtcbiAgICAvLyBSZWNvcmQgZGVkdWN0aW9uIGZyb20gc291cmNlXG4gICAgYXdhaXQgdGhpcy5pbnZlbnRvcnlSZXBvc2l0b3J5LnJlY29yZEFkanVzdG1lbnQoe1xuICAgICAgcHJvZHVjdElkOiB0cmFuc2ZlckR0by5wcm9kdWN0SWQsXG4gICAgICBxdWFudGl0eTogLXRyYW5zZmVyRHRvLnF1YW50aXR5LFxuICAgICAgcmVhc29uOiBgdHJhbnNmZXJfdG9fJHt0cmFuc2ZlckR0by50b0xvY2F0aW9ufWAsXG4gICAgICBkYXRlOiBuZXcgRGF0ZSgpLFxuICAgIH0pO1xuXG4gICAgLy8gUmVjb3JkIGFkZGl0aW9uIHRvIGRlc3RpbmF0aW9uXG4gICAgYXdhaXQgdGhpcy5pbnZlbnRvcnlSZXBvc2l0b3J5LnJlY29yZEFkanVzdG1lbnQoe1xuICAgICAgcHJvZHVjdElkOiB0cmFuc2ZlckR0by5wcm9kdWN0SWQsXG4gICAgICBxdWFudGl0eTogdHJhbnNmZXJEdG8ucXVhbnRpdHksXG4gICAgICByZWFzb246IGB0cmFuc2Zlcl9mcm9tXyR7dHJhbnNmZXJEdG8uZnJvbUxvY2F0aW9ufWAsXG4gICAgICBkYXRlOiBuZXcgRGF0ZSgpLFxuICAgIH0pO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=