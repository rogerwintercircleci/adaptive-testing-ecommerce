bb230fde6a3c3e6cf7c6e5e495e0d8d1
"use strict";
/**
 * Discount/Coupon Service Implementation
 *
 * Handles discount codes, validation, and application
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.DiscountService = exports.DiscountType = void 0;
const errors_1 = require("@libs/errors");
var DiscountType;
(function (DiscountType) {
    DiscountType["PERCENTAGE"] = "percentage";
    DiscountType["FIXED_AMOUNT"] = "fixed_amount";
    DiscountType["FREE_SHIPPING"] = "free_shipping";
})(DiscountType || (exports.DiscountType = DiscountType = {}));
class DiscountService {
    discountRepository;
    constructor(discountRepository) {
        this.discountRepository = discountRepository;
    }
    async createDiscount(data) {
        // Validate percentage discount
        if (data.type === DiscountType.PERCENTAGE && data.value > 100) {
            throw new errors_1.BadRequestError('Percentage discount cannot exceed 100%');
        }
        // Validate value is positive
        if (data.value < 0) {
            throw new errors_1.BadRequestError('Discount value must be positive');
        }
        // Normalize code to uppercase
        const normalizedCode = data.code.toUpperCase();
        const discountData = {
            ...data,
            code: normalizedCode,
            usageCount: 0,
            isActive: true,
            createdAt: new Date(),
        };
        return this.discountRepository.create(discountData);
    }
    async validateDiscount(code) {
        const discount = await this.discountRepository.findByCode(code.toUpperCase());
        if (!discount) {
            return { isValid: false, reason: 'Discount code not found' };
        }
        if (!discount.isActive) {
            return { isValid: false, reason: 'Discount code is not active' };
        }
        const now = new Date();
        if (discount.expiresAt && discount.expiresAt < now) {
            return { isValid: false, reason: 'Discount code has expired' };
        }
        if (discount.startsAt && discount.startsAt > now) {
            return { isValid: false, reason: 'Discount code is not yet active' };
        }
        if (discount.maxUsageCount && discount.usageCount >= discount.maxUsageCount) {
            return { isValid: false, reason: 'Discount code has reached maximum usage limit' };
        }
        return { isValid: true, discount };
    }
    async applyDiscount(data) {
        const validation = await this.validateDiscount(data.code);
        if (!validation.isValid) {
            throw new errors_1.BadRequestError(validation.reason || 'Invalid discount code');
        }
        const discount = validation.discount;
        // Check minimum purchase requirement
        if (discount.minPurchaseAmount && data.orderSubtotal < discount.minPurchaseAmount) {
            throw new errors_1.BadRequestError(`Order must meet minimum purchase amount of $${discount.minPurchaseAmount}`);
        }
        // Check per-user usage limit
        if (discount.maxUsagePerUser) {
            const userUsages = await this.discountRepository.findByUserId(data.userId);
            const timesUsed = userUsages.filter(u => u.discountId === discount.id).length;
            if (timesUsed >= discount.maxUsagePerUser) {
                throw new errors_1.BadRequestError('You have already used this discount code');
            }
        }
        let discountAmount = 0;
        let freeShipping = false;
        let shippingDiscount = 0;
        if (discount.type === DiscountType.PERCENTAGE) {
            discountAmount = (data.orderSubtotal * discount.value) / 100;
            // Apply maximum discount cap if specified
            if (discount.maxDiscountAmount && discountAmount > discount.maxDiscountAmount) {
                discountAmount = discount.maxDiscountAmount;
            }
        }
        else if (discount.type === DiscountType.FIXED_AMOUNT) {
            discountAmount = discount.value;
            // Don't allow discount to exceed order subtotal
            if (discountAmount > data.orderSubtotal) {
                discountAmount = data.orderSubtotal;
            }
        }
        else if (discount.type === DiscountType.FREE_SHIPPING) {
            freeShipping = true;
            shippingDiscount = data.shippingCost || 0;
        }
        // Increment usage count
        await this.discountRepository.incrementUsageCount(discount.id, data.userId);
        return {
            discountAmount,
            finalAmount: data.orderSubtotal - discountAmount,
            freeShipping,
            shippingDiscount,
        };
    }
    async getActiveDiscounts() {
        return this.discountRepository.findActive();
    }
    async deactivateDiscount(discountId) {
        await this.discountRepository.findById(discountId);
        return this.discountRepository.update(discountId, { isActive: false });
    }
    async getDiscountUsageStats(discountId) {
        const discount = await this.discountRepository.findById(discountId);
        const totalUsage = discount.usageCount || 0;
        const maxUsage = discount.maxUsageCount || 0;
        const remainingUsage = maxUsage > 0 ? maxUsage - totalUsage : Infinity;
        const usagePercentage = maxUsage > 0 ? (totalUsage / maxUsage) * 100 : 0;
        return {
            totalUsage,
            remainingUsage: remainingUsage === Infinity ? null : remainingUsage,
            usagePercentage,
        };
    }
    async calculateSavings(code, orderSubtotal) {
        const discount = await this.discountRepository.findByCode(code.toUpperCase());
        if (!discount) {
            return 0;
        }
        if (discount.type === DiscountType.PERCENTAGE) {
            let savings = (orderSubtotal * discount.value) / 100;
            if (discount.maxDiscountAmount && savings > discount.maxDiscountAmount) {
                savings = discount.maxDiscountAmount;
            }
            return savings;
        }
        else if (discount.type === DiscountType.FIXED_AMOUNT) {
            return Math.min(discount.value, orderSubtotal);
        }
        return 0;
    }
    async deleteDiscount(discountId) {
        return this.discountRepository.delete(discountId);
    }
}
exports.DiscountService = DiscountService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXEFkYXB0aXZlX1Rlc3RpbmdcXHNyY1xcc2VydmljZXNcXHByb21vdGlvbnNcXHNlcnZpY2VzXFxkaXNjb3VudC5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHOzs7QUFHSCx5Q0FBK0M7QUFFL0MsSUFBWSxZQUlYO0FBSkQsV0FBWSxZQUFZO0lBQ3RCLHlDQUF5QixDQUFBO0lBQ3pCLDZDQUE2QixDQUFBO0lBQzdCLCtDQUErQixDQUFBO0FBQ2pDLENBQUMsRUFKVyxZQUFZLDRCQUFaLFlBQVksUUFJdkI7QUFtQ0QsTUFBYSxlQUFlO0lBQ047SUFBcEIsWUFBb0Isa0JBQXNDO1FBQXRDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7SUFBRyxDQUFDO0lBRTlELEtBQUssQ0FBQyxjQUFjLENBQUMsSUFBdUI7UUFDMUMsK0JBQStCO1FBQy9CLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxZQUFZLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxLQUFLLEdBQUcsR0FBRyxFQUFFLENBQUM7WUFDOUQsTUFBTSxJQUFJLHdCQUFlLENBQUMsd0NBQXdDLENBQUMsQ0FBQztRQUN0RSxDQUFDO1FBRUQsNkJBQTZCO1FBQzdCLElBQUksSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUNuQixNQUFNLElBQUksd0JBQWUsQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO1FBQy9ELENBQUM7UUFFRCw4QkFBOEI7UUFDOUIsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUUvQyxNQUFNLFlBQVksR0FBRztZQUNuQixHQUFHLElBQUk7WUFDUCxJQUFJLEVBQUUsY0FBYztZQUNwQixVQUFVLEVBQUUsQ0FBQztZQUNiLFFBQVEsRUFBRSxJQUFJO1lBQ2QsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO1NBQ3RCLENBQUM7UUFFRixPQUFPLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUM7SUFD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Q0FBQyxJQUFJLEtBQUssWUFBWSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQzlDLElBQUksT0FBTyxHQUFHLENBQUMsYUFBYSxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLENBQUM7WUFFckQsSUFBSSxRQUFRLENBQUMsaUJBQWlCLElBQUksT0FBTyxHQUFHLFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO2dCQUN2RSxPQUFPLEdBQUcsUUFBUSxDQUFDLGlCQUFpQixDQUFDO1lBQ3ZDLENBQUM7WUFFRCxPQUFPLE9BQU8sQ0FBQztRQUNqQixDQUFDO2FBQU0sSUFBSSxRQUFRLENBQUMsSUFBSSxLQUFLLFlBQVksQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUN2RCxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxhQUFhLENBQUMsQ0FBQztRQUNqRCxDQUFDO1FBRUQsT0FBTyxDQUFDLENBQUM7SUFDWCxDQUFDO0lBRUQsS0FBSyxDQUFDLGNBQWMsQ0FBQyxVQUFrQjtRQUNyQyxPQUFPLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDcEQsQ0FBQztDQUNGO0FBcktELDBDQXFLQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcQWRhcHRpdmVfVGVzdGluZ1xcc3JjXFxzZXJ2aWNlc1xccHJvbW90aW9uc1xcc2VydmljZXNcXGRpc2NvdW50LnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBEaXNjb3VudC9Db3Vwb24gU2VydmljZSBJbXBsZW1lbnRhdGlvblxuICpcbiAqIEhhbmRsZXMgZGlzY291bnQgY29kZXMsIHZhbGlkYXRpb24sIGFuZCBhcHBsaWNhdGlvblxuICovXG5cbmltcG9ydCB7IERpc2NvdW50UmVwb3NpdG9yeSB9IGZyb20gJy4uL3JlcG9zaXRvcmllcy9kaXNjb3VudC5yZXBvc2l0b3J5JztcbmltcG9ydCB7IEJhZFJlcXVlc3RFcnJvciB9IGZyb20gJ0BsaWJzL2Vycm9ycyc7XG5cbmV4cG9ydCBlbnVtIERpc2NvdW50VHlwZSB7XG4gIFBFUkNFTlRBR0UgPSAncGVyY2VudGFnZScsXG4gIEZJWEVEX0FNT1VOVCA9ICdmaXhlZF9hbW91bnQnLFxuICBGUkVFX1NISVBQSU5HID0gJ2ZyZWVfc2hpcHBpbmcnLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIENyZWF0ZURpc2NvdW50RHRvIHtcbiAgY29kZTogc3RyaW5nO1xuICB0eXBlOiBEaXNjb3VudFR5cGU7XG4gIHZhbHVlOiBudW1iZXI7XG4gIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG4gIGV4cGlyZXNBdD86IERhdGU7XG4gIHN0YXJ0c0F0PzogRGF0ZTtcbiAgbWluUHVyY2hhc2VBbW91bnQ/OiBudW1iZXI7XG4gIG1heERpc2NvdW50QW1vdW50PzogbnVtYmVyO1xuICBtYXhVc2FnZUNvdW50PzogbnVtYmVyO1xuICBtYXhVc2FnZVBlclVzZXI/OiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBwbHlEaXNjb3VudER0byB7XG4gIGNvZGU6IHN0cmluZztcbiAgb3JkZXJTdWJ0b3RhbDogbnVtYmVyO1xuICB1c2VySWQ6IHN0cmluZztcbiAgc2hpcHBpbmdDb3N0PzogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFZhbGlkYXRpb25SZXN1bHQge1xuICBpc1ZhbGlkOiBib29sZWFuO1xuICBkaXNjb3VudD86IGFueTtcbiAgcmVhc29uPzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFwcGx5UmVzdWx0IHtcbiAgZGlzY291bnRBbW91bnQ6IG51bWJlcjtcbiAgZmluYWxBbW91bnQ6IG51bWJlcjtcbiAgZnJlZVNoaXBwaW5nPzogYm9vbGVhbjtcbiAgc2hpcHBpbmdEaXNjb3VudD86IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIERpc2NvdW50U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZGlzY291bnRSZXBvc2l0b3J5OiBEaXNjb3VudFJlcG9zaXRvcnkpIHt9XG5cbiAgYXN5bmMgY3JlYXRlRGlzY291bnQoZGF0YTogQ3JlYXRlRGlzY291bnREdG8pIHtcbiAgICAvLyBWYWxpZGF0ZSBwZXJjZW50YWdlIGRpc2NvdW50XG4gICAgaWYgKGRhdGEudHlwZSA9PT0gRGlzY291bnRUeXBlLlBFUkNFTlRBR0UgJiYgZGF0YS52YWx1ZSA+IDEwMCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFcnJvcignUGVyY2VudGFnZSBkaXNjb3VudCBjYW5ub3QgZXhjZWVkIDEwMCUnKTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSB2YWx1ZSBpcyBwb3NpdGl2ZVxuICAgIGlmIChkYXRhLnZhbHVlIDwgMCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFcnJvcignRGlzY291bnQgdmFsdWUgbXVzdCBiZSBwb3NpdGl2ZScpO1xuICAgIH1cblxuICAgIC8vIE5vcm1hbGl6ZSBjb2RlIHRvIHVwcGVyY2FzZVxuICAgIGNvbnN0IG5vcm1hbGl6ZWRDb2RlID0gZGF0YS5jb2RlLnRvVXBwZXJDYXNlKCk7XG5cbiAgICBjb25zdCBkaXNjb3VudERhdGEgPSB7XG4gICAgICAuLi5kYXRhLFxuICAgICAgY29kZTogbm9ybWFsaXplZENvZGUsXG4gICAgICB1c2FnZUNvdW50OiAwLFxuICAgICAgaXNBY3RpdmU6IHRydWUsXG4gICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLmRpc2NvdW50UmVwb3NpdG9yeS5jcmVhdGUoZGlzY291bnREYXRhKTtcbiAgfVxuXG4gIGFzeW5jIHZhbGlkYXRlRGlzY291bnQoY29kZTogc3RyaW5nKTogUHJvbWlzZTxWYWxpZGF0aW9uUmVzdWx0PiB7XG4gICAgY29uc3QgZGlzY291bnQgPSBhd2FpdCB0aGlzLmRpc2NvdW50UmVwb3NpdG9yeS5maW5kQnlDb2RlKGNvZGUudG9VcHBlckNhc2UoKSk7XG5cbiAgICBpZiAoIWRpc2NvdW50KSB7XG4gICAgICByZXR1cm4geyBpc1ZhbGlkOiBmYWxzZSwgcmVhc29uOiAnRGlzY291bnQgY29kZSBub3QgZm91bmQnIH07XG4gICAgfVxuXG4gICAgaWYgKCFkaXNjb3VudC5pc0FjdGl2ZSkge1xuICAgICAgcmV0dXJuIHsgaXNWYWxpZDogZmFsc2UsIHJlYXNvbjogJ0Rpc2NvdW50IGNvZGUgaXMgbm90IGFjdGl2ZScgfTtcbiAgICB9XG5cbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuXG4gICAgaWYgKGRpc2NvdW50LmV4cGlyZXNBdCAmJiBkaXNjb3VudC5leHBpcmVzQXQgPCBub3cpIHtcbiAgICAgIHJldHVybiB7IGlzVmFsaWQ6IGZhbHNlLCByZWFzb246ICdEaXNjb3VudCBjb2RlIGhhcyBleHBpcmVkJyB9O1xuICAgIH1cblxuICAgIGlmIChkaXNjb3VudC5zdGFydHNBdCAmJiBkaXNjb3VudC5zdGFydHNBdCA+IG5vdykge1xuICAgICAgcmV0dXJuIHsgaXNWYWxpZDogZmFsc2UsIHJlYXNvbjogJ0Rpc2NvdW50IGNvZGUgaXMgbm90IHlldCBhY3RpdmUnIH07XG4gICAgfVxuXG4gICAgaWYgKGRpc2NvdW50Lm1heFVzYWdlQ291bnQgJiYgZGlzY291bnQudXNhZ2VDb3VudCA+PSBkaXNjb3VudC5tYXhVc2FnZUNvdW50KSB7XG4gICAgICByZXR1cm4geyBpc1ZhbGlkOiBmYWxzZSwgcmVhc29uOiAnRGlzY291bnQgY29kZSBoYXMgcmVhY2hlZCBtYXhpbXVtIHVzYWdlIGxpbWl0JyB9O1xuICAgIH1cblxuICAgIHJldHVybiB7IGlzVmFsaWQ6IHRydWUsIGRpc2NvdW50IH07XG4gIH1cblxuICBhc3luYyBhcHBseURpc2NvdW50KGRhdGE6IEFwcGx5RGlzY291bnREdG8pOiBQcm9taXNlPEFwcGx5UmVzdWx0PiB7XG4gICAgY29uc3QgdmFsaWRhdGlvbiA9IGF3YWl0IHRoaXMudmFsaWRhdGVEaXNjb3VudChkYXRhLmNvZGUpO1xuXG4gICAgaWYgKCF2YWxpZGF0aW9uLmlzVmFsaWQpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXJyb3IodmFsaWRhdGlvbi5yZWFzb24gfHwgJ0ludmFsaWQgZGlzY291bnQgY29kZScpO1xuICAgIH1cblxuICAgIGNvbnN0IGRpc2NvdW50ID0gdmFsaWRhdGlvbi5kaXNjb3VudDtcblxuICAgIC8vIENoZWNrIG1pbmltdW0gcHVyY2hhc2UgcmVxdWlyZW1lbnRcbiAgICBpZiAoZGlzY291bnQubWluUHVyY2hhc2VBbW91bnQgJiYgZGF0YS5vcmRlclN1YnRvdGFsIDwgZGlzY291bnQubWluUHVyY2hhc2VBbW91bnQpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXJyb3IoXG4gICAgICAgIGBPcmRlciBtdXN0IG1lZXQgbWluaW11bSBwdXJjaGFzZSBhbW91bnQgb2YgJCR7ZGlzY291bnQubWluUHVyY2hhc2VBbW91bnR9YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBwZXItdXNlciB1c2FnZSBsaW1pdFxuICAgIGlmIChkaXNjb3VudC5tYXhVc2FnZVBlclVzZXIpIHtcbiAgICAgIGNvbnN0IHVzZXJVc2FnZXMgPSBhd2FpdCB0aGlzLmRpc2NvdW50UmVwb3NpdG9yeS5maW5kQnlVc2VySWQoZGF0YS51c2VySWQpO1xuICAgICAgY29uc3QgdGltZXNVc2VkID0gdXNlclVzYWdlcy5maWx0ZXIodSA9PiB1LmRpc2NvdW50SWQgPT09IGRpc2NvdW50LmlkKS5sZW5ndGg7XG5cbiAgICAgIGlmICh0aW1lc1VzZWQgPj0gZGlzY291bnQubWF4VXNhZ2VQZXJVc2VyKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXJyb3IoJ1lvdSBoYXZlIGFscmVhZHkgdXNlZCB0aGlzIGRpc2NvdW50IGNvZGUnKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBsZXQgZGlzY291bnRBbW91bnQgPSAwO1xuICAgIGxldCBmcmVlU2hpcHBpbmcgPSBmYWxzZTtcbiAgICBsZXQgc2hpcHBpbmdEaXNjb3VudCA9IDA7XG5cbiAgICBpZiAoZGlzY291bnQudHlwZSA9PT0gRGlzY291bnRUeXBlLlBFUkNFTlRBR0UpIHtcbiAgICAgIGRpc2NvdW50QW1vdW50ID0gKGRhdGEub3JkZXJTdWJ0b3RhbCAqIGRpc2NvdW50LnZhbHVlKSAvIDEwMDtcblxuICAgICAgLy8gQXBwbHkgbWF4aW11bSBkaXNjb3VudCBjYXAgaWYgc3BlY2lmaWVkXG4gICAgICBpZiAoZGlzY291bnQubWF4RGlzY291bnRBbW91bnQgJiYgZGlzY291bnRBbW91bnQgPiBkaXNjb3VudC5tYXhEaXNjb3VudEFtb3VudCkge1xuICAgICAgICBkaXNjb3VudEFtb3VudCA9IGRpc2NvdW50Lm1heERpc2NvdW50QW1vdW50O1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoZGlzY291bnQudHlwZSA9PT0gRGlzY291bnRUeXBlLkZJWEVEX0FNT1VOVCkge1xuICAgICAgZGlzY291bnRBbW91bnQgPSBkaXNjb3VudC52YWx1ZTtcblxuICAgICAgLy8gRG9uJ3QgYWxsb3cgZGlzY291bnQgdG8gZXhjZWVkIG9yZGVyIHN1YnRvdGFsXG4gICAgICBpZiAoZGlzY291bnRBbW91bnQgPiBkYXRhLm9yZGVyU3VidG90YWwpIHtcbiAgICAgICAgZGlzY291bnRBbW91bnQgPSBkYXRhLm9yZGVyU3VidG90YWw7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChkaXNjb3VudC50eXBlID09PSBEaXNjb3VudFR5cGUuRlJFRV9TSElQUElORykge1xuICAgICAgZnJlZVNoaXBwaW5nID0gdHJ1ZTtcbiAgICAgIHNoaXBwaW5nRGlzY291bnQgPSBkYXRhLnNoaXBwaW5nQ29zdCB8fCAwO1xuICAgIH1cblxuICAgIC8vIEluY3JlbWVudCB1c2FnZSBjb3VudFxuICAgIGF3YWl0IHRoaXMuZGlzY291bnRSZXBvc2l0b3J5LmluY3JlbWVudFVzYWdlQ291bnQoZGlzY291bnQuaWQsIGRhdGEudXNlcklkKTtcblxuICAgIHJldHVybiB7XG4gICAgICBkaXNjb3VudEFtb3VudCxcbiAgICAgIGZpbmFsQW1vdW50OiBkYXRhLm9yZGVyU3VidG90YWwgLSBkaXNjb3VudEFtb3VudCxcbiAgICAgIGZyZWVTaGlwcGluZyxcbiAgICAgIHNoaXBwaW5nRGlzY291bnQsXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIGdldEFjdGl2ZURpc2NvdW50cygpIHtcbiAgICByZXR1cm4gdGhpcy5kaXNjb3VudFJlcG9zaXRvcnkuZmluZEFjdGl2ZSgpO1xuICB9XG5cbiAgYXN5bmMgZGVhY3RpdmF0ZURpc2NvdW50KGRpc2NvdW50SWQ6IHN0cmluZykge1xuICAgIGF3YWl0IHRoaXMuZGlzY291bnRSZXBvc2l0b3J5LmZpbmRCeUlkKGRpc2NvdW50SWQpO1xuICAgIHJldHVybiB0aGlzLmRpc2NvdW50UmVwb3NpdG9yeS51cGRhdGUoZGlzY291bnRJZCwgeyBpc0FjdGl2ZTogZmFsc2UgfSk7XG4gIH1cblxuICBhc3luYyBnZXREaXNjb3VudFVzYWdlU3RhdHMoZGlzY291bnRJZDogc3RyaW5nKSB7XG4gICAgY29uc3QgZGlzY291bnQgPSBhd2FpdCB0aGlzLmRpc2NvdW50UmVwb3NpdG9yeS5maW5kQnlJZChkaXNjb3VudElkKTtcblxuICAgIGNvbnN0IHRvdGFsVXNhZ2UgPSBkaXNjb3VudC51c2FnZUNvdW50IHx8IDA7XG4gICAgY29uc3QgbWF4VXNhZ2UgPSBkaXNjb3VudC5tYXhVc2FnZUNvdW50IHx8IDA7XG4gICAgY29uc3QgcmVtYWluaW5nVXNhZ2UgPSBtYXhVc2FnZSA+IDAgPyBtYXhVc2FnZSAtIHRvdGFsVXNhZ2UgOiBJbmZpbml0eTtcbiAgICBjb25zdCB1c2FnZVBlcmNlbnRhZ2UgPSBtYXhVc2FnZSA+IDAgPyAodG90YWxVc2FnZSAvIG1heFVzYWdlKSAqIDEwMCA6IDA7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxVc2FnZSxcbiAgICAgIHJlbWFpbmluZ1VzYWdlOiByZW1haW5pbmdVc2FnZSA9PT0gSW5maW5pdHkgPyBudWxsIDogcmVtYWluaW5nVXNhZ2UsXG4gICAgICB1c2FnZVBlcmNlbnRhZ2UsXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIGNhbGN1bGF0ZVNhdmluZ3MoY29kZTogc3RyaW5nLCBvcmRlclN1YnRvdGFsOiBudW1iZXIpIHtcbiAgICBjb25zdCBkaXNjb3VudCA9IGF3YWl0IHRoaXMuZGlzY291bnRSZXBvc2l0b3J5LmZpbmRCeUNvZGUoY29kZS50b1VwcGVyQ2FzZSgpKTtcblxuICAgIGlmICghZGlzY291bnQpIHtcbiAgICAgIHJldHVybiAwO1xuICAgIH1cblxuICAgIGlmIChkaXNjb3VudC50eXBlID09PSBEaXNjb3VudFR5cGUuUEVSQ0VOVEFHRSkge1xuICAgICAgbGV0IHNhdmluZ3MgPSAob3JkZXJTdWJ0b3RhbCAqIGRpc2NvdW50LnZhbHVlKSAvIDEwMDtcblxuICAgICAgaWYgKGRpc2NvdW50Lm1heERpc2NvdW50QW1vdW50ICYmIHNhdmluZ3MgPiBkaXNjb3VudC5tYXhEaXNjb3VudEFtb3VudCkge1xuICAgICAgICBzYXZpbmdzID0gZGlzY291bnQubWF4RGlzY291bnRBbW91bnQ7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBzYXZpbmdzO1xuICAgIH0gZWxzZSBpZiAoZGlzY291bnQudHlwZSA9PT0gRGlzY291bnRUeXBlLkZJWEVEX0FNT1VOVCkge1xuICAgICAgcmV0dXJuIE1hdGgubWluKGRpc2NvdW50LnZhbHVlLCBvcmRlclN1YnRvdGFsKTtcbiAgICB9XG5cbiAgICByZXR1cm4gMDtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZURpc2NvdW50KGRpc2NvdW50SWQ6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLmRpc2NvdW50UmVwb3NpdG9yeS5kZWxldGUoZGlzY291bnRJZCk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==