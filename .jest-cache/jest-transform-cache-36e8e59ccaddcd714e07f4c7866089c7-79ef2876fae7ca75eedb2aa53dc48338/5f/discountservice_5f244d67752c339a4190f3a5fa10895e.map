{"file":"C:\\Adaptive_Testing\\src\\services\\promotions\\services\\discount.service.ts","mappings":"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","names":[],"sources":["C:\\Adaptive_Testing\\src\\services\\promotions\\services\\discount.service.ts"],"sourcesContent":["/**\n * Discount/Coupon Service Implementation\n *\n * Handles discount codes, validation, and application\n */\n\nimport { DiscountRepository } from '../repositories/discount.repository';\nimport { BadRequestError } from '@libs/errors';\n\nexport enum DiscountType {\n  PERCENTAGE = 'percentage',\n  FIXED_AMOUNT = 'fixed_amount',\n  FREE_SHIPPING = 'free_shipping',\n}\n\nexport interface CreateDiscountDto {\n  code: string;\n  type: DiscountType;\n  value: number;\n  description: string;\n  expiresAt?: Date;\n  startsAt?: Date;\n  minPurchaseAmount?: number;\n  maxDiscountAmount?: number;\n  maxUsageCount?: number;\n  maxUsagePerUser?: number;\n}\n\nexport interface ApplyDiscountDto {\n  code: string;\n  orderSubtotal: number;\n  userId: string;\n  shippingCost?: number;\n}\n\nexport interface ValidationResult {\n  isValid: boolean;\n  discount?: any;\n  reason?: string;\n}\n\nexport interface ApplyResult {\n  discountAmount: number;\n  finalAmount: number;\n  freeShipping?: boolean;\n  shippingDiscount?: number;\n}\n\nexport class DiscountService {\n  constructor(private discountRepository: DiscountRepository) {}\n\n  async createDiscount(data: CreateDiscountDto) {\n    // Validate percentage discount\n    if (data.type === DiscountType.PERCENTAGE && data.value > 100) {\n      throw new BadRequestError('Percentage discount cannot exceed 100%');\n    }\n\n    // Validate value is positive\n    if (data.value < 0) {\n      throw new BadRequestError('Discount value must be positive');\n    }\n\n    // Normalize code to uppercase\n    const normalizedCode = data.code.toUpperCase();\n\n    const discountData = {\n      ...data,\n      code: normalizedCode,\n      usageCount: 0,\n      isActive: true,\n      createdAt: new Date(),\n    };\n\n    return this.discountRepository.create(discountData);\n  }\n\n  async validateDiscount(code: string): Promise<ValidationResult> {\n    const discount = await this.discountRepository.findByCode(code.toUpperCase());\n\n    if (!discount) {\n      return { isValid: false, reason: 'Discount code not found' };\n    }\n\n    if (!discount.isActive) {\n      return { isValid: false, reason: 'Discount code is not active' };\n    }\n\n    const now = new Date();\n\n    if (discount.expiresAt && discount.expiresAt < now) {\n      return { isValid: false, reason: 'Discount code has expired' };\n    }\n\n    if (discount.startsAt && discount.startsAt > now) {\n      return { isValid: false, reason: 'Discount code is not yet active' };\n    }\n\n    if (discount.maxUsageCount && discount.usageCount >= discount.maxUsageCount) {\n      return { isValid: false, reason: 'Discount code has reached maximum usage limit' };\n    }\n\n    return { isValid: true, discount };\n  }\n\n  async applyDiscount(data: ApplyDiscountDto): Promise<ApplyResult> {\n    const validation = await this.validateDiscount(data.code);\n\n    if (!validation.isValid) {\n      throw new BadRequestError(validation.reason || 'Invalid discount code');\n    }\n\n    const discount = validation.discount;\n\n    // Check minimum purchase requirement\n    if (discount.minPurchaseAmount && data.orderSubtotal < discount.minPurchaseAmount) {\n      throw new BadRequestError(\n        `Order must meet minimum purchase amount of $${discount.minPurchaseAmount}`\n      );\n    }\n\n    // Check per-user usage limit\n    if (discount.maxUsagePerUser) {\n      const userUsages = await this.discountRepository.findByUserId(data.userId);\n      const timesUsed = userUsages.filter(u => u.discountId === discount.id).length;\n\n      if (timesUsed >= discount.maxUsagePerUser) {\n        throw new BadRequestError('You have already used this discount code');\n      }\n    }\n\n    let discountAmount = 0;\n    let freeShipping = false;\n    let shippingDiscount = 0;\n\n    if (discount.type === DiscountType.PERCENTAGE) {\n      discountAmount = (data.orderSubtotal * discount.value) / 100;\n\n      // Apply maximum discount cap if specified\n      if (discount.maxDiscountAmount && discountAmount > discount.maxDiscountAmount) {\n        discountAmount = discount.maxDiscountAmount;\n      }\n    } else if (discount.type === DiscountType.FIXED_AMOUNT) {\n      discountAmount = discount.value;\n\n      // Don't allow discount to exceed order subtotal\n      if (discountAmount > data.orderSubtotal) {\n        discountAmount = data.orderSubtotal;\n      }\n    } else if (discount.type === DiscountType.FREE_SHIPPING) {\n      freeShipping = true;\n      shippingDiscount = data.shippingCost || 0;\n    }\n\n    // Increment usage count\n    await this.discountRepository.incrementUsageCount(discount.id, data.userId);\n\n    return {\n      discountAmount,\n      finalAmount: data.orderSubtotal - discountAmount,\n      freeShipping,\n      shippingDiscount,\n    };\n  }\n\n  async getActiveDiscounts() {\n    return this.discountRepository.findActive();\n  }\n\n  async deactivateDiscount(discountId: string) {\n    await this.discountRepository.findById(discountId);\n    return this.discountRepository.update(discountId, { isActive: false });\n  }\n\n  async getDiscountUsageStats(discountId: string) {\n    const discount = await this.discountRepository.findById(discountId);\n\n    const totalUsage = discount.usageCount || 0;\n    const maxUsage = discount.maxUsageCount || 0;\n    const remainingUsage = maxUsage > 0 ? maxUsage - totalUsage : Infinity;\n    const usagePercentage = maxUsage > 0 ? (totalUsage / maxUsage) * 100 : 0;\n\n    return {\n      totalUsage,\n      remainingUsage: remainingUsage === Infinity ? null : remainingUsage,\n      usagePercentage,\n    };\n  }\n\n  async calculateSavings(code: string, orderSubtotal: number) {\n    const discount = await this.discountRepository.findByCode(code.toUpperCase());\n\n    if (!discount) {\n      return 0;\n    }\n\n    if (discount.type === DiscountType.PERCENTAGE) {\n      let savings = (orderSubtotal * discount.value) / 100;\n\n      if (discount.maxDiscountAmount && savings > discount.maxDiscountAmount) {\n        savings = discount.maxDiscountAmount;\n      }\n\n      return savings;\n    } else if (discount.type === DiscountType.FIXED_AMOUNT) {\n      return Math.min(discount.value, orderSubtotal);\n    }\n\n    return 0;\n  }\n\n  async deleteDiscount(discountId: string) {\n    return this.discountRepository.delete(discountId);\n  }\n}\n"],"version":3}