09d25c05d75c3b5a7a24106ff818abcc
"use strict";
/**
 * Integration Tests: Product Repository with Real Database
 */
Object.defineProperty(exports, "__esModule", { value: true });
const product_repository_1 = require("../../../src/services/product-catalog/repositories/product.repository");
const product_entity_1 = require("../../../src/services/product-catalog/entities/product.entity");
const errors_1 = require("../../../src/libs/errors");
describe('ProductRepository Integration Tests', () => {
    let dataSource;
    let productRepository;
    beforeAll(async () => {
        dataSource = {
            isInitialized: true,
            getRepository: jest.fn(),
        };
    });
    afterAll(async () => {
        if (dataSource?.isInitialized) {
            await dataSource.destroy();
        }
    });
    beforeEach(async () => {
        const repository = dataSource.getRepository(product_entity_1.Product);
        productRepository = new product_repository_1.ProductRepository(repository);
    });
    describe('CRUD Operations', () => {
        it('should create and retrieve product', async () => {
            const productData = {
                name: 'Test Product',
                description: 'Test Description',
                sku: 'TEST-SKU-001',
                price: 99.99,
                inventory: 10,
            };
            const created = await productRepository.createProduct(productData);
            expect(created.id).toBeDefined();
            expect(created.sku).toBe('TEST-SKU-001');
            const retrieved = await productRepository.findById(created.id);
            expect(retrieved.name).toBe('Test Product');
        });
        it('should enforce unique SKU constraint', async () => {
            const productData = {
                name: 'Product',
                description: 'Description',
                sku: 'DUPLICATE-SKU',
                price: 50.00,
                inventory: 5,
            };
            await productRepository.createProduct(productData);
            await expect(productRepository.createProduct(productData)).rejects.toThrow(errors_1.ConflictError);
        });
        it('should update product inventory', async () => {
            const product = await productRepository.createProduct({
                name: 'Inventory Test',
                description: 'Test',
                sku: 'INV-001',
                price: 25.00,
                inventory: 100,
            });
            const updated = await productRepository.updateInventory(product.id, 150);
            expect(updated.inventory).toBe(150);
        });
    });
    describe('Inventory Management', () => {
        it('should decrement inventory correctly', async () => {
            const product = await productRepository.createProduct({
                name: 'Decrement Test',
                description: 'Test',
                sku: 'DEC-001',
                price: 30.00,
                inventory: 100,
            });
            const updated = await productRepository.decrementInventory(product.id, 25);
            expect(updated.inventory).toBe(75);
        });
        it('should increment inventory correctly', async () => {
            const product = await productRepository.createProduct({
                name: 'Increment Test',
                description: 'Test',
                sku: 'INC-001',
                price: 40.00,
                inventory: 50,
            });
            const updated = await productRepository.incrementInventory(product.id, 30);
            expect(updated.inventory).toBe(80);
        });
        it('should find low stock products', async () => {
            await productRepository.createProduct({
                name: 'Low Stock 1',
                description: 'Test',
                sku: 'LOW-001',
                price: 20.00,
                inventory: 3,
                status: product_entity_1.ProductStatus.ACTIVE,
            });
            await productRepository.createProduct({
                name: 'Low Stock 2',
                description: 'Test',
                sku: 'LOW-002',
                price: 20.00,
                inventory: 5,
                status: product_entity_1.ProductStatus.ACTIVE,
            });
            const lowStock = await productRepository.findLowStock(10);
            expect(lowStock.length).toBeGreaterThanOrEqual(2);
            expect(lowStock.every(p => p.inventory <= 10)).toBe(true);
        });
    });
    describe('Search and Filter', () => {
        beforeEach(async () => {
            await productRepository.createProduct({
                name: 'Laptop Computer',
                description: 'High performance laptop',
                sku: 'LAPTOP-001',
                price: 999.99,
                inventory: 10,
                status: product_entity_1.ProductStatus.ACTIVE,
            });
            await productRepository.createProduct({
                name: 'Mouse',
                description: 'Wireless mouse',
                sku: 'MOUSE-001',
                price: 29.99,
                inventory: 50,
                status: product_entity_1.ProductStatus.ACTIVE,
            });
        });
        it('should search products by name', async () => {
            const results = await productRepository.searchProducts('laptop', {});
            expect(results.items.length).toBeGreaterThanOrEqual(1);
            expect(results.items[0].name).toContain('Laptop');
        });
        it('should filter by price range', async () => {
            const results = await productRepository.searchProducts('', {
                minPrice: 20,
                maxPrice: 50,
            });
            expect(results.items.every(p => p.price >= 20 && p.price <= 50)).toBe(true);
        });
        it('should support pagination', async () => {
            const page1 = await productRepository.searchProducts('', {
                page: 1,
                limit: 1,
            });
            expect(page1.items.length).toBeLessThanOrEqual(1);
            expect(page1.page).toBe(1);
            expect(page1.totalPages).toBeGreaterThanOrEqual(1);
        });
    });
    describe('Product Status and Sales', () => {
        it('should find products by status', async () => {
            await productRepository.createProduct({
                name: 'Active Product',
                description: 'Test',
                sku: 'ACTIVE-001',
                price: 50.00,
                inventory: 10,
                status: product_entity_1.ProductStatus.ACTIVE,
            });
            const activeProducts = await productRepository.findByStatus(product_entity_1.ProductStatus.ACTIVE);
            expect(activeProducts.length).toBeGreaterThanOrEqual(1);
            expect(activeProducts.every(p => p.status === product_entity_1.ProductStatus.ACTIVE)).toBe(true);
        });
        it('should track sold count', async () => {
            const product = await productRepository.createProduct({
                name: 'Sales Test',
                description: 'Test',
                sku: 'SALES-001',
                price: 60.00,
                inventory: 100,
            });
            const updated = await productRepository.incrementSoldCount(product.id, 15);
            expect(updated.soldCount).toBe(15);
        });
        it('should find top selling products', async () => {
            const topSelling = await productRepository.findTopSelling(5);
            expect(Array.isArray(topSelling)).toBe(true);
            expect(topSelling.length).toBeLessThanOrEqual(5);
        });
    });
    describe('Ratings and Reviews', () => {
        it('should update product rating', async () => {
            const product = await productRepository.createProduct({
                name: 'Rating Test',
                description: 'Test',
                sku: 'RATING-001',
                price: 45.00,
                inventory: 20,
            });
            const updated = await productRepository.updateRating(product.id, 4.5, 10);
            expect(updated.rating).toBe(4.5);
            expect(updated.reviewCount).toBe(10);
        });
        it('should find top rated products', async () => {
            const topRated = await productRepository.findTopRated(10, 5);
            expect(Array.isArray(topRated)).toBe(true);
        });
    });
    describe('Sale Products', () => {
        it('should find products on sale', async () => {
            await productRepository.createProduct({
                name: 'Sale Product',
                description: 'On sale',
                sku: 'SALE-001',
                price: 79.99,
                compareAtPrice: 99.99,
                inventory: 15,
                status: product_entity_1.ProductStatus.ACTIVE,
            });
            const onSale = await productRepository.findOnSale();
            expect(onSale.length).toBeGreaterThanOrEqual(1);
            expect(onSale.every(p => p.compareAtPrice > p.price)).toBe(true);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXEFkYXB0aXZlX1Rlc3RpbmdcXHRlc3RzXFxpbnRlZ3JhdGlvblxcZGF0YWJhc2VcXHByb2R1Y3QtcmVwb3NpdG9yeS5pbnRlZ3JhdGlvbi50ZXN0LnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7R0FFRzs7QUFHSCw4R0FBMEc7QUFDMUcsa0dBQXVHO0FBQ3ZHLHFEQUF5RDtBQUV6RCxRQUFRLENBQUMscUNBQXFDLEVBQUUsR0FBRyxFQUFFO0lBQ25ELElBQUksVUFBc0IsQ0FBQztJQUMzQixJQUFJLGlCQUFvQyxDQUFDO0lBRXpDLFNBQVMsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNuQixVQUFVLEdBQUc7WUFDWCxhQUFhLEVBQUUsSUFBSTtZQUNuQixhQUFhLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtTQUNBLENBQUM7SUFDN0IsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbEIsSUFBSSxVQUFVLEVBQUUsYUFBYSxFQUFFLENBQUM7WUFDOUIsTUFBTSxVQUFVLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDN0IsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0lBRUgsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ3BCLE1BQU0sVUFBVSxHQUFHLFVBQVUsQ0FBQyxhQUFhLENBQUMsd0JBQU8sQ0FBQyxDQUFDO1FBQ3JELGlCQUFpQixHQUFHLElBQUksc0NBQWlCLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDeEQsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO1FBQy9CLEVBQUUsQ0FBQyxvQ0FBb0MsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNsRCxNQUFNLFdBQVcsR0FBRztnQkFDbEIsSUFBSSxFQUFFLGNBQWM7Z0JBQ3BCLFdBQVcsRUFBRSxrQkFBa0I7Z0JBQy9CLEdBQUcsRUFBRSxjQUFjO2dCQUNuQixLQUFLLEVBQUUsS0FBSztnQkFDWixTQUFTLEVBQUUsRUFBRTthQUNkLENBQUM7WUFFRixN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LEtBQUssRUFBRSxLQUFLO2dCQUNaLGNBQWMsRUFBRSxLQUFLO2dCQUNyQixTQUFTLEVBQUUsRUFBRTtnQkFDYixNQUFNLEVBQUUsOEJBQWEsQ0FBQyxNQUFNO2FBQzdCLENBQUMsQ0FBQztZQUVILE1BQU0sTUFBTSxHQUFHLE1BQU0saUJBQWlCLENBQUMsVUFBVSxFQUFFLENBQUM7WUFFcEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNoRCxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxjQUFlLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BFLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcQWRhcHRpdmVfVGVzdGluZ1xcdGVzdHNcXGludGVncmF0aW9uXFxkYXRhYmFzZVxccHJvZHVjdC1yZXBvc2l0b3J5LmludGVncmF0aW9uLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBJbnRlZ3JhdGlvbiBUZXN0czogUHJvZHVjdCBSZXBvc2l0b3J5IHdpdGggUmVhbCBEYXRhYmFzZVxuICovXG5cbmltcG9ydCB7IERhdGFTb3VyY2UgfSBmcm9tICd0eXBlb3JtJztcbmltcG9ydCB7IFByb2R1Y3RSZXBvc2l0b3J5IH0gZnJvbSAnLi4vLi4vLi4vc3JjL3NlcnZpY2VzL3Byb2R1Y3QtY2F0YWxvZy9yZXBvc2l0b3JpZXMvcHJvZHVjdC5yZXBvc2l0b3J5JztcbmltcG9ydCB7IFByb2R1Y3QsIFByb2R1Y3RTdGF0dXMgfSBmcm9tICcuLi8uLi8uLi9zcmMvc2VydmljZXMvcHJvZHVjdC1jYXRhbG9nL2VudGl0aWVzL3Byb2R1Y3QuZW50aXR5JztcbmltcG9ydCB7IENvbmZsaWN0RXJyb3IgfSBmcm9tICcuLi8uLi8uLi9zcmMvbGlicy9lcnJvcnMnO1xuXG5kZXNjcmliZSgnUHJvZHVjdFJlcG9zaXRvcnkgSW50ZWdyYXRpb24gVGVzdHMnLCAoKSA9PiB7XG4gIGxldCBkYXRhU291cmNlOiBEYXRhU291cmNlO1xuICBsZXQgcHJvZHVjdFJlcG9zaXRvcnk6IFByb2R1Y3RSZXBvc2l0b3J5O1xuXG4gIGJlZm9yZUFsbChhc3luYyAoKSA9PiB7XG4gICAgZGF0YVNvdXJjZSA9IHtcbiAgICAgIGlzSW5pdGlhbGl6ZWQ6IHRydWUsXG4gICAgICBnZXRSZXBvc2l0b3J5OiBqZXN0LmZuKCksXG4gICAgfSBhcyB1bmtub3duIGFzIERhdGFTb3VyY2U7XG4gIH0pO1xuXG4gIGFmdGVyQWxsKGFzeW5jICgpID0+IHtcbiAgICBpZiAoZGF0YVNvdXJjZT8uaXNJbml0aWFsaXplZCkge1xuICAgICAgYXdhaXQgZGF0YVNvdXJjZS5kZXN0cm95KCk7XG4gICAgfVxuICB9KTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCByZXBvc2l0b3J5ID0gZGF0YVNvdXJjZS5nZXRSZXBvc2l0b3J5KFByb2R1Y3QpO1xuICAgIHByb2R1Y3RSZXBvc2l0b3J5ID0gbmV3IFByb2R1Y3RSZXBvc2l0b3J5KHJlcG9zaXRvcnkpO1xuICB9KTtcblxuICBkZXNjcmliZSgnQ1JVRCBPcGVyYXRpb25zJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY3JlYXRlIGFuZCByZXRyaWV2ZSBwcm9kdWN0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcHJvZHVjdERhdGEgPSB7XG4gICAgICAgIG5hbWU6ICdUZXN0IFByb2R1Y3QnLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ1Rlc3QgRGVzY3JpcHRpb24nLFxuICAgICAgICBza3U6ICdURVNULVNLVS0wMDEnLFxuICAgICAgICBwcmljZTogOTkuOTksXG4gICAgICAgIGludmVudG9yeTogMTAsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBjcmVhdGVkID0gYXdhaXQgcHJvZHVjdFJlcG9zaXRvcnkuY3JlYXRlUHJvZHVjdChwcm9kdWN0RGF0YSk7XG5cbiAgICAgIGV4cGVjdChjcmVhdGVkLmlkKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGNyZWF0ZWQuc2t1KS50b0JlKCdURVNULVNLVS0wMDEnKTtcblxuICAgICAgY29uc3QgcmV0cmlldmVkID0gYXdhaXQgcHJvZHVjdFJlcG9zaXRvcnkuZmluZEJ5SWQoY3JlYXRlZC5pZCk7XG4gICAgICBleHBlY3QocmV0cmlldmVkLm5hbWUpLnRvQmUoJ1Rlc3QgUHJvZHVjdCcpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBlbmZvcmNlIHVuaXF1ZSBTS1UgY29uc3RyYWludCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHByb2R1Y3REYXRhID0ge1xuICAgICAgICBuYW1lOiAnUHJvZHVjdCcsXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnRGVzY3JpcHRpb24nLFxuICAgICAgICBza3U6ICdEVVBMSUNBVEUtU0tVJyxcbiAgICAgICAgcHJpY2U6IDUwLjAwLFxuICAgICAgICBpbnZlbnRvcnk6IDUsXG4gICAgICB9O1xuXG4gICAgICBhd2FpdCBwcm9kdWN0UmVwb3NpdG9yeS5jcmVhdGVQcm9kdWN0KHByb2R1Y3REYXRhKTtcblxuICAgICAgYXdhaXQgZXhwZWN0KFxuICAgICAgICBwcm9kdWN0UmVwb3NpdG9yeS5jcmVhdGVQcm9kdWN0KHByb2R1Y3REYXRhKVxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coQ29uZmxpY3RFcnJvcik7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHVwZGF0ZSBwcm9kdWN0IGludmVudG9yeScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHByb2R1Y3QgPSBhd2FpdCBwcm9kdWN0UmVwb3NpdG9yeS5jcmVhdGVQcm9kdWN0KHtcbiAgICAgICAgbmFtZTogJ0ludmVudG9yeSBUZXN0JyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdUZXN0JyxcbiAgICAgICAgc2t1OiAnSU5WLTAwMScsXG4gICAgICAgIHByaWNlOiAyNS4wMCxcbiAgICAgICAgaW52ZW50b3J5OiAxMDAsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgdXBkYXRlZCA9IGF3YWl0IHByb2R1Y3RSZXBvc2l0b3J5LnVwZGF0ZUludmVudG9yeShwcm9kdWN0LmlkLCAxNTApO1xuXG4gICAgICBleHBlY3QodXBkYXRlZC5pbnZlbnRvcnkpLnRvQmUoMTUwKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0ludmVudG9yeSBNYW5hZ2VtZW50JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZGVjcmVtZW50IGludmVudG9yeSBjb3JyZWN0bHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBwcm9kdWN0ID0gYXdhaXQgcHJvZHVjdFJlcG9zaXRvcnkuY3JlYXRlUHJvZHVjdCh7XG4gICAgICAgIG5hbWU6ICdEZWNyZW1lbnQgVGVzdCcsXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnVGVzdCcsXG4gICAgICAgIHNrdTogJ0RFQy0wMDEnLFxuICAgICAgICBwcmljZTogMzAuMDAsXG4gICAgICAgIGludmVudG9yeTogMTAwLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHVwZGF0ZWQgPSBhd2FpdCBwcm9kdWN0UmVwb3NpdG9yeS5kZWNyZW1lbnRJbnZlbnRvcnkocHJvZHVjdC5pZCwgMjUpO1xuXG4gICAgICBleHBlY3QodXBkYXRlZC5pbnZlbnRvcnkpLnRvQmUoNzUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBpbmNyZW1lbnQgaW52ZW50b3J5IGNvcnJlY3RseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHByb2R1Y3QgPSBhd2FpdCBwcm9kdWN0UmVwb3NpdG9yeS5jcmVhdGVQcm9kdWN0KHtcbiAgICAgICAgbmFtZTogJ0luY3JlbWVudCBUZXN0JyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdUZXN0JyxcbiAgICAgICAgc2t1OiAnSU5DLTAwMScsXG4gICAgICAgIHByaWNlOiA0MC4wMCxcbiAgICAgICAgaW52ZW50b3J5OiA1MCxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCB1cGRhdGVkID0gYXdhaXQgcHJvZHVjdFJlcG9zaXRvcnkuaW5jcmVtZW50SW52ZW50b3J5KHByb2R1Y3QuaWQsIDMwKTtcblxuICAgICAgZXhwZWN0KHVwZGF0ZWQuaW52ZW50b3J5KS50b0JlKDgwKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZmluZCBsb3cgc3RvY2sgcHJvZHVjdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBwcm9kdWN0UmVwb3NpdG9yeS5jcmVhdGVQcm9kdWN0KHtcbiAgICAgICAgbmFtZTogJ0xvdyBTdG9jayAxJyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdUZXN0JyxcbiAgICAgICAgc2t1OiAnTE9XLTAwMScsXG4gICAgICAgIHByaWNlOiAyMC4wMCxcbiAgICAgICAgaW52ZW50b3J5OiAzLFxuICAgICAgICBzdGF0dXM6IFByb2R1Y3RTdGF0dXMuQUNUSVZFLFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IHByb2R1Y3RSZXBvc2l0b3J5LmNyZWF0ZVByb2R1Y3Qoe1xuICAgICAgICBuYW1lOiAnTG93IFN0b2NrIDInLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ1Rlc3QnLFxuICAgICAgICBza3U6ICdMT1ctMDAyJyxcbiAgICAgICAgcHJpY2U6IDIwLjAwLFxuICAgICAgICBpbnZlbnRvcnk6IDUsXG4gICAgICAgIHN0YXR1czogUHJvZHVjdFN0YXR1cy5BQ1RJVkUsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgbG93U3RvY2sgPSBhd2FpdCBwcm9kdWN0UmVwb3NpdG9yeS5maW5kTG93U3RvY2soMTApO1xuXG4gICAgICBleHBlY3QobG93U3RvY2subGVuZ3RoKS50b0JlR3JlYXRlclRoYW5PckVxdWFsKDIpO1xuICAgICAgZXhwZWN0KGxvd1N0b2NrLmV2ZXJ5KHAgPT4gcC5pbnZlbnRvcnkgPD0gMTApKS50b0JlKHRydWUpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnU2VhcmNoIGFuZCBGaWx0ZXInLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBwcm9kdWN0UmVwb3NpdG9yeS5jcmVhdGVQcm9kdWN0KHtcbiAgICAgICAgbmFtZTogJ0xhcHRvcCBDb21wdXRlcicsXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnSGlnaCBwZXJmb3JtYW5jZSBsYXB0b3AnLFxuICAgICAgICBza3U6ICdMQVBUT1AtMDAxJyxcbiAgICAgICAgcHJpY2U6IDk5OS45OSxcbiAgICAgICAgaW52ZW50b3J5OiAxMCxcbiAgICAgICAgc3RhdHVzOiBQcm9kdWN0U3RhdHVzLkFDVElWRSxcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCBwcm9kdWN0UmVwb3NpdG9yeS5jcmVhdGVQcm9kdWN0KHtcbiAgICAgICAgbmFtZTogJ01vdXNlJyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdXaXJlbGVzcyBtb3VzZScsXG4gICAgICAgIHNrdTogJ01PVVNFLTAwMScsXG4gICAgICAgIHByaWNlOiAyOS45OSxcbiAgICAgICAgaW52ZW50b3J5OiA1MCxcbiAgICAgICAgc3RhdHVzOiBQcm9kdWN0U3RhdHVzLkFDVElWRSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBzZWFyY2ggcHJvZHVjdHMgYnkgbmFtZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBwcm9kdWN0UmVwb3NpdG9yeS5zZWFyY2hQcm9kdWN0cygnbGFwdG9wJywge30pO1xuXG4gICAgICBleHBlY3QocmVzdWx0cy5pdGVtcy5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbk9yRXF1YWwoMSk7XG4gICAgICBleHBlY3QocmVzdWx0cy5pdGVtc1swXS5uYW1lKS50b0NvbnRhaW4oJ0xhcHRvcCcpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBmaWx0ZXIgYnkgcHJpY2UgcmFuZ2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgcHJvZHVjdFJlcG9zaXRvcnkuc2VhcmNoUHJvZHVjdHMoJycsIHtcbiAgICAgICAgbWluUHJpY2U6IDIwLFxuICAgICAgICBtYXhQcmljZTogNTAsXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0KHJlc3VsdHMuaXRlbXMuZXZlcnkocCA9PiBwLnByaWNlID49IDIwICYmIHAucHJpY2UgPD0gNTApKS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBzdXBwb3J0IHBhZ2luYXRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBwYWdlMSA9IGF3YWl0IHByb2R1Y3RSZXBvc2l0b3J5LnNlYXJjaFByb2R1Y3RzKCcnLCB7XG4gICAgICAgIHBhZ2U6IDEsXG4gICAgICAgIGxpbWl0OiAxLFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChwYWdlMS5pdGVtcy5sZW5ndGgpLnRvQmVMZXNzVGhhbk9yRXF1YWwoMSk7XG4gICAgICBleHBlY3QocGFnZTEucGFnZSkudG9CZSgxKTtcbiAgICAgIGV4cGVjdChwYWdlMS50b3RhbFBhZ2VzKS50b0JlR3JlYXRlclRoYW5PckVxdWFsKDEpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnUHJvZHVjdCBTdGF0dXMgYW5kIFNhbGVzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZmluZCBwcm9kdWN0cyBieSBzdGF0dXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBwcm9kdWN0UmVwb3NpdG9yeS5jcmVhdGVQcm9kdWN0KHtcbiAgICAgICAgbmFtZTogJ0FjdGl2ZSBQcm9kdWN0JyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdUZXN0JyxcbiAgICAgICAgc2t1OiAnQUNUSVZFLTAwMScsXG4gICAgICAgIHByaWNlOiA1MC4wMCxcbiAgICAgICAgaW52ZW50b3J5OiAxMCxcbiAgICAgICAgc3RhdHVzOiBQcm9kdWN0U3RhdHVzLkFDVElWRSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBhY3RpdmVQcm9kdWN0cyA9IGF3YWl0IHByb2R1Y3RSZXBvc2l0b3J5LmZpbmRCeVN0YXR1cyhQcm9kdWN0U3RhdHVzLkFDVElWRSk7XG5cbiAgICAgIGV4cGVjdChhY3RpdmVQcm9kdWN0cy5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbk9yRXF1YWwoMSk7XG4gICAgICBleHBlY3QoYWN0aXZlUHJvZHVjdHMuZXZlcnkocCA9PiBwLnN0YXR1cyA9PT0gUHJvZHVjdFN0YXR1cy5BQ1RJVkUpKS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB0cmFjayBzb2xkIGNvdW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcHJvZHVjdCA9IGF3YWl0IHByb2R1Y3RSZXBvc2l0b3J5LmNyZWF0ZVByb2R1Y3Qoe1xuICAgICAgICBuYW1lOiAnU2FsZXMgVGVzdCcsXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnVGVzdCcsXG4gICAgICAgIHNrdTogJ1NBTEVTLTAwMScsXG4gICAgICAgIHByaWNlOiA2MC4wMCxcbiAgICAgICAgaW52ZW50b3J5OiAxMDAsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgdXBkYXRlZCA9IGF3YWl0IHByb2R1Y3RSZXBvc2l0b3J5LmluY3JlbWVudFNvbGRDb3VudChwcm9kdWN0LmlkLCAxNSk7XG5cbiAgICAgIGV4cGVjdCh1cGRhdGVkLnNvbGRDb3VudCkudG9CZSgxNSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGZpbmQgdG9wIHNlbGxpbmcgcHJvZHVjdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB0b3BTZWxsaW5nID0gYXdhaXQgcHJvZHVjdFJlcG9zaXRvcnkuZmluZFRvcFNlbGxpbmcoNSk7XG5cbiAgICAgIGV4cGVjdChBcnJheS5pc0FycmF5KHRvcFNlbGxpbmcpKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHRvcFNlbGxpbmcubGVuZ3RoKS50b0JlTGVzc1RoYW5PckVxdWFsKDUpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnUmF0aW5ncyBhbmQgUmV2aWV3cycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHVwZGF0ZSBwcm9kdWN0IHJhdGluZycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHByb2R1Y3QgPSBhd2FpdCBwcm9kdWN0UmVwb3NpdG9yeS5jcmVhdGVQcm9kdWN0KHtcbiAgICAgICAgbmFtZTogJ1JhdGluZyBUZXN0JyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdUZXN0JyxcbiAgICAgICAgc2t1OiAnUkFUSU5HLTAwMScsXG4gICAgICAgIHByaWNlOiA0NS4wMCxcbiAgICAgICAgaW52ZW50b3J5OiAyMCxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCB1cGRhdGVkID0gYXdhaXQgcHJvZHVjdFJlcG9zaXRvcnkudXBkYXRlUmF0aW5nKHByb2R1Y3QuaWQsIDQuNSwgMTApO1xuXG4gICAgICBleHBlY3QodXBkYXRlZC5yYXRpbmcpLnRvQmUoNC41KTtcbiAgICAgIGV4cGVjdCh1cGRhdGVkLnJldmlld0NvdW50KS50b0JlKDEwKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZmluZCB0b3AgcmF0ZWQgcHJvZHVjdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB0b3BSYXRlZCA9IGF3YWl0IHByb2R1Y3RSZXBvc2l0b3J5LmZpbmRUb3BSYXRlZCgxMCwgNSk7XG5cbiAgICAgIGV4cGVjdChBcnJheS5pc0FycmF5KHRvcFJhdGVkKSkudG9CZSh0cnVlKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1NhbGUgUHJvZHVjdHMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBmaW5kIHByb2R1Y3RzIG9uIHNhbGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBwcm9kdWN0UmVwb3NpdG9yeS5jcmVhdGVQcm9kdWN0KHtcbiAgICAgICAgbmFtZTogJ1NhbGUgUHJvZHVjdCcsXG4gICAgICAgIGRlc2NyaXB0aW9uOiAnT24gc2FsZScsXG4gICAgICAgIHNrdTogJ1NBTEUtMDAxJyxcbiAgICAgICAgcHJpY2U6IDc5Ljk5LFxuICAgICAgICBjb21wYXJlQXRQcmljZTogOTkuOTksXG4gICAgICAgIGludmVudG9yeTogMTUsXG4gICAgICAgIHN0YXR1czogUHJvZHVjdFN0YXR1cy5BQ1RJVkUsXG4gICAgICB9KTtcblxuICAgICAgY29uc3Qgb25TYWxlID0gYXdhaXQgcHJvZHVjdFJlcG9zaXRvcnkuZmluZE9uU2FsZSgpO1xuXG4gICAgICBleHBlY3Qob25TYWxlLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCgxKTtcbiAgICAgIGV4cGVjdChvblNhbGUuZXZlcnkocCA9PiBwLmNvbXBhcmVBdFByaWNlISA+IHAucHJpY2UpKS50b0JlKHRydWUpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9