7f3f64eb45818c877f9b1a1a5a01047f
"use strict";
/**
 * TDD Implementation: Cart Service
 *
 * Shopping cart management
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.CartService = void 0;
const errors_1 = require("@libs/errors");
class CartService {
    cartStorage;
    constructor(cartStorage) {
        this.cartStorage = cartStorage;
    }
    /**
     * Get cart for user (create if doesn't exist)
     */
    async getCart(userId) {
        let cart = this.cartStorage.get(userId);
        if (!cart) {
            cart = {
                userId,
                items: [],
                subtotal: 0,
                itemCount: 0,
                createdAt: new Date(),
                updatedAt: new Date(),
            };
            this.cartStorage.set(userId, cart);
        }
        return cart;
    }
    /**
     * Add item to cart
     */
    async addItem(userId, item) {
        if (item.quantity <= 0) {
            throw new errors_1.BadRequestError('Quantity must be positive');
        }
        const cart = await this.getCart(userId);
        // Check if item already exists
        const existingItem = cart.items.find(i => i.productId === item.productId);
        if (existingItem) {
            // Update quantity
            existingItem.quantity += item.quantity;
            existingItem.subtotal = existingItem.unitPrice * existingItem.quantity;
        }
        else {
            // Add new item
            cart.items.push({
                ...item,
                subtotal: item.unitPrice * item.quantity,
            });
        }
        // Recalculate cart totals
        this.recalculateCart(cart);
        cart.updatedAt = new Date();
        this.cartStorage.set(userId, cart);
        return cart;
    }
    /**
     * Update item quantity
     */
    async updateItemQuantity(userId, productId, quantity) {
        if (quantity < 0) {
            throw new errors_1.BadRequestError('Quantity must be positive');
        }
        const cart = await this.getCart(userId);
        const item = cart.items.find(i => i.productId === productId);
        if (!item) {
            throw new errors_1.NotFoundError('Item not found in cart');
        }
        if (quantity === 0) {
            // Remove item if quantity is zero
            return this.removeItem(userId, productId);
        }
        item.quantity = quantity;
        item.subtotal = item.unitPrice * item.quantity;
        this.recalculateCart(cart);
        cart.updatedAt = new Date();
        this.cartStorage.set(userId, cart);
        return cart;
    }
    /**
     * Remove item from cart
     */
    async removeItem(userId, productId) {
        const cart = await this.getCart(userId);
        const itemIndex = cart.items.findIndex(i => i.productId === productId);
        if (itemIndex === -1) {
            throw new errors_1.NotFoundError('Item not found in cart');
        }
        cart.items.splice(itemIndex, 1);
        this.recalculateCart(cart);
        cart.updatedAt = new Date();
        this.cartStorage.set(userId, cart);
        return cart;
    }
    /**
     * Clear cart
     */
    async clearCart(userId) {
        const cart = await this.getCart(userId);
        cart.items = [];
        cart.subtotal = 0;
        cart.itemCount = 0;
        cart.updatedAt = new Date();
        this.cartStorage.set(userId, cart);
        return cart;
    }
    /**
     * Get cart item count
     */
    async getCartItemCount(userId) {
        const cart = await this.getCart(userId);
        return cart.itemCount;
    }
    /**
     * Get cart subtotal
     */
    async getCartSubtotal(userId) {
        const cart = await this.getCart(userId);
        return cart.subtotal;
    }
    /**
     * Recalculate cart totals
     */
    recalculateCart(cart) {
        cart.subtotal = cart.items.reduce((sum, item) => sum + item.subtotal, 0);
        cart.itemCount = cart.items.reduce((sum, item) => sum + item.quantity, 0);
    }
}
exports.CartService = CartService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXEFkYXB0aXZlX1Rlc3RpbmdcXHNyY1xcc2VydmljZXNcXG9yZGVyLXByb2Nlc3NpbmdcXHNlcnZpY2VzXFxjYXJ0LnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7O0dBSUc7OztBQUVILHlDQUE4RDtBQTRCOUQsTUFBYSxXQUFXO0lBQ0Y7SUFBcEIsWUFBb0IsV0FBOEI7UUFBOUIsZ0JBQVcsR0FBWCxXQUFXLENBQW1CO0lBQUcsQ0FBQztJQUV0RDs7T0FFRztJQUNILEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBYztRQUMxQixJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUV4QyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDVixJQUFJLEdBQUc7Z0JBQ0wsTUFBTTtnQkFDTixLQUFLLEVBQUUsRUFBRTtnQkFDVCxRQUFRLEVBQUUsQ0FBQztnQkFDWCxTQUFTLEVBQUUsQ0FBQztnQkFDWixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7Z0JBQ3JCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTthQUN0QixDQUFDO1lBQ0YsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3JDLENBQUM7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBYyxFQUFFLElBQWdCO1FBQzVDLElBQUksSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUN2QixNQUFNLElBQUksd0JBQWUsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO1FBQ3pELENBQUM7UUFFRCxNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFeEMsK0JBQStCO1FBQy9CLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxF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LENBQUMsQ0FBQyxDQUFDO1FBQ3pFLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUM1RSxDQUFDO0NBQ0Y7QUFqSkQsa0NBaUpDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxBZGFwdGl2ZV9UZXN0aW5nXFxzcmNcXHNlcnZpY2VzXFxvcmRlci1wcm9jZXNzaW5nXFxzZXJ2aWNlc1xcY2FydC5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVEREIEltcGxlbWVudGF0aW9uOiBDYXJ0IFNlcnZpY2VcbiAqXG4gKiBTaG9wcGluZyBjYXJ0IG1hbmFnZW1lbnRcbiAqL1xuXG5pbXBvcnQgeyBCYWRSZXF1ZXN0RXJyb3IsIE5vdEZvdW5kRXJyb3IgfSBmcm9tICdAbGlicy9lcnJvcnMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIENhcnRJdGVtIHtcbiAgcHJvZHVjdElkOiBzdHJpbmc7XG4gIHByb2R1Y3ROYW1lOiBzdHJpbmc7XG4gIHByb2R1Y3RTa3U6IHN0cmluZztcbiAgdW5pdFByaWNlOiBudW1iZXI7XG4gIHF1YW50aXR5OiBudW1iZXI7XG4gIHN1YnRvdGFsOiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2FydCB7XG4gIHVzZXJJZDogc3RyaW5nO1xuICBpdGVtczogQ2FydEl0ZW1bXTtcbiAgc3VidG90YWw6IG51bWJlcjtcbiAgaXRlbUNvdW50OiBudW1iZXI7XG4gIGNyZWF0ZWRBdDogRGF0ZTtcbiAgdXBkYXRlZEF0OiBEYXRlO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFkZEl0ZW1EdG8ge1xuICBwcm9kdWN0SWQ6IHN0cmluZztcbiAgcHJvZHVjdE5hbWU6IHN0cmluZztcbiAgcHJvZHVjdFNrdTogc3RyaW5nO1xuICB1bml0UHJpY2U6IG51bWJlcjtcbiAgcXVhbnRpdHk6IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIENhcnRTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBjYXJ0U3RvcmFnZTogTWFwPHN0cmluZywgQ2FydD4pIHt9XG5cbiAgLyoqXG4gICAqIEdldCBjYXJ0IGZvciB1c2VyIChjcmVhdGUgaWYgZG9lc24ndCBleGlzdClcbiAgICovXG4gIGFzeW5jIGdldENhcnQodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPENhcnQ+IHtcbiAgICBsZXQgY2FydCA9IHRoaXMuY2FydFN0b3JhZ2UuZ2V0KHVzZXJJZCk7XG5cbiAgICBpZiAoIWNhcnQpIHtcbiAgICAgIGNhcnQgPSB7XG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgaXRlbXM6IFtdLFxuICAgICAgICBzdWJ0b3RhbDogMCxcbiAgICAgICAgaXRlbUNvdW50OiAwLFxuICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIH07XG4gICAgICB0aGlzLmNhcnRTdG9yYWdlLnNldCh1c2VySWQsIGNhcnQpO1xuICAgIH1cblxuICAgIHJldHVybiBjYXJ0O1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBpdGVtIHRvIGNhcnRcbiAgICovXG4gIGFzeW5jIGFkZEl0ZW0odXNlcklkOiBzdHJpbmcsIGl0ZW06IEFkZEl0ZW1EdG8pOiBQcm9taXNlPENhcnQ+IHtcbiAgICBpZiAoaXRlbS5xdWFudGl0eSA8PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEVycm9yKCdRdWFudGl0eSBtdXN0IGJlIHBvc2l0aXZlJyk7XG4gICAgfVxuXG4gICAgY29uc3QgY2FydCA9IGF3YWl0IHRoaXMuZ2V0Q2FydCh1c2VySWQpO1xuXG4gICAgLy8gQ2hlY2sgaWYgaXRlbSBhbHJlYWR5IGV4aXN0c1xuICAgIGNvbnN0IGV4aXN0aW5nSXRlbSA9IGNhcnQuaXRlbXMuZmluZChpID0+IGkucHJvZHVjdElkID09PSBpdGVtLnByb2R1Y3RJZCk7XG5cbiAgICBpZiAoZXhpc3RpbmdJdGVtKSB7XG4gICAgICAvLyBVcGRhdGUgcXVhbnRpdHlcbiAgICAgIGV4aXN0aW5nSXRlbS5xdWFudGl0eSArPSBpdGVtLnF1YW50aXR5O1xuICAgICAgZXhpc3RpbmdJdGVtLnN1YnRvdGFsID0gZXhpc3RpbmdJdGVtLnVuaXRQcmljZSAqIGV4aXN0aW5nSXRlbS5xdWFudGl0eTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQWRkIG5ldyBpdGVtXG4gICAgICBjYXJ0Lml0ZW1zLnB1c2goe1xuICAgICAgICAuLi5pdGVtLFxuICAgICAgICBzdWJ0b3RhbDogaXRlbS51bml0UHJpY2UgKiBpdGVtLnF1YW50aXR5LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gUmVjYWxjdWxhdGUgY2FydCB0b3RhbHNcbiAgICB0aGlzLnJlY2FsY3VsYXRlQ2FydChjYXJ0KTtcbiAgICBjYXJ0LnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCk7XG5cbiAgICB0aGlzLmNhcnRTdG9yYWdlLnNldCh1c2VySWQsIGNhcnQpO1xuICAgIHJldHVybiBjYXJ0O1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSBpdGVtIHF1YW50aXR5XG4gICAqL1xuICBhc3luYyB1cGRhdGVJdGVtUXVhbnRpdHkodXNlcklkOiBzdHJpbmcsIHByb2R1Y3RJZDogc3RyaW5nLCBxdWFudGl0eTogbnVtYmVyKTogUHJvbWlzZTxDYXJ0PiB7XG4gICAgaWYgKHF1YW50aXR5IDwgMCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFcnJvcignUXVhbnRpdHkgbXVzdCBiZSBwb3NpdGl2ZScpO1xuICAgIH1cblxuICAgIGNvbnN0IGNhcnQgPSBhd2FpdCB0aGlzLmdldENhcnQodXNlcklkKTtcbiAgICBjb25zdCBpdGVtID0gY2FydC5pdGVtcy5maW5kKGkgPT4gaS5wcm9kdWN0SWQgPT09IHByb2R1Y3RJZCk7XG5cbiAgICBpZiAoIWl0ZW0pIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEVycm9yKCdJdGVtIG5vdCBmb3VuZCBpbiBjYXJ0Jyk7XG4gICAgfVxuXG4gICAgaWYgKHF1YW50aXR5ID09PSAwKSB7XG4gICAgICAvLyBSZW1vdmUgaXRlbSBpZiBxdWFudGl0eSBpcyB6ZXJvXG4gICAgICByZXR1cm4gdGhpcy5yZW1vdmVJdGVtKHVzZXJJZCwgcHJvZHVjdElkKTtcbiAgICB9XG5cbiAgICBpdGVtLnF1YW50aXR5ID0gcXVhbnRpdHk7XG4gICAgaXRlbS5zdWJ0b3RhbCA9IGl0ZW0udW5pdFByaWNlICogaXRlbS5xdWFudGl0eTtcblxuICAgIHRoaXMucmVjYWxjdWxhdGVDYXJ0KGNhcnQpO1xuICAgIGNhcnQudXBkYXRlZEF0ID0gbmV3IERhdGUoKTtcblxuICAgIHRoaXMuY2FydFN0b3JhZ2Uuc2V0KHVzZXJJZCwgY2FydCk7XG4gICAgcmV0dXJuIGNhcnQ7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIGl0ZW0gZnJvbSBjYXJ0XG4gICAqL1xuICBhc3luYyByZW1vdmVJdGVtKHVzZXJJZDogc3RyaW5nLCBwcm9kdWN0SWQ6IHN0cmluZyk6IFByb21pc2U8Q2FydD4ge1xuICAgIGNvbnN0IGNhcnQgPSBhd2FpdCB0aGlzLmdldENhcnQodXNlcklkKTtcbiAgICBjb25zdCBpdGVtSW5kZXggPSBjYXJ0Lml0ZW1zLmZpbmRJbmRleChpID0+IGkucHJvZHVjdElkID09PSBwcm9kdWN0SWQpO1xuXG4gICAgaWYgKGl0ZW1JbmRleCA9PT0gLTEpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEVycm9yKCdJdGVtIG5vdCBmb3VuZCBpbiBjYXJ0Jyk7XG4gICAgfVxuXG4gICAgY2FydC5pdGVtcy5zcGxpY2UoaXRlbUluZGV4LCAxKTtcblxuICAgIHRoaXMucmVjYWxjdWxhdGVDYXJ0KGNhcnQpO1xuICAgIGNhcnQudXBkYXRlZEF0ID0gbmV3IERhdGUoKTtcblxuICAgIHRoaXMuY2FydFN0b3JhZ2Uuc2V0KHVzZXJJZCwgY2FydCk7XG4gICAgcmV0dXJuIGNhcnQ7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXIgY2FydFxuICAgKi9cbiAgYXN5bmMgY2xlYXJDYXJ0KHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTxDYXJ0PiB7XG4gICAgY29uc3QgY2FydCA9IGF3YWl0IHRoaXMuZ2V0Q2FydCh1c2VySWQpO1xuXG4gICAgY2FydC5pdGVtcyA9IFtdO1xuICAgIGNhcnQuc3VidG90YWwgPSAwO1xuICAgIGNhcnQuaXRlbUNvdW50ID0gMDtcbiAgICBjYXJ0LnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCk7XG5cbiAgICB0aGlzLmNhcnRTdG9yYWdlLnNldCh1c2VySWQsIGNhcnQpO1xuICAgIHJldHVybiBjYXJ0O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjYXJ0IGl0ZW0gY291bnRcbiAgICovXG4gIGFzeW5jIGdldENhcnRJdGVtQ291bnQodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGNvbnN0IGNhcnQgPSBhd2FpdCB0aGlzLmdldENhcnQodXNlcklkKTtcbiAgICByZXR1cm4gY2FydC5pdGVtQ291bnQ7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGNhcnQgc3VidG90YWxcbiAgICovXG4gIGFzeW5jIGdldENhcnRTdWJ0b3RhbCh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3QgY2FydCA9IGF3YWl0IHRoaXMuZ2V0Q2FydCh1c2VySWQpO1xuICAgIHJldHVybiBjYXJ0LnN1YnRvdGFsO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlY2FsY3VsYXRlIGNhcnQgdG90YWxzXG4gICAqL1xuICBwcml2YXRlIHJlY2FsY3VsYXRlQ2FydChjYXJ0OiBDYXJ0KTogdm9pZCB7XG4gICAgY2FydC5zdWJ0b3RhbCA9IGNhcnQuaXRlbXMucmVkdWNlKChzdW0sIGl0ZW0pID0+IHN1bSArIGl0ZW0uc3VidG90YWwsIDApO1xuICAgIGNhcnQuaXRlbUNvdW50ID0gY2FydC5pdGVtcy5yZWR1Y2UoKHN1bSwgaXRlbSkgPT4gc3VtICsgaXRlbS5xdWFudGl0eSwgMCk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==