396f19dbaf728f86e6ebd4f499fb1049
"use strict";
/**
 * Product Review Service Implementation
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.ReviewService = void 0;
const errors_1 = require("@libs/errors");
class ReviewService {
    reviewRepository;
    productRepository;
    orderRepository;
    constructor(reviewRepository, productRepository, orderRepository) {
        this.reviewRepository = reviewRepository;
        this.productRepository = productRepository;
        this.orderRepository = orderRepository;
    }
    async createReview(data) {
        // Validate rating
        if (data.rating < 1 || data.rating > 5) {
            throw new errors_1.BadRequestError('Rating must be between 1 and 5');
        }
        // Check product exists
        await this.productRepository.findById(data.productId);
        // Check for duplicate review
        const existingReviews = await this.reviewRepository.findByProductId(data.productId);
        if (existingReviews.some(r => r.userId === data.userId)) {
            throw new errors_1.BadRequestError('You have already reviewed this product');
        }
        // Check if verified purchase
        const isVerifiedPurchase = await this.orderRepository.hasUserPurchasedProduct(data.userId, data.productId);
        const review = await this.reviewRepository.create({
            ...data,
            isVerifiedPurchase,
            helpfulCount: 0,
            createdAt: new Date(),
        });
        // Update product average rating
        const avgRating = await this.reviewRepository.getAverageRating(data.productId);
        const reviews = await this.reviewRepository.findByProductId(data.productId);
        await this.productRepository.updateRating(data.productId, avgRating, reviews.length);
        return review;
    }
    async getProductReviews(productId, options) {
        let reviews = await this.reviewRepository.findByProductId(productId);
        if (options?.minRating) {
            reviews = reviews.filter(r => r.rating >= options.minRating);
        }
        if (options?.verifiedOnly) {
            reviews = await this.reviewRepository.findVerifiedPurchases(productId);
        }
        if (options?.sortBy === 'helpful') {
            reviews.sort((a, b) => (b.helpfulCount || 0) - (a.helpfulCount || 0));
        }
        if (options?.page && options?.limit) {
            const start = (options.page - 1) * options.limit;
            reviews = reviews.slice(start, start + options.limit);
        }
        return reviews;
    }
    async getUserReviews(userId) {
        return this.reviewRepository.findByUserId(userId);
    }
    async updateReview(reviewId, userId, data) {
        const review = await this.reviewRepository.findById(reviewId);
        if (review.userId !== userId) {
            throw new errors_1.UnauthorizedError('You can only update your own reviews');
        }
        const updated = await this.reviewRepository.update(reviewId, data);
        // Update product rating
        const avgRating = await this.reviewRepository.getAverageRating(review.productId);
        const reviews = await this.reviewRepository.findByProductId(review.productId);
        await this.productRepository.updateRating(review.productId, avgRating, reviews.length);
        return updated;
    }
    async deleteReview(reviewId, userId) {
        const review = await this.reviewRepository.findById(reviewId);
        if (review.userId !== userId) {
            throw new errors_1.UnauthorizedError('You can only delete your own reviews');
        }
        await this.reviewRepository.delete(reviewId);
        // Update product rating
        const avgRating = await this.reviewRepository.getAverageRating(review.productId);
        const reviews = await this.reviewRepository.findByProductId(review.productId);
        await this.productRepository.updateRating(review.productId, avgRating, reviews.length);
    }
    async markReviewAsHelpful(reviewId, userId) {
        const review = await this.reviewRepository.findById(reviewId);
        if (review.userId === userId) {
            throw new errors_1.BadRequestError('You cannot mark your own review as helpful');
        }
        await this.reviewRepository.markAsHelpful(reviewId, userId);
    }
    async getProductRatingDistribution(productId) {
        const reviews = await this.reviewRepository.findByProductId(productId);
        const distribution = {
            fiveStars: reviews.filter(r => r.rating === 5).length,
            fourStars: reviews.filter(r => r.rating === 4).length,
            threeStars: reviews.filter(r => r.rating === 3).length,
            twoStars: reviews.filter(r => r.rating === 2).length,
            oneStars: reviews.filter(r => r.rating === 1).length,
        };
        return distribution;
    }
    async getAverageRating(productId) {
        return this.reviewRepository.getAverageRating(productId);
    }
    async getReviewCount(productId) {
        return this.reviewRepository.countByProductId(productId);
    }
    async getReviewSummary(productId) {
        const [averageRating, totalReviews, distribution] = await Promise.all([
            this.getAverageRating(productId),
            this.getReviewCount(productId),
            this.getProductRatingDistribution(productId),
        ]);
        return {
            averageRating,
            totalReviews,
            distribution,
        };
    }
}
exports.ReviewService = ReviewService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXEFkYXB0aXZlX1Rlc3RpbmdcXHNyY1xcc2VydmljZXNcXHByb2R1Y3QtY2F0YWxvZ1xcc2VydmljZXNcXHJldmlldy5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7R0FFRzs7O0FBS0gseUNBQWtFO0FBZ0JsRSxNQUFhLGFBQWE7SUFFZDtJQUNBO0lBQ0E7SUFIVixZQUNVLGdCQUFrQyxFQUNsQyxpQkFBb0MsRUFDcEMsZUFBZ0M7UUFGaEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3BDLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtJQUN2QyxDQUFDO0lBRUosS0FBSyxDQUFDLFlBQVksQ0FBQyxJQUFxQjtRQUN0QyxrQkFBa0I7UUFDbEIsSUFBSSxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3ZDLE1BQU0sSUFBSSx3QkFBZSxDQUFDLGdDQUFnQyxDQUFDLENBQUM7UUFDOUQsQ0FBQztRQUVELHVCQUF1QjtRQUN2QixNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRXRELDZCQUE2QjtRQUM3QixNQUFNLGVBQWUsR0FBRyxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3BGLElBQUksZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLEtBQUssSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDeEQsTUFBTSxJQUFJLHdCQUFlLENBQUMsd0NBQXdDLENBQUMsQ0FBQztRQUN0RSxDQUFDO1FBRUQsNkJBQTZCO1FBQzdCLE1BQU0sa0JBQWtCLEdBQUcsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLHVCQUF1QixDQUMzRSxJQUFJLENBQUMsTUFB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T0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDM0QsQ0FBQztJQUVELEtBQUssQ0FBQyxjQUFjLENBQUMsU0FBaUI7UUFDcEMsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDM0QsQ0FBQztJQUVELEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFpQjtRQUN0QyxNQUFNLENBQUMsYUFBYSxFQUFFLFlBQVksRUFBRSxZQUFZLENBQUMsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFDcEUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQztZQUNoQyxJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQztZQUM5QixJQUFJLENBQUMsNEJBQTRCLENBQUMsU0FBUyxDQUFDO1NBQzdDLENBQUMsQ0FBQztRQUVILE9BQU87WUFDTCxhQUFhO1lBQ2IsWUFBWTtZQUNaLFlBQVk7U0FDYixDQUFDO0lBQ0osQ0FBQztDQUNGO0FBbkpELHNDQW1KQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcQWRhcHRpdmVfVGVzdGluZ1xcc3JjXFxzZXJ2aWNlc1xccHJvZHVjdC1jYXRhbG9nXFxzZXJ2aWNlc1xccmV2aWV3LnNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBQcm9kdWN0IFJldmlldyBTZXJ2aWNlIEltcGxlbWVudGF0aW9uXG4gKi9cblxuaW1wb3J0IHsgUmV2aWV3UmVwb3NpdG9yeSB9IGZyb20gJy4uL3JlcG9zaXRvcmllcy9yZXZpZXcucmVwb3NpdG9yeSc7XG5pbXBvcnQgeyBQcm9kdWN0UmVwb3NpdG9yeSB9IGZyb20gJy4uL3JlcG9zaXRvcmllcy9wcm9kdWN0LnJlcG9zaXRvcnknO1xuaW1wb3J0IHsgT3JkZXJSZXBvc2l0b3J5IH0gZnJvbSAnLi4vLi4vb3JkZXItcHJvY2Vzc2luZy9yZXBvc2l0b3JpZXMvb3JkZXIucmVwb3NpdG9yeSc7XG5pbXBvcnQgeyBCYWRSZXF1ZXN0RXJyb3IsIFVuYXV0aG9yaXplZEVycm9yIH0gZnJvbSAnQGxpYnMvZXJyb3JzJztcblxuZXhwb3J0IGludGVyZmFjZSBDcmVhdGVSZXZpZXdEdG8ge1xuICBwcm9kdWN0SWQ6IHN0cmluZztcbiAgdXNlcklkOiBzdHJpbmc7XG4gIHJhdGluZzogbnVtYmVyO1xuICB0aXRsZT86IHN0cmluZztcbiAgY29tbWVudD86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBVcGRhdGVSZXZpZXdEdG8ge1xuICByYXRpbmc/OiBudW1iZXI7XG4gIHRpdGxlPzogc3RyaW5nO1xuICBjb21tZW50Pzogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgUmV2aWV3U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmV2aWV3UmVwb3NpdG9yeTogUmV2aWV3UmVwb3NpdG9yeSxcbiAgICBwcml2YXRlIHByb2R1Y3RSZXBvc2l0b3J5OiBQcm9kdWN0UmVwb3NpdG9yeSxcbiAgICBwcml2YXRlIG9yZGVyUmVwb3NpdG9yeTogT3JkZXJSZXBvc2l0b3J5XG4gICkge31cblxuICBhc3luYyBjcmVhdGVSZXZpZXcoZGF0YTogQ3JlYXRlUmV2aWV3RHRvKSB7XG4gICAgLy8gVmFsaWRhdGUgcmF0aW5nXG4gICAgaWYgKGRhdGEucmF0aW5nIDwgMSB8fCBkYXRhLnJhdGluZyA+IDUpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXJyb3IoJ1JhdGluZyBtdXN0IGJlIGJldHdlZW4gMSBhbmQgNScpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIHByb2R1Y3QgZXhpc3RzXG4gICAgYXdhaXQgdGhpcy5wcm9kdWN0UmVwb3NpdG9yeS5maW5kQnlJZChkYXRhLnByb2R1Y3RJZCk7XG5cbiAgICAvLyBDaGVjayBmb3IgZHVwbGljYXRlIHJldmlld1xuICAgIGNvbnN0IGV4aXN0aW5nUmV2aWV3cyA9IGF3YWl0IHRoaXMucmV2aWV3UmVwb3NpdG9yeS5maW5kQnlQcm9kdWN0SWQoZGF0YS5wcm9kdWN0SWQpO1xuICAgIGlmIChleGlzdGluZ1Jldmlld3Muc29tZShyID0+IHIudXNlcklkID09PSBkYXRhLnVzZXJJZCkpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXJyb3IoJ1lvdSBoYXZlIGFscmVhZHkgcmV2aWV3ZWQgdGhpcyBwcm9kdWN0Jyk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgdmVyaWZpZWQgcHVyY2hhc2VcbiAgICBjb25zdCBpc1ZlcmlmaWVkUHVyY2hhc2UgPSBhd2FpdCB0aGlzLm9yZGVyUmVwb3NpdG9yeS5oYXNVc2VyUHVyY2hhc2VkUHJvZHVjdChcbiAgICAgIGRhdGEudXNlcklkLFxuICAgICAgZGF0YS5wcm9kdWN0SWRcbiAgICApO1xuXG4gICAgY29uc3QgcmV2aWV3ID0gYXdhaXQgdGhpcy5yZXZpZXdSZXBvc2l0b3J5LmNyZWF0ZSh7XG4gICAgICAuLi5kYXRhLFxuICAgICAgaXNWZXJpZmllZFB1cmNoYXNlLFxuICAgICAgaGVscGZ1bENvdW50OiAwLFxuICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgIH0pO1xuXG4gICAgLy8gVXBkYXRlIHByb2R1Y3QgYXZlcmFnZSByYXRpbmdcbiAgICBjb25zdCBhdmdSYXRpbmcgPSBhd2FpdCB0aGlzLnJldmlld1JlcG9zaXRvcnkuZ2V0QXZlcmFnZVJhdGluZyhkYXRhLnByb2R1Y3RJZCk7XG4gICAgY29uc3QgcmV2aWV3cyA9IGF3YWl0IHRoaXMucmV2aWV3UmVwb3NpdG9yeS5maW5kQnlQcm9kdWN0SWQoZGF0YS5wcm9kdWN0SWQpO1xuICAgIGF3YWl0IHRoaXMucHJvZHVjdFJlcG9zaXRvcnkudXBkYXRlUmF0aW5nKGRhdGEucHJvZHVjdElkLCBhdmdSYXRpbmcsIHJldmlld3MubGVuZ3RoKTtcblxuICAgIHJldHVybiByZXZpZXc7XG4gIH1cblxuICBhc3luYyBnZXRQcm9kdWN0UmV2aWV3cyhwcm9kdWN0SWQ6IHN0cmluZywgb3B0aW9ucz86IGFueSkge1xuICAgIGxldCByZXZpZXdzID0gYXdhaXQgdGhpcy5yZXZpZXdSZXBvc2l0b3J5LmZpbmRCeVByb2R1Y3RJZChwcm9kdWN0SWQpO1xuXG4gICAgaWYgKG9wdGlvbnM/Lm1pblJhdGluZykge1xuICAgICAgcmV2aWV3cyA9IHJldmlld3MuZmlsdGVyKHIgPT4gci5yYXRpbmcgPj0gb3B0aW9ucy5taW5SYXRpbmcpO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zPy52ZXJpZmllZE9ubHkpIHtcbiAgICAgIHJldmlld3MgPSBhd2FpdCB0aGlzLnJldmlld1JlcG9zaXRvcnkuZmluZFZlcmlmaWVkUHVyY2hhc2VzKHByb2R1Y3RJZCk7XG4gICAgfVxuXG4gICAgaWYgKG9wdGlvbnM/LnNvcnRCeSA9PT0gJ2hlbHBmdWwnKSB7XG4gICAgICByZXZpZXdzLnNvcnQoKGEsIGIpID0+IChiLmhlbHBmdWxDb3VudCB8fCAwKSAtIChhLmhlbHBmdWxDb3VudCB8fCAwKSk7XG4gICAgfVxuXG4gICAgaWYgKG9wdGlvbnM/LnBhZ2UgJiYgb3B0aW9ucz8ubGltaXQpIHtcbiAgICAgIGNvbnN0IHN0YXJ0ID0gKG9wdGlvbnMucGFnZSAtIDEpICogb3B0aW9ucy5saW1pdDtcbiAgICAgIHJldmlld3MgPSByZXZpZXdzLnNsaWNlKHN0YXJ0LCBzdGFydCArIG9wdGlvbnMubGltaXQpO1xuICAgIH1cblxuICAgIHJldHVybiByZXZpZXdzO1xuICB9XG5cbiAgYXN5bmMgZ2V0VXNlclJldmlld3ModXNlcklkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5yZXZpZXdSZXBvc2l0b3J5LmZpbmRCeVVzZXJJZCh1c2VySWQpO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlUmV2aWV3KHJldmlld0lkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nLCBkYXRhOiBVcGRhdGVSZXZpZXdEdG8pIHtcbiAgICBjb25zdCByZXZpZXcgPSBhd2FpdCB0aGlzLnJldmlld1JlcG9zaXRvcnkuZmluZEJ5SWQocmV2aWV3SWQpO1xuXG4gICAgaWYgKHJldmlldy51c2VySWQgIT09IHVzZXJJZCkge1xuICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEVycm9yKCdZb3UgY2FuIG9ubHkgdXBkYXRlIHlvdXIgb3duIHJldmlld3MnKTtcbiAgICB9XG5cbiAgICBjb25zdCB1cGRhdGVkID0gYXdhaXQgdGhpcy5yZXZpZXdSZXBvc2l0b3J5LnVwZGF0ZShyZXZpZXdJZCwgZGF0YSk7XG5cbiAgICAvLyBVcGRhdGUgcHJvZHVjdCByYXRpbmdcbiAgICBjb25zdCBhdmdSYXRpbmcgPSBhd2FpdCB0aGlzLnJldmlld1JlcG9zaXRvcnkuZ2V0QXZlcmFnZVJhdGluZyhyZXZpZXcucHJvZHVjdElkKTtcbiAgICBjb25zdCByZXZpZXdzID0gYXdhaXQgdGhpcy5yZXZpZXdSZXBvc2l0b3J5LmZpbmRCeVByb2R1Y3RJZChyZXZpZXcucHJvZHVjdElkKTtcbiAgICBhd2FpdCB0aGlzLnByb2R1Y3RSZXBvc2l0b3J5LnVwZGF0ZVJhdGluZyhyZXZpZXcucHJvZHVjdElkLCBhdmdSYXRpbmcsIHJldmlld3MubGVuZ3RoKTtcblxuICAgIHJldHVybiB1cGRhdGVkO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlUmV2aWV3KHJldmlld0lkOiBzdHJpbmcsIHVzZXJJZDogc3RyaW5nKSB7XG4gICAgY29uc3QgcmV2aWV3ID0gYXdhaXQgdGhpcy5yZXZpZXdSZXBvc2l0b3J5LmZpbmRCeUlkKHJldmlld0lkKTtcblxuICAgIGlmIChyZXZpZXcudXNlcklkICE9PSB1c2VySWQpIHtcbiAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFcnJvcignWW91IGNhbiBvbmx5IGRlbGV0ZSB5b3VyIG93biByZXZpZXdzJyk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5yZXZpZXdSZXBvc2l0b3J5LmRlbGV0ZShyZXZpZXdJZCk7XG5cbiAgICAvLyBVcGRhdGUgcHJvZHVjdCByYXRpbmdcbiAgICBjb25zdCBhdmdSYXRpbmcgPSBhd2FpdCB0aGlzLnJldmlld1JlcG9zaXRvcnkuZ2V0QXZlcmFnZVJhdGluZyhyZXZpZXcucHJvZHVjdElkKTtcbiAgICBjb25zdCByZXZpZXdzID0gYXdhaXQgdGhpcy5yZXZpZXdSZXBvc2l0b3J5LmZpbmRCeVByb2R1Y3RJZChyZXZpZXcucHJvZHVjdElkKTtcbiAgICBhd2FpdCB0aGlzLnByb2R1Y3RSZXBvc2l0b3J5LnVwZGF0ZVJhdGluZyhyZXZpZXcucHJvZHVjdElkLCBhdmdSYXRpbmcsIHJldmlld3MubGVuZ3RoKTtcbiAgfVxuXG4gIGFzeW5jIG1hcmtSZXZpZXdBc0hlbHBmdWwocmV2aWV3SWQ6IHN0cmluZywgdXNlcklkOiBzdHJpbmcpIHtcbiAgICBjb25zdCByZXZpZXcgPSBhd2FpdCB0aGlzLnJldmlld1JlcG9zaXRvcnkuZmluZEJ5SWQocmV2aWV3SWQpO1xuXG4gICAgaWYgKHJldmlldy51c2VySWQgPT09IHVzZXJJZCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFcnJvcignWW91IGNhbm5vdCBtYXJrIHlvdXIgb3duIHJldmlldyBhcyBoZWxwZnVsJyk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5yZXZpZXdSZXBvc2l0b3J5Lm1hcmtBc0hlbHBmdWwocmV2aWV3SWQsIHVzZXJJZCk7XG4gIH1cblxuICBhc3luYyBnZXRQcm9kdWN0UmF0aW5nRGlzdHJpYnV0aW9uKHByb2R1Y3RJZDogc3RyaW5nKSB7XG4gICAgY29uc3QgcmV2aWV3cyA9IGF3YWl0IHRoaXMucmV2aWV3UmVwb3NpdG9yeS5maW5kQnlQcm9kdWN0SWQocHJvZHVjdElkKTtcblxuICAgIGNvbnN0IGRpc3RyaWJ1dGlvbiA9IHtcbiAgICAgIGZpdmVTdGFyczogcmV2aWV3cy5maWx0ZXIociA9PiByLnJhdGluZyA9PT0gNSkubGVuZ3RoLFxuICAgICAgZm91clN0YXJzOiByZXZpZXdzLmZpbHRlcihyID0+IHIucmF0aW5nID09PSA0KS5sZW5ndGgsXG4gICAgICB0aHJlZVN0YXJzOiByZXZpZXdzLmZpbHRlcihyID0+IHIucmF0aW5nID09PSAzKS5sZW5ndGgsXG4gICAgICB0d29TdGFyczogcmV2aWV3cy5maWx0ZXIociA9PiByLnJhdGluZyA9PT0gMikubGVuZ3RoLFxuICAgICAgb25lU3RhcnM6IHJldmlld3MuZmlsdGVyKHIgPT4gci5yYXRpbmcgPT09IDEpLmxlbmd0aCxcbiAgICB9O1xuXG4gICAgcmV0dXJuIGRpc3RyaWJ1dGlvbjtcbiAgfVxuXG4gIGFzeW5jIGdldEF2ZXJhZ2VSYXRpbmcocHJvZHVjdElkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5yZXZpZXdSZXBvc2l0b3J5LmdldEF2ZXJhZ2VSYXRpbmcocHJvZHVjdElkKTtcbiAgfVxuXG4gIGFzeW5jIGdldFJldmlld0NvdW50KHByb2R1Y3RJZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMucmV2aWV3UmVwb3NpdG9yeS5jb3VudEJ5UHJvZHVjdElkKHByb2R1Y3RJZCk7XG4gIH1cblxuICBhc3luYyBnZXRSZXZpZXdTdW1tYXJ5KHByb2R1Y3RJZDogc3RyaW5nKSB7XG4gICAgY29uc3QgW2F2ZXJhZ2VSYXRpbmcsIHRvdGFsUmV2aWV3cywgZGlzdHJpYnV0aW9uXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgIHRoaXMuZ2V0QXZlcmFnZVJhdGluZyhwcm9kdWN0SWQpLFxuICAgICAgdGhpcy5nZXRSZXZpZXdDb3VudChwcm9kdWN0SWQpLFxuICAgICAgdGhpcy5nZXRQcm9kdWN0UmF0aW5nRGlzdHJpYnV0aW9uKHByb2R1Y3RJZCksXG4gICAgXSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgYXZlcmFnZVJhdGluZyxcbiAgICAgIHRvdGFsUmV2aWV3cyxcbiAgICAgIGRpc3RyaWJ1dGlvbixcbiAgICB9O1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=