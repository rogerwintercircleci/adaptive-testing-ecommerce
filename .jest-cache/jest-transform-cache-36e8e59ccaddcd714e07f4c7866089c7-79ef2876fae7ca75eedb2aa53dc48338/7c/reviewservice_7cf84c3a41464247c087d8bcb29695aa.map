{"file":"C:\\Adaptive_Testing\\src\\services\\product-catalog\\services\\review.service.ts","mappings":"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","names":[],"sources":["C:\\Adaptive_Testing\\src\\services\\product-catalog\\services\\review.service.ts"],"sourcesContent":["/**\n * Product Review Service Implementation\n */\n\nimport { ReviewRepository } from '../repositories/review.repository';\nimport { ProductRepository } from '../repositories/product.repository';\nimport { OrderRepository } from '../../order-processing/repositories/order.repository';\nimport { BadRequestError, UnauthorizedError } from '@libs/errors';\n\nexport interface CreateReviewDto {\n  productId: string;\n  userId: string;\n  rating: number;\n  title?: string;\n  comment?: string;\n}\n\nexport interface UpdateReviewDto {\n  rating?: number;\n  title?: string;\n  comment?: string;\n}\n\nexport class ReviewService {\n  constructor(\n    private reviewRepository: ReviewRepository,\n    private productRepository: ProductRepository,\n    private orderRepository: OrderRepository\n  ) {}\n\n  async createReview(data: CreateReviewDto) {\n    // Validate rating\n    if (data.rating < 1 || data.rating > 5) {\n      throw new BadRequestError('Rating must be between 1 and 5');\n    }\n\n    // Check product exists\n    await this.productRepository.findById(data.productId);\n\n    // Check for duplicate review\n    const existingReviews = await this.reviewRepository.findByProductId(data.productId);\n    if (existingReviews.some(r => r.userId === data.userId)) {\n      throw new BadRequestError('You have already reviewed this product');\n    }\n\n    // Check if verified purchase\n    const isVerifiedPurchase = await this.orderRepository.hasUserPurchasedProduct(\n      data.userId,\n      data.productId\n    );\n\n    const review = await this.reviewRepository.create({\n      ...data,\n      isVerifiedPurchase,\n      helpfulCount: 0,\n      createdAt: new Date(),\n    });\n\n    // Update product average rating\n    const avgRating = await this.reviewRepository.getAverageRating(data.productId);\n    const reviews = await this.reviewRepository.findByProductId(data.productId);\n    await this.productRepository.updateRating(data.productId, avgRating, reviews.length);\n\n    return review;\n  }\n\n  async getProductReviews(productId: string, options?: any) {\n    let reviews = await this.reviewRepository.findByProductId(productId);\n\n    if (options?.minRating) {\n      reviews = reviews.filter(r => r.rating >= options.minRating);\n    }\n\n    if (options?.verifiedOnly) {\n      reviews = await this.reviewRepository.findVerifiedPurchases(productId);\n    }\n\n    if (options?.sortBy === 'helpful') {\n      reviews.sort((a, b) => (b.helpfulCount || 0) - (a.helpfulCount || 0));\n    }\n\n    if (options?.page && options?.limit) {\n      const start = (options.page - 1) * options.limit;\n      reviews = reviews.slice(start, start + options.limit);\n    }\n\n    return reviews;\n  }\n\n  async getUserReviews(userId: string) {\n    return this.reviewRepository.findByUserId(userId);\n  }\n\n  async updateReview(reviewId: string, userId: string, data: UpdateReviewDto) {\n    const review = await this.reviewRepository.findById(reviewId);\n\n    if (review.userId !== userId) {\n      throw new UnauthorizedError('You can only update your own reviews');\n    }\n\n    const updated = await this.reviewRepository.update(reviewId, data);\n\n    // Update product rating\n    const avgRating = await this.reviewRepository.getAverageRating(review.productId);\n    const reviews = await this.reviewRepository.findByProductId(review.productId);\n    await this.productRepository.updateRating(review.productId, avgRating, reviews.length);\n\n    return updated;\n  }\n\n  async deleteReview(reviewId: string, userId: string) {\n    const review = await this.reviewRepository.findById(reviewId);\n\n    if (review.userId !== userId) {\n      throw new UnauthorizedError('You can only delete your own reviews');\n    }\n\n    await this.reviewRepository.delete(reviewId);\n\n    // Update product rating\n    const avgRating = await this.reviewRepository.getAverageRating(review.productId);\n    const reviews = await this.reviewRepository.findByProductId(review.productId);\n    await this.productRepository.updateRating(review.productId, avgRating, reviews.length);\n  }\n\n  async markReviewAsHelpful(reviewId: string, userId: string) {\n    const review = await this.reviewRepository.findById(reviewId);\n\n    if (review.userId === userId) {\n      throw new BadRequestError('You cannot mark your own review as helpful');\n    }\n\n    await this.reviewRepository.markAsHelpful(reviewId, userId);\n  }\n\n  async getProductRatingDistribution(productId: string) {\n    const reviews = await this.reviewRepository.findByProductId(productId);\n\n    const distribution = {\n      fiveStars: reviews.filter(r => r.rating === 5).length,\n      fourStars: reviews.filter(r => r.rating === 4).length,\n      threeStars: reviews.filter(r => r.rating === 3).length,\n      twoStars: reviews.filter(r => r.rating === 2).length,\n      oneStars: reviews.filter(r => r.rating === 1).length,\n    };\n\n    return distribution;\n  }\n\n  async getAverageRating(productId: string) {\n    return this.reviewRepository.getAverageRating(productId);\n  }\n\n  async getReviewCount(productId: string) {\n    return this.reviewRepository.countByProductId(productId);\n  }\n\n  async getReviewSummary(productId: string) {\n    const [averageRating, totalReviews, distribution] = await Promise.all([\n      this.getAverageRating(productId),\n      this.getReviewCount(productId),\n      this.getProductRatingDistribution(productId),\n    ]);\n\n    return {\n      averageRating,\n      totalReviews,\n      distribution,\n    };\n  }\n}\n"],"version":3}