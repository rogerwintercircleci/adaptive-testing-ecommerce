3d6f9018249b2a4c5ea47ac614b325d2
"use strict";
/**
 * Unit Tests: Authentication Middleware
 *
 * Testing JWT authentication and authorization middleware
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
jest.mock('./jwt.utils');
const auth_middleware_1 = require("./auth.middleware");
const errors_1 = require("../errors");
const jwtUtils = __importStar(require("./jwt.utils"));
describe('Authentication Middleware', () => {
    let mockRequest;
    let mockResponse;
    let mockNext;
    beforeEach(() => {
        mockRequest = {
            headers: {},
            user: undefined,
        };
        mockResponse = {};
        mockNext = jest.fn();
    });
    describe('authenticate', () => {
        it('should authenticate valid token', () => {
            const mockPayload = {
                userId: '123',
                email: 'test@example.com',
                role: 'customer',
            };
            mockRequest.headers = {
                authorization: 'Bearer valid-token',
            };
            jwtUtils.extractTokenFromHeader.mockReturnValue('valid-token');
            jwtUtils.verifyAccessToken.mockReturnValue(mockPayload);
            (0, auth_middleware_1.authenticate)(mockRequest, mockResponse, mockNext);
            expect(mockRequest.user).toEqual(mockPayload);
            expect(mockNext).toHaveBeenCalledWith();
        });
        it('should reject request without authorization header', () => {
            jwtUtils.extractTokenFromHeader.mockReturnValue(null);
            (0, auth_middleware_1.authenticate)(mockRequest, mockResponse, mockNext);
            expect(mockNext).toHaveBeenCalledWith(expect.any(errors_1.UnauthorizedError));
        });
        it('should reject invalid token', () => {
            mockRequest.headers = {
                authorization: 'Bearer invalid-token',
            };
            jwtUtils.extractTokenFromHeader.mockReturnValue('invalid-token');
            jwtUtils.verifyAccessToken.mockImplementation(() => {
                throw new errors_1.UnauthorizedError('Invalid token');
            });
            (0, auth_middleware_1.authenticate)(mockRequest, mockResponse, mockNext);
            expect(mockNext).toHaveBeenCalledWith(expect.any(errors_1.UnauthorizedError));
        });
        it('should reject expired token', () => {
            mockRequest.headers = {
                authorization: 'Bearer expired-token',
            };
            jwtUtils.extractTokenFromHeader.mockReturnValue('expired-token');
            jwtUtils.verifyAccessToken.mockImplementation(() => {
                throw new errors_1.UnauthorizedError('Token expired');
            });
            (0, auth_middleware_1.authenticate)(mockRequest, mockResponse, mockNext);
            expect(mockNext).toHaveBeenCalledWith(expect.any(errors_1.UnauthorizedError));
        });
        it('should reject malformed authorization header', () => {
            mockRequest.headers = {
                authorization: 'InvalidFormat token',
            };
            jwtUtils.extractTokenFromHeader.mockReturnValue(null);
            (0, auth_middleware_1.authenticate)(mockRequest, mockResponse, mockNext);
            expect(mockNext).toHaveBeenCalledWith(expect.any(errors_1.UnauthorizedError));
        });
    });
    describe('optionalAuthenticate', () => {
        it('should attach user if valid token provided', () => {
            const mockPayload = {
                userId: '123',
                email: 'test@example.com',
                role: 'customer',
            };
            mockRequest.headers = {
                authorization: 'Bearer valid-token',
            };
            jwtUtils.extractTokenFromHeader.mockReturnValue('valid-token');
            jwtUtils.verifyAccessToken.mockReturnValue(mockPayload);
            (0, auth_middleware_1.optionalAuthenticate)(mockRequest, mockResponse, mockNext);
            expect(mockRequest.user).toEqual(mockPayload);
            expect(mockNext).toHaveBeenCalledWith();
        });
        it('should not fail if no token provided', () => {
            jwtUtils.extractTokenFromHeader.mockReturnValue(null);
            (0, auth_middleware_1.optionalAuthenticate)(mockRequest, mockResponse, mockNext);
            expect(mockRequest.user).toBeUndefined();
            expect(mockNext).toHaveBeenCalledWith();
        });
        it('should ignore invalid token and continue', () => {
            mockRequest.headers = {
                authorization: 'Bearer invalid-token',
            };
            jwtUtils.extractTokenFromHeader.mockReturnValue('invalid-token');
            jwtUtils.verifyAccessToken.mockImplementation(() => {
                throw new errors_1.UnauthorizedError('Invalid token');
            });
            (0, auth_middleware_1.optionalAuthenticate)(mockRequest, mockResponse, mockNext);
            expect(mockRequest.user).toBeUndefined();
            expect(mockNext).toHaveBeenCalledWith();
        });
        it('should ignore expired token and continue', () => {
            mockRequest.headers = {
                authorization: 'Bearer expired-token',
            };
            jwtUtils.extractTokenFromHeader.mockReturnValue('expired-token');
            jwtUtils.verifyAccessToken.mockImplementation(() => {
                throw new errors_1.UnauthorizedError('Token expired');
            });
            (0, auth_middleware_1.optionalAuthenticate)(mockRequest, mockResponse, mockNext);
            expect(mockRequest.user).toBeUndefined();
            expect(mockNext).toHaveBeenCalledWith();
        });
    });
    describe('authorize', () => {
        it('should authorize user with allowed role', () => {
            mockRequest.user = {
                userId: '123',
                email: 'admin@example.com',
                role: 'admin',
            };
            const middleware = (0, auth_middleware_1.authorize)('admin', 'vendor');
            middleware(mockRequest, mockResponse, mockNext);
            expect(mockNext).toHaveBeenCalledWith();
        });
        it('should reject user without allowed role', () => {
            mockRequest.user = {
                userId: '123',
                email: 'customer@example.com',
                role: 'customer',
            };
            const middleware = (0, auth_middleware_1.authorize)('admin', 'vendor');
            middleware(mockRequest, mockResponse, mockNext);
            expect(mockNext).toHaveBeenCalledWith(expect.any(errors_1.ForbiddenError));
        });
        it('should reject unauthenticated user', () => {
            mockRequest.user = undefined;
            const middleware = (0, auth_middleware_1.authorize)('admin');
            middleware(mockRequest, mockResponse, mockNext);
            expect(mockNext).toHaveBeenCalledWith(expect.any(errors_1.UnauthorizedError));
        });
        it('should handle single role', () => {
            mockRequest.user = {
                userId: '123',
                email: 'admin@example.com',
                role: 'admin',
            };
            const middleware = (0, auth_middleware_1.authorize)('admin');
            middleware(mockRequest, mockResponse, mockNext);
            expect(mockNext).toHaveBeenCalledWith();
        });
        it('should handle multiple roles', () => {
            mockRequest.user = {
                userId: '123',
                email: 'vendor@example.com',
                role: 'vendor',
            };
            const middleware = (0, auth_middleware_1.authorize)('admin', 'vendor', 'customer');
            middleware(mockRequest, mockResponse, mockNext);
            expect(mockNext).toHaveBeenCalledWith();
        });
    });
    describe('authorizeOwnerOrAdmin', () => {
        const getUserId = (req) => req.params.userId;
        it('should allow resource owner to access', () => {
            mockRequest.user = {
                userId: '123',
                email: 'user@example.com',
                role: 'customer',
            };
            mockRequest.params = { userId: '123' };
            const middleware = (0, auth_middleware_1.authorizeOwnerOrAdmin)(getUserId);
            middleware(mockRequest, mockResponse, mockNext);
            expect(mockNext).toHaveBeenCalledWith();
        });
        it('should allow admin to access any resource', () => {
            mockRequest.user = {
                userId: 'admin-id',
                email: 'admin@example.com',
                role: 'admin',
            };
            mockRequest.params = { userId: 'other-user-id' };
            const middleware = (0, auth_middleware_1.authorizeOwnerOrAdmin)(getUserId);
            middleware(mockRequest, mockResponse, mockNext);
            expect(mockNext).toHaveBeenCalledWith();
        });
        it('should reject non-owner non-admin', () => {
            mockRequest.user = {
                userId: '123',
                email: 'user@example.com',
                role: 'customer',
            };
            mockRequest.params = { userId: '456' };
            const middleware = (0, auth_middleware_1.authorizeOwnerOrAdmin)(getUserId);
            middleware(mockRequest, mockResponse, mockNext);
            expect(mockNext).toHaveBeenCalledWith(expect.any(errors_1.ForbiddenError));
        });
        it('should reject unauthenticated user', () => {
            mockRequest.user = undefined;
            mockRequest.params = { userId: '123' };
            const middleware = (0, auth_middleware_1.authorizeOwnerOrAdmin)(getUserId);
            middleware(mockRequest, mockResponse, mockNext);
            expect(mockNext).toHaveBeenCalledWith(expect.any(errors_1.UnauthorizedError));
        });
        it('should work with custom getUserId function', () => {
            const getOrderUserId = (req) => req.body.userId;
            mockRequest.user = {
                userId: '123',
                email: 'user@example.com',
                role: 'customer',
            };
            mockRequest.body = { userId: '123' };
            const middleware = (0, auth_middleware_1.authorizeOwnerOrAdmin)(getOrderUserId);
            middleware(mockRequest, mockResponse, mockNext);
            expect(mockNext).toHaveBeenCalledWith();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXEFkYXB0aXZlX1Rlc3RpbmdcXHNyY1xcbGlic1xcYXV0aFxcYXV0aC5taWRkbGV3YXJlLnNwZWMudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7O0dBSUc7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBWUgsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztBQVR6Qix1REFLMkI7QUFDM0Isc0NBQThEO0FBQzlELHNEQUF3QztBQUl4QyxRQUFRLENBQUMsMkJBQTJCLEVBQUUsR0FBRyxFQUFFO0lBQ3pDLElBQUksV0FBNkIsQ0FBQztJQUNsQyxJQUFJLFlBQStCLENBQUM7SUFDcEMsSUFBSSxRQUFzQixDQUFDO0lBRTNCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxXQUFXLEdBQUc7WUFDWixPQUFPLEVBQUUsRUFBRTtZQUNYLElBQUksRUFBRSxTQUFTO1NBQ2hCLENBQUM7UUFDRixZQUFZLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLFFBQVEsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7SUFDdkIsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsY0FBYyxFQUFFLEdBQUcsRUFBRTtRQUM1QixFQUFFLENBQUMsaUNBQWlDLEVBQUUsR0FBRyxFQUFFO1lBQ3pDLE1BQU0sV0FBVyxHQUFHO2dCQUNsQixNQUFNLEVBQUUsS0FBSztnQkFDYixLQUFLLEVBQUUsa0JBQWtCO2dCQUN6QixJQUFJLEVBQUUsVUFBVTthQUNqQixDQUFDO1lBRUYsV0FBVyxDQUFDLE9BQU8sR0FBRztnQkFDcEIsYUFBYSxFQUFFLG9CQUFvQjthQUNwQyxDQUFDO1lBRUQsUUFBUSxDQUFDLHNCQUFvQyxDQUFDLGVBQWUsQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUM3RSxRQUFRLENBQUMsaUJBQStCLENBQUMsZUFBZSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRXZFLElBQUEsOEJBQVksRUFBQyxXQUFzQixFQUFFLFlBQXdCLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFFekUsTUFB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LENBQUM7WUFDN0IsV0FBVyxDQUFDLE1BQU0sR0FBRyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQztZQUV2QyxNQUFNLFVBQVUsR0FBRyxJQUFBLHVDQUFxQixFQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRXBELFVBQVUsQ0FBQyxXQUFzQixFQUFFLFlBQXdCLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFFdkUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsMEJBQWlCLENBQUMsQ0FBQyxDQUFDO1FBQ3ZFLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLDRDQUE0QyxFQUFFLEdBQUcsRUFBRTtZQUNwRCxNQUFNLGNBQWMsR0FBRyxDQUFDLEdBQVksRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7WUFFekQsV0FBVyxDQUFDLElBQUksR0FBRztnQkFDakIsTUFBTSxFQUFFLEtBQUs7Z0JBQ2IsS0FBSyxFQUFFLGtCQUFrQjtnQkFDekIsSUFBSSxFQUFFLFVBQVU7YUFDakIsQ0FBQztZQUNGLFdBQVcsQ0FBQyxJQUFJLEdBQUcsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUM7WUFFckMsTUFBTSxVQUFVLEdBQUcsSUFBQSx1Q0FBcUIsRUFBQyxjQUFjLENBQUMsQ0FBQztZQUV6RCxVQUFVLENBQUMsV0FBc0IsRUFBRSxZQUF3QixFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBRXZFLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBQzFDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcQWRhcHRpdmVfVGVzdGluZ1xcc3JjXFxsaWJzXFxhdXRoXFxhdXRoLm1pZGRsZXdhcmUuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFVuaXQgVGVzdHM6IEF1dGhlbnRpY2F0aW9uIE1pZGRsZXdhcmVcbiAqXG4gKiBUZXN0aW5nIEpXVCBhdXRoZW50aWNhdGlvbiBhbmQgYXV0aG9yaXphdGlvbiBtaWRkbGV3YXJlXG4gKi9cblxuaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHtcbiAgYXV0aGVudGljYXRlLFxuICBvcHRpb25hbEF1dGhlbnRpY2F0ZSxcbiAgYXV0aG9yaXplLFxuICBhdXRob3JpemVPd25lck9yQWRtaW4sXG59IGZyb20gJy4vYXV0aC5taWRkbGV3YXJlJztcbmltcG9ydCB7IFVuYXV0aG9yaXplZEVycm9yLCBGb3JiaWRkZW5FcnJvciB9IGZyb20gJy4uL2Vycm9ycyc7XG5pbXBvcnQgKiBhcyBqd3RVdGlscyBmcm9tICcuL2p3dC51dGlscyc7XG5cbmplc3QubW9jaygnLi9qd3QudXRpbHMnKTtcblxuZGVzY3JpYmUoJ0F1dGhlbnRpY2F0aW9uIE1pZGRsZXdhcmUnLCAoKSA9PiB7XG4gIGxldCBtb2NrUmVxdWVzdDogUGFydGlhbDxSZXF1ZXN0PjtcbiAgbGV0IG1vY2tSZXNwb25zZTogUGFydGlhbDxSZXNwb25zZT47XG4gIGxldCBtb2NrTmV4dDogTmV4dEZ1bmN0aW9uO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIG1vY2tSZXF1ZXN0ID0ge1xuICAgICAgaGVhZGVyczoge30sXG4gICAgICB1c2VyOiB1bmRlZmluZWQsXG4gICAgfTtcbiAgICBtb2NrUmVzcG9uc2UgPSB7fTtcbiAgICBtb2NrTmV4dCA9IGplc3QuZm4oKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2F1dGhlbnRpY2F0ZScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGF1dGhlbnRpY2F0ZSB2YWxpZCB0b2tlbicsICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tQYXlsb2FkID0ge1xuICAgICAgICB1c2VySWQ6ICcxMjMnLFxuICAgICAgICBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLFxuICAgICAgICByb2xlOiAnY3VzdG9tZXInLFxuICAgICAgfTtcblxuICAgICAgbW9ja1JlcXVlc3QuaGVhZGVycyA9IHtcbiAgICAgICAgYXV0aG9yaXphdGlvbjogJ0JlYXJlciB2YWxpZC10b2tlbicsXG4gICAgICB9O1xuXG4gICAgICAoand0VXRpbHMuZXh0cmFjdFRva2VuRnJvbUhlYWRlciBhcyBqZXN0Lk1vY2spLm1vY2tSZXR1cm5WYWx1ZSgndmFsaWQtdG9rZW4nKTtcbiAgICAgIChqd3RVdGlscy52ZXJpZnlBY2Nlc3NUb2tlbiBhcyBqZXN0Lk1vY2spLm1vY2tSZXR1cm5WYWx1ZShtb2NrUGF5bG9hZCk7XG5cbiAgICAgIGF1dGhlbnRpY2F0ZShtb2NrUmVxdWVzdCBhcyBSZXF1ZXN0LCBtb2NrUmVzcG9uc2UgYXMgUmVzcG9uc2UsIG1vY2tOZXh0KTtcblxuICAgICAgZXhwZWN0KG1vY2tSZXF1ZXN0LnVzZXIpLnRvRXF1YWwobW9ja1BheWxvYWQpO1xuICAgICAgZXhwZWN0KG1vY2tOZXh0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZWplY3QgcmVxdWVzdCB3aXRob3V0IGF1dGhvcml6YXRpb24gaGVhZGVyJywgKCkgPT4ge1xuICAgICAgKGp3dFV0aWxzLmV4dHJhY3RUb2tlbkZyb21IZWFkZXIgYXMgamVzdC5Nb2NrKS5tb2NrUmV0dXJuVmFsdWUobnVsbCk7XG5cbiAgICAgIGF1dGhlbnRpY2F0ZShtb2NrUmVxdWVzdCBhcyBSZXF1ZXN0LCBtb2NrUmVzcG9uc2UgYXMgUmVzcG9uc2UsIG1vY2tOZXh0KTtcblxuICAgICAgZXhwZWN0KG1vY2tOZXh0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChleHBlY3QuYW55KFVuYXV0aG9yaXplZEVycm9yKSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlamVjdCBpbnZhbGlkIHRva2VuJywgKCkgPT4ge1xuICAgICAgbW9ja1JlcXVlc3QuaGVhZGVycyA9IHtcbiAgICAgICAgYXV0aG9yaXphdGlvbjogJ0JlYXJlciBpbnZhbGlkLXRva2VuJyxcbiAgICAgIH07XG5cbiAgICAgIChqd3RVdGlscy5leHRyYWN0VG9rZW5Gcm9tSGVhZGVyIGFzIGplc3QuTW9jaykubW9ja1JldHVyblZhbHVlKCdpbnZhbGlkLXRva2VuJyk7XG4gICAgICAoand0VXRpbHMudmVyaWZ5QWNjZXNzVG9rZW4gYXMgamVzdC5Nb2NrKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4ge1xuICAgICAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXJyb3IoJ0ludmFsaWQgdG9rZW4nKTtcbiAgICAgIH0pO1xuXG4gICAgICBhdXRoZW50aWNhdGUobW9ja1JlcXVlc3QgYXMgUmVxdWVzdCwgbW9ja1Jlc3BvbnNlIGFzIFJlc3BvbnNlLCBtb2NrTmV4dCk7XG5cbiAgICAgIGV4cGVjdChtb2NrTmV4dCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoZXhwZWN0LmFueShVbmF1dGhvcml6ZWRFcnJvcikpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZWplY3QgZXhwaXJlZCB0b2tlbicsICgpID0+IHtcbiAgICAgIG1vY2tSZXF1ZXN0LmhlYWRlcnMgPSB7XG4gICAgICAgIGF1dGhvcml6YXRpb246ICdCZWFyZXIgZXhwaXJlZC10b2tlbicsXG4gICAgICB9O1xuXG4gICAgICAoand0VXRpbHMuZXh0cmFjdFRva2VuRnJvbUhlYWRlciBhcyBqZXN0Lk1vY2spLm1vY2tSZXR1cm5WYWx1ZSgnZXhwaXJlZC10b2tlbicpO1xuICAgICAgKGp3dFV0aWxzLnZlcmlmeUFjY2Vzc1Rva2VuIGFzIGplc3QuTW9jaykubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IHtcbiAgICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEVycm9yKCdUb2tlbiBleHBpcmVkJyk7XG4gICAgICB9KTtcblxuICAgICAgYXV0aGVudGljYXRlKG1vY2tSZXF1ZXN0IGFzIFJlcXVlc3QsIG1vY2tSZXNwb25zZSBhcyBSZXNwb25zZSwgbW9ja05leHQpO1xuXG4gICAgICBleHBlY3QobW9ja05leHQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGV4cGVjdC5hbnkoVW5hdXRob3JpemVkRXJyb3IpKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmVqZWN0IG1hbGZvcm1lZCBhdXRob3JpemF0aW9uIGhlYWRlcicsICgpID0+IHtcbiAgICAgIG1vY2tSZXF1ZXN0LmhlYWRlcnMgPSB7XG4gICAgICAgIGF1dGhvcml6YXRpb246ICdJbnZhbGlkRm9ybWF0IHRva2VuJyxcbiAgICAgIH07XG5cbiAgICAgIChqd3RVdGlscy5leHRyYWN0VG9rZW5Gcm9tSGVhZGVyIGFzIGplc3QuTW9jaykubW9ja1JldHVyblZhbHVlKG51bGwpO1xuXG4gICAgICBhdXRoZW50aWNhdGUobW9ja1JlcXVlc3QgYXMgUmVxdWVzdCwgbW9ja1Jlc3BvbnNlIGFzIFJlc3BvbnNlLCBtb2NrTmV4dCk7XG5cbiAgICAgIGV4cGVjdChtb2NrTmV4dCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoZXhwZWN0LmFueShVbmF1dGhvcml6ZWRFcnJvcikpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnb3B0aW9uYWxBdXRoZW50aWNhdGUnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBhdHRhY2ggdXNlciBpZiB2YWxpZCB0b2tlbiBwcm92aWRlZCcsICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tQYXlsb2FkID0ge1xuICAgICAgICB1c2VySWQ6ICcxMjMnLFxuICAgICAgICBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLFxuICAgICAgICByb2xlOiAnY3VzdG9tZXInLFxuICAgICAgfTtcblxuICAgICAgbW9ja1JlcXVlc3QuaGVhZGVycyA9IHtcbiAgICAgICAgYXV0aG9yaXphdGlvbjogJ0JlYXJlciB2YWxpZC10b2tlbicsXG4gICAgICB9O1xuXG4gICAgICAoand0VXRpbHMuZXh0cmFjdFRva2VuRnJvbUhlYWRlciBhcyBqZXN0Lk1vY2spLm1vY2tSZXR1cm5WYWx1ZSgndmFsaWQtdG9rZW4nKTtcbiAgICAgIChqd3RVdGlscy52ZXJpZnlBY2Nlc3NUb2tlbiBhcyBqZXN0Lk1vY2spLm1vY2tSZXR1cm5WYWx1ZShtb2NrUGF5bG9hZCk7XG5cbiAgICAgIG9wdGlvbmFsQXV0aGVudGljYXRlKG1vY2tSZXF1ZXN0IGFzIFJlcXVlc3QsIG1vY2tSZXNwb25zZSBhcyBSZXNwb25zZSwgbW9ja05leHQpO1xuXG4gICAgICBleHBlY3QobW9ja1JlcXVlc3QudXNlcikudG9FcXVhbChtb2NrUGF5bG9hZCk7XG4gICAgICBleHBlY3QobW9ja05leHQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIG5vdCBmYWlsIGlmIG5vIHRva2VuIHByb3ZpZGVkJywgKCkgPT4ge1xuICAgICAgKGp3dFV0aWxzLmV4dHJhY3RUb2tlbkZyb21IZWFkZXIgYXMgamVzdC5Nb2NrKS5tb2NrUmV0dXJuVmFsdWUobnVsbCk7XG5cbiAgICAgIG9wdGlvbmFsQXV0aGVudGljYXRlKG1vY2tSZXF1ZXN0IGFzIFJlcXVlc3QsIG1vY2tSZXNwb25zZSBhcyBSZXNwb25zZSwgbW9ja05leHQpO1xuXG4gICAgICBleHBlY3QobW9ja1JlcXVlc3QudXNlcikudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KG1vY2tOZXh0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBpZ25vcmUgaW52YWxpZCB0b2tlbiBhbmQgY29udGludWUnLCAoKSA9PiB7XG4gICAgICBtb2NrUmVxdWVzdC5oZWFkZXJzID0ge1xuICAgICAgICBhdXRob3JpemF0aW9uOiAnQmVhcmVyIGludmFsaWQtdG9rZW4nLFxuICAgICAgfTtcblxuICAgICAgKGp3dFV0aWxzLmV4dHJhY3RUb2tlbkZyb21IZWFkZXIgYXMgamVzdC5Nb2NrKS5tb2NrUmV0dXJuVmFsdWUoJ2ludmFsaWQtdG9rZW4nKTtcbiAgICAgIChqd3RVdGlscy52ZXJpZnlBY2Nlc3NUb2tlbiBhcyBqZXN0Lk1vY2spLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB7XG4gICAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFcnJvcignSW52YWxpZCB0b2tlbicpO1xuICAgICAgfSk7XG5cbiAgICAgIG9wdGlvbmFsQXV0aGVudGljYXRlKG1vY2tSZXF1ZXN0IGFzIFJlcXVlc3QsIG1vY2tSZXNwb25zZSBhcyBSZXNwb25zZSwgbW9ja05leHQpO1xuXG4gICAgICBleHBlY3QobW9ja1JlcXVlc3QudXNlcikudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KG1vY2tOZXh0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBpZ25vcmUgZXhwaXJlZCB0b2tlbiBhbmQgY29udGludWUnLCAoKSA9PiB7XG4gICAgICBtb2NrUmVxdWVzdC5oZWFkZXJzID0ge1xuICAgICAgICBhdXRob3JpemF0aW9uOiAnQmVhcmVyIGV4cGlyZWQtdG9rZW4nLFxuICAgICAgfTtcblxuICAgICAgKGp3dFV0aWxzLmV4dHJhY3RUb2tlbkZyb21IZWFkZXIgYXMgamVzdC5Nb2NrKS5tb2NrUmV0dXJuVmFsdWUoJ2V4cGlyZWQtdG9rZW4nKTtcbiAgICAgIChqd3RVdGlscy52ZXJpZnlBY2Nlc3NUb2tlbiBhcyBqZXN0Lk1vY2spLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB7XG4gICAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFcnJvcignVG9rZW4gZXhwaXJlZCcpO1xuICAgICAgfSk7XG5cbiAgICAgIG9wdGlvbmFsQXV0aGVudGljYXRlKG1vY2tSZXF1ZXN0IGFzIFJlcXVlc3QsIG1vY2tSZXNwb25zZSBhcyBSZXNwb25zZSwgbW9ja05leHQpO1xuXG4gICAgICBleHBlY3QobW9ja1JlcXVlc3QudXNlcikudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KG1vY2tOZXh0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnYXV0aG9yaXplJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgYXV0aG9yaXplIHVzZXIgd2l0aCBhbGxvd2VkIHJvbGUnLCAoKSA9PiB7XG4gICAgICBtb2NrUmVxdWVzdC51c2VyID0ge1xuICAgICAgICB1c2VySWQ6ICcxMjMnLFxuICAgICAgICBlbWFpbDogJ2FkbWluQGV4YW1wbGUuY29tJyxcbiAgICAgICAgcm9sZTogJ2FkbWluJyxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IG1pZGRsZXdhcmUgPSBhdXRob3JpemUoJ2FkbWluJywgJ3ZlbmRvcicpO1xuXG4gICAgICBtaWRkbGV3YXJlKG1vY2tSZXF1ZXN0IGFzIFJlcXVlc3QsIG1vY2tSZXNwb25zZSBhcyBSZXNwb25zZSwgbW9ja05leHQpO1xuXG4gICAgICBleHBlY3QobW9ja05leHQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlamVjdCB1c2VyIHdpdGhvdXQgYWxsb3dlZCByb2xlJywgKCkgPT4ge1xuICAgICAgbW9ja1JlcXVlc3QudXNlciA9IHtcbiAgICAgICAgdXNlcklkOiAnMTIzJyxcbiAgICAgICAgZW1haWw6ICdjdXN0b21lckBleGFtcGxlLmNvbScsXG4gICAgICAgIHJvbGU6ICdjdXN0b21lcicsXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBtaWRkbGV3YXJlID0gYXV0aG9yaXplKCdhZG1pbicsICd2ZW5kb3InKTtcblxuICAgICAgbWlkZGxld2FyZShtb2NrUmVxdWVzdCBhcyBSZXF1ZXN0LCBtb2NrUmVzcG9uc2UgYXMgUmVzcG9uc2UsIG1vY2tOZXh0KTtcblxuICAgICAgZXhwZWN0KG1vY2tOZXh0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChleHBlY3QuYW55KEZvcmJpZGRlbkVycm9yKSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlamVjdCB1bmF1dGhlbnRpY2F0ZWQgdXNlcicsICgpID0+IHtcbiAgICAgIG1vY2tSZXF1ZXN0LnVzZXIgPSB1bmRlZmluZWQ7XG5cbiAgICAgIGNvbnN0IG1pZGRsZXdhcmUgPSBhdXRob3JpemUoJ2FkbWluJyk7XG5cbiAgICAgIG1pZGRsZXdhcmUobW9ja1JlcXVlc3QgYXMgUmVxdWVzdCwgbW9ja1Jlc3BvbnNlIGFzIFJlc3BvbnNlLCBtb2NrTmV4dCk7XG5cbiAgICAgIGV4cGVjdChtb2NrTmV4dCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoZXhwZWN0LmFueShVbmF1dGhvcml6ZWRFcnJvcikpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgc2luZ2xlIHJvbGUnLCAoKSA9PiB7XG4gICAgICBtb2NrUmVxdWVzdC51c2VyID0ge1xuICAgICAgICB1c2VySWQ6ICcxMjMnLFxuICAgICAgICBlbWFpbDogJ2FkbWluQGV4YW1wbGUuY29tJyxcbiAgICAgICAgcm9sZTogJ2FkbWluJyxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IG1pZGRsZXdhcmUgPSBhdXRob3JpemUoJ2FkbWluJyk7XG5cbiAgICAgIG1pZGRsZXdhcmUobW9ja1JlcXVlc3QgYXMgUmVxdWVzdCwgbW9ja1Jlc3BvbnNlIGFzIFJlc3BvbnNlLCBtb2NrTmV4dCk7XG5cbiAgICAgIGV4cGVjdChtb2NrTmV4dCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIG11bHRpcGxlIHJvbGVzJywgKCkgPT4ge1xuICAgICAgbW9ja1JlcXVlc3QudXNlciA9IHtcbiAgICAgICAgdXNlcklkOiAnMTIzJyxcbiAgICAgICAgZW1haWw6ICd2ZW5kb3JAZXhhbXBsZS5jb20nLFxuICAgICAgICByb2xlOiAndmVuZG9yJyxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IG1pZGRsZXdhcmUgPSBhdXRob3JpemUoJ2FkbWluJywgJ3ZlbmRvcicsICdjdXN0b21lcicpO1xuXG4gICAgICBtaWRkbGV3YXJlKG1vY2tSZXF1ZXN0IGFzIFJlcXVlc3QsIG1vY2tSZXNwb25zZSBhcyBSZXNwb25zZSwgbW9ja05leHQpO1xuXG4gICAgICBleHBlY3QobW9ja05leHQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdhdXRob3JpemVPd25lck9yQWRtaW4nLCAoKSA9PiB7XG4gICAgY29uc3QgZ2V0VXNlcklkID0gKHJlcTogUmVxdWVzdCkgPT4gcmVxLnBhcmFtcy51c2VySWQ7XG5cbiAgICBpdCgnc2hvdWxkIGFsbG93IHJlc291cmNlIG93bmVyIHRvIGFjY2VzcycsICgpID0+IHtcbiAgICAgIG1vY2tSZXF1ZXN0LnVzZXIgPSB7XG4gICAgICAgIHVzZXJJZDogJzEyMycsXG4gICAgICAgIGVtYWlsOiAndXNlckBleGFtcGxlLmNvbScsXG4gICAgICAgIHJvbGU6ICdjdXN0b21lcicsXG4gICAgICB9O1xuICAgICAgbW9ja1JlcXVlc3QucGFyYW1zID0geyB1c2VySWQ6ICcxMjMnIH07XG5cbiAgICAgIGNvbnN0IG1pZGRsZXdhcmUgPSBhdXRob3JpemVPd25lck9yQWRtaW4oZ2V0VXNlcklkKTtcblxuICAgICAgbWlkZGxld2FyZShtb2NrUmVxdWVzdCBhcyBSZXF1ZXN0LCBtb2NrUmVzcG9uc2UgYXMgUmVzcG9uc2UsIG1vY2tOZXh0KTtcblxuICAgICAgZXhwZWN0KG1vY2tOZXh0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBhbGxvdyBhZG1pbiB0byBhY2Nlc3MgYW55IHJlc291cmNlJywgKCkgPT4ge1xuICAgICAgbW9ja1JlcXVlc3QudXNlciA9IHtcbiAgICAgICAgdXNlcklkOiAnYWRtaW4taWQnLFxuICAgICAgICBlbWFpbDogJ2FkbWluQGV4YW1wbGUuY29tJyxcbiAgICAgICAgcm9sZTogJ2FkbWluJyxcbiAgICAgIH07XG4gICAgICBtb2NrUmVxdWVzdC5wYXJhbXMgPSB7IHVzZXJJZDogJ290aGVyLXVzZXItaWQnIH07XG5cbiAgICAgIGNvbnN0IG1pZGRsZXdhcmUgPSBhdXRob3JpemVPd25lck9yQWRtaW4oZ2V0VXNlcklkKTtcblxuICAgICAgbWlkZGxld2FyZShtb2NrUmVxdWVzdCBhcyBSZXF1ZXN0LCBtb2NrUmVzcG9uc2UgYXMgUmVzcG9uc2UsIG1vY2tOZXh0KTtcblxuICAgICAgZXhwZWN0KG1vY2tOZXh0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZWplY3Qgbm9uLW93bmVyIG5vbi1hZG1pbicsICgpID0+IHtcbiAgICAgIG1vY2tSZXF1ZXN0LnVzZXIgPSB7XG4gICAgICAgIHVzZXJJZDogJzEyMycsXG4gICAgICAgIGVtYWlsOiAndXNlckBleGFtcGxlLmNvbScsXG4gICAgICAgIHJvbGU6ICdjdXN0b21lcicsXG4gICAgICB9O1xuICAgICAgbW9ja1JlcXVlc3QucGFyYW1zID0geyB1c2VySWQ6ICc0NTYnIH07XG5cbiAgICAgIGNvbnN0IG1pZGRsZXdhcmUgPSBhdXRob3JpemVPd25lck9yQWRtaW4oZ2V0VXNlcklkKTtcblxuICAgICAgbWlkZGxld2FyZShtb2NrUmVxdWVzdCBhcyBSZXF1ZXN0LCBtb2NrUmVzcG9uc2UgYXMgUmVzcG9uc2UsIG1vY2tOZXh0KTtcblxuICAgICAgZXhwZWN0KG1vY2tOZXh0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChleHBlY3QuYW55KEZvcmJpZGRlbkVycm9yKSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlamVjdCB1bmF1dGhlbnRpY2F0ZWQgdXNlcicsICgpID0+IHtcbiAgICAgIG1vY2tSZXF1ZXN0LnVzZXIgPSB1bmRlZmluZWQ7XG4gICAgICBtb2NrUmVxdWVzdC5wYXJhbXMgPSB7IHVzZXJJZDogJzEyMycgfTtcblxuICAgICAgY29uc3QgbWlkZGxld2FyZSA9IGF1dGhvcml6ZU93bmVyT3JBZG1pbihnZXRVc2VySWQpO1xuXG4gICAgICBtaWRkbGV3YXJlKG1vY2tSZXF1ZXN0IGFzIFJlcXVlc3QsIG1vY2tSZXNwb25zZSBhcyBSZXNwb25zZSwgbW9ja05leHQpO1xuXG4gICAgICBleHBlY3QobW9ja05leHQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGV4cGVjdC5hbnkoVW5hdXRob3JpemVkRXJyb3IpKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgd29yayB3aXRoIGN1c3RvbSBnZXRVc2VySWQgZnVuY3Rpb24nLCAoKSA9PiB7XG4gICAgICBjb25zdCBnZXRPcmRlclVzZXJJZCA9IChyZXE6IFJlcXVlc3QpID0+IHJlcS5ib2R5LnVzZXJJZDtcblxuICAgICAgbW9ja1JlcXVlc3QudXNlciA9IHtcbiAgICAgICAgdXNlcklkOiAnMTIzJyxcbiAgICAgICAgZW1haWw6ICd1c2VyQGV4YW1wbGUuY29tJyxcbiAgICAgICAgcm9sZTogJ2N1c3RvbWVyJyxcbiAgICAgIH07XG4gICAgICBtb2NrUmVxdWVzdC5ib2R5ID0geyB1c2VySWQ6ICcxMjMnIH07XG5cbiAgICAgIGNvbnN0IG1pZGRsZXdhcmUgPSBhdXRob3JpemVPd25lck9yQWRtaW4oZ2V0T3JkZXJVc2VySWQpO1xuXG4gICAgICBtaWRkbGV3YXJlKG1vY2tSZXF1ZXN0IGFzIFJlcXVlc3QsIG1vY2tSZXNwb25zZSBhcyBSZXNwb25zZSwgbW9ja05leHQpO1xuXG4gICAgICBleHBlY3QobW9ja05leHQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=