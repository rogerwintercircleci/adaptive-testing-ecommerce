3d12431facc7f77a2dc6b55cc8adbc74
"use strict";
/**
 * Unit Tests: JWT Utilities
 *
 * Testing JWT token generation and verification
 */
Object.defineProperty(exports, "__esModule", { value: true });
const jwt_utils_1 = require("./jwt.utils");
const errors_1 = require("../errors");
describe('JWT Utilities', () => {
    const mockPayload = {
        userId: '123',
        email: 'test@example.com',
        role: 'customer',
    };
    describe('generateAccessToken', () => {
        it('should generate valid access token', () => {
            const token = (0, jwt_utils_1.generateAccessToken)(mockPayload);
            expect(token).toBeDefined();
            expect(typeof token).toBe('string');
            expect(token.split('.')).toHaveLength(3);
        });
        it('should include payload data in token', () => {
            const token = (0, jwt_utils_1.generateAccessToken)(mockPayload);
            const decoded = (0, jwt_utils_1.decodeToken)(token);
            expect(decoded?.userId).toBe(mockPayload.userId);
            expect(decoded?.email).toBe(mockPayload.email);
            expect(decoded?.role).toBe(mockPayload.role);
        });
        it('should generate different tokens for same payload', () => {
            const token1 = (0, jwt_utils_1.generateAccessToken)(mockPayload);
            const token2 = (0, jwt_utils_1.generateAccessToken)(mockPayload);
            // Tokens will differ due to iat (issued at) timestamp
            expect(token1).not.toBe(token2);
        });
    });
    describe('generateRefreshToken', () => {
        it('should generate valid refresh token', () => {
            const token = (0, jwt_utils_1.generateRefreshToken)(mockPayload);
            expect(token).toBeDefined();
            expect(typeof token).toBe('string');
            expect(token.split('.')).toHaveLength(3);
        });
        it('should generate different token than access token', () => {
            const accessToken = (0, jwt_utils_1.generateAccessToken)(mockPayload);
            const refreshToken = (0, jwt_utils_1.generateRefreshToken)(mockPayload);
            expect(accessToken).not.toBe(refreshToken);
        });
    });
    describe('verifyAccessToken', () => {
        it('should verify valid access token', () => {
            const token = (0, jwt_utils_1.generateAccessToken)(mockPayload);
            const verified = (0, jwt_utils_1.verifyAccessToken)(token);
            expect(verified.userId).toBe(mockPayload.userId);
            expect(verified.email).toBe(mockPayload.email);
            expect(verified.role).toBe(mockPayload.role);
            expect(verified.iat).toBeDefined();
            expect(verified.exp).toBeDefined();
        });
        it('should throw UnauthorizedError for invalid token', () => {
            expect(() => (0, jwt_utils_1.verifyAccessToken)('invalid.token.here')).toThrow(errors_1.UnauthorizedError);
        });
        it('should throw UnauthorizedError for malformed token', () => {
            expect(() => (0, jwt_utils_1.verifyAccessToken)('not-a-jwt')).toThrow(errors_1.UnauthorizedError);
        });
        it('should reject refresh token as access token', () => {
            const refreshToken = (0, jwt_utils_1.generateRefreshToken)(mockPayload);
            expect(() => (0, jwt_utils_1.verifyAccessToken)(refreshToken)).toThrow(errors_1.UnauthorizedError);
        });
    });
    describe('verifyRefreshToken', () => {
        it('should verify valid refresh token', () => {
            const token = (0, jwt_utils_1.generateRefreshToken)(mockPayload);
            const verified = (0, jwt_utils_1.verifyRefreshToken)(token);
            expect(verified.userId).toBe(mockPayload.userId);
            expect(verified.email).toBe(mockPayload.email);
            expect(verified.role).toBe(mockPayload.role);
        });
        it('should throw UnauthorizedError for invalid token', () => {
            expect(() => (0, jwt_utils_1.verifyRefreshToken)('invalid.token.here')).toThrow(errors_1.UnauthorizedError);
        });
        it('should reject access token as refresh token', () => {
            const accessToken = (0, jwt_utils_1.generateAccessToken)(mockPayload);
            expect(() => (0, jwt_utils_1.verifyRefreshToken)(accessToken)).toThrow(errors_1.UnauthorizedError);
        });
    });
    describe('decodeToken', () => {
        it('should decode token without verification', () => {
            const token = (0, jwt_utils_1.generateAccessToken)(mockPayload);
            const decoded = (0, jwt_utils_1.decodeToken)(token);
            expect(decoded).toBeDefined();
            expect(decoded?.userId).toBe(mockPayload.userId);
        });
        it('should return null for invalid token', () => {
            const decoded = (0, jwt_utils_1.decodeToken)('invalid-token');
            expect(decoded).toBeNull();
        });
        it('should decode expired token', () => {
            // Even expired tokens can be decoded
            const token = (0, jwt_utils_1.generateAccessToken)(mockPayload);
            const decoded = (0, jwt_utils_1.decodeToken)(token);
            expect(decoded).toBeDefined();
        });
    });
    describe('extractTokenFromHeader', () => {
        it('should extract token from valid Bearer header', () => {
            const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';
            const header = `Bearer ${token}`;
            const extracted = (0, jwt_utils_1.extractTokenFromHeader)(header);
            expect(extracted).toBe(token);
        });
        it('should return null for missing header', () => {
            const extracted = (0, jwt_utils_1.extractTokenFromHeader)(undefined);
            expect(extracted).toBeNull();
        });
        it('should return null for malformed header', () => {
            const extracted = (0, jwt_utils_1.extractTokenFromHeader)('InvalidHeader token');
            expect(extracted).toBeNull();
        });
        it('should return null for header without token', () => {
            const extracted = (0, jwt_utils_1.extractTokenFromHeader)('Bearer');
            expect(extracted).toBeNull();
        });
        it('should return null for token without Bearer prefix', () => {
            const extracted = (0, jwt_utils_1.extractTokenFromHeader)('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...');
            expect(extracted).toBeNull();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXEFkYXB0aXZlX1Rlc3RpbmdcXHNyY1xcbGlic1xcYXV0aFxcand0LnV0aWxzLnNwZWMudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7O0dBSUc7O0FBRUgsMkNBUXFCO0FBQ3JCLHNDQUE4QztBQUU5QyxRQUFRLENBQUMsZUFBZSxFQUFFLEdBQUcsRUFBRTtJQUM3QixNQUFNLFdBQVcsR0FBb0M7UUFDbkQsTUFBTSxFQUFFLEtBQUs7UUFDYixLQUFLLEVBQUUsa0JBQWtCO1FBQ3pCLElBQUksRUFBRSxVQUFVO0tBQ2pCLENBQUM7SUFFRixRQUFRLENBQUMscUJBQXFCLEVBQUUsR0FBRyxFQUFFO1FBQ25DLEVBQUUsQ0FBQyxvQ0FBb0MsRUFBRSxHQUFHLEVBQUU7WUFDNUMsTUFBTSxLQUFLLEdBQUcsSUFBQSwrQkFBbUIsRUFBQyxXQUFXLENBQUMsQ0FBQztZQUUvQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDNUIsTUFBTSxDQUFDLE9BQU8sS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3BDLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzNDLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLHNDQUFzQyxFQUFFLEdBQUcsRUFBRTtZQUM5QyxNQUFNLEtBQUssR0FBRyxJQUFBLCtCQUFtQixFQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQy9DLE1BQU0sT0FBTyxHQUFHLElBQUEsdUJBQVcsRUFBQyxLQUFLLENBQUMsQ0FBQztZQUVuQyxNQUFNLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDakQsTUFBTSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQy9DLE1BQU0sQ0FBQyxP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c291cmNlcyI6WyJDOlxcQWRhcHRpdmVfVGVzdGluZ1xcc3JjXFxsaWJzXFxhdXRoXFxqd3QudXRpbHMuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFVuaXQgVGVzdHM6IEpXVCBVdGlsaXRpZXNcbiAqXG4gKiBUZXN0aW5nIEpXVCB0b2tlbiBnZW5lcmF0aW9uIGFuZCB2ZXJpZmljYXRpb25cbiAqL1xuXG5pbXBvcnQge1xuICBnZW5lcmF0ZUFjY2Vzc1Rva2VuLFxuICBnZW5lcmF0ZVJlZnJlc2hUb2tlbixcbiAgdmVyaWZ5QWNjZXNzVG9rZW4sXG4gIHZlcmlmeVJlZnJlc2hUb2tlbixcbiAgZGVjb2RlVG9rZW4sXG4gIGV4dHJhY3RUb2tlbkZyb21IZWFkZXIsXG4gIEpXVFBheWxvYWQsXG59IGZyb20gJy4vand0LnV0aWxzJztcbmltcG9ydCB7IFVuYXV0aG9yaXplZEVycm9yIH0gZnJvbSAnLi4vZXJyb3JzJztcblxuZGVzY3JpYmUoJ0pXVCBVdGlsaXRpZXMnLCAoKSA9PiB7XG4gIGNvbnN0IG1vY2tQYXlsb2FkOiBPbWl0PEpXVFBheWxvYWQsICdpYXQnIHwgJ2V4cCc+ID0ge1xuICAgIHVzZXJJZDogJzEyMycsXG4gICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcbiAgICByb2xlOiAnY3VzdG9tZXInLFxuICB9O1xuXG4gIGRlc2NyaWJlKCdnZW5lcmF0ZUFjY2Vzc1Rva2VuJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZ2VuZXJhdGUgdmFsaWQgYWNjZXNzIHRva2VuJywgKCkgPT4ge1xuICAgICAgY29uc3QgdG9rZW4gPSBnZW5lcmF0ZUFjY2Vzc1Rva2VuKG1vY2tQYXlsb2FkKTtcblxuICAgICAgZXhwZWN0KHRva2VuKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHR5cGVvZiB0b2tlbikudG9CZSgnc3RyaW5nJyk7XG4gICAgICBleHBlY3QodG9rZW4uc3BsaXQoJy4nKSkudG9IYXZlTGVuZ3RoKDMpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBpbmNsdWRlIHBheWxvYWQgZGF0YSBpbiB0b2tlbicsICgpID0+IHtcbiAgICAgIGNvbnN0IHRva2VuID0gZ2VuZXJhdGVBY2Nlc3NUb2tlbihtb2NrUGF5bG9hZCk7XG4gICAgICBjb25zdCBkZWNvZGVkID0gZGVjb2RlVG9rZW4odG9rZW4pO1xuXG4gICAgICBleHBlY3QoZGVjb2RlZD8udXNlcklkKS50b0JlKG1vY2tQYXlsb2FkLnVzZXJJZCk7XG4gICAgICBleHBlY3QoZGVjb2RlZD8uZW1haWwpLnRvQmUobW9ja1BheWxvYWQuZW1haWwpO1xuICAgICAgZXhwZWN0KGRlY29kZWQ/LnJvbGUpLnRvQmUobW9ja1BheWxvYWQucm9sZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGdlbmVyYXRlIGRpZmZlcmVudCB0b2tlbnMgZm9yIHNhbWUgcGF5bG9hZCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHRva2VuMSA9IGdlbmVyYXRlQWNjZXNzVG9rZW4obW9ja1BheWxvYWQpO1xuICAgICAgY29uc3QgdG9rZW4yID0gZ2VuZXJhdGVBY2Nlc3NUb2tlbihtb2NrUGF5bG9hZCk7XG5cbiAgICAgIC8vIFRva2VucyB3aWxsIGRpZmZlciBkdWUgdG8gaWF0IChpc3N1ZWQgYXQpIHRpbWVzdGFtcFxuICAgICAgZXhwZWN0KHRva2VuMSkubm90LnRvQmUodG9rZW4yKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2dlbmVyYXRlUmVmcmVzaFRva2VuJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZ2VuZXJhdGUgdmFsaWQgcmVmcmVzaCB0b2tlbicsICgpID0+IHtcbiAgICAgIGNvbnN0IHRva2VuID0gZ2VuZXJhdGVSZWZyZXNoVG9rZW4obW9ja1BheWxvYWQpO1xuXG4gICAgICBleHBlY3QodG9rZW4pLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QodHlwZW9mIHRva2VuKS50b0JlKCdzdHJpbmcnKTtcbiAgICAgIGV4cGVjdCh0b2tlbi5zcGxpdCgnLicpKS50b0hhdmVMZW5ndGgoMyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGdlbmVyYXRlIGRpZmZlcmVudCB0b2tlbiB0aGFuIGFjY2VzcyB0b2tlbicsICgpID0+IHtcbiAgICAgIGNvbnN0IGFjY2Vzc1Rva2VuID0gZ2VuZXJhdGVBY2Nlc3NUb2tlbihtb2NrUGF5bG9hZCk7XG4gICAgICBjb25zdCByZWZyZXNoVG9rZW4gPSBnZW5lcmF0ZVJlZnJlc2hUb2tlbihtb2NrUGF5bG9hZCk7XG5cbiAgICAgIGV4cGVjdChhY2Nlc3NUb2tlbikubm90LnRvQmUocmVmcmVzaFRva2VuKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3ZlcmlmeUFjY2Vzc1Rva2VuJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgdmVyaWZ5IHZhbGlkIGFjY2VzcyB0b2tlbicsICgpID0+IHtcbiAgICAgIGNvbnN0IHRva2VuID0gZ2VuZXJhdGVBY2Nlc3NUb2tlbihtb2NrUGF5bG9hZCk7XG4gICAgICBjb25zdCB2ZXJpZmllZCA9IHZlcmlmeUFjY2Vzc1Rva2VuKHRva2VuKTtcblxuICAgICAgZXhwZWN0KHZlcmlmaWVkLnVzZXJJZCkudG9CZShtb2NrUGF5bG9hZC51c2VySWQpO1xuICAgICAgZXhwZWN0KHZlcmlmaWVkLmVtYWlsKS50b0JlKG1vY2tQYXlsb2FkLmVtYWlsKTtcbiAgICAgIGV4cGVjdCh2ZXJpZmllZC5yb2xlKS50b0JlKG1vY2tQYXlsb2FkLnJvbGUpO1xuICAgICAgZXhwZWN0KHZlcmlmaWVkLmlhdCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdCh2ZXJpZmllZC5leHApLnRvQmVEZWZpbmVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHRocm93IFVuYXV0aG9yaXplZEVycm9yIGZvciBpbnZhbGlkIHRva2VuJywgKCkgPT4ge1xuICAgICAgZXhwZWN0KCgpID0+IHZlcmlmeUFjY2Vzc1Rva2VuKCdpbnZhbGlkLnRva2VuLmhlcmUnKSkudG9UaHJvdyhVbmF1dGhvcml6ZWRFcnJvcik7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHRocm93IFVuYXV0aG9yaXplZEVycm9yIGZvciBtYWxmb3JtZWQgdG9rZW4nLCAoKSA9PiB7XG4gICAgICBleHBlY3QoKCkgPT4gdmVyaWZ5QWNjZXNzVG9rZW4oJ25vdC1hLWp3dCcpKS50b1Rocm93KFVuYXV0aG9yaXplZEVycm9yKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmVqZWN0IHJlZnJlc2ggdG9rZW4gYXMgYWNjZXNzIHRva2VuJywgKCkgPT4ge1xuICAgICAgY29uc3QgcmVmcmVzaFRva2VuID0gZ2VuZXJhdGVSZWZyZXNoVG9rZW4obW9ja1BheWxvYWQpO1xuXG4gICAgICBleHBlY3QoKCkgPT4gdmVyaWZ5QWNjZXNzVG9rZW4ocmVmcmVzaFRva2VuKSkudG9UaHJvdyhVbmF1dGhvcml6ZWRFcnJvcik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCd2ZXJpZnlSZWZyZXNoVG9rZW4nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCB2ZXJpZnkgdmFsaWQgcmVmcmVzaCB0b2tlbicsICgpID0+IHtcbiAgICAgIGNvbnN0IHRva2VuID0gZ2VuZXJhdGVSZWZyZXNoVG9rZW4obW9ja1BheWxvYWQpO1xuICAgICAgY29uc3QgdmVyaWZpZWQgPSB2ZXJpZnlSZWZyZXNoVG9rZW4odG9rZW4pO1xuXG4gICAgICBleHBlY3QodmVyaWZpZWQudXNlcklkKS50b0JlKG1vY2tQYXlsb2FkLnVzZXJJZCk7XG4gICAgICBleHBlY3QodmVyaWZpZWQuZW1haWwpLnRvQmUobW9ja1BheWxvYWQuZW1haWwpO1xuICAgICAgZXhwZWN0KHZlcmlmaWVkLnJvbGUpLnRvQmUobW9ja1BheWxvYWQucm9sZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHRocm93IFVuYXV0aG9yaXplZEVycm9yIGZvciBpbnZhbGlkIHRva2VuJywgKCkgPT4ge1xuICAgICAgZXhwZWN0KCgpID0+IHZlcmlmeVJlZnJlc2hUb2tlbignaW52YWxpZC50b2tlbi5oZXJlJykpLnRvVGhyb3coVW5hdXRob3JpemVkRXJyb3IpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZWplY3QgYWNjZXNzIHRva2VuIGFzIHJlZnJlc2ggdG9rZW4nLCAoKSA9PiB7XG4gICAgICBjb25zdCBhY2Nlc3NUb2tlbiA9IGdlbmVyYXRlQWNjZXNzVG9rZW4obW9ja1BheWxvYWQpO1xuXG4gICAgICBleHBlY3QoKCkgPT4gdmVyaWZ5UmVmcmVzaFRva2VuKGFjY2Vzc1Rva2VuKSkudG9UaHJvdyhVbmF1dGhvcml6ZWRFcnJvcik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdkZWNvZGVUb2tlbicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGRlY29kZSB0b2tlbiB3aXRob3V0IHZlcmlmaWNhdGlvbicsICgpID0+IHtcbiAgICAgIGNvbnN0IHRva2VuID0gZ2VuZXJhdGVBY2Nlc3NUb2tlbihtb2NrUGF5bG9hZCk7XG4gICAgICBjb25zdCBkZWNvZGVkID0gZGVjb2RlVG9rZW4odG9rZW4pO1xuXG4gICAgICBleHBlY3QoZGVjb2RlZCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChkZWNvZGVkPy51c2VySWQpLnRvQmUobW9ja1BheWxvYWQudXNlcklkKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIG51bGwgZm9yIGludmFsaWQgdG9rZW4nLCAoKSA9PiB7XG4gICAgICBjb25zdCBkZWNvZGVkID0gZGVjb2RlVG9rZW4oJ2ludmFsaWQtdG9rZW4nKTtcblxuICAgICAgZXhwZWN0KGRlY29kZWQpLnRvQmVOdWxsKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGRlY29kZSBleHBpcmVkIHRva2VuJywgKCkgPT4ge1xuICAgICAgLy8gRXZlbiBleHBpcmVkIHRva2VucyBjYW4gYmUgZGVjb2RlZFxuICAgICAgY29uc3QgdG9rZW4gPSBnZW5lcmF0ZUFjY2Vzc1Rva2VuKG1vY2tQYXlsb2FkKTtcbiAgICAgIGNvbnN0IGRlY29kZWQgPSBkZWNvZGVUb2tlbih0b2tlbik7XG5cbiAgICAgIGV4cGVjdChkZWNvZGVkKS50b0JlRGVmaW5lZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZXh0cmFjdFRva2VuRnJvbUhlYWRlcicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGV4dHJhY3QgdG9rZW4gZnJvbSB2YWxpZCBCZWFyZXIgaGVhZGVyJywgKCkgPT4ge1xuICAgICAgY29uc3QgdG9rZW4gPSAnZXlKaGJHY2lPaUpJVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5Li4uJztcbiAgICAgIGNvbnN0IGhlYWRlciA9IGBCZWFyZXIgJHt0b2tlbn1gO1xuXG4gICAgICBjb25zdCBleHRyYWN0ZWQgPSBleHRyYWN0VG9rZW5Gcm9tSGVhZGVyKGhlYWRlcik7XG5cbiAgICAgIGV4cGVjdChleHRyYWN0ZWQpLnRvQmUodG9rZW4pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gbnVsbCBmb3IgbWlzc2luZyBoZWFkZXInLCAoKSA9PiB7XG4gICAgICBjb25zdCBleHRyYWN0ZWQgPSBleHRyYWN0VG9rZW5Gcm9tSGVhZGVyKHVuZGVmaW5lZCk7XG5cbiAgICAgIGV4cGVjdChleHRyYWN0ZWQpLnRvQmVOdWxsKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBudWxsIGZvciBtYWxmb3JtZWQgaGVhZGVyJywgKCkgPT4ge1xuICAgICAgY29uc3QgZXh0cmFjdGVkID0gZXh0cmFjdFRva2VuRnJvbUhlYWRlcignSW52YWxpZEhlYWRlciB0b2tlbicpO1xuXG4gICAgICBleHBlY3QoZXh0cmFjdGVkKS50b0JlTnVsbCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gbnVsbCBmb3IgaGVhZGVyIHdpdGhvdXQgdG9rZW4nLCAoKSA9PiB7XG4gICAgICBjb25zdCBleHRyYWN0ZWQgPSBleHRyYWN0VG9rZW5Gcm9tSGVhZGVyKCdCZWFyZXInKTtcblxuICAgICAgZXhwZWN0KGV4dHJhY3RlZCkudG9CZU51bGwoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIG51bGwgZm9yIHRva2VuIHdpdGhvdXQgQmVhcmVyIHByZWZpeCcsICgpID0+IHtcbiAgICAgIGNvbnN0IGV4dHJhY3RlZCA9IGV4dHJhY3RUb2tlbkZyb21IZWFkZXIoJ2V5SmhiR2NpT2lKSVV6STFOaUlzSW5SNWNDSTZJa3BYVkNKOS4uLicpO1xuXG4gICAgICBleHBlY3QoZXh0cmFjdGVkKS50b0JlTnVsbCgpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9