cc36dfedcf990c8d0e3cf4fa87ac792f
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.asyncHandler = exports.errorHandler = void 0;
const base_error_1 = require("./base.error");
const logger_1 = require("../logger/logger");
/**
 * Global error handler middleware
 * Catches all errors and sends appropriate responses
 */
const errorHandler = (err, req, res, _next) => {
    if (err instanceof base_error_1.BaseError) {
        // Log operational errors at appropriate level
        if (err.statusCode >= 500) {
            logger_1.logger.error('Operational error', {
                error: err.message,
                stack: err.stack,
                statusCode: err.statusCode,
                path: req.path,
                method: req.method,
            });
        }
        else {
            logger_1.logger.warn('Client error', {
                error: err.message,
                statusCode: err.statusCode,
                path: req.path,
                method: req.method,
            });
        }
        res.status(err.statusCode).json(err.toJSON());
        return;
    }
    // Unexpected errors (not operational)
    logger_1.logger.error('Unexpected error', {
        error: err.message,
        stack: err.stack,
        path: req.path,
        method: req.method,
    });
    res.status(500).json({
        error: 'InternalServerError',
        message: 'An unexpected error occurred',
        statusCode: 500,
        timestamp: new Date().toISOString(),
    });
};
exports.errorHandler = errorHandler;
/**
 * Async error wrapper for route handlers
 * Eliminates need for try-catch in async route handlers
 */
const asyncHandler = (fn) => {
    return (req, res, next) => {
        Promise.resolve(fn(req, res, next)).catch(next);
    };
};
exports.asyncHandler = asyncHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXEFkYXB0aXZlX1Rlc3RpbmdcXHNyY1xcbGlic1xcZXJyb3JzXFxlcnJvci5oYW5kbGVyLnRzIiwibWFwcGluZ3MiOiI7OztBQUNBLDZDQUF5QztBQUN6Qyw2Q0FBMEM7QUFFMUM7OztHQUdHO0FBQ0ksTUFBTSxZQUFZLEdBQUcsQ0FDMUIsR0FBVSxFQUNWLEdBQVksRUFDWixHQUFhLEVBQ2IsS0FBbUIsRUFDYixFQUFFO0lBQ1IsSUFBSSxHQUFHLFlBQVksc0JBQVMsRUFBRSxDQUFDO1FBQzdCLDhDQUE4QztRQUM5QyxJQUFJLEdBQUcsQ0FBQyxVQUFVLElBQUksR0FBRyxFQUFFLENBQUM7WUFDMUIsZUFBTSxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsRUFBRTtnQkFDaEMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxPQUFPO2dCQUNsQixLQUFLLEVBQUUsR0FBRyxDQUFDLEtBQUs7Z0JBQ2hCLFVBQVUsRUFBRSxHQUFHLENBQUMsVUFBVTtnQkFDMUIsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJO2dCQUNkLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTTthQUNuQixDQUFDLENBQUM7UUFDTCxDQUFDO2FBQU0sQ0FBQztZQUNOLGVBQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFO2dCQUMxQixLQUFLLEVBQUUsR0FBRyxDQUFDLE9BQU87Z0JBQ2xCLFVBQVUsRUFBRSxHQUFHLENBQUMsVUFBVTtnQkFDMUIsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJO2dCQUNkLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTTthQUNuQixDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBQzlDLE9BQU87SUFDVCxDQUFDO0lBRUQsc0NBQXNDO0lBQ3RDLGVBQU0sQ0FBQyxLQUFLLENBQUMsa0JBQWtCLEVBQUU7UUFDL0IsS0FBSyxFQUFFLEdBQUcsQ0FBQyxPQUFPO1FBQ2xCLEtBQUssRUFBRSxHQUFHLENBQUMsS0FBSztRQUNoQixJQUFJLEVBQUUsR0FBRyxDQUFDLElBQUk7UUFDZCxNQUFNLEVBQUUsR0FBRyxDQUFDLE1BQU07S0FDbkIsQ0FBQyxDQUFDO0lBRUgsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDbkIsS0FBSyxFQUFFLHFCQUFxQjtRQUM1QixPQUFPLEVBQUUsOEJBQThCO1FBQ3ZDLFVBQVUsRUFBRSxHQUFHO1FBQ2YsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO0tBQ3BDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQztBQTNDVyxRQUFBLFlBQVksZ0JBMkN2QjtBQUVGOzs7R0FHRztBQUNJLE1BQU0sWUFBWSxHQUFHLENBQzFCLEVBQXlFLEVBQ3pFLEVBQUU7SUFDRixPQUFPLENBQUMsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQixFQUFRLEVBQUU7UUFDL0QsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNsRCxDQUFDLENBQUM7QUFDSixDQUFDLENBQUM7QUFOVyxRQUFBLFlBQVksZ0JBTXZCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxBZGFwdGl2ZV9UZXN0aW5nXFxzcmNcXGxpYnNcXGVycm9yc1xcZXJyb3IuaGFuZGxlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSwgTmV4dEZ1bmN0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBCYXNlRXJyb3IgfSBmcm9tICcuL2Jhc2UuZXJyb3InO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vbG9nZ2VyL2xvZ2dlcic7XG5cbi8qKlxuICogR2xvYmFsIGVycm9yIGhhbmRsZXIgbWlkZGxld2FyZVxuICogQ2F0Y2hlcyBhbGwgZXJyb3JzIGFuZCBzZW5kcyBhcHByb3ByaWF0ZSByZXNwb25zZXNcbiAqL1xuZXhwb3J0IGNvbnN0IGVycm9ySGFuZGxlciA9IChcbiAgZXJyOiBFcnJvcixcbiAgcmVxOiBSZXF1ZXN0LFxuICByZXM6IFJlc3BvbnNlLFxuICBfbmV4dDogTmV4dEZ1bmN0aW9uXG4pOiB2b2lkID0+IHtcbiAgaWYgKGVyciBpbnN0YW5jZW9mIEJhc2VFcnJvcikge1xuICAgIC8vIExvZyBvcGVyYXRpb25hbCBlcnJvcnMgYXQgYXBwcm9wcmlhdGUgbGV2ZWxcbiAgICBpZiAoZXJyLnN0YXR1c0NvZGUgPj0gNTAwKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ09wZXJhdGlvbmFsIGVycm9yJywge1xuICAgICAgICBlcnJvcjogZXJyLm1lc3NhZ2UsXG4gICAgICAgIHN0YWNrOiBlcnIuc3RhY2ssXG4gICAgICAgIHN0YXR1c0NvZGU6IGVyci5zdGF0dXNDb2RlLFxuICAgICAgICBwYXRoOiByZXEucGF0aCxcbiAgICAgICAgbWV0aG9kOiByZXEubWV0aG9kLFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZ2dlci53YXJuKCdDbGllbnQgZXJyb3InLCB7XG4gICAgICAgIGVycm9yOiBlcnIubWVzc2FnZSxcbiAgICAgICAgc3RhdHVzQ29kZTogZXJyLnN0YXR1c0NvZGUsXG4gICAgICAgIHBhdGg6IHJlcS5wYXRoLFxuICAgICAgICBtZXRob2Q6IHJlcS5tZXRob2QsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXMuc3RhdHVzKGVyci5zdGF0dXNDb2RlKS5qc29uKGVyci50b0pTT04oKSk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLy8gVW5leHBlY3RlZCBlcnJvcnMgKG5vdCBvcGVyYXRpb25hbClcbiAgbG9nZ2VyLmVycm9yKCdVbmV4cGVjdGVkIGVycm9yJywge1xuICAgIGVycm9yOiBlcnIubWVzc2FnZSxcbiAgICBzdGFjazogZXJyLnN0YWNrLFxuICAgIHBhdGg6IHJlcS5wYXRoLFxuICAgIG1ldGhvZDogcmVxLm1ldGhvZCxcbiAgfSk7XG5cbiAgcmVzLnN0YXR1cyg1MDApLmpzb24oe1xuICAgIGVycm9yOiAnSW50ZXJuYWxTZXJ2ZXJFcnJvcicsXG4gICAgbWVzc2FnZTogJ0FuIHVuZXhwZWN0ZWQgZXJyb3Igb2NjdXJyZWQnLFxuICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgfSk7XG59O1xuXG4vKipcbiAqIEFzeW5jIGVycm9yIHdyYXBwZXIgZm9yIHJvdXRlIGhhbmRsZXJzXG4gKiBFbGltaW5hdGVzIG5lZWQgZm9yIHRyeS1jYXRjaCBpbiBhc3luYyByb3V0ZSBoYW5kbGVyc1xuICovXG5leHBvcnQgY29uc3QgYXN5bmNIYW5kbGVyID0gKFxuICBmbjogKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiBQcm9taXNlPHVua25vd24+XG4pID0+IHtcbiAgcmV0dXJuIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IHZvaWQgPT4ge1xuICAgIFByb21pc2UucmVzb2x2ZShmbihyZXEsIHJlcywgbmV4dCkpLmNhdGNoKG5leHQpO1xuICB9O1xufTtcbiJdLCJ2ZXJzaW9uIjozfQ==