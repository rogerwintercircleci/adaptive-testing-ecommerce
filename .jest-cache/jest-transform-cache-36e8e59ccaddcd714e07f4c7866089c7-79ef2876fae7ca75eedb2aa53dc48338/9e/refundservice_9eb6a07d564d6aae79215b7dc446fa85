5df988f92fcbb9c6bfc09ea3558a8b74
"use strict";
/**
 * Refund & Returns Service Implementation
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.RefundService = exports.ReturnStatus = exports.ReturnReason = exports.RefundStatus = void 0;
const errors_1 = require("@libs/errors");
const refund_entity_1 = require("../entities/refund.entity");
Object.defineProperty(exports, "RefundStatus", { enumerable: true, get: function () { return refund_entity_1.RefundStatus; } });
Object.defineProperty(exports, "ReturnReason", { enumerable: true, get: function () { return refund_entity_1.ReturnReason; } });
Object.defineProperty(exports, "ReturnStatus", { enumerable: true, get: function () { return refund_entity_1.ReturnStatus; } });
const order_entity_1 = require("../entities/order.entity");
class RefundService {
    refundRepository;
    orderRepository;
    inventoryRepository;
    paymentGatewayService;
    shippingProviderService;
    RETURN_WINDOW_DAYS = 30;
    constructor(refundRepository, orderRepository, inventoryRepository, paymentGatewayService, shippingProviderService) {
        this.refundRepository = refundRepository;
        this.orderRepository = orderRepository;
        this.inventoryRepository = inventoryRepository;
        this.paymentGatewayService = paymentGatewayService;
        this.shippingProviderService = shippingProviderService;
    }
    async createRefundRequest(data) {
        const order = await this.orderRepository.findById(data.orderId);
        // Validate order is paid
        if (order.paymentStatus !== order_entity_1.PaymentStatus.PAID) {
            throw new errors_1.BadRequestError('Order must be paid to request a refund');
        }
        // Check return window
        if (order.deliveredAt) {
            const daysSinceDelivery = (Date.now() - order.deliveredAt.getTime()) / (1000 * 60 * 60 * 24);
            if (daysSinceDelivery > this.RETURN_WINDOW_DAYS) {
                throw new errors_1.BadRequestError(`Return window of ${this.RETURN_WINDOW_DAYS} days has expired`);
            }
        }
        // Require photos for defective items
        if ((data.reason === refund_entity_1.ReturnReason.DEFECTIVE || data.reason === refund_entity_1.ReturnReason.DAMAGED) &&
            (!data.photos || data.photos.length === 0)) {
            throw new errors_1.BadRequestError('Photos are required for defective or damaged items');
        }
        // Calculate refund amounts
        const itemsWithRefunds = data.items.map(item => {
            const orderItem = order.items.find(oi => oi.productId === item.productId);
            if (!orderItem) {
                throw new errors_1.BadRequestError(`Product ${item.productId} not found in order`);
            }
            if (item.quantity > orderItem.quantity) {
                throw new errors_1.BadRequestError('Refund quantity exceeds ordered quantity');
            }
            const refundAmount = (orderItem.unitPrice * item.quantity);
            return {
                ...item,
                refundAmount,
            };
        });
        const refundAmount = itemsWithRefunds.reduce((sum, item) => sum + item.refundAmount, 0);
        return this.refundRepository.create({
            orderId: data.orderId,
            userId: order.userId,
            reason: data.reason,
            description: data.description,
            items: data.items,
            refundAmount,
            status: refund_entity_1.RefundStatus.PENDING,
            photos: data.photos,
            restockItems: data.reason !== refund_entity_1.ReturnReason.DEFECTIVE && data.reason !== refund_entity_1.ReturnReason.DAMAGED,
            createdAt: new Date(),
        });
    }
    async approveRefund(refundId, _approvedBy) {
        const refund = await this.refundRepository.findById(refundId);
        if (refund.status !== refund_entity_1.RefundStatus.PENDING) {
            throw new errors_1.BadRequestError('Only pending refunds can be approved');
        }
        return this.refundRepository.updateStatus(refundId, refund_entity_1.RefundStatus.APPROVED);
    }
    async rejectRefund(refundId, reason) {
        const refund = await this.refundRepository.findById(refundId);
        if (refund.status !== refund_entity_1.RefundStatus.PENDING) {
            throw new errors_1.BadRequestError('Only pending refunds can be rejected');
        }
        await this.refundRepository.update(refundId, {
            status: refund_entity_1.RefundStatus.REJECTED,
            rejectionReason: reason,
        });
        return this.refundRepository.findById(refundId);
    }
    async processRefund(refundId) {
        const refund = await this.refundRepository.findById(refundId);
        if (refund.status !== refund_entity_1.RefundStatus.APPROVED) {
            throw new errors_1.BadRequestError('Only approved refunds can be processed');
        }
        // Update status to processing
        await this.refundRepository.updateStatus(refundId, refund_entity_1.RefundStatus.PROCESSING);
        try {
            const order = await this.orderRepository.findById(refund.orderId);
            // Issue payment refund
            await this.paymentGatewayService.refundPayment({
                transactionId: `txn_${order.id}`,
                amount: refund.refundAmount,
                reason: refund.reason,
            });
            // Restock items if applicable
            if (refund.restockItems) {
                await this.restockItems(refund.id);
            }
            // Mark as completed
            await this.refundRepository.update(refundId, {
                status: refund_entity_1.RefundStatus.COMPLETED,
                processedAt: new Date(),
            });
            return this.refundRepository.findById(refundId);
        }
        catch (error) {
            // Mark as failed
            await this.refundRepository.updateStatus(refundId, refund_entity_1.RefundStatus.FAILED);
            throw error;
        }
    }
    async restockItems(refundId) {
        const refund = await this.refundRepository.findById(refundId);
        if (!refund.restockItems) {
            return;
        }
        for (const item of refund.items) {
            const inventory = await this.inventoryRepository.findByProductId(item.productId);
            await this.inventoryRepository.update(item.productId, {
                quantity: inventory.quantity + item.quantity,
            });
            await this.inventoryRepository.recordAdjustment({
                productId: item.productId,
                quantity: item.quantity,
                reason: `refund_restock_${refundId}`,
                date: new Date(),
            });
        }
    }
    async generateReturnLabel(refundId) {
        const refund = await this.refundRepository.findById(refundId);
        const order = await this.orderRepository.findById(refund.orderId);
        if (refund.status !== refund_entity_1.RefundStatus.APPROVED) {
            throw new errors_1.BadRequestError('Refund must be approved to generate return label');
        }
        const label = await this.shippingProviderService.createReturnLabel({
            orderId: order.id,
            fromAddress: order.shippingAddress,
            refundId,
        });
        await this.refundRepository.update(refundId, {
            returnLabelUrl: label.labelUrl,
            returnTrackingNumber: label.trackingNumber,
            returnStatus: refund_entity_1.ReturnStatus.LABEL_GENERATED,
        });
        return {
            labelUrl: label.labelUrl,
            trackingNumber: label.trackingNumber,
        };
    }
    async trackReturn(trackingNumber) {
        const refund = await this.repository.findOne({
            where: { returnTrackingNumber: trackingNumber },
        });
        if (!refund) {
            throw new errors_1.NotFoundError('Return not found');
        }
        const trackingInfo = await this.shippingProviderService.trackShipment(trackingNumber);
        // Update return status based on tracking
        let returnStatus = refund.returnStatus;
        if (trackingInfo.status === 'in_transit') {
            returnStatus = refund_entity_1.ReturnStatus.IN_TRANSIT;
        }
        else if (trackingInfo.status === 'delivered') {
            returnStatus = refund_entity_1.ReturnStatus.RECEIVED;
        }
        if (returnStatus !== refund.returnStatus) {
            await this.refundRepository.updateReturnStatus(refund.id, returnStatus);
        }
        return {
            ...trackingInfo,
            refundId: refund.id,
            returnStatus,
        };
    }
    async markReturnAsReceived(refundId) {
        await this.refundRepository.findById(refundId);
        await this.refundRepository.updateReturnStatus(refundId, refund_entity_1.ReturnStatus.RECEIVED);
        return this.refundRepository.findById(refundId);
    }
    async getRefundStatistics(options) {
        const totalRefunded = await this.refundRepository.getTotalRefundedAmount(options?.startDate, options?.endDate);
        const pending = await this.refundRepository.countByStatus(refund_entity_1.RefundStatus.PENDING);
        const approved = await this.refundRepository.countByStatus(refund_entity_1.RefundStatus.APPROVED);
        const rejected = await this.refundRepository.countByStatus(refund_entity_1.RefundStatus.REJECTED);
        const completed = await this.refundRepository.countByStatus(refund_entity_1.RefundStatus.COMPLETED);
        return {
            totalRefunded,
            pending,
            approved,
            rejected,
            completed,
        };
    }
    async checkEligibility(orderId) {
        const order = await this.orderRepository.findById(orderId);
        const issues = [];
        if (order.paymentStatus !== order_entity_1.PaymentStatus.PAID) {
            issues.push('Order must be paid');
        }
        if (order.deliveredAt) {
            const daysSinceDelivery = (Date.now() - order.deliveredAt.getTime()) / (1000 * 60 * 60 * 24);
            if (daysSinceDelivery > this.RETURN_WINDOW_DAYS) {
                issues.push(`Return window of ${this.RETURN_WINDOW_DAYS} days has expired`);
            }
        }
        return {
            eligible: issues.length === 0,
            issues,
        };
    }
    async calculateRefundAmount(data) {
        const order = await this.orderRepository.findById(data.orderId);
        let totalRefund = 0;
        for (const item of data.items) {
            const orderItem = order.items.find(oi => oi.productId === item.productId);
            if (!orderItem) {
                throw new errors_1.BadRequestError(`Product ${item.productId} not found in order`);
            }
            if (item.quantity > orderItem.quantity) {
                throw new errors_1.BadRequestError('Refund quantity exceeds ordered quantity');
            }
            totalRefund += orderItem.unitPrice * item.quantity;
        }
        return {
            refundAmount: totalRefund,
            items: data.items.map(item => {
                const orderItem = order.items.find(oi => oi.productId === item.productId);
                return {
                    ...item,
                    unitPrice: orderItem.unitPrice,
                    refundAmount: orderItem.unitPrice * item.quantity,
                };
            }),
        };
    }
    async getUserRefunds(userId) {
        return this.refundRepository.findByUserId(userId);
    }
    async getOrderRefunds(orderId) {
        return this.refundRepository.findByOrderId(orderId);
    }
    get repository() {
        return this.refundRepository['repository'];
    }
}
exports.RefundService = RefundService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXEFkYXB0aXZlX1Rlc3RpbmdcXHNyY1xcc2VydmljZXNcXG9yZGVyLXByb2Nlc3NpbmdcXHNlcnZpY2VzXFxyZWZ1bmQuc2VydmljZS50cyIsIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7OztBQU9ILHlDQUE4RDtBQUM5RCw2REFBcUY7QUFJNUUsNkZBSkEsNEJBQVksT0FJQTtBQUFFLDZGQUpBLDRCQUFZLE9BSUE7QUFBRSw2RkFKQSw0QkFBWSxPQUlBO0FBSGpELDJEQUF5RDtBQWdCekQsTUFBYSxhQUFhO0lBSWQ7SUFDQTtJQUNBO0lBQ0E7SUFDQTtJQVBPLGtCQUFrQixHQUFHLEVBQUUsQ0FBQztJQUV6QyxZQUNVLGdCQUFrQyxFQUNsQyxlQUFnQyxFQUNoQyxtQkFBd0MsRUFDeEMscUJBQTRDLEVBQzVDLHVCQUFnRDtRQUpoRCxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUNoQyx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBdUI7UUFDNUMsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtJQUN2RCxDQUFDO0lBRUosS0FBSyxDQUFDLG1CQUFtQixDQUFDLElBQTRCO1FBQ3BELE1BQU0sS0FBSyxHQUFHLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRWhFLHlCQUF5QjtRQUN6QixJQUFJLEtBQUssQ0FBQyxhQUFhLEtBQUssNEJBQWEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUMvQyxNQUFNLElBQUksd0JBQWUsQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFDO1FBQ3RFLENBQUM7UUFFRCxzQkFBc0I7UUFDdEIsSUFBSSxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDdEIsTUFBTSxpQkFBaUIsR0FDckIsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUs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LFlBQVksQ0FBQyxDQUFDO0lBQzdDLENBQUM7Q0FDRjtBQXpURCxzQ0F5VEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXEFkYXB0aXZlX1Rlc3RpbmdcXHNyY1xcc2VydmljZXNcXG9yZGVyLXByb2Nlc3NpbmdcXHNlcnZpY2VzXFxyZWZ1bmQuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFJlZnVuZCAmIFJldHVybnMgU2VydmljZSBJbXBsZW1lbnRhdGlvblxuICovXG5cbmltcG9ydCB7IFJlZnVuZFJlcG9zaXRvcnkgfSBmcm9tICcuLi9yZXBvc2l0b3JpZXMvcmVmdW5kLnJlcG9zaXRvcnknO1xuaW1wb3J0IHsgT3JkZXJSZXBvc2l0b3J5IH0gZnJvbSAnLi4vcmVwb3NpdG9yaWVzL29yZGVyLnJlcG9zaXRvcnknO1xuaW1wb3J0IHsgSW52ZW50b3J5UmVwb3NpdG9yeSB9IGZyb20gJy4uLy4uL2ludmVudG9yeS9yZXBvc2l0b3JpZXMvaW52ZW50b3J5LnJlcG9zaXRvcnknO1xuaW1wb3J0IHsgUGF5bWVudEdhdGV3YXlTZXJ2aWNlIH0gZnJvbSAnLi9wYXltZW50LWdhdGV3YXkuc2VydmljZSc7XG5pbXBvcnQgeyBTaGlwcGluZ1Byb3ZpZGVyU2VydmljZSB9IGZyb20gJy4vc2hpcHBpbmctcHJvdmlkZXIuc2VydmljZSc7XG5pbXBvcnQgeyBCYWRSZXF1ZXN0RXJyb3IsIE5vdEZvdW5kRXJyb3IgfSBmcm9tICdAbGlicy9lcnJvcnMnO1xuaW1wb3J0IHsgUmVmdW5kU3RhdHVzLCBSZXR1cm5SZWFzb24sIFJldHVyblN0YXR1cyB9IGZyb20gJy4uL2VudGl0aWVzL3JlZnVuZC5lbnRpdHknO1xuaW1wb3J0IHsgUGF5bWVudFN0YXR1cyB9IGZyb20gJy4uL2VudGl0aWVzL29yZGVyLmVudGl0eSc7XG5cbi8vIFJlLWV4cG9ydCBlbnVtcyBmb3IgY29udmVuaWVuY2VcbmV4cG9ydCB7IFJlZnVuZFN0YXR1cywgUmV0dXJuUmVhc29uLCBSZXR1cm5TdGF0dXMgfTtcblxuZXhwb3J0IGludGVyZmFjZSBDcmVhdGVSZWZ1bmRSZXF1ZXN0RHRvIHtcbiAgb3JkZXJJZDogc3RyaW5nO1xuICByZWFzb246IFJldHVyblJlYXNvbjtcbiAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XG4gIGl0ZW1zOiBBcnJheTx7XG4gICAgcHJvZHVjdElkOiBzdHJpbmc7XG4gICAgcXVhbnRpdHk6IG51bWJlcjtcbiAgfT47XG4gIHBob3Rvcz86IHN0cmluZ1tdO1xufVxuXG5leHBvcnQgY2xhc3MgUmVmdW5kU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgUkVUVVJOX1dJTkRPV19EQVlTID0gMzA7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWZ1bmRSZXBvc2l0b3J5OiBSZWZ1bmRSZXBvc2l0b3J5LFxuICAgIHByaXZhdGUgb3JkZXJSZXBvc2l0b3J5OiBPcmRlclJlcG9zaXRvcnksXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlSZXBvc2l0b3J5OiBJbnZlbnRvcnlSZXBvc2l0b3J5LFxuICAgIHByaXZhdGUgcGF5bWVudEdhdGV3YXlTZXJ2aWNlOiBQYXltZW50R2F0ZXdheVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBzaGlwcGluZ1Byb3ZpZGVyU2VydmljZTogU2hpcHBpbmdQcm92aWRlclNlcnZpY2VcbiAgKSB7fVxuXG4gIGFzeW5jIGNyZWF0ZVJlZnVuZFJlcXVlc3QoZGF0YTogQ3JlYXRlUmVmdW5kUmVxdWVzdER0bykge1xuICAgIGNvbnN0IG9yZGVyID0gYXdhaXQgdGhpcy5vcmRlclJlcG9zaXRvcnkuZmluZEJ5SWQoZGF0YS5vcmRlcklkKTtcblxuICAgIC8vIFZhbGlkYXRlIG9yZGVyIGlzIHBhaWRcbiAgICBpZiAob3JkZXIucGF5bWVudFN0YXR1cyAhPT0gUGF5bWVudFN0YXR1cy5QQUlEKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEVycm9yKCdPcmRlciBtdXN0IGJlIHBhaWQgdG8gcmVxdWVzdCBhIHJlZnVuZCcpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIHJldHVybiB3aW5kb3dcbiAgICBpZiAob3JkZXIuZGVsaXZlcmVkQXQpIHtcbiAgICAgIGNvbnN0IGRheXNTaW5jZURlbGl2ZXJ5ID1cbiAgICAgICAgKERhdGUubm93KCkgLSBvcmRlci5kZWxpdmVyZWRBdC5nZXRUaW1lKCkpIC8gKDEwMDAgKiA2MCAqIDYwICogMjQpO1xuICAgICAgaWYgKGRheXNTaW5jZURlbGl2ZXJ5ID4gdGhpcy5SRVRVUk5fV0lORE9XX0RBWVMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFcnJvcihcbiAgICAgICAgICBgUmV0dXJuIHdpbmRvdyBvZiAke3RoaXMuUkVUVVJOX1dJTkRPV19EQVlTfSBkYXlzIGhhcyBleHBpcmVkYFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFJlcXVpcmUgcGhvdG9zIGZvciBkZWZlY3RpdmUgaXRlbXNcbiAgICBpZiAoXG4gICAgICAoZGF0YS5yZWFzb24gPT09IFJldHVyblJlYXNvbi5ERUZFQ1RJVkUgfHwgZGF0YS5yZWFzb24gPT09IFJldHVyblJlYXNvbi5EQU1BR0VEKSAmJlxuICAgICAgKCFkYXRhLnBob3RvcyB8fCBkYXRhLnBob3Rvcy5sZW5ndGggPT09IDApXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEVycm9yKCdQaG90b3MgYXJlIHJlcXVpcmVkIGZvciBkZWZlY3RpdmUgb3IgZGFtYWdlZCBpdGVtcycpO1xuICAgIH1cblxuICAgIC8vIENhbGN1bGF0ZSByZWZ1bmQgYW1vdW50c1xuICAgIGNvbnN0IGl0ZW1zV2l0aFJlZnVuZHMgPSBkYXRhLml0ZW1zLm1hcChpdGVtID0+IHtcbiAgICAgIGNvbnN0IG9yZGVySXRlbSA9IG9yZGVyLml0ZW1zLmZpbmQob2kgPT4gb2kucHJvZHVjdElkID09PSBpdGVtLnByb2R1Y3RJZCk7XG4gICAgICBpZiAoIW9yZGVySXRlbSkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEVycm9yKGBQcm9kdWN0ICR7aXRlbS5wcm9kdWN0SWR9IG5vdCBmb3VuZCBpbiBvcmRlcmApO1xuICAgICAgfVxuXG4gICAgICBpZiAoaXRlbS5xdWFudGl0eSA+IG9yZGVySXRlbS5xdWFudGl0eSkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEVycm9yKCdSZWZ1bmQgcXVhbnRpdHkgZXhjZWVkcyBvcmRlcmVkIHF1YW50aXR5Jyk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlZnVuZEFtb3VudCA9IChvcmRlckl0ZW0udW5pdFByaWNlICogaXRlbS5xdWFudGl0eSk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5pdGVtLFxuICAgICAgICByZWZ1bmRBbW91bnQsXG4gICAgICB9O1xuICAgIH0pO1xuXG4gICAgY29uc3QgcmVmdW5kQW1vdW50ID0gaXRlbXNXaXRoUmVmdW5kcy5yZWR1Y2UoXG4gICAgICAoc3VtLCBpdGVtKSA9PiBzdW0gKyBpdGVtLnJlZnVuZEFtb3VudCxcbiAgICAgIDBcbiAgICApO1xuXG4gICAgcmV0dXJuIHRoaXMucmVmdW5kUmVwb3NpdG9yeS5jcmVhdGUoe1xuICAgICAgb3JkZXJJZDogZGF0YS5vcmRlcklkLFxuICAgICAgdXNlcklkOiBvcmRlci51c2VySWQsXG4gICAgICByZWFzb246IGRhdGEucmVhc29uLFxuICAgICAgZGVzY3JpcHRpb246IGRhdGEuZGVzY3JpcHRpb24sXG4gICAgICBpdGVtczogZGF0YS5pdGVtcyxcbiAgICAgIHJlZnVuZEFtb3VudCxcbiAgICAgIHN0YXR1czogUmVmdW5kU3RhdHVzLlBFTkRJTkcsXG4gICAgICBwaG90b3M6IGRhdGEucGhvdG9zLFxuICAgICAgcmVzdG9ja0l0ZW1zOiBkYXRhLnJlYXNvbiAhPT0gUmV0dXJuUmVhc29uLkRFRkVDVElWRSAmJiBkYXRhLnJlYXNvbiAhPT0gUmV0dXJuUmVhc29uLkRBTUFHRUQsXG4gICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgfSBhcyBhbnkpO1xuICB9XG5cbiAgYXN5bmMgYXBwcm92ZVJlZnVuZChyZWZ1bmRJZDogc3RyaW5nLCBfYXBwcm92ZWRCeT86IHN0cmluZykge1xuICAgIGNvbnN0IHJlZnVuZCA9IGF3YWl0IHRoaXMucmVmdW5kUmVwb3NpdG9yeS5maW5kQnlJZChyZWZ1bmRJZCk7XG5cbiAgICBpZiAocmVmdW5kLnN0YXR1cyAhPT0gUmVmdW5kU3RhdHVzLlBFTkRJTkcpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXJyb3IoJ09ubHkgcGVuZGluZyByZWZ1bmRzIGNhbiBiZSBhcHByb3ZlZCcpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnJlZnVuZFJlcG9zaXRvcnkudXBkYXRlU3RhdHVzKHJlZnVuZElkLCBSZWZ1bmRTdGF0dXMuQVBQUk9WRUQpO1xuICB9XG5cbiAgYXN5bmMgcmVqZWN0UmVmdW5kKHJlZnVuZElkOiBzdHJpbmcsIHJlYXNvbjogc3RyaW5nKSB7XG4gICAgY29uc3QgcmVmdW5kID0gYXdhaXQgdGhpcy5yZWZ1bmRSZXBvc2l0b3J5LmZpbmRCeUlkKHJlZnVuZElkKTtcblxuICAgIGlmIChyZWZ1bmQuc3RhdHVzICE9PSBSZWZ1bmRTdGF0dXMuUEVORElORykge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFcnJvcignT25seSBwZW5kaW5nIHJlZnVuZHMgY2FuIGJlIHJlamVjdGVkJyk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5yZWZ1bmRSZXBvc2l0b3J5LnVwZGF0ZShyZWZ1bmRJZCwge1xuICAgICAgc3RhdHVzOiBSZWZ1bmRTdGF0dXMuUkVKRUNURUQsXG4gICAgICByZWplY3Rpb25SZWFzb246IHJlYXNvbixcbiAgICB9IGFzIGFueSk7XG5cbiAgICByZXR1cm4gdGhpcy5yZWZ1bmRSZXBvc2l0b3J5LmZpbmRCeUlkKHJlZnVuZElkKTtcbiAgfVxuXG4gIGFzeW5jIHByb2Nlc3NSZWZ1bmQocmVmdW5kSWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHJlZnVuZCA9IGF3YWl0IHRoaXMucmVmdW5kUmVwb3NpdG9yeS5maW5kQnlJZChyZWZ1bmRJZCk7XG5cbiAgICBpZiAocmVmdW5kLnN0YXR1cyAhPT0gUmVmdW5kU3RhdHVzLkFQUFJPVkVEKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEVycm9yKCdPbmx5IGFwcHJvdmVkIHJlZnVuZHMgY2FuIGJlIHByb2Nlc3NlZCcpO1xuICAgIH1cblxuICAgIC8vIFVwZGF0ZSBzdGF0dXMgdG8gcHJvY2Vzc2luZ1xuICAgIGF3YWl0IHRoaXMucmVmdW5kUmVwb3NpdG9yeS51cGRhdGVTdGF0dXMocmVmdW5kSWQsIFJlZnVuZFN0YXR1cy5QUk9DRVNTSU5HKTtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBvcmRlciA9IGF3YWl0IHRoaXMub3JkZXJSZXBvc2l0b3J5LmZpbmRCeUlkKHJlZnVuZC5vcmRlcklkKTtcblxuICAgICAgLy8gSXNzdWUgcGF5bWVudCByZWZ1bmRcbiAgICAgIGF3YWl0IHRoaXMucGF5bWVudEdhdGV3YXlTZXJ2aWNlLnJlZnVuZFBheW1lbnQoe1xuICAgICAgICB0cmFuc2FjdGlvbklkOiBgdHhuXyR7b3JkZXIuaWR9YCxcbiAgICAgICAgYW1vdW50OiByZWZ1bmQucmVmdW5kQW1vdW50LFxuICAgICAgICByZWFzb246IHJlZnVuZC5yZWFzb24gYXMgc3RyaW5nLFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFJlc3RvY2sgaXRlbXMgaWYgYXBwbGljYWJsZVxuICAgICAgaWYgKHJlZnVuZC5yZXN0b2NrSXRlbXMpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5yZXN0b2NrSXRlbXMocmVmdW5kLmlkKTtcbiAgICAgIH1cblxuICAgICAgLy8gTWFyayBhcyBjb21wbGV0ZWRcbiAgICAgIGF3YWl0IHRoaXMucmVmdW5kUmVwb3NpdG9yeS51cGRhdGUocmVmdW5kSWQsIHtcbiAgICAgICAgc3RhdHVzOiBSZWZ1bmRTdGF0dXMuQ09NUExFVEVELFxuICAgICAgICBwcm9jZXNzZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIH0gYXMgYW55KTtcblxuICAgICAgcmV0dXJuIHRoaXMucmVmdW5kUmVwb3NpdG9yeS5maW5kQnlJZChyZWZ1bmRJZCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIE1hcmsgYXMgZmFpbGVkXG4gICAgICBhd2FpdCB0aGlzLnJlZnVuZFJlcG9zaXRvcnkudXBkYXRlU3RhdHVzKHJlZnVuZElkLCBSZWZ1bmRTdGF0dXMuRkFJTEVEKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHJlc3RvY2tJdGVtcyhyZWZ1bmRJZDogc3RyaW5nKSB7XG4gICAgY29uc3QgcmVmdW5kID0gYXdhaXQgdGhpcy5yZWZ1bmRSZXBvc2l0b3J5LmZpbmRCeUlkKHJlZnVuZElkKTtcblxuICAgIGlmICghcmVmdW5kLnJlc3RvY2tJdGVtcykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgaXRlbSBvZiByZWZ1bmQuaXRlbXMpIHtcbiAgICAgIGNvbnN0IGludmVudG9yeSA9IGF3YWl0IHRoaXMuaW52ZW50b3J5UmVwb3NpdG9yeS5maW5kQnlQcm9kdWN0SWQoaXRlbS5wcm9kdWN0SWQpO1xuICAgICAgYXdhaXQgdGhpcy5pbnZlbnRvcnlSZXBvc2l0b3J5LnVwZGF0ZShpdGVtLnByb2R1Y3RJZCwge1xuICAgICAgICBxdWFudGl0eTogaW52ZW50b3J5LnF1YW50aXR5ICsgaXRlbS5xdWFudGl0eSxcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCB0aGlzLmludmVudG9yeVJlcG9zaXRvcnkucmVjb3JkQWRqdXN0bWVudCh7XG4gICAgICAgIHByb2R1Y3RJZDogaXRlbS5wcm9kdWN0SWQsXG4gICAgICAgIHF1YW50aXR5OiBpdGVtLnF1YW50aXR5LFxuICAgICAgICByZWFzb246IGByZWZ1bmRfcmVzdG9ja18ke3JlZnVuZElkfWAsXG4gICAgICAgIGRhdGU6IG5ldyBEYXRlKCksXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZW5lcmF0ZVJldHVybkxhYmVsKHJlZnVuZElkOiBzdHJpbmcpIHtcbiAgICBjb25zdCByZWZ1bmQgPSBhd2FpdCB0aGlzLnJlZnVuZFJlcG9zaXRvcnkuZmluZEJ5SWQocmVmdW5kSWQpO1xuICAgIGNvbnN0IG9yZGVyID0gYXdhaXQgdGhpcy5vcmRlclJlcG9zaXRvcnkuZmluZEJ5SWQocmVmdW5kLm9yZGVySWQpO1xuXG4gICAgaWYgKHJlZnVuZC5zdGF0dXMgIT09IFJlZnVuZFN0YXR1cy5BUFBST1ZFRCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFcnJvcignUmVmdW5kIG11c3QgYmUgYXBwcm92ZWQgdG8gZ2VuZXJhdGUgcmV0dXJuIGxhYmVsJyk7XG4gICAgfVxuXG4gICAgY29uc3QgbGFiZWwgPSBhd2FpdCB0aGlzLnNoaXBwaW5nUHJvdmlkZXJTZXJ2aWNlLmNyZWF0ZVJldHVybkxhYmVsKHtcbiAgICAgIG9yZGVySWQ6IG9yZGVyLmlkLFxuICAgICAgZnJvbUFkZHJlc3M6IG9yZGVyLnNoaXBwaW5nQWRkcmVzcyxcbiAgICAgIHJlZnVuZElkLFxuICAgIH0pO1xuXG4gICAgYXdhaXQgdGhpcy5yZWZ1bmRSZXBvc2l0b3J5LnVwZGF0ZShyZWZ1bmRJZCwge1xuICAgICAgcmV0dXJuTGFiZWxVcmw6IGxhYmVsLmxhYmVsVXJsLFxuICAgICAgcmV0dXJuVHJhY2tpbmdOdW1iZXI6IGxhYmVsLnRyYWNraW5nTnVtYmVyLFxuICAgICAgcmV0dXJuU3RhdHVzOiBSZXR1cm5TdGF0dXMuTEFCRUxfR0VORVJBVEVELFxuICAgIH0gYXMgYW55KTtcblxuICAgIHJldHVybiB7XG4gICAgICBsYWJlbFVybDogbGFiZWwubGFiZWxVcmwsXG4gICAgICB0cmFja2luZ051bWJlcjogbGFiZWwudHJhY2tpbmdOdW1iZXIsXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIHRyYWNrUmV0dXJuKHRyYWNraW5nTnVtYmVyOiBzdHJpbmcpIHtcbiAgICBjb25zdCByZWZ1bmQgPSBhd2FpdCB0aGlzLnJlcG9zaXRvcnkuZmluZE9uZSh7XG4gICAgICB3aGVyZTogeyByZXR1cm5UcmFja2luZ051bWJlcjogdHJhY2tpbmdOdW1iZXIgfSxcbiAgICB9KTtcblxuICAgIGlmICghcmVmdW5kKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFcnJvcignUmV0dXJuIG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIGNvbnN0IHRyYWNraW5nSW5mbyA9IGF3YWl0IHRoaXMuc2hpcHBpbmdQcm92aWRlclNlcnZpY2UudHJhY2tTaGlwbWVudCh0cmFja2luZ051bWJlcik7XG5cbiAgICAvLyBVcGRhdGUgcmV0dXJuIHN0YXR1cyBiYXNlZCBvbiB0cmFja2luZ1xuICAgIGxldCByZXR1cm5TdGF0dXMgPSByZWZ1bmQucmV0dXJuU3RhdHVzO1xuICAgIGlmICh0cmFja2luZ0luZm8uc3RhdHVzID09PSAnaW5fdHJhbnNpdCcpIHtcbiAgICAgIHJldHVyblN0YXR1cyA9IFJldHVyblN0YXR1cy5JTl9UUkFOU0lUO1xuICAgIH0gZWxzZSBpZiAodHJhY2tpbmdJbmZvLnN0YXR1cyA9PT0gJ2RlbGl2ZXJlZCcpIHtcbiAgICAgIHJldHVyblN0YXR1cyA9IFJldHVyblN0YXR1cy5SRUNFSVZFRDtcbiAgICB9XG5cbiAgICBpZiAocmV0dXJuU3RhdHVzICE9PSByZWZ1bmQucmV0dXJuU3RhdHVzKSB7XG4gICAgICBhd2FpdCB0aGlzLnJlZnVuZFJlcG9zaXRvcnkudXBkYXRlUmV0dXJuU3RhdHVzKHJlZnVuZC5pZCwgcmV0dXJuU3RhdHVzKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgLi4udHJhY2tpbmdJbmZvLFxuICAgICAgcmVmdW5kSWQ6IHJlZnVuZC5pZCxcbiAgICAgIHJldHVyblN0YXR1cyxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgbWFya1JldHVybkFzUmVjZWl2ZWQocmVmdW5kSWQ6IHN0cmluZykge1xuICAgIGF3YWl0IHRoaXMucmVmdW5kUmVwb3NpdG9yeS5maW5kQnlJZChyZWZ1bmRJZCk7XG5cbiAgICBhd2FpdCB0aGlzLnJlZnVuZFJlcG9zaXRvcnkudXBkYXRlUmV0dXJuU3RhdHVzKHJlZnVuZElkLCBSZXR1cm5TdGF0dXMuUkVDRUlWRUQpO1xuXG4gICAgcmV0dXJuIHRoaXMucmVmdW5kUmVwb3NpdG9yeS5maW5kQnlJZChyZWZ1bmRJZCk7XG4gIH1cblxuICBhc3luYyBnZXRSZWZ1bmRTdGF0aXN0aWNzKG9wdGlvbnM/OiB7IHN0YXJ0RGF0ZT86IERhdGU7IGVuZERhdGU/OiBEYXRlIH0pIHtcbiAgICBjb25zdCB0b3RhbFJlZnVuZGVkID0gYXdhaXQgdGhpcy5yZWZ1bmRSZXBvc2l0b3J5LmdldFRvdGFsUmVmdW5kZWRBbW91bnQoXG4gICAgICBvcHRpb25zPy5zdGFydERhdGUsXG4gICAgICBvcHRpb25zPy5lbmREYXRlXG4gICAgKTtcblxuICAgIGNvbnN0IHBlbmRpbmcgPSBhd2FpdCB0aGlzLnJlZnVuZFJlcG9zaXRvcnkuY291bnRCeVN0YXR1cyhSZWZ1bmRTdGF0dXMuUEVORElORyk7XG4gICAgY29uc3QgYXBwcm92ZWQgPSBhd2FpdCB0aGlzLnJlZnVuZFJlcG9zaXRvcnkuY291bnRCeVN0YXR1cyhSZWZ1bmRTdGF0dXMuQVBQUk9WRUQpO1xuICAgIGNvbnN0IHJlamVjdGVkID0gYXdhaXQgdGhpcy5yZWZ1bmRSZXBvc2l0b3J5LmNvdW50QnlTdGF0dXMoUmVmdW5kU3RhdHVzLlJFSkVDVEVEKTtcbiAgICBjb25zdCBjb21wbGV0ZWQgPSBhd2FpdCB0aGlzLnJlZnVuZFJlcG9zaXRvcnkuY291bnRCeVN0YXR1cyhSZWZ1bmRTdGF0dXMuQ09NUExFVEVEKTtcblxuICAgIHJldHVybiB7XG4gICAgICB0b3RhbFJlZnVuZGVkLFxuICAgICAgcGVuZGluZyxcbiAgICAgIGFwcHJvdmVkLFxuICAgICAgcmVqZWN0ZWQsXG4gICAgICBjb21wbGV0ZWQsXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIGNoZWNrRWxpZ2liaWxpdHkob3JkZXJJZDogc3RyaW5nKSB7XG4gICAgY29uc3Qgb3JkZXIgPSBhd2FpdCB0aGlzLm9yZGVyUmVwb3NpdG9yeS5maW5kQnlJZChvcmRlcklkKTtcblxuICAgIGNvbnN0IGlzc3Vlczogc3RyaW5nW10gPSBbXTtcblxuICAgIGlmIChvcmRlci5wYXltZW50U3RhdHVzICE9PSBQYXltZW50U3RhdHVzLlBBSUQpIHtcbiAgICAgIGlzc3Vlcy5wdXNoKCdPcmRlciBtdXN0IGJlIHBhaWQnKTtcbiAgICB9XG5cbiAgICBpZiAob3JkZXIuZGVsaXZlcmVkQXQpIHtcbiAgICAgIGNvbnN0IGRheXNTaW5jZURlbGl2ZXJ5ID1cbiAgICAgICAgKERhdGUubm93KCkgLSBvcmRlci5kZWxpdmVyZWRBdC5nZXRUaW1lKCkpIC8gKDEwMDAgKiA2MCAqIDYwICogMjQpO1xuICAgICAgaWYgKGRheXNTaW5jZURlbGl2ZXJ5ID4gdGhpcy5SRVRVUk5fV0lORE9XX0RBWVMpIHtcbiAgICAgICAgaXNzdWVzLnB1c2goYFJldHVybiB3aW5kb3cgb2YgJHt0aGlzLlJFVFVSTl9XSU5ET1dfREFZU30gZGF5cyBoYXMgZXhwaXJlZGApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBlbGlnaWJsZTogaXNzdWVzLmxlbmd0aCA9PT0gMCxcbiAgICAgIGlzc3VlcyxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgY2FsY3VsYXRlUmVmdW5kQW1vdW50KGRhdGE6IHtcbiAgICBvcmRlcklkOiBzdHJpbmc7XG4gICAgaXRlbXM6IEFycmF5PHsgcHJvZHVjdElkOiBzdHJpbmc7IHF1YW50aXR5OiBudW1iZXIgfT47XG4gIH0pIHtcbiAgICBjb25zdCBvcmRlciA9IGF3YWl0IHRoaXMub3JkZXJSZXBvc2l0b3J5LmZpbmRCeUlkKGRhdGEub3JkZXJJZCk7XG5cbiAgICBsZXQgdG90YWxSZWZ1bmQgPSAwO1xuXG4gICAgZm9yIChjb25zdCBpdGVtIG9mIGRhdGEuaXRlbXMpIHtcbiAgICAgIGNvbnN0IG9yZGVySXRlbSA9IG9yZGVyLml0ZW1zLmZpbmQob2kgPT4gb2kucHJvZHVjdElkID09PSBpdGVtLnByb2R1Y3RJZCk7XG4gICAgICBpZiAoIW9yZGVySXRlbSkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEVycm9yKGBQcm9kdWN0ICR7aXRlbS5wcm9kdWN0SWR9IG5vdCBmb3VuZCBpbiBvcmRlcmApO1xuICAgICAgfVxuXG4gICAgICBpZiAoaXRlbS5xdWFudGl0eSA+IG9yZGVySXRlbS5xdWFudGl0eSkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEVycm9yKCdSZWZ1bmQgcXVhbnRpdHkgZXhjZWVkcyBvcmRlcmVkIHF1YW50aXR5Jyk7XG4gICAgICB9XG5cbiAgICAgIHRvdGFsUmVmdW5kICs9IG9yZGVySXRlbS51bml0UHJpY2UgKiBpdGVtLnF1YW50aXR5O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICByZWZ1bmRBbW91bnQ6IHRvdGFsUmVmdW5kLFxuICAgICAgaXRlbXM6IGRhdGEuaXRlbXMubWFwKGl0ZW0gPT4ge1xuICAgICAgICBjb25zdCBvcmRlckl0ZW0gPSBvcmRlci5pdGVtcy5maW5kKG9pID0+IG9pLnByb2R1Y3RJZCA9PT0gaXRlbS5wcm9kdWN0SWQpITtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAuLi5pdGVtLFxuICAgICAgICAgIHVuaXRQcmljZTogb3JkZXJJdGVtLnVuaXRQcmljZSxcbiAgICAgICAgICByZWZ1bmRBbW91bnQ6IG9yZGVySXRlbS51bml0UHJpY2UgKiBpdGVtLnF1YW50aXR5LFxuICAgICAgICB9O1xuICAgICAgfSksXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIGdldFVzZXJSZWZ1bmRzKHVzZXJJZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMucmVmdW5kUmVwb3NpdG9yeS5maW5kQnlVc2VySWQodXNlcklkKTtcbiAgfVxuXG4gIGFzeW5jIGdldE9yZGVyUmVmdW5kcyhvcmRlcklkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5yZWZ1bmRSZXBvc2l0b3J5LmZpbmRCeU9yZGVySWQob3JkZXJJZCk7XG4gIH1cblxuICBwcml2YXRlIGdldCByZXBvc2l0b3J5KCkge1xuICAgIHJldHVybiB0aGlzLnJlZnVuZFJlcG9zaXRvcnlbJ3JlcG9zaXRvcnknXTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9