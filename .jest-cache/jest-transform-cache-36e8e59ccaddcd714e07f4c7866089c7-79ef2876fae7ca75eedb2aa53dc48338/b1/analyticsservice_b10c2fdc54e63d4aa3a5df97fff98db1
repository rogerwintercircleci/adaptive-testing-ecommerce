c61abd90baf72f7c20f949e14fab7733
"use strict";
/**
 * TDD Implementation: Analytics Service
 *
 * Sales metrics, user behavior tracking, and reporting
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.AnalyticsService = void 0;
const user_entity_1 = require("../../user-management/entities/user.entity");
class AnalyticsService {
    orderRepository;
    productRepository;
    userRepository;
    eventStore = new Map();
    productMetrics = new Map();
    constructor(orderRepository, productRepository, userRepository) {
        this.orderRepository = orderRepository;
        this.productRepository = productRepository;
        this.userRepository = userRepository;
    }
    /**
     * Get total revenue from all orders
     */
    async getTotalRevenue() {
        return this.orderRepository.getTotalRevenue();
    }
    /**
     * Get revenue for date range
     */
    async getRevenueByDateRange(startDate, endDate) {
        const orders = await this.orderRepository.findOrdersByDateRange(startDate, endDate);
        return orders.reduce((sum, order) => sum + order.total, 0);
    }
    /**
     * Calculate average order value
     */
    async getAverageOrderValue() {
        const totalRevenue = await this.orderRepository.getTotalRevenue();
        const orderCount = await this.orderRepository.count();
        if (orderCount === 0) {
            return 0;
        }
        return Math.round((totalRevenue / orderCount) * 100) / 100;
    }
    /**
     * Get top selling products
     */
    async getTopSellingProducts(limit = 10) {
        return this.productRepository.findTopSelling(limit);
    }
    /**
     * Get top rated products
     */
    async getTopRatedProducts(limit = 10) {
        return this.productRepository.findTopRated(limit);
    }
    /**
     * Get low stock alerts
     */
    async getLowStockAlert(threshold = 10) {
        return this.productRepository.findLowStock(threshold);
    }
    /**
     * Get user growth metrics
     */
    async getUserGrowthMetrics() {
        const totalUsers = await this.userRepository.count();
        // Calculate new users this month
        const startOfMonth = new Date();
        startOfMonth.setDate(1);
        startOfMonth.setHours(0, 0, 0, 0);
        // In a real implementation, this would filter by created date
        const newUsersThisMonth = await this.userRepository.count();
        const actualNewUsers = Math.min(newUsersThisMonth, totalUsers);
        const growthRate = totalUsers > 0
            ? Math.round((actualNewUsers / totalUsers) * 100)
            : 0;
        return {
            totalUsers,
            newUsersThisMonth: actualNewUsers,
            growthRate,
        };
    }
    /**
     * Get active user count
     */
    async getActiveUserCount() {
        const activeUsers = await this.userRepository.findByStatus(user_entity_1.UserStatus.ACTIVE);
        return activeUsers.length;
    }
    /**
     * Get sales metrics by period
     */
    async getSalesMetricsByPeriod(period) {
        const endDate = new Date();
        const startDate = new Date();
        // Calculate date range based on period
        switch (period) {
            case 'day':
                startDate.setDate(endDate.getDate() - 30); // Last 30 days
                break;
            case 'week':
                startDate.setDate(endDate.getDate() - 84); // Last 12 weeks
                break;
            case 'month':
                startDate.setMonth(endDate.getMonth() - 12); // Last 12 months
                break;
        }
        const orders = await this.orderRepository.findOrdersByDateRange(startDate, endDate);
        // Group orders by period
        const metrics = [];
        const groupedOrders = this.groupOrdersByPeriod(orders, period);
        for (const [periodKey, periodOrders] of Object.entries(groupedOrders)) {
            const revenue = periodOrders.reduce((sum, order) => sum + order.total, 0);
            const orderCount = periodOrders.length;
            const averageOrderValue = orderCount > 0 ? revenue / orderCount : 0;
            metrics.push({
                period: periodKey,
                revenue,
                orderCount,
                averageOrderValue,
            });
        }
        return metrics;
    }
    /**
     * Calculate conversion rate
     */
    async getConversionRate(visitors, orders) {
        if (visitors === 0) {
            return 0;
        }
        return Math.round((orders / visitors) * 100 * 100) / 100;
    }
    /**
     * Calculate customer lifetime value
     */
    async getCustomerLifetimeValue() {
        const totalRevenue = await this.orderRepository.getTotalRevenue();
        const totalCustomers = await this.userRepository.count();
        if (totalCustomers === 0) {
            return 0;
        }
        return Math.round(totalRevenue / totalCustomers);
    }
    /**
     * Get product performance metrics
     */
    async getProductPerformance(productId) {
        let metrics = this.productMetrics.get(productId);
        if (!metrics) {
            metrics = {
                views: 0,
                purchases: 0,
                conversionRate: 0,
                revenue: 0,
            };
            this.productMetrics.set(productId, metrics);
        }
        return metrics;
    }
    /**
     * Track analytics event
     */
    async trackEvent(event) {
        const userEvents = this.eventStore.get(event.userId) || [];
        userEvents.push(event);
        this.eventStore.set(event.userId, userEvents);
        // Update product metrics if it's a product-related event
        if (event.productId && event.eventType === 'product_view') {
            const metrics = await this.getProductPerformance(event.productId);
            metrics.views++;
            this.productMetrics.set(event.productId, metrics);
        }
    }
    /**
     * Get events by user
     */
    async getEventsByUser(userId) {
        return this.eventStore.get(userId) || [];
    }
    /**
     * Get dashboard metrics
     */
    async getDashboardMetrics() {
        const totalRevenue = await this.orderRepository.getTotalRevenue();
        const totalOrders = await this.orderRepository.count();
        const totalUsers = await this.userRepository.count();
        const totalProducts = await this.productRepository.count();
        const averageOrderValue = await this.getAverageOrderValue();
        const userGrowth = await this.getUserGrowthMetrics();
        return {
            totalRevenue,
            totalOrders,
            totalUsers,
            totalProducts,
            averageOrderValue,
            userGrowthRate: userGrowth.growthRate,
        };
    }
    /**
     * Export analytics report
     */
    async exportReport(type, options) {
        const report = {
            type,
            generatedAt: new Date(),
            data: {},
        };
        switch (type) {
            case 'revenue':
                report.data = {
                    totalRevenue: await this.getTotalRevenue(),
                    averageOrderValue: await this.getAverageOrderValue(),
                    orderCount: await this.orderRepository.count(),
                };
                if (options?.startDate && options?.endDate) {
                    report.data.periodRevenue = await this.getRevenueByDateRange(options.startDate, options.endDate);
                }
                break;
            case 'users':
                report.data = {
                    totalUsers: await this.userRepository.count(),
                    activeUsers: await this.getActiveUserCount(),
                    userGrowth: await this.getUserGrowthMetrics(),
                    customerLifetimeValue: await this.getCustomerLifetimeValue(),
                };
                break;
            case 'products':
                report.data = {
                    totalProducts: await this.productRepository.count(),
                    topSelling: await this.getTopSellingProducts(10),
                    topRated: await this.getTopRatedProducts(10),
                    lowStock: await this.getLowStockAlert(),
                };
                break;
        }
        return report;
    }
    /**
     * Group orders by period
     */
    groupOrdersByPeriod(orders, period) {
        const grouped = {};
        for (const order of orders) {
            const date = new Date(order.createdAt);
            let key;
            switch (period) {
                case 'day':
                    key = date.toISOString().split('T')[0];
                    break;
                case 'week':
                    const weekNum = this.getWeekNumber(date);
                    key = `${date.getFullYear()}-W${weekNum}`;
                    break;
                case 'month':
                    key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    break;
            }
            if (!grouped[key]) {
                grouped[key] = [];
            }
            grouped[key].push(order);
        }
        return grouped;
    }
    /**
     * Get week number of year
     */
    getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d.getTime() - yearStart.getTime()) / 86400000) + 1) / 7);
    }
}
exports.AnalyticsService = AnalyticsService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXEFkYXB0aXZlX1Rlc3RpbmdcXHNyY1xcc2VydmljZXNcXGFuYWx5dGljc1xcc2VydmljZXNcXGFuYWx5dGljcy5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHOzs7QUFNSCw0RUFBd0U7QUE4Q3hFLE1BQWEsZ0JBQWdCO0lBS2pCO0lBQ0E7SUFDQTtJQU5GLFVBQVUsR0FBa0MsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUN0RCxjQUFjLEdBQTJDLElBQUksR0FBRyxFQUFFLENBQUM7SUFFM0UsWUFDVSxlQUFnQyxFQUNoQyxpQkFBb0MsRUFDcEMsY0FBOEI7UUFGOUIsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ2hDLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFDcEMsbUJBQWMsR0FBZCxjQUFjLENBQWdCO0lBQ3JDLENBQUM7SUFFSjs7T0FFRztJQUNILEtBQUssQ0FBQyxlQUFlO1FBQ25CLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxlQUFlLEVBQUUsQ0FBQztJQUNoRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMscUJBQXFCLENBQUMsU0FBZSxFQUFFLE9BQWE7UUFDeEQsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLHFCQUFxQixDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNwRixPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztJQUM3RCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsb0JBQW9CO1FBQ3hCLE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUNsRSxNQUFNLFVBQVUsR0FBRyxNQUFNLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFdEQsSUFBSSxVQUFVLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDckIsT0FBTyxDQUFDLENBQUM7UUFDWCxDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsWUFBWSxHQUFHLFVBQVUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQztJQUM3RCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMscUJBQXFCLENBQUMsUUFBZ0IsRUFBRTtRQUM1QyxPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLG1CQUFtQixDQUFDLFFBQWdCLEVBQUU7UUFDMUMsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3BELENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFvQixFQUFFO1FBQzNDLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN4RCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsb0JBQW9CO1FBQ3hCLE1BQU0sVUFBVSxHQUFHLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUVyRCxpQ0FBaUM7UUFDakMsTUFBTSxZQUFZLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUNoQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3hCLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFFbEMsOERBQThEO1FBQzlELE1BQU0saUJBQWlCLEdBQUcsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzVELE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsaUJBQWlCLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFFL0QsTUFBTSxVQUFVLEdBQUcsVUFBVSxHQUFHLENBQUM7WUFDL0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxjQUFjLEdBQUcsVUFBVSxDQUFDLEdBQUcsR0FBRyxDQUFDO1lBQ2pELENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFTixPQUFPO1lBQ0wsVUFBVTtZQUNWLGlCQUFpQixFQUFFLGNBQWM7WUFDakMsVUFBVTtTQUNYLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsa0JBQWtCO1FBQ3RCLE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQUMsd0JBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM5RSxPQUFPLFdBQVcsQ0FBQyxNQUFNLENBQUM7SUFDNUIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLHVCQUF1QixDQUFDLE1BQWdDO1FBQzVELE1BQU0sT0FBTyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDM0IsTUFBTSxTQUFTLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUU3Qix1Q0FBdUM7UUFDdkMsUUFBUSxNQUFNLEVBQUUsQ0FBQztZQUNmLEtBQUssS0FBSztnQkFDUixTQUFTLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLGVBQWU7Z0JBQzFELE1BQU07WUFDUixLQUFLLE1BQU07Z0JBQ1QsU0FBUyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxnQkFBZ0I7Z0JBQzNELE1BQU07WUFDUixLQUFLLE9BQU87Z0JBQ1YsU0FBUyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxpQkFBaUI7Z0JBQzlELE1BQU07UUFDVixDQUFDO1FBRUQsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLHFCQUFxQixDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUVwRix5QkFBeUI7UUFDekIsTUFBTSxPQUFPLEdBQWtCLEVBQUUsQ0FBQztRQUNsQyxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRS9ELEtBQUssTUFBTSxDQUFDLFNBQVMsRUFBRSxZQUFZLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUM7WUFDdEUsTUFBTSxPQUFPLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLEdBQUcsR0FBRyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzFFLE1BQU0sVUFBVSxHQUFHLFlBQVksQ0FBQyxNQUFNLENBQUM7WUFDdkMsTUFBTSxpQkFBaUIsR0FBRyxVQUFVLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFcEUsT0FBTyxDQUFDLElBQUksQ0FBQztnQkFDWCxNQUFNLEVBQUUsU0FBUztnQkFDakIsT0FBTztnQkFDUCxVQUFVO2dCQUNWLGlCQUFpQjthQUNsQixDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLGlCQUFpQixDQUFDLFFBQWdCLEVBQUUsTUFBYztRQUN0RCxJQUFJLFFBQVEsS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUNuQixPQUFPLENBQUMsQ0FBQztRQUNYLENBQUM7UUFFRCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLEdBQUcsUUFBUSxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQztJQUMzRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsd0JBQXdCO1FBQzVCLE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUNsRSxNQUFNLGNBQWMsR0FBRyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFekQsSUFBSSxjQUFjLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDekIsT0FBTyxDQUFDLENBQUM7UUFDWCxDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksR0FBRyxjQUFjLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMscUJBQXFCLENBQUMsU0FBaUI7UUFDM0MsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFakQsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ2IsT0FBTyxHQUFHO2dCQUNSLEtBQUssRUFBRSxDQUFDO2dCQUNSLFNBQVMsRUFBRSxDQUFDO2dCQUNaLGNBQWMsRUFBRSxDQUFDO2dCQUNqQixPQUFPLEVBQUUsQ0FBQzthQUNYLENBQUM7WUFDRixJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDOUMsQ0FBQztRQUVELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxVQUFVLENBQUMsS0FBcUI7UUFDcEMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUMzRCxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFFOUMseURBQXlEO1FBQ3pELElBQUksS0FBSyxDQUFDLFNBQVMsSUFBSSxLQUFLLENBQUMsU0FBUyxLQUFLLGNBQWMsRUFBRSxDQUFDO1lBQzFELE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNsRSxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDaEIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNwRCxDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLGVBQWUsQ0FBQyxNQUFjO1FBQ2xDLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQzNDLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxtQkFBbUI7UUFDdkIsTUFBTSxZQUFZLEdBQUcsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQ2xFLE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUN2RCxNQUFNLFVBQVUsR0FBRyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDckQsTUFBTSxhQUFhLEdBQUcsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDM0QsTUFBTSxpQkFBaUIsR0FBRyxNQUFNLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBQzVELE1BQU0sVUFBVSxHQUFHLE1BQU0sSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7UUFFckQsT0FBTztZQUNMLFlBQVk7WUFDWixXQUFXO1lBQ1gsVUFBVTtZQUNWLGFBQWE7WUFDYixpQkFBaUI7WUFDakIsY0FBYyxFQUFFLFVBQVUsQ0FBQyxVQUFVO1NBQ3RDLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsWUFBWSxDQUNoQixJQUFzQyxFQUN0QyxPQUE4QztRQUU5QyxNQUFNLE1BQU0sR0FBb0I7WUFDOUIsSUFBSTtZQUNKLFdBQVcsRUFBRSxJQUFJLElBQUksRUFBRTtZQUN2QixJQUFJLEVBQUUsRUFBRTtTQUNULENBQUM7UUFFRixRQUFRLElBQUksRUFBRSxDQUFDO1lBQ2IsS0FBSyxTQUFTO2dCQUNaLE1BQU0sQ0FBQyxJQUFJLEdBQUc7b0JBQ1osWUFBWSxFQUFFLE1BQU0sSUFBSSxDQUFDLGVBQWUsRUFBRTtvQkFDMUMsaUJBQWlCLEVBQUUsTUFBTSxJQUFJLENBQUMsb0JBQW9CLEVBQUU7b0JBQ3BELFVBQVUsRUFBRSxNQUFNLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFO2lCQUMvQyxDQUFDO2dCQUNGLElBQUksT0FBTyxFQUFFLFNBQVMsSUFBSSxPQUFPLEVBQUUsT0FBTyxFQUFFLENBQUM7b0JBQzNDLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxHQUFHLE1BQU0sSUFBSSxDQUFDLHFCQUFxQixDQUMxRCxPQUFPLENBQUMsU0FBUyxFQUNqQixPQUFPLENBQUMsT0FBTyxDQUNoQixDQUFDO2dCQUNKLENBQUM7Z0JBQ0QsTUFBTTtZQUVSLEtBQUssT0FBTztnQkFDVixNQUFNLENBQUMsSUFBSSxHQUFHO29CQUNaLFVBQVUsRUFBRSxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFO29CQUM3QyxXQUFXLEVBQUUsTUFBTSxJQUFJLENBQUMsa0JBQWtCLEVBQUU7b0JBQzVDLFVBQVUsRUFBRSxNQUFNLElBQUksQ0FBQyxvQkFBb0IsRUFBRTtvQkFDN0MscUJBQXFCLEVBQUUsTUFBTSxJQUFJLENBQUMsd0JBQXdCLEVBQUU7aUJBQzdELENBQUM7Z0JBQ0YsTUFBTTtZQUVSLEtBQUssVUFBVTtnQkFDYixNQUFNLENBQUMsSUFBSSxHQUFHO29CQUNaLGFBQWEsRUFBRSxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLEVBQUU7b0JBQ25ELFVBQVUsRUFBRSxNQUFNLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxFQUFFLENBQUM7b0JBQ2hELFFBQVEsRUFBRSxNQUFNLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFLENBQUM7b0JBQzVDLFFBQVEsRUFBRSxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtpQkFDeEMsQ0FBQztnQkFDRixNQUFNO1FBQ1YsQ0FBQztRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFFRDs7T0FFRztJQUNLLG1CQUFtQixDQUN6QixNQUFhLEVBQ2IsTUFBZ0M7UUFFaEMsTUFBTSxPQUFPLEdBQTBCLEVBQUUsQ0FBQztRQUUxQyxLQUFLLE1BQU0sS0FBSyxJQUFJLE1BQU0sRUFBRSxDQUFDO1lBQzNCLE1BQU0sSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUN2QyxJQUFJLEdBQVcsQ0FBQztZQUVoQixRQUFRLE1BQU0sRUFBRSxDQUFDO2dCQUNmLEtBQUssS0FBSztvQkFDUixHQUFHLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDdkMsTUFBTTtnQkFDUixLQUFLLE1BQU07b0JBQ1QsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDekMsR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRSxLQUFLLE9BQU8sRUFBRSxDQUFDO29CQUMxQyxNQUFNO2dCQUNSLEtBQUssT0FBTztvQkFDVixHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUM7b0JBQzlFLE1BQU07WUFDVixDQUFDO1lBRUQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO2dCQUNsQixPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ3BCLENBQUM7WUFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzNCLENBQUM7UUFFRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBRUQ7O09BRUc7SUFDSyxhQUFhLENBQUMsSUFBVTtRQUM5QixNQUFNLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNsRixNQUFNLE1BQU0sR0FBRyxDQUFDLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2xDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQztRQUMxQyxNQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxjQUFjLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMvRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxHQUFHLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQy9FLENBQUM7Q0FDRjtBQS9URCw0Q0ErVEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXEFkYXB0aXZlX1Rlc3RpbmdcXHNyY1xcc2VydmljZXNcXGFuYWx5dGljc1xcc2VydmljZXNcXGFuYWx5dGljcy5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVEREIEltcGxlbWVudGF0aW9uOiBBbmFseXRpY3MgU2VydmljZVxuICpcbiAqIFNhbGVzIG1ldHJpY3MsIHVzZXIgYmVoYXZpb3IgdHJhY2tpbmcsIGFuZCByZXBvcnRpbmdcbiAqL1xuXG5pbXBvcnQgeyBPcmRlclJlcG9zaXRvcnkgfSBmcm9tICcuLi8uLi9vcmRlci1wcm9jZXNzaW5nL3JlcG9zaXRvcmllcy9vcmRlci5yZXBvc2l0b3J5JztcbmltcG9ydCB7IFByb2R1Y3RSZXBvc2l0b3J5IH0gZnJvbSAnLi4vLi4vcHJvZHVjdC1jYXRhbG9nL3JlcG9zaXRvcmllcy9wcm9kdWN0LnJlcG9zaXRvcnknO1xuaW1wb3J0IHsgVXNlclJlcG9zaXRvcnkgfSBmcm9tICcuLi8uLi91c2VyLW1hbmFnZW1lbnQvcmVwb3NpdG9yaWVzL3VzZXIucmVwb3NpdG9yeSc7XG5pbXBvcnQgeyBQcm9kdWN0IH0gZnJvbSAnLi4vLi4vcHJvZHVjdC1jYXRhbG9nL2VudGl0aWVzL3Byb2R1Y3QuZW50aXR5JztcbmltcG9ydCB7IFVzZXJTdGF0dXMgfSBmcm9tICcuLi8uLi91c2VyLW1hbmFnZW1lbnQvZW50aXRpZXMvdXNlci5lbnRpdHknO1xuXG5leHBvcnQgaW50ZXJmYWNlIFVzZXJHcm93dGhNZXRyaWNzIHtcbiAgdG90YWxVc2VyczogbnVtYmVyO1xuICBuZXdVc2Vyc1RoaXNNb250aDogbnVtYmVyO1xuICBncm93dGhSYXRlOiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2FsZXNNZXRyaWMge1xuICBwZXJpb2Q6IHN0cmluZztcbiAgcmV2ZW51ZTogbnVtYmVyO1xuICBvcmRlckNvdW50OiBudW1iZXI7XG4gIGF2ZXJhZ2VPcmRlclZhbHVlOiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJvZHVjdFBlcmZvcm1hbmNlTWV0cmljcyB7XG4gIHZpZXdzOiBudW1iZXI7XG4gIHB1cmNoYXNlczogbnVtYmVyO1xuICBjb252ZXJzaW9uUmF0ZTogbnVtYmVyO1xuICByZXZlbnVlOiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQW5hbHl0aWNzRXZlbnQge1xuICB1c2VySWQ6IHN0cmluZztcbiAgZXZlbnRUeXBlOiBzdHJpbmc7XG4gIHRpbWVzdGFtcDogRGF0ZTtcbiAgcHJvZHVjdElkPzogc3RyaW5nO1xuICBwYWdlPzogc3RyaW5nO1xuICBtZXRhZGF0YT86IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIERhc2hib2FyZE1ldHJpY3Mge1xuICB0b3RhbFJldmVudWU6IG51bWJlcjtcbiAgdG90YWxPcmRlcnM6IG51bWJlcjtcbiAgdG90YWxVc2VyczogbnVtYmVyO1xuICB0b3RhbFByb2R1Y3RzOiBudW1iZXI7XG4gIGF2ZXJhZ2VPcmRlclZhbHVlOiBudW1iZXI7XG4gIHVzZXJHcm93dGhSYXRlOiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQW5hbHl0aWNzUmVwb3J0IHtcbiAgdHlwZTogJ3JldmVudWUnIHwgJ3VzZXJzJyB8ICdwcm9kdWN0cyc7XG4gIGdlbmVyYXRlZEF0OiBEYXRlO1xuICBkYXRhOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbn1cblxuZXhwb3J0IGNsYXNzIEFuYWx5dGljc1NlcnZpY2Uge1xuICBwcml2YXRlIGV2ZW50U3RvcmU6IE1hcDxzdHJpbmcsIEFuYWx5dGljc0V2ZW50W10+ID0gbmV3IE1hcCgpO1xuICBwcml2YXRlIHByb2R1Y3RNZXRyaWNzOiBNYXA8c3RyaW5nLCBQcm9kdWN0UGVyZm9ybWFuY2VNZXRyaWNzPiA9IG5ldyBNYXAoKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG9yZGVyUmVwb3NpdG9yeTogT3JkZXJSZXBvc2l0b3J5LFxuICAgIHByaXZhdGUgcHJvZHVjdFJlcG9zaXRvcnk6IFByb2R1Y3RSZXBvc2l0b3J5LFxuICAgIHByaXZhdGUgdXNlclJlcG9zaXRvcnk6IFVzZXJSZXBvc2l0b3J5XG4gICkge31cblxuICAvKipcbiAgICogR2V0IHRvdGFsIHJldmVudWUgZnJvbSBhbGwgb3JkZXJzXG4gICAqL1xuICBhc3luYyBnZXRUb3RhbFJldmVudWUoKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICByZXR1cm4gdGhpcy5vcmRlclJlcG9zaXRvcnkuZ2V0VG90YWxSZXZlbnVlKCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHJldmVudWUgZm9yIGRhdGUgcmFuZ2VcbiAgICovXG4gIGFzeW5jIGdldFJldmVudWVCeURhdGVSYW5nZShzdGFydERhdGU6IERhdGUsIGVuZERhdGU6IERhdGUpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGNvbnN0IG9yZGVycyA9IGF3YWl0IHRoaXMub3JkZXJSZXBvc2l0b3J5LmZpbmRPcmRlcnNCeURhdGVSYW5nZShzdGFydERhdGUsIGVuZERhdGUpO1xuICAgIHJldHVybiBvcmRlcnMucmVkdWNlKChzdW0sIG9yZGVyKSA9PiBzdW0gKyBvcmRlci50b3RhbCwgMCk7XG4gIH1cblxuICAvKipcbiAgICogQ2FsY3VsYXRlIGF2ZXJhZ2Ugb3JkZXIgdmFsdWVcbiAgICovXG4gIGFzeW5jIGdldEF2ZXJhZ2VPcmRlclZhbHVlKCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3QgdG90YWxSZXZlbnVlID0gYXdhaXQgdGhpcy5vcmRlclJlcG9zaXRvcnkuZ2V0VG90YWxSZXZlbnVlKCk7XG4gICAgY29uc3Qgb3JkZXJDb3VudCA9IGF3YWl0IHRoaXMub3JkZXJSZXBvc2l0b3J5LmNvdW50KCk7XG5cbiAgICBpZiAob3JkZXJDb3VudCA9PT0gMCkge1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuXG4gICAgcmV0dXJuIE1hdGgucm91bmQoKHRvdGFsUmV2ZW51ZSAvIG9yZGVyQ291bnQpICogMTAwKSAvIDEwMDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdG9wIHNlbGxpbmcgcHJvZHVjdHNcbiAgICovXG4gIGFzeW5jIGdldFRvcFNlbGxpbmdQcm9kdWN0cyhsaW1pdDogbnVtYmVyID0gMTApOiBQcm9taXNlPFByb2R1Y3RbXT4ge1xuICAgIHJldHVybiB0aGlzLnByb2R1Y3RSZXBvc2l0b3J5LmZpbmRUb3BTZWxsaW5nKGxpbWl0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdG9wIHJhdGVkIHByb2R1Y3RzXG4gICAqL1xuICBhc3luYyBnZXRUb3BSYXRlZFByb2R1Y3RzKGxpbWl0OiBudW1iZXIgPSAxMCk6IFByb21pc2U8UHJvZHVjdFtdPiB7XG4gICAgcmV0dXJuIHRoaXMucHJvZHVjdFJlcG9zaXRvcnkuZmluZFRvcFJhdGVkKGxpbWl0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgbG93IHN0b2NrIGFsZXJ0c1xuICAgKi9cbiAgYXN5bmMgZ2V0TG93U3RvY2tBbGVydCh0aHJlc2hvbGQ6IG51bWJlciA9IDEwKTogUHJvbWlzZTxQcm9kdWN0W10+IHtcbiAgICByZXR1cm4gdGhpcy5wcm9kdWN0UmVwb3NpdG9yeS5maW5kTG93U3RvY2sodGhyZXNob2xkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdXNlciBncm93dGggbWV0cmljc1xuICAgKi9cbiAgYXN5bmMgZ2V0VXNlckdyb3d0aE1ldHJpY3MoKTogUHJvbWlzZTxVc2VyR3Jvd3RoTWV0cmljcz4ge1xuICAgIGNvbnN0IHRvdGFsVXNlcnMgPSBhd2FpdCB0aGlzLnVzZXJSZXBvc2l0b3J5LmNvdW50KCk7XG5cbiAgICAvLyBDYWxjdWxhdGUgbmV3IHVzZXJzIHRoaXMgbW9udGhcbiAgICBjb25zdCBzdGFydE9mTW9udGggPSBuZXcgRGF0ZSgpO1xuICAgIHN0YXJ0T2ZNb250aC5zZXREYXRlKDEpO1xuICAgIHN0YXJ0T2ZNb250aC5zZXRIb3VycygwLCAwLCAwLCAwKTtcblxuICAgIC8vIEluIGEgcmVhbCBpbXBsZW1lbnRhdGlvbiwgdGhpcyB3b3VsZCBmaWx0ZXIgYnkgY3JlYXRlZCBkYXRlXG4gICAgY29uc3QgbmV3VXNlcnNUaGlzTW9udGggPSBhd2FpdCB0aGlzLnVzZXJSZXBvc2l0b3J5LmNvdW50KCk7XG4gICAgY29uc3QgYWN0dWFsTmV3VXNlcnMgPSBNYXRoLm1pbihuZXdVc2Vyc1RoaXNNb250aCwgdG90YWxVc2Vycyk7XG5cbiAgICBjb25zdCBncm93dGhSYXRlID0gdG90YWxVc2VycyA+IDBcbiAgICAgID8gTWF0aC5yb3VuZCgoYWN0dWFsTmV3VXNlcnMgLyB0b3RhbFVzZXJzKSAqIDEwMClcbiAgICAgIDogMDtcblxuICAgIHJldHVybiB7XG4gICAgICB0b3RhbFVzZXJzLFxuICAgICAgbmV3VXNlcnNUaGlzTW9udGg6IGFjdHVhbE5ld1VzZXJzLFxuICAgICAgZ3Jvd3RoUmF0ZSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhY3RpdmUgdXNlciBjb3VudFxuICAgKi9cbiAgYXN5bmMgZ2V0QWN0aXZlVXNlckNvdW50KCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3QgYWN0aXZlVXNlcnMgPSBhd2FpdCB0aGlzLnVzZXJSZXBvc2l0b3J5LmZpbmRCeVN0YXR1cyhVc2VyU3RhdHVzLkFDVElWRSk7XG4gICAgcmV0dXJuIGFjdGl2ZVVzZXJzLmxlbmd0aDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgc2FsZXMgbWV0cmljcyBieSBwZXJpb2RcbiAgICovXG4gIGFzeW5jIGdldFNhbGVzTWV0cmljc0J5UGVyaW9kKHBlcmlvZDogJ2RheScgfCAnd2VlaycgfCAnbW9udGgnKTogUHJvbWlzZTxTYWxlc01ldHJpY1tdPiB7XG4gICAgY29uc3QgZW5kRGF0ZSA9IG5ldyBEYXRlKCk7XG4gICAgY29uc3Qgc3RhcnREYXRlID0gbmV3IERhdGUoKTtcblxuICAgIC8vIENhbGN1bGF0ZSBkYXRlIHJhbmdlIGJhc2VkIG9uIHBlcmlvZFxuICAgIHN3aXRjaCAocGVyaW9kKSB7XG4gICAgICBjYXNlICdkYXknOlxuICAgICAgICBzdGFydERhdGUuc2V0RGF0ZShlbmREYXRlLmdldERhdGUoKSAtIDMwKTsgLy8gTGFzdCAzMCBkYXlzXG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnd2Vlayc6XG4gICAgICAgIHN0YXJ0RGF0ZS5zZXREYXRlKGVuZERhdGUuZ2V0RGF0ZSgpIC0gODQpOyAvLyBMYXN0IDEyIHdlZWtzXG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnbW9udGgnOlxuICAgICAgICBzdGFydERhdGUuc2V0TW9udGgoZW5kRGF0ZS5nZXRNb250aCgpIC0gMTIpOyAvLyBMYXN0IDEyIG1vbnRoc1xuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICBjb25zdCBvcmRlcnMgPSBhd2FpdCB0aGlzLm9yZGVyUmVwb3NpdG9yeS5maW5kT3JkZXJzQnlEYXRlUmFuZ2Uoc3RhcnREYXRlLCBlbmREYXRlKTtcblxuICAgIC8vIEdyb3VwIG9yZGVycyBieSBwZXJpb2RcbiAgICBjb25zdCBtZXRyaWNzOiBTYWxlc01ldHJpY1tdID0gW107XG4gICAgY29uc3QgZ3JvdXBlZE9yZGVycyA9IHRoaXMuZ3JvdXBPcmRlcnNCeVBlcmlvZChvcmRlcnMsIHBlcmlvZCk7XG5cbiAgICBmb3IgKGNvbnN0IFtwZXJpb2RLZXksIHBlcmlvZE9yZGVyc10gb2YgT2JqZWN0LmVudHJpZXMoZ3JvdXBlZE9yZGVycykpIHtcbiAgICAgIGNvbnN0IHJldmVudWUgPSBwZXJpb2RPcmRlcnMucmVkdWNlKChzdW0sIG9yZGVyKSA9PiBzdW0gKyBvcmRlci50b3RhbCwgMCk7XG4gICAgICBjb25zdCBvcmRlckNvdW50ID0gcGVyaW9kT3JkZXJzLmxlbmd0aDtcbiAgICAgIGNvbnN0IGF2ZXJhZ2VPcmRlclZhbHVlID0gb3JkZXJDb3VudCA+IDAgPyByZXZlbnVlIC8gb3JkZXJDb3VudCA6IDA7XG5cbiAgICAgIG1ldHJpY3MucHVzaCh7XG4gICAgICAgIHBlcmlvZDogcGVyaW9kS2V5LFxuICAgICAgICByZXZlbnVlLFxuICAgICAgICBvcmRlckNvdW50LFxuICAgICAgICBhdmVyYWdlT3JkZXJWYWx1ZSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBtZXRyaWNzO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZSBjb252ZXJzaW9uIHJhdGVcbiAgICovXG4gIGFzeW5jIGdldENvbnZlcnNpb25SYXRlKHZpc2l0b3JzOiBudW1iZXIsIG9yZGVyczogbnVtYmVyKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICBpZiAodmlzaXRvcnMgPT09IDApIHtcbiAgICAgIHJldHVybiAwO1xuICAgIH1cblxuICAgIHJldHVybiBNYXRoLnJvdW5kKChvcmRlcnMgLyB2aXNpdG9ycykgKiAxMDAgKiAxMDApIC8gMTAwO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZSBjdXN0b21lciBsaWZldGltZSB2YWx1ZVxuICAgKi9cbiAgYXN5bmMgZ2V0Q3VzdG9tZXJMaWZldGltZVZhbHVlKCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3QgdG90YWxSZXZlbnVlID0gYXdhaXQgdGhpcy5vcmRlclJlcG9zaXRvcnkuZ2V0VG90YWxSZXZlbnVlKCk7XG4gICAgY29uc3QgdG90YWxDdXN0b21lcnMgPSBhd2FpdCB0aGlzLnVzZXJSZXBvc2l0b3J5LmNvdW50KCk7XG5cbiAgICBpZiAodG90YWxDdXN0b21lcnMgPT09IDApIHtcbiAgICAgIHJldHVybiAwO1xuICAgIH1cblxuICAgIHJldHVybiBNYXRoLnJvdW5kKHRvdGFsUmV2ZW51ZSAvIHRvdGFsQ3VzdG9tZXJzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgcHJvZHVjdCBwZXJmb3JtYW5jZSBtZXRyaWNzXG4gICAqL1xuICBhc3luYyBnZXRQcm9kdWN0UGVyZm9ybWFuY2UocHJvZHVjdElkOiBzdHJpbmcpOiBQcm9taXNlPFByb2R1Y3RQZXJmb3JtYW5jZU1ldHJpY3M+IHtcbiAgICBsZXQgbWV0cmljcyA9IHRoaXMucHJvZHVjdE1ldHJpY3MuZ2V0KHByb2R1Y3RJZCk7XG5cbiAgICBpZiAoIW1ldHJpY3MpIHtcbiAgICAgIG1ldHJpY3MgPSB7XG4gICAgICAgIHZpZXdzOiAwLFxuICAgICAgICBwdXJjaGFzZXM6IDAsXG4gICAgICAgIGNvbnZlcnNpb25SYXRlOiAwLFxuICAgICAgICByZXZlbnVlOiAwLFxuICAgICAgfTtcbiAgICAgIHRoaXMucHJvZHVjdE1ldHJpY3Muc2V0KHByb2R1Y3RJZCwgbWV0cmljcyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG1ldHJpY3M7XG4gIH1cblxuICAvKipcbiAgICogVHJhY2sgYW5hbHl0aWNzIGV2ZW50XG4gICAqL1xuICBhc3luYyB0cmFja0V2ZW50KGV2ZW50OiBBbmFseXRpY3NFdmVudCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHVzZXJFdmVudHMgPSB0aGlzLmV2ZW50U3RvcmUuZ2V0KGV2ZW50LnVzZXJJZCkgfHwgW107XG4gICAgdXNlckV2ZW50cy5wdXNoKGV2ZW50KTtcbiAgICB0aGlzLmV2ZW50U3RvcmUuc2V0KGV2ZW50LnVzZXJJZCwgdXNlckV2ZW50cyk7XG5cbiAgICAvLyBVcGRhdGUgcHJvZHVjdCBtZXRyaWNzIGlmIGl0J3MgYSBwcm9kdWN0LXJlbGF0ZWQgZXZlbnRcbiAgICBpZiAoZXZlbnQucHJvZHVjdElkICYmIGV2ZW50LmV2ZW50VHlwZSA9PT0gJ3Byb2R1Y3RfdmlldycpIHtcbiAgICAgIGNvbnN0IG1ldHJpY3MgPSBhd2FpdCB0aGlzLmdldFByb2R1Y3RQZXJmb3JtYW5jZShldmVudC5wcm9kdWN0SWQpO1xuICAgICAgbWV0cmljcy52aWV3cysrO1xuICAgICAgdGhpcy5wcm9kdWN0TWV0cmljcy5zZXQoZXZlbnQucHJvZHVjdElkLCBtZXRyaWNzKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IGV2ZW50cyBieSB1c2VyXG4gICAqL1xuICBhc3luYyBnZXRFdmVudHNCeVVzZXIodXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPEFuYWx5dGljc0V2ZW50W10+IHtcbiAgICByZXR1cm4gdGhpcy5ldmVudFN0b3JlLmdldCh1c2VySWQpIHx8IFtdO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBkYXNoYm9hcmQgbWV0cmljc1xuICAgKi9cbiAgYXN5bmMgZ2V0RGFzaGJvYXJkTWV0cmljcygpOiBQcm9taXNlPERhc2hib2FyZE1ldHJpY3M+IHtcbiAgICBjb25zdCB0b3RhbFJldmVudWUgPSBhd2FpdCB0aGlzLm9yZGVyUmVwb3NpdG9yeS5nZXRUb3RhbFJldmVudWUoKTtcbiAgICBjb25zdCB0b3RhbE9yZGVycyA9IGF3YWl0IHRoaXMub3JkZXJSZXBvc2l0b3J5LmNvdW50KCk7XG4gICAgY29uc3QgdG90YWxVc2VycyA9IGF3YWl0IHRoaXMudXNlclJlcG9zaXRvcnkuY291bnQoKTtcbiAgICBjb25zdCB0b3RhbFByb2R1Y3RzID0gYXdhaXQgdGhpcy5wcm9kdWN0UmVwb3NpdG9yeS5jb3VudCgpO1xuICAgIGNvbnN0IGF2ZXJhZ2VPcmRlclZhbHVlID0gYXdhaXQgdGhpcy5nZXRBdmVyYWdlT3JkZXJWYWx1ZSgpO1xuICAgIGNvbnN0IHVzZXJHcm93dGggPSBhd2FpdCB0aGlzLmdldFVzZXJHcm93dGhNZXRyaWNzKCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxSZXZlbnVlLFxuICAgICAgdG90YWxPcmRlcnMsXG4gICAgICB0b3RhbFVzZXJzLFxuICAgICAgdG90YWxQcm9kdWN0cyxcbiAgICAgIGF2ZXJhZ2VPcmRlclZhbHVlLFxuICAgICAgdXNlckdyb3d0aFJhdGU6IHVzZXJHcm93dGguZ3Jvd3RoUmF0ZSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEV4cG9ydCBhbmFseXRpY3MgcmVwb3J0XG4gICAqL1xuICBhc3luYyBleHBvcnRSZXBvcnQoXG4gICAgdHlwZTogJ3JldmVudWUnIHwgJ3VzZXJzJyB8ICdwcm9kdWN0cycsXG4gICAgb3B0aW9ucz86IHsgc3RhcnREYXRlPzogRGF0ZTsgZW5kRGF0ZT86IERhdGUgfVxuICApOiBQcm9taXNlPEFuYWx5dGljc1JlcG9ydD4ge1xuICAgIGNvbnN0IHJlcG9ydDogQW5hbHl0aWNzUmVwb3J0ID0ge1xuICAgICAgdHlwZSxcbiAgICAgIGdlbmVyYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgZGF0YToge30sXG4gICAgfTtcblxuICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgY2FzZSAncmV2ZW51ZSc6XG4gICAgICAgIHJlcG9ydC5kYXRhID0ge1xuICAgICAgICAgIHRvdGFsUmV2ZW51ZTogYXdhaXQgdGhpcy5nZXRUb3RhbFJldmVudWUoKSxcbiAgICAgICAgICBhdmVyYWdlT3JkZXJWYWx1ZTogYXdhaXQgdGhpcy5nZXRBdmVyYWdlT3JkZXJWYWx1ZSgpLFxuICAgICAgICAgIG9yZGVyQ291bnQ6IGF3YWl0IHRoaXMub3JkZXJSZXBvc2l0b3J5LmNvdW50KCksXG4gICAgICAgIH07XG4gICAgICAgIGlmIChvcHRpb25zPy5zdGFydERhdGUgJiYgb3B0aW9ucz8uZW5kRGF0ZSkge1xuICAgICAgICAgIHJlcG9ydC5kYXRhLnBlcmlvZFJldmVudWUgPSBhd2FpdCB0aGlzLmdldFJldmVudWVCeURhdGVSYW5nZShcbiAgICAgICAgICAgIG9wdGlvbnMuc3RhcnREYXRlLFxuICAgICAgICAgICAgb3B0aW9ucy5lbmREYXRlXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAndXNlcnMnOlxuICAgICAgICByZXBvcnQuZGF0YSA9IHtcbiAgICAgICAgICB0b3RhbFVzZXJzOiBhd2FpdCB0aGlzLnVzZXJSZXBvc2l0b3J5LmNvdW50KCksXG4gICAgICAgICAgYWN0aXZlVXNlcnM6IGF3YWl0IHRoaXMuZ2V0QWN0aXZlVXNlckNvdW50KCksXG4gICAgICAgICAgdXNlckdyb3d0aDogYXdhaXQgdGhpcy5nZXRVc2VyR3Jvd3RoTWV0cmljcygpLFxuICAgICAgICAgIGN1c3RvbWVyTGlmZXRpbWVWYWx1ZTogYXdhaXQgdGhpcy5nZXRDdXN0b21lckxpZmV0aW1lVmFsdWUoKSxcbiAgICAgICAgfTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJ3Byb2R1Y3RzJzpcbiAgICAgICAgcmVwb3J0LmRhdGEgPSB7XG4gICAgICAgICAgdG90YWxQcm9kdWN0czogYXdhaXQgdGhpcy5wcm9kdWN0UmVwb3NpdG9yeS5jb3VudCgpLFxuICAgICAgICAgIHRvcFNlbGxpbmc6IGF3YWl0IHRoaXMuZ2V0VG9wU2VsbGluZ1Byb2R1Y3RzKDEwKSxcbiAgICAgICAgICB0b3BSYXRlZDogYXdhaXQgdGhpcy5nZXRUb3BSYXRlZFByb2R1Y3RzKDEwKSxcbiAgICAgICAgICBsb3dTdG9jazogYXdhaXQgdGhpcy5nZXRMb3dTdG9ja0FsZXJ0KCksXG4gICAgICAgIH07XG4gICAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIHJldHVybiByZXBvcnQ7XG4gIH1cblxuICAvKipcbiAgICogR3JvdXAgb3JkZXJzIGJ5IHBlcmlvZFxuICAgKi9cbiAgcHJpdmF0ZSBncm91cE9yZGVyc0J5UGVyaW9kKFxuICAgIG9yZGVyczogYW55W10sXG4gICAgcGVyaW9kOiAnZGF5JyB8ICd3ZWVrJyB8ICdtb250aCdcbiAgKTogUmVjb3JkPHN0cmluZywgYW55W10+IHtcbiAgICBjb25zdCBncm91cGVkOiBSZWNvcmQ8c3RyaW5nLCBhbnlbXT4gPSB7fTtcblxuICAgIGZvciAoY29uc3Qgb3JkZXIgb2Ygb3JkZXJzKSB7XG4gICAgICBjb25zdCBkYXRlID0gbmV3IERhdGUob3JkZXIuY3JlYXRlZEF0KTtcbiAgICAgIGxldCBrZXk6IHN0cmluZztcblxuICAgICAgc3dpdGNoIChwZXJpb2QpIHtcbiAgICAgICAgY2FzZSAnZGF5JzpcbiAgICAgICAgICBrZXkgPSBkYXRlLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnd2Vlayc6XG4gICAgICAgICAgY29uc3Qgd2Vla051bSA9IHRoaXMuZ2V0V2Vla051bWJlcihkYXRlKTtcbiAgICAgICAgICBrZXkgPSBgJHtkYXRlLmdldEZ1bGxZZWFyKCl9LVcke3dlZWtOdW19YDtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnbW9udGgnOlxuICAgICAgICAgIGtleSA9IGAke2RhdGUuZ2V0RnVsbFllYXIoKX0tJHtTdHJpbmcoZGF0ZS5nZXRNb250aCgpICsgMSkucGFkU3RhcnQoMiwgJzAnKX1gO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWdyb3VwZWRba2V5XSkge1xuICAgICAgICBncm91cGVkW2tleV0gPSBbXTtcbiAgICAgIH1cbiAgICAgIGdyb3VwZWRba2V5XS5wdXNoKG9yZGVyKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZ3JvdXBlZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgd2VlayBudW1iZXIgb2YgeWVhclxuICAgKi9cbiAgcHJpdmF0ZSBnZXRXZWVrTnVtYmVyKGRhdGU6IERhdGUpOiBudW1iZXIge1xuICAgIGNvbnN0IGQgPSBuZXcgRGF0ZShEYXRlLlVUQyhkYXRlLmdldEZ1bGxZZWFyKCksIGRhdGUuZ2V0TW9udGgoKSwgZGF0ZS5nZXREYXRlKCkpKTtcbiAgICBjb25zdCBkYXlOdW0gPSBkLmdldFVUQ0RheSgpIHx8IDc7XG4gICAgZC5zZXRVVENEYXRlKGQuZ2V0VVRDRGF0ZSgpICsgNCAtIGRheU51bSk7XG4gICAgY29uc3QgeWVhclN0YXJ0ID0gbmV3IERhdGUoRGF0ZS5VVEMoZC5nZXRVVENGdWxsWWVhcigpLCAwLCAxKSk7XG4gICAgcmV0dXJuIE1hdGguY2VpbCgoKChkLmdldFRpbWUoKSAtIHllYXJTdGFydC5nZXRUaW1lKCkpIC8gODY0MDAwMDApICsgMSkgLyA3KTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9