{"file":"C:\\Adaptive_Testing\\src\\services\\analytics\\services\\analytics.service.ts","mappings":"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","names":[],"sources":["C:\\Adaptive_Testing\\src\\services\\analytics\\services\\analytics.service.ts"],"sourcesContent":["/**\n * TDD Implementation: Analytics Service\n *\n * Sales metrics, user behavior tracking, and reporting\n */\n\nimport { OrderRepository } from '../../order-processing/repositories/order.repository';\nimport { ProductRepository } from '../../product-catalog/repositories/product.repository';\nimport { UserRepository } from '../../user-management/repositories/user.repository';\nimport { Product } from '../../product-catalog/entities/product.entity';\nimport { UserStatus } from '../../user-management/entities/user.entity';\n\nexport interface UserGrowthMetrics {\n  totalUsers: number;\n  newUsersThisMonth: number;\n  growthRate: number;\n}\n\nexport interface SalesMetric {\n  period: string;\n  revenue: number;\n  orderCount: number;\n  averageOrderValue: number;\n}\n\nexport interface ProductPerformanceMetrics {\n  views: number;\n  purchases: number;\n  conversionRate: number;\n  revenue: number;\n}\n\nexport interface AnalyticsEvent {\n  userId: string;\n  eventType: string;\n  timestamp: Date;\n  productId?: string;\n  page?: string;\n  metadata?: Record<string, unknown>;\n}\n\nexport interface DashboardMetrics {\n  totalRevenue: number;\n  totalOrders: number;\n  totalUsers: number;\n  totalProducts: number;\n  averageOrderValue: number;\n  userGrowthRate: number;\n}\n\nexport interface AnalyticsReport {\n  type: 'revenue' | 'users' | 'products';\n  generatedAt: Date;\n  data: Record<string, unknown>;\n}\n\nexport class AnalyticsService {\n  private eventStore: Map<string, AnalyticsEvent[]> = new Map();\n  private productMetrics: Map<string, ProductPerformanceMetrics> = new Map();\n\n  constructor(\n    private orderRepository: OrderRepository,\n    private productRepository: ProductRepository,\n    private userRepository: UserRepository\n  ) {}\n\n  /**\n   * Get total revenue from all orders\n   */\n  async getTotalRevenue(): Promise<number> {\n    return this.orderRepository.getTotalRevenue();\n  }\n\n  /**\n   * Get revenue for date range\n   */\n  async getRevenueByDateRange(startDate: Date, endDate: Date): Promise<number> {\n    const orders = await this.orderRepository.findOrdersByDateRange(startDate, endDate);\n    return orders.reduce((sum, order) => sum + order.total, 0);\n  }\n\n  /**\n   * Calculate average order value\n   */\n  async getAverageOrderValue(): Promise<number> {\n    const totalRevenue = await this.orderRepository.getTotalRevenue();\n    const orderCount = await this.orderRepository.count();\n\n    if (orderCount === 0) {\n      return 0;\n    }\n\n    return Math.round((totalRevenue / orderCount) * 100) / 100;\n  }\n\n  /**\n   * Get top selling products\n   */\n  async getTopSellingProducts(limit: number = 10): Promise<Product[]> {\n    return this.productRepository.findTopSelling(limit);\n  }\n\n  /**\n   * Get top rated products\n   */\n  async getTopRatedProducts(limit: number = 10): Promise<Product[]> {\n    return this.productRepository.findTopRated(limit);\n  }\n\n  /**\n   * Get low stock alerts\n   */\n  async getLowStockAlert(threshold: number = 10): Promise<Product[]> {\n    return this.productRepository.findLowStock(threshold);\n  }\n\n  /**\n   * Get user growth metrics\n   */\n  async getUserGrowthMetrics(): Promise<UserGrowthMetrics> {\n    const totalUsers = await this.userRepository.count();\n\n    // Calculate new users this month\n    const startOfMonth = new Date();\n    startOfMonth.setDate(1);\n    startOfMonth.setHours(0, 0, 0, 0);\n\n    // In a real implementation, this would filter by created date\n    const newUsersThisMonth = await this.userRepository.count();\n    const actualNewUsers = Math.min(newUsersThisMonth, totalUsers);\n\n    const growthRate = totalUsers > 0\n      ? Math.round((actualNewUsers / totalUsers) * 100)\n      : 0;\n\n    return {\n      totalUsers,\n      newUsersThisMonth: actualNewUsers,\n      growthRate,\n    };\n  }\n\n  /**\n   * Get active user count\n   */\n  async getActiveUserCount(): Promise<number> {\n    const activeUsers = await this.userRepository.findByStatus(UserStatus.ACTIVE);\n    return activeUsers.length;\n  }\n\n  /**\n   * Get sales metrics by period\n   */\n  async getSalesMetricsByPeriod(period: 'day' | 'week' | 'month'): Promise<SalesMetric[]> {\n    const endDate = new Date();\n    const startDate = new Date();\n\n    // Calculate date range based on period\n    switch (period) {\n      case 'day':\n        startDate.setDate(endDate.getDate() - 30); // Last 30 days\n        break;\n      case 'week':\n        startDate.setDate(endDate.getDate() - 84); // Last 12 weeks\n        break;\n      case 'month':\n        startDate.setMonth(endDate.getMonth() - 12); // Last 12 months\n        break;\n    }\n\n    const orders = await this.orderRepository.findOrdersByDateRange(startDate, endDate);\n\n    // Group orders by period\n    const metrics: SalesMetric[] = [];\n    const groupedOrders = this.groupOrdersByPeriod(orders, period);\n\n    for (const [periodKey, periodOrders] of Object.entries(groupedOrders)) {\n      const revenue = periodOrders.reduce((sum, order) => sum + order.total, 0);\n      const orderCount = periodOrders.length;\n      const averageOrderValue = orderCount > 0 ? revenue / orderCount : 0;\n\n      metrics.push({\n        period: periodKey,\n        revenue,\n        orderCount,\n        averageOrderValue,\n      });\n    }\n\n    return metrics;\n  }\n\n  /**\n   * Calculate conversion rate\n   */\n  async getConversionRate(visitors: number, orders: number): Promise<number> {\n    if (visitors === 0) {\n      return 0;\n    }\n\n    return Math.round((orders / visitors) * 100 * 100) / 100;\n  }\n\n  /**\n   * Calculate customer lifetime value\n   */\n  async getCustomerLifetimeValue(): Promise<number> {\n    const totalRevenue = await this.orderRepository.getTotalRevenue();\n    const totalCustomers = await this.userRepository.count();\n\n    if (totalCustomers === 0) {\n      return 0;\n    }\n\n    return Math.round(totalRevenue / totalCustomers);\n  }\n\n  /**\n   * Get product performance metrics\n   */\n  async getProductPerformance(productId: string): Promise<ProductPerformanceMetrics> {\n    let metrics = this.productMetrics.get(productId);\n\n    if (!metrics) {\n      metrics = {\n        views: 0,\n        purchases: 0,\n        conversionRate: 0,\n        revenue: 0,\n      };\n      this.productMetrics.set(productId, metrics);\n    }\n\n    return metrics;\n  }\n\n  /**\n   * Track analytics event\n   */\n  async trackEvent(event: AnalyticsEvent): Promise<void> {\n    const userEvents = this.eventStore.get(event.userId) || [];\n    userEvents.push(event);\n    this.eventStore.set(event.userId, userEvents);\n\n    // Update product metrics if it's a product-related event\n    if (event.productId && event.eventType === 'product_view') {\n      const metrics = await this.getProductPerformance(event.productId);\n      metrics.views++;\n      this.productMetrics.set(event.productId, metrics);\n    }\n  }\n\n  /**\n   * Get events by user\n   */\n  async getEventsByUser(userId: string): Promise<AnalyticsEvent[]> {\n    return this.eventStore.get(userId) || [];\n  }\n\n  /**\n   * Get dashboard metrics\n   */\n  async getDashboardMetrics(): Promise<DashboardMetrics> {\n    const totalRevenue = await this.orderRepository.getTotalRevenue();\n    const totalOrders = await this.orderRepository.count();\n    const totalUsers = await this.userRepository.count();\n    const totalProducts = await this.productRepository.count();\n    const averageOrderValue = await this.getAverageOrderValue();\n    const userGrowth = await this.getUserGrowthMetrics();\n\n    return {\n      totalRevenue,\n      totalOrders,\n      totalUsers,\n      totalProducts,\n      averageOrderValue,\n      userGrowthRate: userGrowth.growthRate,\n    };\n  }\n\n  /**\n   * Export analytics report\n   */\n  async exportReport(\n    type: 'revenue' | 'users' | 'products',\n    options?: { startDate?: Date; endDate?: Date }\n  ): Promise<AnalyticsReport> {\n    const report: AnalyticsReport = {\n      type,\n      generatedAt: new Date(),\n      data: {},\n    };\n\n    switch (type) {\n      case 'revenue':\n        report.data = {\n          totalRevenue: await this.getTotalRevenue(),\n          averageOrderValue: await this.getAverageOrderValue(),\n          orderCount: await this.orderRepository.count(),\n        };\n        if (options?.startDate && options?.endDate) {\n          report.data.periodRevenue = await this.getRevenueByDateRange(\n            options.startDate,\n            options.endDate\n          );\n        }\n        break;\n\n      case 'users':\n        report.data = {\n          totalUsers: await this.userRepository.count(),\n          activeUsers: await this.getActiveUserCount(),\n          userGrowth: await this.getUserGrowthMetrics(),\n          customerLifetimeValue: await this.getCustomerLifetimeValue(),\n        };\n        break;\n\n      case 'products':\n        report.data = {\n          totalProducts: await this.productRepository.count(),\n          topSelling: await this.getTopSellingProducts(10),\n          topRated: await this.getTopRatedProducts(10),\n          lowStock: await this.getLowStockAlert(),\n        };\n        break;\n    }\n\n    return report;\n  }\n\n  /**\n   * Group orders by period\n   */\n  private groupOrdersByPeriod(\n    orders: any[],\n    period: 'day' | 'week' | 'month'\n  ): Record<string, any[]> {\n    const grouped: Record<string, any[]> = {};\n\n    for (const order of orders) {\n      const date = new Date(order.createdAt);\n      let key: string;\n\n      switch (period) {\n        case 'day':\n          key = date.toISOString().split('T')[0];\n          break;\n        case 'week':\n          const weekNum = this.getWeekNumber(date);\n          key = `${date.getFullYear()}-W${weekNum}`;\n          break;\n        case 'month':\n          key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;\n          break;\n      }\n\n      if (!grouped[key]) {\n        grouped[key] = [];\n      }\n      grouped[key].push(order);\n    }\n\n    return grouped;\n  }\n\n  /**\n   * Get week number of year\n   */\n  private getWeekNumber(date: Date): number {\n    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));\n    const dayNum = d.getUTCDay() || 7;\n    d.setUTCDate(d.getUTCDate() + 4 - dayNum);\n    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));\n    return Math.ceil((((d.getTime() - yearStart.getTime()) / 86400000) + 1) / 7);\n  }\n}\n"],"version":3}