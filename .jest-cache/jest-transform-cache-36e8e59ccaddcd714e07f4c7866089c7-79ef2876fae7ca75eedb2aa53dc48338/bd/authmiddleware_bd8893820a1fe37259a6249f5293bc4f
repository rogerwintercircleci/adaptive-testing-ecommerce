f40260d7b84c5aaab62293688adb0f39
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.authorizeOwnerOrAdmin = exports.authorize = exports.optionalAuthenticate = exports.authenticate = void 0;
const errors_1 = require("../errors");
const jwt_utils_1 = require("./jwt.utils");
/**
 * Authentication middleware
 * Verifies JWT token and attaches user payload to request
 */
const authenticate = (req, _res, next) => {
    try {
        const token = (0, jwt_utils_1.extractTokenFromHeader)(req.headers.authorization);
        if (!token) {
            throw new errors_1.UnauthorizedError('No authentication token provided');
        }
        const payload = (0, jwt_utils_1.verifyAccessToken)(token);
        req.user = payload;
        next();
    }
    catch (error) {
        next(error);
    }
};
exports.authenticate = authenticate;
/**
 * Optional authentication middleware
 * Attaches user if token is valid, but doesn't fail if no token
 */
const optionalAuthenticate = (req, _res, next) => {
    try {
        const token = (0, jwt_utils_1.extractTokenFromHeader)(req.headers.authorization);
        if (token) {
            const payload = (0, jwt_utils_1.verifyAccessToken)(token);
            req.user = payload;
        }
        next();
    }
    catch (error) {
        // Ignore auth errors for optional authentication
        next();
    }
};
exports.optionalAuthenticate = optionalAuthenticate;
/**
 * Role-based authorization middleware factory
 * Use after authenticate middleware
 */
const authorize = (...allowedRoles) => {
    return (req, _res, next) => {
        try {
            if (!req.user) {
                throw new errors_1.UnauthorizedError('User not authenticated');
            }
            if (!allowedRoles.includes(req.user.role)) {
                throw new errors_1.ForbiddenError('Insufficient permissions');
            }
            next();
        }
        catch (error) {
            next(error);
        }
    };
};
exports.authorize = authorize;
/**
 * Check if user is the resource owner or has admin role
 */
const authorizeOwnerOrAdmin = (getUserIdFromRequest) => {
    return (req, _res, next) => {
        try {
            if (!req.user) {
                throw new errors_1.UnauthorizedError('User not authenticated');
            }
            const resourceUserId = getUserIdFromRequest(req);
            if (req.user.userId !== resourceUserId && req.user.role !== 'admin') {
                throw new errors_1.ForbiddenError('Access denied');
            }
            next();
        }
        catch (error) {
            next(error);
        }
    };
};
exports.authorizeOwnerOrAdmin = authorizeOwnerOrAdmin;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXEFkYXB0aXZlX1Rlc3RpbmdcXHNyY1xcbGlic1xcYXV0aFxcYXV0aC5taWRkbGV3YXJlLnRzIiwibWFwcGluZ3MiOiI7OztBQUNBLHNDQUE4RDtBQUM5RCwyQ0FBb0Y7QUFhcEY7OztHQUdHO0FBQ0ksTUFBTSxZQUFZLEdBQUcsQ0FBQyxHQUFZLEVBQUUsSUFBYyxFQUFFLElBQWtCLEVBQVEsRUFBRTtJQUNyRixJQUFJLENBQUM7UUFDSCxNQUFNLEtBQUssR0FBRyxJQUFBLGtDQUFzQixFQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFaEUsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ1gsTUFBTSxJQUFJLDBCQUFpQixDQUFDLGtDQUFrQyxDQUFDLENBQUM7UUFDbEUsQ0FBQztRQUVELE1BQU0sT0FBTyxHQUFHLElBQUEsNkJBQWlCLEVBQUMsS0FBSyxDQUFDLENBQUM7UUFDekMsR0FBRyxDQUFDLElBQUksR0FBRyxPQUFPLENBQUM7UUFDbkIsSUFBSSxFQUFFLENBQUM7SUFDVCxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDLENBQUM7QUFkVyxRQUFBLFlBQVksZ0JBY3ZCO0FBRUY7OztHQUdHO0FBQ0ksTUFBTSxvQkFBb0IsR0FBRyxDQUNsQyxHQUFZLEVBQ1osSUFBYyxFQUNkLElBQWtCLEVBQ1osRUFBRTtJQUNSLElBQUksQ0FBQztRQUNILE1BQU0sS0FBSyxHQUFHLElBQUEsa0NBQXNCLEVBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUVoRSxJQUFJLEtBQUssRUFBRSxDQUFDO1lBQ1YsTUFBTSxPQUFPLEdBQUcsSUFBQSw2QkFBaUIsRUFBQyxLQUFLLENBQUMsQ0FBQztZQUN6QyxHQUFHLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQztRQUNyQixDQUFDO1FBQ0QsSUFBSSxFQUFFLENBQUM7SUFDVCxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLGlEQUFpRDtRQUNqRCxJQUFJLEVBQUUsQ0FBQztJQUNULENBQUM7QUFDSCxDQUFDLENBQUM7QUFqQlcsUUFBQSxvQkFBb0Isd0JBaUIvQjtBQUVGOzs7R0FHRztBQUNJLE1BQU0sU0FBUyxHQUFHLENBQUMsR0FBRyxZQUFzQixFQUFFLEVBQUU7SUFDckQsT0FBTyxDQUFDLEdBQVksRUFBRSxJQUFjLEVBQUUsSUFBa0IsRUFBUSxFQUFFO1FBQ2hFLElBQUksQ0FBQztZQUNILElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ2QsTUFBTSxJQUFJLDBCQUFpQixDQUFDLHdCQUF3QixDQUFDLENBQUM7WUFDeEQsQ0FBQztZQUVELElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztnQkFDMUMsTUFBTSxJQUFJLHVCQUFjLENBQUMsMEJBQTBCLENBQUMsQ0FBQztZQUN2RCxDQUFDO1lBRUQsSUFBSSxFQUFFLENBQUM7UUFDVCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNkLENBQUM7SUFDSCxDQUFDLENBQUM7QUFDSixDQUFDLENBQUM7QUFoQlcsUUFBQSxTQUFTLGFBZ0JwQjtBQUVGOztHQUVHO0FBQ0ksTUFBTSxxQkFBcUIsR0FBRyxDQUFDLG9CQUE4QyxFQUFFLEVBQUU7SUFDdEYsT0FBTyxDQUFDLEdBQVksRUFBRSxJQUFjLEVBQUUsSUFBa0IsRUFBUSxFQUFFO1FBQ2hFLElBQUksQ0FBQztZQUNILElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ2QsTUFBTSxJQUFJLDBCQUFpQixDQUFDLHdCQUF3QixDQUFDLENBQUM7WUFDeEQsQ0FBQztZQUVELE1BQU0sY0FBYyxHQUFHLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBRWpELElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLEtBQUssY0FBYyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLE9BQU8sRUFBRSxDQUFDO2dCQUNwRSxNQUFNLElBQUksdUJBQWMsQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUM1QyxDQUFDO1lBRUQsSUFBSSxFQUFFLENBQUM7UUFDVCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNkLENBQUM7SUFDSCxDQUFDLENBQUM7QUFDSixDQUFDLENBQUM7QUFsQlcsUUFBQSxxQkFBcUIseUJBa0JoQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcQWRhcHRpdmVfVGVzdGluZ1xcc3JjXFxsaWJzXFxhdXRoXFxhdXRoLm1pZGRsZXdhcmUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgVW5hdXRob3JpemVkRXJyb3IsIEZvcmJpZGRlbkVycm9yIH0gZnJvbSAnLi4vZXJyb3JzJztcbmltcG9ydCB7IHZlcmlmeUFjY2Vzc1Rva2VuLCBleHRyYWN0VG9rZW5Gcm9tSGVhZGVyLCBKV1RQYXlsb2FkIH0gZnJvbSAnLi9qd3QudXRpbHMnO1xuXG4vKipcbiAqIEV4dGVuZCBFeHByZXNzIFJlcXVlc3QgdG8gaW5jbHVkZSB1c2VyIHBheWxvYWRcbiAqL1xuZGVjbGFyZSBnbG9iYWwge1xuICBuYW1lc3BhY2UgRXhwcmVzcyB7XG4gICAgaW50ZXJmYWNlIFJlcXVlc3Qge1xuICAgICAgdXNlcj86IEpXVFBheWxvYWQ7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogQXV0aGVudGljYXRpb24gbWlkZGxld2FyZVxuICogVmVyaWZpZXMgSldUIHRva2VuIGFuZCBhdHRhY2hlcyB1c2VyIHBheWxvYWQgdG8gcmVxdWVzdFxuICovXG5leHBvcnQgY29uc3QgYXV0aGVudGljYXRlID0gKHJlcTogUmVxdWVzdCwgX3JlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbik6IHZvaWQgPT4ge1xuICB0cnkge1xuICAgIGNvbnN0IHRva2VuID0gZXh0cmFjdFRva2VuRnJvbUhlYWRlcihyZXEuaGVhZGVycy5hdXRob3JpemF0aW9uKTtcblxuICAgIGlmICghdG9rZW4pIHtcbiAgICAgIHRocm93IG5ldyBVbmF1dGhvcml6ZWRFcnJvcignTm8gYXV0aGVudGljYXRpb24gdG9rZW4gcHJvdmlkZWQnKTtcbiAgICB9XG5cbiAgICBjb25zdCBwYXlsb2FkID0gdmVyaWZ5QWNjZXNzVG9rZW4odG9rZW4pO1xuICAgIHJlcS51c2VyID0gcGF5bG9hZDtcbiAgICBuZXh0KCk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbmV4dChlcnJvcik7XG4gIH1cbn07XG5cbi8qKlxuICogT3B0aW9uYWwgYXV0aGVudGljYXRpb24gbWlkZGxld2FyZVxuICogQXR0YWNoZXMgdXNlciBpZiB0b2tlbiBpcyB2YWxpZCwgYnV0IGRvZXNuJ3QgZmFpbCBpZiBubyB0b2tlblxuICovXG5leHBvcnQgY29uc3Qgb3B0aW9uYWxBdXRoZW50aWNhdGUgPSAoXG4gIHJlcTogUmVxdWVzdCxcbiAgX3JlczogUmVzcG9uc2UsXG4gIG5leHQ6IE5leHRGdW5jdGlvblxuKTogdm9pZCA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgdG9rZW4gPSBleHRyYWN0VG9rZW5Gcm9tSGVhZGVyKHJlcS5oZWFkZXJzLmF1dGhvcml6YXRpb24pO1xuXG4gICAgaWYgKHRva2VuKSB7XG4gICAgICBjb25zdCBwYXlsb2FkID0gdmVyaWZ5QWNjZXNzVG9rZW4odG9rZW4pO1xuICAgICAgcmVxLnVzZXIgPSBwYXlsb2FkO1xuICAgIH1cbiAgICBuZXh0KCk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgLy8gSWdub3JlIGF1dGggZXJyb3JzIGZvciBvcHRpb25hbCBhdXRoZW50aWNhdGlvblxuICAgIG5leHQoKTtcbiAgfVxufTtcblxuLyoqXG4gKiBSb2xlLWJhc2VkIGF1dGhvcml6YXRpb24gbWlkZGxld2FyZSBmYWN0b3J5XG4gKiBVc2UgYWZ0ZXIgYXV0aGVudGljYXRlIG1pZGRsZXdhcmVcbiAqL1xuZXhwb3J0IGNvbnN0IGF1dGhvcml6ZSA9ICguLi5hbGxvd2VkUm9sZXM6IHN0cmluZ1tdKSA9PiB7XG4gIHJldHVybiAocmVxOiBSZXF1ZXN0LCBfcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKTogdm9pZCA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGlmICghcmVxLnVzZXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IFVuYXV0aG9yaXplZEVycm9yKCdVc2VyIG5vdCBhdXRoZW50aWNhdGVkJyk7XG4gICAgICB9XG5cbiAgICAgIGlmICghYWxsb3dlZFJvbGVzLmluY2x1ZGVzKHJlcS51c2VyLnJvbGUpKSB7XG4gICAgICAgIHRocm93IG5ldyBGb3JiaWRkZW5FcnJvcignSW5zdWZmaWNpZW50IHBlcm1pc3Npb25zJyk7XG4gICAgICB9XG5cbiAgICAgIG5leHQoKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbmV4dChlcnJvcik7XG4gICAgfVxuICB9O1xufTtcblxuLyoqXG4gKiBDaGVjayBpZiB1c2VyIGlzIHRoZSByZXNvdXJjZSBvd25lciBvciBoYXMgYWRtaW4gcm9sZVxuICovXG5leHBvcnQgY29uc3QgYXV0aG9yaXplT3duZXJPckFkbWluID0gKGdldFVzZXJJZEZyb21SZXF1ZXN0OiAocmVxOiBSZXF1ZXN0KSA9PiBzdHJpbmcpID0+IHtcbiAgcmV0dXJuIChyZXE6IFJlcXVlc3QsIF9yZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pOiB2b2lkID0+IHtcbiAgICB0cnkge1xuICAgICAgaWYgKCFyZXEudXNlcikge1xuICAgICAgICB0aHJvdyBuZXcgVW5hdXRob3JpemVkRXJyb3IoJ1VzZXIgbm90IGF1dGhlbnRpY2F0ZWQnKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVzb3VyY2VVc2VySWQgPSBnZXRVc2VySWRGcm9tUmVxdWVzdChyZXEpO1xuXG4gICAgICBpZiAocmVxLnVzZXIudXNlcklkICE9PSByZXNvdXJjZVVzZXJJZCAmJiByZXEudXNlci5yb2xlICE9PSAnYWRtaW4nKSB7XG4gICAgICAgIHRocm93IG5ldyBGb3JiaWRkZW5FcnJvcignQWNjZXNzIGRlbmllZCcpO1xuICAgICAgfVxuXG4gICAgICBuZXh0KCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIG5leHQoZXJyb3IpO1xuICAgIH1cbiAgfTtcbn07XG4iXSwidmVyc2lvbiI6M30=