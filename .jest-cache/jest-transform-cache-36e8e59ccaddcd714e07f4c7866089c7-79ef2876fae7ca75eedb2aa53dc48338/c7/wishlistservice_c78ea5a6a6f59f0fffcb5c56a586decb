9cafc2192bc72134fe8988891d13ed99
"use strict";
/**
 * Wishlist Service Implementation
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.WishlistService = void 0;
const errors_1 = require("@libs/errors");
const crypto = __importStar(require("crypto"));
class WishlistService {
    wishlistRepository;
    productRepository;
    constructor(wishlistRepository, productRepository) {
        this.wishlistRepository = wishlistRepository;
        this.productRepository = productRepository;
    }
    async addToWishlist(data) {
        // Verify product exists
        await this.productRepository.findById(data.productId);
        // Check for duplicate
        const existing = await this.wishlistRepository.findByUserAndProduct(data.userId, data.productId);
        if (existing) {
            throw new errors_1.BadRequestError('Product is already in wishlist');
        }
        return this.wishlistRepository.create({
            ...data,
            createdAt: new Date(),
        });
    }
    async getWishlist(userId, options) {
        let items = await this.wishlistRepository.findByUserId(userId);
        if (items.length === 0) {
            return [];
        }
        // Get product details
        const productIds = items.map(item => item.productId);
        const products = await this.productRepository.findByIds(productIds);
        let wishlist = items.map(item => ({
            ...item,
            product: products.find(p => p.id === item.productId),
        }));
        // Apply filters
        if (options?.minPrice !== undefined || options?.maxPrice !== undefined) {
            wishlist = wishlist.filter(item => {
                const price = item.product?.price || 0;
                if (options.minPrice !== undefined && price < options.minPrice)
                    return false;
                if (options.maxPrice !== undefined && price > options.maxPrice)
                    return false;
                return true;
            });
        }
        // Sort
        if (options?.sortBy === 'recent') {
            wishlist.sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());
        }
        return wishlist;
    }
    async removeFromWishlist(userId, productId) {
        const item = await this.wishlistRepository.findByUserAndProduct(userId, productId);
        if (!item) {
            throw new errors_1.NotFoundError('Item not found in wishlist');
        }
        await this.wishlistRepository.delete(item.id);
    }
    async clearWishlist(userId) {
        await this.wishlistRepository.deleteAllByUserId(userId);
    }
    async getWishlistCount(userId) {
        return this.wishlistRepository.countByUserId(userId);
    }
    async isInWishlist(userId, productId) {
        const item = await this.wishlistRepository.findByUserAndProduct(userId, productId);
        return !!item;
    }
    async moveToCart(userId, productId) {
        const item = await this.wishlistRepository.findByUserAndProduct(userId, productId);
        if (!item) {
            throw new errors_1.NotFoundError('Item not found in wishlist');
        }
        const result = await this.wishlistRepository.moveToCart(item.id);
        await this.wishlistRepository.delete(item.id);
        return result;
    }
    async shareWishlist(_userId) {
        const shareToken = crypto.randomBytes(16).toString('hex');
        const shareUrl = `https://app.example.com/wishlist/shared/${shareToken}`;
        return {
            shareToken,
            shareUrl,
        };
    }
    async getSharedWishlist(_shareToken) {
        // In production, decode token to get userId
        // For now, mock implementation
        const userId = 'user-1';
        return this.getWishlist(userId);
    }
    async getWishlistTotalValue(userId) {
        const wishlist = await this.getWishlist(userId);
        return wishlist.reduce((total, item) => {
            return total + (item.product?.price || 0);
        }, 0);
    }
    async getPriceDropAlerts(userId) {
        const wishlist = await this.getWishlist(userId);
        return wishlist
            .filter(item => {
            if (!item.priceWhenAdded || !item.product)
                return false;
            return item.product.price < item.priceWhenAdded;
        })
            .map(item => ({
            ...item,
            priceDrop: item.priceWhenAdded - item.product.price,
        }));
    }
    async getOutOfStockItems(userId) {
        const wishlist = await this.getWishlist(userId);
        return wishlist.filter(item => item.product && item.product.inventory === 0);
    }
    async addMultipleToWishlist(userId, productIds) {
        await this.productRepository.findByIds(productIds);
        let added = 0;
        let failed = 0;
        for (const productId of productIds) {
            try {
                const existing = await this.wishlistRepository.findByUserAndProduct(userId, productId);
                if (!existing) {
                    await this.wishlistRepository.create({
                        userId,
                        productId,
                        createdAt: new Date(),
                    });
                    added++;
                }
            }
            catch (error) {
                failed++;
            }
        }
        return { added, failed };
    }
}
exports.WishlistService = WishlistService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXEFkYXB0aXZlX1Rlc3RpbmdcXHNyY1xcc2VydmljZXNcXHdpc2hsaXN0XFxzZXJ2aWNlc1xcd2lzaGxpc3Quc2VydmljZS50cyIsIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUlILHlDQUE4RDtBQUM5RCwrQ0FBaUM7QUFRakMsTUFBYSxlQUFlO0lBRWhCO0lBQ0E7SUFGVixZQUNVLGtCQUFzQyxFQUN0QyxpQkFBb0M7UUFEcEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUN0QyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO0lBQzNDLENBQUM7SUFFSixLQUFLLENBQUMsYUFBYSxDQUFDLElBQXNCO1FBQ3hDLHdCQUF3QjtRQUN4QixNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRXRELHNCQUFzQjtRQUN0QixNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxvQkFBb0IsQ0FDakUsSUFBSSxDQUFDLE1BQU0sRUFDWCxJQUFJLENBQUMsU0FBUyxDQUNmLENBQUM7UUFFRixJQUFJLFFBQVEsRUFBRSxDQUFDO1lBQ2IsTUFBTSxJQUFJLHdCQUFlLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztRQUM5RCxDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDO1lBQ3BDLEdBQUcsSUFBSTtZQUNQLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtTQUN0QixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsS0FBSyxDQUFDLFdBQVcsQ0FBQyxNQUFjLEVBQUUsT0FBYTtRQUM3QyxJQUFJLEtBQUssR0FBRyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFL0QsSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQ3ZCLE9BQU8sRUFB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SCxNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxvQkFBb0IsQ0FDakUsTUFBTSxFQUNOLFNBQVMsQ0FDVixDQUFDO2dCQUVGLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztvQkFDZCxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUM7d0JBQ25DLE1BQU07d0JBQ04sU0FBUzt3QkFDVCxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7cUJBQ3RCLENBQUMsQ0FBQztvQkFDSCxLQUFLLEVBQUUsQ0FBQztnQkFDVixDQUFDO1lBQ0gsQ0FBQztZQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7Z0JBQ2YsTUFBTSxFQUFFLENBQUM7WUFDWCxDQUFDO1FBQ0gsQ0FBQztRQUVELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLENBQUM7SUFDM0IsQ0FBQztDQUNGO0FBektELDBDQXlLQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcQWRhcHRpdmVfVGVzdGluZ1xcc3JjXFxzZXJ2aWNlc1xcd2lzaGxpc3RcXHNlcnZpY2VzXFx3aXNobGlzdC5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogV2lzaGxpc3QgU2VydmljZSBJbXBsZW1lbnRhdGlvblxuICovXG5cbmltcG9ydCB7IFdpc2hsaXN0UmVwb3NpdG9yeSB9IGZyb20gJy4uL3JlcG9zaXRvcmllcy93aXNobGlzdC5yZXBvc2l0b3J5JztcbmltcG9ydCB7IFByb2R1Y3RSZXBvc2l0b3J5IH0gZnJvbSAnLi4vLi4vcHJvZHVjdC1jYXRhbG9nL3JlcG9zaXRvcmllcy9wcm9kdWN0LnJlcG9zaXRvcnknO1xuaW1wb3J0IHsgQmFkUmVxdWVzdEVycm9yLCBOb3RGb3VuZEVycm9yIH0gZnJvbSAnQGxpYnMvZXJyb3JzJztcbmltcG9ydCAqIGFzIGNyeXB0byBmcm9tICdjcnlwdG8nO1xuXG5leHBvcnQgaW50ZXJmYWNlIEFkZFRvV2lzaGxpc3REdG8ge1xuICB1c2VySWQ6IHN0cmluZztcbiAgcHJvZHVjdElkOiBzdHJpbmc7XG4gIG5vdGU/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBXaXNobGlzdFNlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHdpc2hsaXN0UmVwb3NpdG9yeTogV2lzaGxpc3RSZXBvc2l0b3J5LFxuICAgIHByaXZhdGUgcHJvZHVjdFJlcG9zaXRvcnk6IFByb2R1Y3RSZXBvc2l0b3J5XG4gICkge31cblxuICBhc3luYyBhZGRUb1dpc2hsaXN0KGRhdGE6IEFkZFRvV2lzaGxpc3REdG8pIHtcbiAgICAvLyBWZXJpZnkgcHJvZHVjdCBleGlzdHNcbiAgICBhd2FpdCB0aGlzLnByb2R1Y3RSZXBvc2l0b3J5LmZpbmRCeUlkKGRhdGEucHJvZHVjdElkKTtcblxuICAgIC8vIENoZWNrIGZvciBkdXBsaWNhdGVcbiAgICBjb25zdCBleGlzdGluZyA9IGF3YWl0IHRoaXMud2lzaGxpc3RSZXBvc2l0b3J5LmZpbmRCeVVzZXJBbmRQcm9kdWN0KFxuICAgICAgZGF0YS51c2VySWQsXG4gICAgICBkYXRhLnByb2R1Y3RJZFxuICAgICk7XG5cbiAgICBpZiAoZXhpc3RpbmcpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXJyb3IoJ1Byb2R1Y3QgaXMgYWxyZWFkeSBpbiB3aXNobGlzdCcpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLndpc2hsaXN0UmVwb3NpdG9yeS5jcmVhdGUoe1xuICAgICAgLi4uZGF0YSxcbiAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGdldFdpc2hsaXN0KHVzZXJJZDogc3RyaW5nLCBvcHRpb25zPzogYW55KSB7XG4gICAgbGV0IGl0ZW1zID0gYXdhaXQgdGhpcy53aXNobGlzdFJlcG9zaXRvcnkuZmluZEJ5VXNlcklkKHVzZXJJZCk7XG5cbiAgICBpZiAoaXRlbXMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgLy8gR2V0IHByb2R1Y3QgZGV0YWlsc1xuICAgIGNvbnN0IHByb2R1Y3RJZHMgPSBpdGVtcy5tYXAoaXRlbSA9PiBpdGVtLnByb2R1Y3RJZCk7XG4gICAgY29uc3QgcHJvZHVjdHMgPSBhd2FpdCB0aGlzLnByb2R1Y3RSZXBvc2l0b3J5LmZpbmRCeUlkcyhwcm9kdWN0SWRzKTtcblxuICAgIGxldCB3aXNobGlzdCA9IGl0ZW1zLm1hcChpdGVtID0+ICh7XG4gICAgICAuLi5pdGVtLFxuICAgICAgcHJvZHVjdDogcHJvZHVjdHMuZmluZChwID0+IHAuaWQgPT09IGl0ZW0ucHJvZHVjdElkKSxcbiAgICB9KSk7XG5cbiAgICAvLyBBcHBseSBmaWx0ZXJzXG4gICAgaWYgKG9wdGlvbnM/Lm1pblByaWNlICE9PSB1bmRlZmluZWQgfHwgb3B0aW9ucz8ubWF4UHJpY2UgIT09IHVuZGVmaW5lZCkge1xuICAgICAgd2lzaGxpc3QgPSB3aXNobGlzdC5maWx0ZXIoaXRlbSA9PiB7XG4gICAgICAgIGNvbnN0IHByaWNlID0gaXRlbS5wcm9kdWN0Py5wcmljZSB8fCAwO1xuICAgICAgICBpZiAob3B0aW9ucy5taW5QcmljZSAhPT0gdW5kZWZpbmVkICYmIHByaWNlIDwgb3B0aW9ucy5taW5QcmljZSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICBpZiAob3B0aW9ucy5tYXhQcmljZSAhPT0gdW5kZWZpbmVkICYmIHByaWNlID4gb3B0aW9ucy5tYXhQcmljZSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIFNvcnRcbiAgICBpZiAob3B0aW9ucz8uc29ydEJ5ID09PSAncmVjZW50Jykge1xuICAgICAgd2lzaGxpc3Quc29ydCgoYSwgYikgPT4gYi5jcmVhdGVkQXQuZ2V0VGltZSgpIC0gYS5jcmVhdGVkQXQuZ2V0VGltZSgpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gd2lzaGxpc3Q7XG4gIH1cblxuICBhc3luYyByZW1vdmVGcm9tV2lzaGxpc3QodXNlcklkOiBzdHJpbmcsIHByb2R1Y3RJZDogc3RyaW5nKSB7XG4gICAgY29uc3QgaXRlbSA9IGF3YWl0IHRoaXMud2lzaGxpc3RSZXBvc2l0b3J5LmZpbmRCeVVzZXJBbmRQcm9kdWN0KHVzZXJJZCwgcHJvZHVjdElkKTtcblxuICAgIGlmICghaXRlbSkge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXJyb3IoJ0l0ZW0gbm90IGZvdW5kIGluIHdpc2hsaXN0Jyk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy53aXNobGlzdFJlcG9zaXRvcnkuZGVsZXRlKGl0ZW0uaWQpO1xuICB9XG5cbiAgYXN5bmMgY2xlYXJXaXNobGlzdCh1c2VySWQ6IHN0cmluZykge1xuICAgIGF3YWl0IHRoaXMud2lzaGxpc3RSZXBvc2l0b3J5LmRlbGV0ZUFsbEJ5VXNlcklkKHVzZXJJZCk7XG4gIH1cblxuICBhc3luYyBnZXRXaXNobGlzdENvdW50KHVzZXJJZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMud2lzaGxpc3RSZXBvc2l0b3J5LmNvdW50QnlVc2VySWQodXNlcklkKTtcbiAgfVxuXG4gIGFzeW5jIGlzSW5XaXNobGlzdCh1c2VySWQ6IHN0cmluZywgcHJvZHVjdElkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBpdGVtID0gYXdhaXQgdGhpcy53aXNobGlzdFJlcG9zaXRvcnkuZmluZEJ5VXNlckFuZFByb2R1Y3QodXNlcklkLCBwcm9kdWN0SWQpO1xuICAgIHJldHVybiAhIWl0ZW07XG4gIH1cblxuICBhc3luYyBtb3ZlVG9DYXJ0KHVzZXJJZDogc3RyaW5nLCBwcm9kdWN0SWQ6IHN0cmluZykge1xuICAgIGNvbnN0IGl0ZW0gPSBhd2FpdCB0aGlzLndpc2hsaXN0UmVwb3NpdG9yeS5maW5kQnlVc2VyQW5kUHJvZHVjdCh1c2VySWQsIHByb2R1Y3RJZCk7XG5cbiAgICBpZiAoIWl0ZW0pIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEVycm9yKCdJdGVtIG5vdCBmb3VuZCBpbiB3aXNobGlzdCcpO1xuICAgIH1cblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMud2lzaGxpc3RSZXBvc2l0b3J5Lm1vdmVUb0NhcnQoaXRlbS5pZCk7XG4gICAgYXdhaXQgdGhpcy53aXNobGlzdFJlcG9zaXRvcnkuZGVsZXRlKGl0ZW0uaWQpO1xuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIGFzeW5jIHNoYXJlV2lzaGxpc3QoX3VzZXJJZDogc3RyaW5nKSB7XG4gICAgY29uc3Qgc2hhcmVUb2tlbiA9IGNyeXB0by5yYW5kb21CeXRlcygxNikudG9TdHJpbmcoJ2hleCcpO1xuICAgIGNvbnN0IHNoYXJlVXJsID0gYGh0dHBzOi8vYXBwLmV4YW1wbGUuY29tL3dpc2hsaXN0L3NoYXJlZC8ke3NoYXJlVG9rZW59YDtcblxuICAgIHJldHVybiB7XG4gICAgICBzaGFyZVRva2VuLFxuICAgICAgc2hhcmVVcmwsXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIGdldFNoYXJlZFdpc2hsaXN0KF9zaGFyZVRva2VuOiBzdHJpbmcpIHtcbiAgICAvLyBJbiBwcm9kdWN0aW9uLCBkZWNvZGUgdG9rZW4gdG8gZ2V0IHVzZXJJZFxuICAgIC8vIEZvciBub3csIG1vY2sgaW1wbGVtZW50YXRpb25cbiAgICBjb25zdCB1c2VySWQgPSAndXNlci0xJztcbiAgICByZXR1cm4gdGhpcy5nZXRXaXNobGlzdCh1c2VySWQpO1xuICB9XG5cbiAgYXN5bmMgZ2V0V2lzaGxpc3RUb3RhbFZhbHVlKHVzZXJJZDogc3RyaW5nKSB7XG4gICAgY29uc3Qgd2lzaGxpc3QgPSBhd2FpdCB0aGlzLmdldFdpc2hsaXN0KHVzZXJJZCk7XG5cbiAgICByZXR1cm4gd2lzaGxpc3QucmVkdWNlKCh0b3RhbCwgaXRlbSkgPT4ge1xuICAgICAgcmV0dXJuIHRvdGFsICsgKGl0ZW0ucHJvZHVjdD8ucHJpY2UgfHwgMCk7XG4gICAgfSwgMCk7XG4gIH1cblxuICBhc3luYyBnZXRQcmljZURyb3BBbGVydHModXNlcklkOiBzdHJpbmcpIHtcbiAgICBjb25zdCB3aXNobGlzdCA9IGF3YWl0IHRoaXMuZ2V0V2lzaGxpc3QodXNlcklkKTtcblxuICAgIHJldHVybiB3aXNobGlzdFxuICAgICAgLmZpbHRlcihpdGVtID0+IHtcbiAgICAgICAgaWYgKCFpdGVtLnByaWNlV2hlbkFkZGVkIHx8ICFpdGVtLnByb2R1Y3QpIHJldHVybiBmYWxzZTtcbiAgICAgICAgcmV0dXJuIGl0ZW0ucHJvZHVjdC5wcmljZSA8IGl0ZW0ucHJpY2VXaGVuQWRkZWQ7XG4gICAgICB9KVxuICAgICAgLm1hcChpdGVtID0+ICh7XG4gICAgICAgIC4uLml0ZW0sXG4gICAgICAgIHByaWNlRHJvcDogaXRlbS5wcmljZVdoZW5BZGRlZCEgLSBpdGVtLnByb2R1Y3QhLnByaWNlLFxuICAgICAgfSkpO1xuICB9XG5cbiAgYXN5bmMgZ2V0T3V0T2ZTdG9ja0l0ZW1zKHVzZXJJZDogc3RyaW5nKSB7XG4gICAgY29uc3Qgd2lzaGxpc3QgPSBhd2FpdCB0aGlzLmdldFdpc2hsaXN0KHVzZXJJZCk7XG5cbiAgICByZXR1cm4gd2lzaGxpc3QuZmlsdGVyKGl0ZW0gPT4gaXRlbS5wcm9kdWN0ICYmIGl0ZW0ucHJvZHVjdC5pbnZlbnRvcnkgPT09IDApO1xuICB9XG5cbiAgYXN5bmMgYWRkTXVsdGlwbGVUb1dpc2hsaXN0KHVzZXJJZDogc3RyaW5nLCBwcm9kdWN0SWRzOiBzdHJpbmdbXSkge1xuICAgIGF3YWl0IHRoaXMucHJvZHVjdFJlcG9zaXRvcnkuZmluZEJ5SWRzKHByb2R1Y3RJZHMpO1xuXG4gICAgbGV0IGFkZGVkID0gMDtcbiAgICBsZXQgZmFpbGVkID0gMDtcblxuICAgIGZvciAoY29uc3QgcHJvZHVjdElkIG9mIHByb2R1Y3RJZHMpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGV4aXN0aW5nID0gYXdhaXQgdGhpcy53aXNobGlzdFJlcG9zaXRvcnkuZmluZEJ5VXNlckFuZFByb2R1Y3QoXG4gICAgICAgICAgdXNlcklkLFxuICAgICAgICAgIHByb2R1Y3RJZFxuICAgICAgICApO1xuXG4gICAgICAgIGlmICghZXhpc3RpbmcpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLndpc2hsaXN0UmVwb3NpdG9yeS5jcmVhdGUoe1xuICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgcHJvZHVjdElkLFxuICAgICAgICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIGFkZGVkKys7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGZhaWxlZCsrO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7IGFkZGVkLCBmYWlsZWQgfTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9