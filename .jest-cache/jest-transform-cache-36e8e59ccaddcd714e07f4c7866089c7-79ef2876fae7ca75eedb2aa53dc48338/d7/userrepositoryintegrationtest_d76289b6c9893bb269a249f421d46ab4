4bd85d2089f14ed23eb60e14b4b4574e
"use strict";
/**
 * Integration Tests: User Repository with Real Database
 *
 * Testing database operations with actual TypeORM connection
 */
Object.defineProperty(exports, "__esModule", { value: true });
const user_repository_1 = require("../../../src/services/user-management/repositories/user.repository");
const user_entity_1 = require("../../../src/services/user-management/entities/user.entity");
const errors_1 = require("../../../src/libs/errors");
describe('UserRepository Integration Tests', () => {
    let dataSource;
    let userRepository;
    beforeAll(async () => {
        // In real implementation, this would connect to test database
        dataSource = {
            isInitialized: true,
            getRepository: jest.fn(),
        };
    });
    afterAll(async () => {
        if (dataSource?.isInitialized) {
            await dataSource.destroy();
        }
    });
    beforeEach(async () => {
        // Clear test data before each test
        const repository = dataSource.getRepository(user_entity_1.User);
        userRepository = new user_repository_1.UserRepository(repository);
    });
    describe('Create and Read Operations', () => {
        it('should create user and retrieve by ID', async () => {
            const userData = {
                email: 'integration@test.com',
                password: 'hashed_password',
                firstName: 'Integration',
                lastName: 'Test',
            };
            const created = await userRepository.createUser(userData);
            expect(created.id).toBeDefined();
            expect(created.email).toBe('integration@test.com');
            const retrieved = await userRepository.findById(created.id);
            expect(retrieved.email).toBe(created.email);
        });
        it('should create user with all optional fields', async () => {
            const userData = {
                email: 'full@test.com',
                password: 'hashed_password',
                firstName: 'Full',
                lastName: 'User',
                phoneNumber: '+1234567890',
                role: user_entity_1.UserRole.ADMIN,
            };
            const created = await userRepository.createUser(userData);
            expect(created.phoneNumber).toBe('+1234567890');
            expect(created.role).toBe(user_entity_1.UserRole.ADMIN);
        });
        it('should enforce unique email constraint', async () => {
            const userData = {
                email: 'duplicate@test.com',
                password: 'password',
                firstName: 'First',
                lastName: 'User',
            };
            await userRepository.createUser(userData);
            await expect(userRepository.createUser(userData)).rejects.toThrow(errors_1.ConflictError);
        });
    });
    describe('Update Operations', () => {
        it('should update user fields', async () => {
            const user = await userRepository.createUser({
                email: 'update@test.com',
                password: 'password',
                firstName: 'Original',
                lastName: 'Name',
            });
            const updated = await userRepository.update(user.id, {
                firstName: 'Updated',
            });
            expect(updated.firstName).toBe('Updated');
            expect(updated.lastName).toBe('Name'); // Unchanged
        });
        it('should update last login timestamp', async () => {
            const user = await userRepository.createUser({
                email: 'login@test.com',
                password: 'password',
                firstName: 'Login',
                lastName: 'Test',
            });
            const before = user.lastLoginAt;
            await new Promise(resolve => setTimeout(resolve, 10));
            const updated = await userRepository.updateLastLogin(user.id);
            expect(updated.lastLoginAt).toBeDefined();
            expect(updated.lastLoginAt).not.toEqual(before);
        });
    });
    describe('Query Operations', () => {
        beforeEach(async () => {
            // Create test data
            await userRepository.createUser({
                email: 'admin@test.com',
                password: 'password',
                firstName: 'Admin',
                lastName: 'User',
                role: user_entity_1.UserRole.ADMIN,
            });
            await userRepository.createUser({
                email: 'customer@test.com',
                password: 'password',
                firstName: 'Customer',
                lastName: 'User',
                role: user_entity_1.UserRole.CUSTOMER,
            });
        });
        it('should find users by role', async () => {
            const admins = await userRepository.findByRole(user_entity_1.UserRole.ADMIN);
            expect(admins.length).toBeGreaterThanOrEqual(1);
            expect(admins.every(u => u.role === user_entity_1.UserRole.ADMIN)).toBe(true);
        });
        it('should find users by status', async () => {
            const pending = await userRepository.findByStatus(user_entity_1.UserStatus.PENDING);
            expect(Array.isArray(pending)).toBe(true);
        });
        it('should find user by email', async () => {
            const user = await userRepository.findByEmail('admin@test.com');
            expect(user).toBeDefined();
            expect(user?.email).toBe('admin@test.com');
        });
    });
    describe('Delete Operations', () => {
        it('should delete user permanently', async () => {
            const user = await userRepository.createUser({
                email: 'delete@test.com',
                password: 'password',
                firstName: 'Delete',
                lastName: 'Me',
            });
            await userRepository.delete(user.id);
            await expect(userRepository.findById(user.id)).rejects.toThrow(errors_1.NotFoundError);
        });
        it('should soft delete user', async () => {
            const user = await userRepository.createUser({
                email: 'softdelete@test.com',
                password: 'password',
                firstName: 'Soft',
                lastName: 'Delete',
            });
            await userRepository.softDelete(user.id);
            // Soft deleted users should not appear in normal queries
            const found = await userRepository.findByEmail('softdelete@test.com');
            expect(found).toBeNull();
        });
    });
    describe('Transaction Operations', () => {
        it('should rollback on error', async () => {
            const initialCount = await userRepository.count();
            try {
                await userRepository.createUser({
                    email: 'test@test.com',
                    password: 'password',
                    firstName: 'Test',
                    lastName: 'User',
                });
                // Simulate error
                throw new Error('Transaction failed');
            }
            catch (error) {
                // Transaction should rollback
            }
            const finalCount = await userRepository.count();
            expect(finalCount).toBe(initialCount);
        });
    });
    describe('Password Reset Flow', () => {
        it('should complete password reset flow', async () => {
            const user = await userRepository.createUser({
                email: 'reset@test.com',
                password: 'old_password',
                firstName: 'Reset',
                lastName: 'Test',
            });
            // Set reset token
            const token = 'reset-token-123';
            await userRepository.setPasswordResetToken(user.id, token);
            // Verify token was set
            const withToken = await userRepository.findById(user.id);
            expect(withToken.passwordResetToken).toBe(token);
            expect(withToken.passwordResetExpires).toBeDefined();
            // Reset password
            const newPassword = 'new_password';
            const updated = await userRepository.resetPassword(token, newPassword);
            expect(updated.password).toBe(newPassword);
            expect(updated.passwordResetToken).toBeNull();
            expect(updated.passwordResetExpires).toBeNull();
        });
    });
    describe('Email Verification Flow', () => {
        it('should complete email verification flow', async () => {
            const user = await userRepository.createUser({
                email: 'verify@test.com',
                password: 'password',
                firstName: 'Verify',
                lastName: 'Test',
            });
            // Set verification token
            const token = 'verify-token-123';
            await userRepository.setEmailVerificationToken(user.id, token);
            // Verify email
            const verified = await userRepository.verifyEmail(token);
            expect(verified.emailVerifiedAt).toBeDefined();
            expect(verified.emailVerificationToken).toBeNull();
            expect(verified.status).toBe(user_entity_1.UserStatus.ACTIVE);
        });
    });
    describe('Login Attempts Tracking', () => {
        it('should track and reset login attempts', async () => {
            const user = await userRepository.createUser({
                email: 'attempts@test.com',
                password: 'password',
                firstName: 'Attempts',
                lastName: 'Test',
            });
            // Increment attempts
            let updated = await userRepository.incrementLoginAttempts(user.id);
            expect(updated.loginAttempts).toBe(1);
            updated = await userRepository.incrementLoginAttempts(user.id);
            expect(updated.loginAttempts).toBe(2);
            // Reset attempts
            updated = await userRepository.resetLoginAttempts(user.id);
            expect(updated.loginAttempts).toBe(0);
            expect(updated.lockedUntil).toBeNull();
        });
        it('should lock account after 5 failed attempts', async () => {
            const user = await userRepository.createUser({
                email: 'lockout@test.com',
                password: 'password',
                firstName: 'Lockout',
                lastName: 'Test',
            });
            // Simulate 5 failed attempts
            let updated = user;
            for (let i = 0; i < 5; i++) {
                updated = await userRepository.incrementLoginAttempts(user.id);
            }
            expect(updated.loginAttempts).toBe(5);
            expect(updated.lockedUntil).toBeDefined();
            expect(updated.lockedUntil.getTime()).toBeGreaterThan(Date.now());
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXEFkYXB0aXZlX1Rlc3RpbmdcXHRlc3RzXFxpbnRlZ3JhdGlvblxcZGF0YWJhc2VcXHVzZXItcmVwb3NpdG9yeS5pbnRlZ3JhdGlvbi50ZXN0LnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHOztBQUdILHdHQUFvRztBQUNwRyw0RkFBd0c7QUFDeEcscURBQXdFO0FBRXhFLFFBQVEsQ0FBQyxrQ0FBa0MsRUFBRSxHQUFHLEVBQUU7SUFDaEQsSUFBSSxVQUFzQixDQUFDO0lBQzNCLElBQUksY0FBOEIsQ0FBQztJQUVuQyxTQUFTLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDbkIsOERBQThEO1FBQzlELFVBQVUsR0FBRztZQUNYLGFBQWEsRUFBRSxJQUFJO1lBQ25CLGFBQWEsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1NBQ0EsQ0FBQztJQUM3QixDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNsQixJQUFJLFVBQVUsRUFBRSxhQUFhLEVBQUUsQ0FBQztZQUM5QixNQUFNLFVBQVUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUM3QixDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFFSCxVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsbUNBQW1DO1FBQ25DLE1BQU0sVUFBVSxHQUFHLFVBQVUsQ0FBQyxhQUFhLENBQUMsa0JBQUksQ0FBQyxDQUFDO1FBQ2xELGNBQWMsR0FBRyxJQUFJLGdDQUFjLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDbEQsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsNEJBQTRCLEVBQUUsR0FBRyxFQUFFO1FBQzFDLEVBQUUsQ0FBQyx1Q0FBdUMsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNyRCxNQUFNLFFBQVEsR0FBRztnQkFDZixLQUFLLEVBQUUsc0JBQXNCO2dCQUM3QixRQUFRLEVBQUUsaUJBQWlCO2dCQUMzQixTQUFTLEVBQUUsYUFBYTtnQkFDeEIsUUFBUSxFQUFFLE1BQU07YUFDakIsQ0FBQztZQUVG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S0FBSyxFQUFFLGtCQUFrQjtnQkFDekIsUUFBUSxFQUFFLFVBQVU7Z0JBQ3BCLFNBQVMsRUFBRSxTQUFTO2dCQUNwQixRQUFRLEVBQUUsTUFBTTthQUNqQixDQUFDLENBQUM7WUFFSCw2QkFBNkI7WUFDN0IsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDO1lBQ25CLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDM0IsT0FBTyxHQUFHLE1BQU0sY0FBYyxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNqRSxDQUFDO1lBRUQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUMxQyxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUNyRSxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXEFkYXB0aXZlX1Rlc3RpbmdcXHRlc3RzXFxpbnRlZ3JhdGlvblxcZGF0YWJhc2VcXHVzZXItcmVwb3NpdG9yeS5pbnRlZ3JhdGlvbi50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogSW50ZWdyYXRpb24gVGVzdHM6IFVzZXIgUmVwb3NpdG9yeSB3aXRoIFJlYWwgRGF0YWJhc2VcbiAqXG4gKiBUZXN0aW5nIGRhdGFiYXNlIG9wZXJhdGlvbnMgd2l0aCBhY3R1YWwgVHlwZU9STSBjb25uZWN0aW9uXG4gKi9cblxuaW1wb3J0IHsgRGF0YVNvdXJjZSB9IGZyb20gJ3R5cGVvcm0nO1xuaW1wb3J0IHsgVXNlclJlcG9zaXRvcnkgfSBmcm9tICcuLi8uLi8uLi9zcmMvc2VydmljZXMvdXNlci1tYW5hZ2VtZW50L3JlcG9zaXRvcmllcy91c2VyLnJlcG9zaXRvcnknO1xuaW1wb3J0IHsgVXNlciwgVXNlclJvbGUsIFVzZXJTdGF0dXMgfSBmcm9tICcuLi8uLi8uLi9zcmMvc2VydmljZXMvdXNlci1tYW5hZ2VtZW50L2VudGl0aWVzL3VzZXIuZW50aXR5JztcbmltcG9ydCB7IE5vdEZvdW5kRXJyb3IsIENvbmZsaWN0RXJyb3IgfSBmcm9tICcuLi8uLi8uLi9zcmMvbGlicy9lcnJvcnMnO1xuXG5kZXNjcmliZSgnVXNlclJlcG9zaXRvcnkgSW50ZWdyYXRpb24gVGVzdHMnLCAoKSA9PiB7XG4gIGxldCBkYXRhU291cmNlOiBEYXRhU291cmNlO1xuICBsZXQgdXNlclJlcG9zaXRvcnk6IFVzZXJSZXBvc2l0b3J5O1xuXG4gIGJlZm9yZUFsbChhc3luYyAoKSA9PiB7XG4gICAgLy8gSW4gcmVhbCBpbXBsZW1lbnRhdGlvbiwgdGhpcyB3b3VsZCBjb25uZWN0IHRvIHRlc3QgZGF0YWJhc2VcbiAgICBkYXRhU291cmNlID0ge1xuICAgICAgaXNJbml0aWFsaXplZDogdHJ1ZSxcbiAgICAgIGdldFJlcG9zaXRvcnk6IGplc3QuZm4oKSxcbiAgICB9IGFzIHVua25vd24gYXMgRGF0YVNvdXJjZTtcbiAgfSk7XG5cbiAgYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuICAgIGlmIChkYXRhU291cmNlPy5pc0luaXRpYWxpemVkKSB7XG4gICAgICBhd2FpdCBkYXRhU291cmNlLmRlc3Ryb3koKTtcbiAgICB9XG4gIH0pO1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIC8vIENsZWFyIHRlc3QgZGF0YSBiZWZvcmUgZWFjaCB0ZXN0XG4gICAgY29uc3QgcmVwb3NpdG9yeSA9IGRhdGFTb3VyY2UuZ2V0UmVwb3NpdG9yeShVc2VyKTtcbiAgICB1c2VyUmVwb3NpdG9yeSA9IG5ldyBVc2VyUmVwb3NpdG9yeShyZXBvc2l0b3J5KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0NyZWF0ZSBhbmQgUmVhZCBPcGVyYXRpb25zJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY3JlYXRlIHVzZXIgYW5kIHJldHJpZXZlIGJ5IElEJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdXNlckRhdGEgPSB7XG4gICAgICAgIGVtYWlsOiAnaW50ZWdyYXRpb25AdGVzdC5jb20nLFxuICAgICAgICBwYXNzd29yZDogJ2hhc2hlZF9wYXNzd29yZCcsXG4gICAgICAgIGZpcnN0TmFtZTogJ0ludGVncmF0aW9uJyxcbiAgICAgICAgbGFzdE5hbWU6ICdUZXN0JyxcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IGNyZWF0ZWQgPSBhd2FpdCB1c2VyUmVwb3NpdG9yeS5jcmVhdGVVc2VyKHVzZXJEYXRhKTtcblxuICAgICAgZXhwZWN0KGNyZWF0ZWQuaWQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoY3JlYXRlZC5lbWFpbCkudG9CZSgnaW50ZWdyYXRpb25AdGVzdC5jb20nKTtcblxuICAgICAgY29uc3QgcmV0cmlldmVkID0gYXdhaXQgdXNlclJlcG9zaXRvcnkuZmluZEJ5SWQoY3JlYXRlZC5pZCk7XG4gICAgICBleHBlY3QocmV0cmlldmVkLmVtYWlsKS50b0JlKGNyZWF0ZWQuZW1haWwpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgdXNlciB3aXRoIGFsbCBvcHRpb25hbCBmaWVsZHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB1c2VyRGF0YSA9IHtcbiAgICAgICAgZW1haWw6ICdmdWxsQHRlc3QuY29tJyxcbiAgICAgICAgcGFzc3dvcmQ6ICdoYXNoZWRfcGFzc3dvcmQnLFxuICAgICAgICBmaXJzdE5hbWU6ICdGdWxsJyxcbiAgICAgICAgbGFzdE5hbWU6ICdVc2VyJyxcbiAgICAgICAgcGhvbmVOdW1iZXI6ICcrMTIzNDU2Nzg5MCcsXG4gICAgICAgIHJvbGU6IFVzZXJSb2xlLkFETUlOLFxuICAgICAgfTtcblxuICAgICAgY29uc3QgY3JlYXRlZCA9IGF3YWl0IHVzZXJSZXBvc2l0b3J5LmNyZWF0ZVVzZXIodXNlckRhdGEpO1xuXG4gICAgICBleHBlY3QoY3JlYXRlZC5waG9uZU51bWJlcikudG9CZSgnKzEyMzQ1Njc4OTAnKTtcbiAgICAgIGV4cGVjdChjcmVhdGVkLnJvbGUpLnRvQmUoVXNlclJvbGUuQURNSU4pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBlbmZvcmNlIHVuaXF1ZSBlbWFpbCBjb25zdHJhaW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdXNlckRhdGEgPSB7XG4gICAgICAgIGVtYWlsOiAnZHVwbGljYXRlQHRlc3QuY29tJyxcbiAgICAgICAgcGFzc3dvcmQ6ICdwYXNzd29yZCcsXG4gICAgICAgIGZpcnN0TmFtZTogJ0ZpcnN0JyxcbiAgICAgICAgbGFzdE5hbWU6ICdVc2VyJyxcbiAgICAgIH07XG5cbiAgICAgIGF3YWl0IHVzZXJSZXBvc2l0b3J5LmNyZWF0ZVVzZXIodXNlckRhdGEpO1xuXG4gICAgICBhd2FpdCBleHBlY3QoXG4gICAgICAgIHVzZXJSZXBvc2l0b3J5LmNyZWF0ZVVzZXIodXNlckRhdGEpXG4gICAgICApLnJlamVjdHMudG9UaHJvdyhDb25mbGljdEVycm9yKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1VwZGF0ZSBPcGVyYXRpb25zJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgdXBkYXRlIHVzZXIgZmllbGRzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHVzZXJSZXBvc2l0b3J5LmNyZWF0ZVVzZXIoe1xuICAgICAgICBlbWFpbDogJ3VwZGF0ZUB0ZXN0LmNvbScsXG4gICAgICAgIHBhc3N3b3JkOiAncGFzc3dvcmQnLFxuICAgICAgICBmaXJzdE5hbWU6ICdPcmlnaW5hbCcsXG4gICAgICAgIGxhc3ROYW1lOiAnTmFtZScsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgdXBkYXRlZCA9IGF3YWl0IHVzZXJSZXBvc2l0b3J5LnVwZGF0ZSh1c2VyLmlkLCB7XG4gICAgICAgIGZpcnN0TmFtZTogJ1VwZGF0ZWQnLFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdCh1cGRhdGVkLmZpcnN0TmFtZSkudG9CZSgnVXBkYXRlZCcpO1xuICAgICAgZXhwZWN0KHVwZGF0ZWQubGFzdE5hbWUpLnRvQmUoJ05hbWUnKTsgLy8gVW5jaGFuZ2VkXG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHVwZGF0ZSBsYXN0IGxvZ2luIHRpbWVzdGFtcCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB1c2VyUmVwb3NpdG9yeS5jcmVhdGVVc2VyKHtcbiAgICAgICAgZW1haWw6ICdsb2dpbkB0ZXN0LmNvbScsXG4gICAgICAgIHBhc3N3b3JkOiAncGFzc3dvcmQnLFxuICAgICAgICBmaXJzdE5hbWU6ICdMb2dpbicsXG4gICAgICAgIGxhc3ROYW1lOiAnVGVzdCcsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgYmVmb3JlID0gdXNlci5sYXN0TG9naW5BdDtcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMCkpO1xuXG4gICAgICBjb25zdCB1cGRhdGVkID0gYXdhaXQgdXNlclJlcG9zaXRvcnkudXBkYXRlTGFzdExvZ2luKHVzZXIuaWQpO1xuXG4gICAgICBleHBlY3QodXBkYXRlZC5sYXN0TG9naW5BdCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdCh1cGRhdGVkLmxhc3RMb2dpbkF0KS5ub3QudG9FcXVhbChiZWZvcmUpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnUXVlcnkgT3BlcmF0aW9ucycsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICAgIC8vIENyZWF0ZSB0ZXN0IGRhdGFcbiAgICAgIGF3YWl0IHVzZXJSZXBvc2l0b3J5LmNyZWF0ZVVzZXIoe1xuICAgICAgICBlbWFpbDogJ2FkbWluQHRlc3QuY29tJyxcbiAgICAgICAgcGFzc3dvcmQ6ICdwYXNzd29yZCcsXG4gICAgICAgIGZpcnN0TmFtZTogJ0FkbWluJyxcbiAgICAgICAgbGFzdE5hbWU6ICdVc2VyJyxcbiAgICAgICAgcm9sZTogVXNlclJvbGUuQURNSU4sXG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgdXNlclJlcG9zaXRvcnkuY3JlYXRlVXNlcih7XG4gICAgICAgIGVtYWlsOiAnY3VzdG9tZXJAdGVzdC5jb20nLFxuICAgICAgICBwYXNzd29yZDogJ3Bhc3N3b3JkJyxcbiAgICAgICAgZmlyc3ROYW1lOiAnQ3VzdG9tZXInLFxuICAgICAgICBsYXN0TmFtZTogJ1VzZXInLFxuICAgICAgICByb2xlOiBVc2VyUm9sZS5DVVNUT01FUixcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBmaW5kIHVzZXJzIGJ5IHJvbGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBhZG1pbnMgPSBhd2FpdCB1c2VyUmVwb3NpdG9yeS5maW5kQnlSb2xlKFVzZXJSb2xlLkFETUlOKTtcblxuICAgICAgZXhwZWN0KGFkbWlucy5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbk9yRXF1YWwoMSk7XG4gICAgICBleHBlY3QoYWRtaW5zLmV2ZXJ5KHUgPT4gdS5yb2xlID09PSBVc2VyUm9sZS5BRE1JTikpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGZpbmQgdXNlcnMgYnkgc3RhdHVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcGVuZGluZyA9IGF3YWl0IHVzZXJSZXBvc2l0b3J5LmZpbmRCeVN0YXR1cyhVc2VyU3RhdHVzLlBFTkRJTkcpO1xuXG4gICAgICBleHBlY3QoQXJyYXkuaXNBcnJheShwZW5kaW5nKSkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZmluZCB1c2VyIGJ5IGVtYWlsJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHVzZXJSZXBvc2l0b3J5LmZpbmRCeUVtYWlsKCdhZG1pbkB0ZXN0LmNvbScpO1xuXG4gICAgICBleHBlY3QodXNlcikudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdCh1c2VyPy5lbWFpbCkudG9CZSgnYWRtaW5AdGVzdC5jb20nKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0RlbGV0ZSBPcGVyYXRpb25zJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZGVsZXRlIHVzZXIgcGVybWFuZW50bHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgdXNlclJlcG9zaXRvcnkuY3JlYXRlVXNlcih7XG4gICAgICAgIGVtYWlsOiAnZGVsZXRlQHRlc3QuY29tJyxcbiAgICAgICAgcGFzc3dvcmQ6ICdwYXNzd29yZCcsXG4gICAgICAgIGZpcnN0TmFtZTogJ0RlbGV0ZScsXG4gICAgICAgIGxhc3ROYW1lOiAnTWUnLFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IHVzZXJSZXBvc2l0b3J5LmRlbGV0ZSh1c2VyLmlkKTtcblxuICAgICAgYXdhaXQgZXhwZWN0KFxuICAgICAgICB1c2VyUmVwb3NpdG9yeS5maW5kQnlJZCh1c2VyLmlkKVxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coTm90Rm91bmRFcnJvcik7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHNvZnQgZGVsZXRlIHVzZXInLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgdXNlclJlcG9zaXRvcnkuY3JlYXRlVXNlcih7XG4gICAgICAgIGVtYWlsOiAnc29mdGRlbGV0ZUB0ZXN0LmNvbScsXG4gICAgICAgIHBhc3N3b3JkOiAncGFzc3dvcmQnLFxuICAgICAgICBmaXJzdE5hbWU6ICdTb2Z0JyxcbiAgICAgICAgbGFzdE5hbWU6ICdEZWxldGUnLFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IHVzZXJSZXBvc2l0b3J5LnNvZnREZWxldGUodXNlci5pZCk7XG5cbiAgICAgIC8vIFNvZnQgZGVsZXRlZCB1c2VycyBzaG91bGQgbm90IGFwcGVhciBpbiBub3JtYWwgcXVlcmllc1xuICAgICAgY29uc3QgZm91bmQgPSBhd2FpdCB1c2VyUmVwb3NpdG9yeS5maW5kQnlFbWFpbCgnc29mdGRlbGV0ZUB0ZXN0LmNvbScpO1xuICAgICAgZXhwZWN0KGZvdW5kKS50b0JlTnVsbCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnVHJhbnNhY3Rpb24gT3BlcmF0aW9ucycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJvbGxiYWNrIG9uIGVycm9yJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW5pdGlhbENvdW50ID0gYXdhaXQgdXNlclJlcG9zaXRvcnkuY291bnQoKTtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdXNlclJlcG9zaXRvcnkuY3JlYXRlVXNlcih7XG4gICAgICAgICAgZW1haWw6ICd0ZXN0QHRlc3QuY29tJyxcbiAgICAgICAgICBwYXNzd29yZDogJ3Bhc3N3b3JkJyxcbiAgICAgICAgICBmaXJzdE5hbWU6ICdUZXN0JyxcbiAgICAgICAgICBsYXN0TmFtZTogJ1VzZXInLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBTaW11bGF0ZSBlcnJvclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyYW5zYWN0aW9uIGZhaWxlZCcpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgLy8gVHJhbnNhY3Rpb24gc2hvdWxkIHJvbGxiYWNrXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGZpbmFsQ291bnQgPSBhd2FpdCB1c2VyUmVwb3NpdG9yeS5jb3VudCgpO1xuICAgICAgZXhwZWN0KGZpbmFsQ291bnQpLnRvQmUoaW5pdGlhbENvdW50KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1Bhc3N3b3JkIFJlc2V0IEZsb3cnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjb21wbGV0ZSBwYXNzd29yZCByZXNldCBmbG93JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHVzZXJSZXBvc2l0b3J5LmNyZWF0ZVVzZXIoe1xuICAgICAgICBlbWFpbDogJ3Jlc2V0QHRlc3QuY29tJyxcbiAgICAgICAgcGFzc3dvcmQ6ICdvbGRfcGFzc3dvcmQnLFxuICAgICAgICBmaXJzdE5hbWU6ICdSZXNldCcsXG4gICAgICAgIGxhc3ROYW1lOiAnVGVzdCcsXG4gICAgICB9KTtcblxuICAgICAgLy8gU2V0IHJlc2V0IHRva2VuXG4gICAgICBjb25zdCB0b2tlbiA9ICdyZXNldC10b2tlbi0xMjMnO1xuICAgICAgYXdhaXQgdXNlclJlcG9zaXRvcnkuc2V0UGFzc3dvcmRSZXNldFRva2VuKHVzZXIuaWQsIHRva2VuKTtcblxuICAgICAgLy8gVmVyaWZ5IHRva2VuIHdhcyBzZXRcbiAgICAgIGNvbnN0IHdpdGhUb2tlbiA9IGF3YWl0IHVzZXJSZXBvc2l0b3J5LmZpbmRCeUlkKHVzZXIuaWQpO1xuICAgICAgZXhwZWN0KHdpdGhUb2tlbi5wYXNzd29yZFJlc2V0VG9rZW4pLnRvQmUodG9rZW4pO1xuICAgICAgZXhwZWN0KHdpdGhUb2tlbi5wYXNzd29yZFJlc2V0RXhwaXJlcykudG9CZURlZmluZWQoKTtcblxuICAgICAgLy8gUmVzZXQgcGFzc3dvcmRcbiAgICAgIGNvbnN0IG5ld1Bhc3N3b3JkID0gJ25ld19wYXNzd29yZCc7XG4gICAgICBjb25zdCB1cGRhdGVkID0gYXdhaXQgdXNlclJlcG9zaXRvcnkucmVzZXRQYXNzd29yZCh0b2tlbiwgbmV3UGFzc3dvcmQpO1xuXG4gICAgICBleHBlY3QodXBkYXRlZC5wYXNzd29yZCkudG9CZShuZXdQYXNzd29yZCk7XG4gICAgICBleHBlY3QodXBkYXRlZC5wYXNzd29yZFJlc2V0VG9rZW4pLnRvQmVOdWxsKCk7XG4gICAgICBleHBlY3QodXBkYXRlZC5wYXNzd29yZFJlc2V0RXhwaXJlcykudG9CZU51bGwoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0VtYWlsIFZlcmlmaWNhdGlvbiBGbG93JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY29tcGxldGUgZW1haWwgdmVyaWZpY2F0aW9uIGZsb3cnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgdXNlclJlcG9zaXRvcnkuY3JlYXRlVXNlcih7XG4gICAgICAgIGVtYWlsOiAndmVyaWZ5QHRlc3QuY29tJyxcbiAgICAgICAgcGFzc3dvcmQ6ICdwYXNzd29yZCcsXG4gICAgICAgIGZpcnN0TmFtZTogJ1ZlcmlmeScsXG4gICAgICAgIGxhc3ROYW1lOiAnVGVzdCcsXG4gICAgICB9KTtcblxuICAgICAgLy8gU2V0IHZlcmlmaWNhdGlvbiB0b2tlblxuICAgICAgY29uc3QgdG9rZW4gPSAndmVyaWZ5LXRva2VuLTEyMyc7XG4gICAgICBhd2FpdCB1c2VyUmVwb3NpdG9yeS5zZXRFbWFpbFZlcmlmaWNhdGlvblRva2VuKHVzZXIuaWQsIHRva2VuKTtcblxuICAgICAgLy8gVmVyaWZ5IGVtYWlsXG4gICAgICBjb25zdCB2ZXJpZmllZCA9IGF3YWl0IHVzZXJSZXBvc2l0b3J5LnZlcmlmeUVtYWlsKHRva2VuKTtcblxuICAgICAgZXhwZWN0KHZlcmlmaWVkLmVtYWlsVmVyaWZpZWRBdCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdCh2ZXJpZmllZC5lbWFpbFZlcmlmaWNhdGlvblRva2VuKS50b0JlTnVsbCgpO1xuICAgICAgZXhwZWN0KHZlcmlmaWVkLnN0YXR1cykudG9CZShVc2VyU3RhdHVzLkFDVElWRSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdMb2dpbiBBdHRlbXB0cyBUcmFja2luZycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHRyYWNrIGFuZCByZXNldCBsb2dpbiBhdHRlbXB0cycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB1c2VyUmVwb3NpdG9yeS5jcmVhdGVVc2VyKHtcbiAgICAgICAgZW1haWw6ICdhdHRlbXB0c0B0ZXN0LmNvbScsXG4gICAgICAgIHBhc3N3b3JkOiAncGFzc3dvcmQnLFxuICAgICAgICBmaXJzdE5hbWU6ICdBdHRlbXB0cycsXG4gICAgICAgIGxhc3ROYW1lOiAnVGVzdCcsXG4gICAgICB9KTtcblxuICAgICAgLy8gSW5jcmVtZW50IGF0dGVtcHRzXG4gICAgICBsZXQgdXBkYXRlZCA9IGF3YWl0IHVzZXJSZXBvc2l0b3J5LmluY3JlbWVudExvZ2luQXR0ZW1wdHModXNlci5pZCk7XG4gICAgICBleHBlY3QodXBkYXRlZC5sb2dpbkF0dGVtcHRzKS50b0JlKDEpO1xuXG4gICAgICB1cGRhdGVkID0gYXdhaXQgdXNlclJlcG9zaXRvcnkuaW5jcmVtZW50TG9naW5BdHRlbXB0cyh1c2VyLmlkKTtcbiAgICAgIGV4cGVjdCh1cGRhdGVkLmxvZ2luQXR0ZW1wdHMpLnRvQmUoMik7XG5cbiAgICAgIC8vIFJlc2V0IGF0dGVtcHRzXG4gICAgICB1cGRhdGVkID0gYXdhaXQgdXNlclJlcG9zaXRvcnkucmVzZXRMb2dpbkF0dGVtcHRzKHVzZXIuaWQpO1xuICAgICAgZXhwZWN0KHVwZGF0ZWQubG9naW5BdHRlbXB0cykudG9CZSgwKTtcbiAgICAgIGV4cGVjdCh1cGRhdGVkLmxvY2tlZFVudGlsKS50b0JlTnVsbCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBsb2NrIGFjY291bnQgYWZ0ZXIgNSBmYWlsZWQgYXR0ZW1wdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgdXNlclJlcG9zaXRvcnkuY3JlYXRlVXNlcih7XG4gICAgICAgIGVtYWlsOiAnbG9ja291dEB0ZXN0LmNvbScsXG4gICAgICAgIHBhc3N3b3JkOiAncGFzc3dvcmQnLFxuICAgICAgICBmaXJzdE5hbWU6ICdMb2Nrb3V0JyxcbiAgICAgICAgbGFzdE5hbWU6ICdUZXN0JyxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBTaW11bGF0ZSA1IGZhaWxlZCBhdHRlbXB0c1xuICAgICAgbGV0IHVwZGF0ZWQgPSB1c2VyO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA1OyBpKyspIHtcbiAgICAgICAgdXBkYXRlZCA9IGF3YWl0IHVzZXJSZXBvc2l0b3J5LmluY3JlbWVudExvZ2luQXR0ZW1wdHModXNlci5pZCk7XG4gICAgICB9XG5cbiAgICAgIGV4cGVjdCh1cGRhdGVkLmxvZ2luQXR0ZW1wdHMpLnRvQmUoNSk7XG4gICAgICBleHBlY3QodXBkYXRlZC5sb2NrZWRVbnRpbCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdCh1cGRhdGVkLmxvY2tlZFVudGlsIS5nZXRUaW1lKCkpLnRvQmVHcmVhdGVyVGhhbihEYXRlLm5vdygpKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==