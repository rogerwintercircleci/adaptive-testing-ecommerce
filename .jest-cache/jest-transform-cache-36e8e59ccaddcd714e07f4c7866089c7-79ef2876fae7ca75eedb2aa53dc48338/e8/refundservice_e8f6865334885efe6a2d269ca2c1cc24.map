{"file":"C:\\Adaptive_Testing\\src\\services\\order-processing\\services\\refund.service.ts","mappings":"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","names":[],"sources":["C:\\Adaptive_Testing\\src\\services\\order-processing\\services\\refund.service.ts"],"sourcesContent":["/**\n * Refund & Returns Service Implementation\n */\n\nimport { RefundRepository } from '../repositories/refund.repository';\nimport { OrderRepository } from '../repositories/order.repository';\nimport { InventoryRepository } from '../../inventory/repositories/inventory.repository';\nimport { PaymentGatewayService } from './payment-gateway.service';\nimport { ShippingProviderService } from './shipping-provider.service';\nimport { BadRequestError, NotFoundError } from '@libs/errors';\nimport { RefundStatus, ReturnReason, ReturnStatus } from '../entities/refund.entity';\nimport { PaymentStatus } from '../entities/order.entity';\n\n// Re-export enums for convenience\nexport { RefundStatus, ReturnReason, ReturnStatus };\n\nexport interface CreateRefundRequestDto {\n  orderId: string;\n  reason: ReturnReason;\n  description?: string;\n  items: Array<{\n    productId: string;\n    quantity: number;\n  }>;\n  photos?: string[];\n}\n\nexport class RefundService {\n  private readonly RETURN_WINDOW_DAYS = 30;\n\n  constructor(\n    private refundRepository: RefundRepository,\n    private orderRepository: OrderRepository,\n    private inventoryRepository: InventoryRepository,\n    private paymentGatewayService: PaymentGatewayService,\n    private shippingProviderService: ShippingProviderService\n  ) {}\n\n  async createRefundRequest(data: CreateRefundRequestDto) {\n    const order = await this.orderRepository.findById(data.orderId);\n\n    // Validate order is paid\n    if (order.paymentStatus !== PaymentStatus.PAID) {\n      throw new BadRequestError('Order must be paid to request a refund');\n    }\n\n    // Check return window\n    if (order.deliveredAt) {\n      const daysSinceDelivery =\n        (Date.now() - order.deliveredAt.getTime()) / (1000 * 60 * 60 * 24);\n      if (daysSinceDelivery > this.RETURN_WINDOW_DAYS) {\n        throw new BadRequestError(\n          `Return window of ${this.RETURN_WINDOW_DAYS} days has expired`\n        );\n      }\n    }\n\n    // Require photos for defective items\n    if (\n      (data.reason === ReturnReason.DEFECTIVE || data.reason === ReturnReason.DAMAGED) &&\n      (!data.photos || data.photos.length === 0)\n    ) {\n      throw new BadRequestError('Photos are required for defective or damaged items');\n    }\n\n    // Calculate refund amounts\n    const itemsWithRefunds = data.items.map(item => {\n      const orderItem = order.items.find(oi => oi.productId === item.productId);\n      if (!orderItem) {\n        throw new BadRequestError(`Product ${item.productId} not found in order`);\n      }\n\n      if (item.quantity > orderItem.quantity) {\n        throw new BadRequestError('Refund quantity exceeds ordered quantity');\n      }\n\n      const refundAmount = (orderItem.unitPrice * item.quantity);\n      return {\n        ...item,\n        refundAmount,\n      };\n    });\n\n    const refundAmount = itemsWithRefunds.reduce(\n      (sum, item) => sum + item.refundAmount,\n      0\n    );\n\n    return this.refundRepository.create({\n      orderId: data.orderId,\n      userId: order.userId,\n      reason: data.reason,\n      description: data.description,\n      items: data.items,\n      refundAmount,\n      status: RefundStatus.PENDING,\n      photos: data.photos,\n      restockItems: data.reason !== ReturnReason.DEFECTIVE && data.reason !== ReturnReason.DAMAGED,\n      createdAt: new Date(),\n    } as any);\n  }\n\n  async approveRefund(refundId: string, _approvedBy?: string) {\n    const refund = await this.refundRepository.findById(refundId);\n\n    if (refund.status !== RefundStatus.PENDING) {\n      throw new BadRequestError('Only pending refunds can be approved');\n    }\n\n    return this.refundRepository.updateStatus(refundId, RefundStatus.APPROVED);\n  }\n\n  async rejectRefund(refundId: string, reason: string) {\n    const refund = await this.refundRepository.findById(refundId);\n\n    if (refund.status !== RefundStatus.PENDING) {\n      throw new BadRequestError('Only pending refunds can be rejected');\n    }\n\n    await this.refundRepository.update(refundId, {\n      status: RefundStatus.REJECTED,\n      rejectionReason: reason,\n    } as any);\n\n    return this.refundRepository.findById(refundId);\n  }\n\n  async processRefund(refundId: string) {\n    const refund = await this.refundRepository.findById(refundId);\n\n    if (refund.status !== RefundStatus.APPROVED) {\n      throw new BadRequestError('Only approved refunds can be processed');\n    }\n\n    // Update status to processing\n    await this.refundRepository.updateStatus(refundId, RefundStatus.PROCESSING);\n\n    try {\n      const order = await this.orderRepository.findById(refund.orderId);\n\n      // Issue payment refund\n      await this.paymentGatewayService.refundPayment({\n        transactionId: `txn_${order.id}`,\n        amount: refund.refundAmount,\n        reason: refund.reason as string,\n      });\n\n      // Restock items if applicable\n      if (refund.restockItems) {\n        await this.restockItems(refund.id);\n      }\n\n      // Mark as completed\n      await this.refundRepository.update(refundId, {\n        status: RefundStatus.COMPLETED,\n        processedAt: new Date(),\n      } as any);\n\n      return this.refundRepository.findById(refundId);\n    } catch (error) {\n      // Mark as failed\n      await this.refundRepository.updateStatus(refundId, RefundStatus.FAILED);\n      throw error;\n    }\n  }\n\n  async restockItems(refundId: string) {\n    const refund = await this.refundRepository.findById(refundId);\n\n    if (!refund.restockItems) {\n      return;\n    }\n\n    for (const item of refund.items) {\n      const inventory = await this.inventoryRepository.findByProductId(item.productId);\n      await this.inventoryRepository.update(item.productId, {\n        quantity: inventory.quantity + item.quantity,\n      });\n\n      await this.inventoryRepository.recordAdjustment({\n        productId: item.productId,\n        quantity: item.quantity,\n        reason: `refund_restock_${refundId}`,\n        date: new Date(),\n      });\n    }\n  }\n\n  async generateReturnLabel(refundId: string) {\n    const refund = await this.refundRepository.findById(refundId);\n    const order = await this.orderRepository.findById(refund.orderId);\n\n    if (refund.status !== RefundStatus.APPROVED) {\n      throw new BadRequestError('Refund must be approved to generate return label');\n    }\n\n    const label = await this.shippingProviderService.createReturnLabel({\n      orderId: order.id,\n      fromAddress: order.shippingAddress,\n      refundId,\n    });\n\n    await this.refundRepository.update(refundId, {\n      returnLabelUrl: label.labelUrl,\n      returnTrackingNumber: label.trackingNumber,\n      returnStatus: ReturnStatus.LABEL_GENERATED,\n    } as any);\n\n    return {\n      labelUrl: label.labelUrl,\n      trackingNumber: label.trackingNumber,\n    };\n  }\n\n  async trackReturn(trackingNumber: string) {\n    const refund = await this.repository.findOne({\n      where: { returnTrackingNumber: trackingNumber },\n    });\n\n    if (!refund) {\n      throw new NotFoundError('Return not found');\n    }\n\n    const trackingInfo = await this.shippingProviderService.trackShipment(trackingNumber);\n\n    // Update return status based on tracking\n    let returnStatus = refund.returnStatus;\n    if (trackingInfo.status === 'in_transit') {\n      returnStatus = ReturnStatus.IN_TRANSIT;\n    } else if (trackingInfo.status === 'delivered') {\n      returnStatus = ReturnStatus.RECEIVED;\n    }\n\n    if (returnStatus !== refund.returnStatus) {\n      await this.refundRepository.updateReturnStatus(refund.id, returnStatus);\n    }\n\n    return {\n      ...trackingInfo,\n      refundId: refund.id,\n      returnStatus,\n    };\n  }\n\n  async markReturnAsReceived(refundId: string) {\n    await this.refundRepository.findById(refundId);\n\n    await this.refundRepository.updateReturnStatus(refundId, ReturnStatus.RECEIVED);\n\n    return this.refundRepository.findById(refundId);\n  }\n\n  async getRefundStatistics(options?: { startDate?: Date; endDate?: Date }) {\n    const totalRefunded = await this.refundRepository.getTotalRefundedAmount(\n      options?.startDate,\n      options?.endDate\n    );\n\n    const pending = await this.refundRepository.countByStatus(RefundStatus.PENDING);\n    const approved = await this.refundRepository.countByStatus(RefundStatus.APPROVED);\n    const rejected = await this.refundRepository.countByStatus(RefundStatus.REJECTED);\n    const completed = await this.refundRepository.countByStatus(RefundStatus.COMPLETED);\n\n    return {\n      totalRefunded,\n      pending,\n      approved,\n      rejected,\n      completed,\n    };\n  }\n\n  async checkEligibility(orderId: string) {\n    const order = await this.orderRepository.findById(orderId);\n\n    const issues: string[] = [];\n\n    if (order.paymentStatus !== PaymentStatus.PAID) {\n      issues.push('Order must be paid');\n    }\n\n    if (order.deliveredAt) {\n      const daysSinceDelivery =\n        (Date.now() - order.deliveredAt.getTime()) / (1000 * 60 * 60 * 24);\n      if (daysSinceDelivery > this.RETURN_WINDOW_DAYS) {\n        issues.push(`Return window of ${this.RETURN_WINDOW_DAYS} days has expired`);\n      }\n    }\n\n    return {\n      eligible: issues.length === 0,\n      issues,\n    };\n  }\n\n  async calculateRefundAmount(data: {\n    orderId: string;\n    items: Array<{ productId: string; quantity: number }>;\n  }) {\n    const order = await this.orderRepository.findById(data.orderId);\n\n    let totalRefund = 0;\n\n    for (const item of data.items) {\n      const orderItem = order.items.find(oi => oi.productId === item.productId);\n      if (!orderItem) {\n        throw new BadRequestError(`Product ${item.productId} not found in order`);\n      }\n\n      if (item.quantity > orderItem.quantity) {\n        throw new BadRequestError('Refund quantity exceeds ordered quantity');\n      }\n\n      totalRefund += orderItem.unitPrice * item.quantity;\n    }\n\n    return {\n      refundAmount: totalRefund,\n      items: data.items.map(item => {\n        const orderItem = order.items.find(oi => oi.productId === item.productId)!;\n        return {\n          ...item,\n          unitPrice: orderItem.unitPrice,\n          refundAmount: orderItem.unitPrice * item.quantity,\n        };\n      }),\n    };\n  }\n\n  async getUserRefunds(userId: string) {\n    return this.refundRepository.findByUserId(userId);\n  }\n\n  async getOrderRefunds(orderId: string) {\n    return this.refundRepository.findByOrderId(orderId);\n  }\n\n  private get repository() {\n    return this.refundRepository['repository'];\n  }\n}\n"],"version":3}